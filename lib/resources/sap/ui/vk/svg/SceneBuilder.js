/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)

        (c) Copyright 2009-2015 SAP SE. All rights reserved
    
 */
sap.ui.define(["sap/base/Log","./Element","./Ellipse","./Rectangle","./Line","./Polyline","./Path","./Text","../View","../totara/TotaraUtils"],function(L,E,a,R,b,P,c,T,V,d){"use strict";var S=function(r,e,h,i){this._sceneIdTreeNodesMap=new Map();this._sceneIdRootNodeMap=new Map();this._materialMap=new Map();this._materialNodesMap=new Map();this._nodes=new Map();this._views=new Map();this._geometries=new Map();this._geometryMeshes=new Map();this._meshNodes=new Map();this._meshSubmeshes=new Map();};S.prototype.setRootNode=function(r,n,s,v){this._rootNode=r;this._nodes.set(n,r);if(s){this._sceneIdTreeNodesMap.set(s,this._nodes);this._sceneIdRootNodeMap.set(s,r);this._currentSceneId=s;}if(v){this._vkScene=v;}return this;};S.prototype.setNodePersistentId=function(n,e,s){this._resetCurrentScene(s);n.sid=e;this._nodes.set(e,n);return true;};S.prototype.cleanup=function(){this._rootNode=null;this._currentSceneId=null;if(this._nodes){this._nodes.clear();}if(this._viewGroups){this._viewGroups.clear();}if(this._views){this._views.clear();}this._materialMap.clear();this._materialNodesMap.clear();this._sceneIdTreeNodesMap.clear();this._sceneIdRootNodeMap.clear();};S.prototype.getNode=function(n,s){if(s){this._resetCurrentScene(s);if(this._nodes){return this._nodes.get(n);}}else{var e=this._sceneIdTreeNodesMap.values();var h=e.next();while(!h.done){var i=h.value.get(n);if(i){return i;}h=e.next();}}return null;};S.prototype._resetCurrentScene=function(s){if(s&&s!==this._currentSceneId){var n=this._sceneIdTreeNodesMap.get(s);if(n){this._nodes=n;}else{this._nodes=new Map();}var e=this._sceneIdRootNodeMap.get(s);if(e){this._rootNode=e;}else{this._rootNode=null;}this._currentSceneId=s;}};S.prototype.createCamera=function(e,s){this._resetCurrentScene(s);return null;};S.prototype.getCamera=function(e){return null;};S.prototype.hasMesh=function(m){return this._meshSubmeshes.has(m);};function f(l){if(Array.isArray(l)){for(var i=0;i<l.length;i++){if(l[i].type===undefined||l[i].type==="mesh"||l[i].type==="line"){return l[i];}}}return null;}S.prototype.insertSubmesh=function(s){if(!s.lods){return false;}var l=f(s.lods);if(!l){return false;}s.boundingBox=l.boundingBox;var e=this._geometries.get(l.id);if(e){var n=this._meshNodes.get(s.meshId);if(n){for(var h=0;h<n.length;h++){this._addGeometryToNode(n[h],e,s);}}}else{d.pushElementIntoMapArray(this._geometryMeshes,l.id,s);}d.pushElementIntoMapArray(this._meshSubmeshes,s.meshId,s);};S.prototype.insertViewGroup=function(i,s){return this;};S.prototype.insertView=function(v,s){this._resetCurrentScene(s);var e=new V();e.setViewId(v.viewId);e.setName(v.name);e.userData={viewInfo:v};this._views.set(v.viewId,e);return this;};S.prototype.getView=function(v,s){this._resetCurrentScene(s);return this._views.get(v);};S.prototype.setViewCamera=function(e,v,s){return this;};S.prototype.getChildNodeIds=function(n,s,e){this._resetCurrentScene(s);var h=this._nodes.get(n);var j=[];if(!h){return j;}if(h&&h.children){for(var i=0;i<h.children.length;i++){var k=h.children[i];if(k.userData.treeNode&&k.userData.treeNode.sid){j.push(k.userData.treeNode.sid);}else if(e&&k.userData.submeshInfo&&k.userData.submeshInfo.id){j.push(k.userData.submeshInfo.id);}}}return j;};S.prototype.setViewNodeInfos=function(n,v,s){this._resetCurrentScene(s);var e=this._views.get(v);e.setNodeInfos(n);return this;};S.prototype.finalizeViewGroups=function(s){return this;};S.prototype.setVoxelThreshold=function(v){return this;};S.prototype.getVoxelThreshold=function(){return 0.0;};S.prototype.createNode=function(n,s){this._resetCurrentScene(s);var t=n.transform;var e=new E({sid:n.sid,name:n.name,matrix:t?[t[0],t[2],t[6],t[8],t[9],t[11]]:undefined});this._nodes.set(n.sid,e);if(n.parametricId){e.userData.parametricId=n.parametricId;}else if(n.meshId){this._setMeshNode(e,n.meshId);}e.userData.treeNode=n;e.setVisible(1,n.visible?n.visible:true);if(n.visualisable===false){e.userData.skipIt=true;}var p=this._nodes.get(n.parentId);(p||this._rootNode).add(e);return e;};S.prototype.createAnnotation=function(e,s){};S.prototype.remove=function(n,s){this._resetCurrentScene(s);var t=this;n=[].concat(n);n.forEach(function(e){var h=t._nodes.get(e);if(h){t._nodes.delete(e);for(var i=0;i<h.children.length;i++){var j=h.children[i];if(j.userData&&j.userData.treeNode&&j.userData.treeNode.sid){t.remove(j.userData.treeNode.sid,s);}}}});return this;};S.prototype._addPolylineSegment=function(s,e,p){var h=e.length;if(h<2){return;}var j=[];var k=e[0]===e[h-1];if(k){h--;}for(var i=0,l=e.length;i<l;i++){var m=e[i]*3;j.push(p[m],p[m+2]);}s.push({type:"polyline",points:j,closed:k});};S.prototype._addGeometryToNode=function(n,e,s){var m=s.materialId;var h=this._materialMap.get(m);var j=e.data;var k=j.indices;var p=j.points;var q=new Float32Array([1,0,0,1,0,0]);if(e.isPositionQuantized&&s.boundingBox){}if(s.transform){}var i,r,t,u;var l=k.length;var v=[];if(e.isPolyline){h=Object.assign(h,{color:[0,0,0,0]});var w=[];for(i=0,r=-1;i<l;i+=2,r=u){t=k[i];u=k[i+1];if(t!==r){this._addPolylineSegment(v,w,p);w.length=0;w.push(t);}w.push(u);}this._addPolylineSegment(v,w,p);}else{h=Object.assign(h,{lineColor:[0,0,0,0],lineWidth:0});var x=[];for(i=0;i<l;i+=3){r=k[i]*3;t=k[i+1]*3;u=k[i+2]*3;x.push(p[r],p[r+2],p[t],p[t+2],p[u],p[u+2]);}v.push({type:"mesh",points:x});}var y=new c({segments:v,isTriangleMesh:!e.isPolyline,matrix:q,material:h,materialID:m,subelement:true});y.uid+="-g";n.add(y);d.pushElementIntoMapArray(this._materialNodesMap,m,y);n.rerender();};S.prototype.setGeometry=function(e){this._geometries.set(e.id,e);var h=this._geometryMeshes.get(e.id);if(h){for(var m=0;m<h.length;m++){var s=h[m];var n=this._meshNodes.get(s.meshId);if(n){for(var i=0;i<n.length;i++){this._addGeometryToNode(n[i],e,s);}}}}if(this._fireSceneUpdated){this._fireSceneUpdated();}return this;};S.prototype._setMeshNode=function(n,m){d.pushElementIntoMapArray(this._meshNodes,m,n);var s=this._meshSubmeshes.get(m);if(s){for(var i=0;i<s.length;i++){var e=s[i];var l=f(e.lods);if(l){var h=this._geometries.get(l.id);if(h){this._addGeometryToNode(n,h,e);}}}}};function g(s){var m=new Float32Array([1,0,0,1,0,0]);if(s.t){m[4]=s.t[0];m[5]=s.t[1];}if(s.r){var x=s.r[0],y=s.r[1],z=s.r[2],w=s.r[3];var e=x*y;var h=z*z;var i=w*z;m[0]=1-(y*y+h)*2;m[1]=(e+i)*2;m[2]=(e-i)*2;m[3]=1-(x*x+h)*2;}if(s.s){m[0]*=s.s[0];m[1]*=s.s[0];m[2]*=s.s[1];m[3]*=s.s[1];}return m;}function o(s){var e=[];var m;function h(){if(e.length>0){e.forEach(function(u){var p=u.points;if(p&&p.length>=4&&p[0]===p[p.length-2]&&p[1]===p[p.length-1]){u.closed=true;p.length-=2;}});s.push({type:"path",segments:e,materialID:m});e=[];}}var j;var i=0;while(i<s.length){var k=s[i];if(k.type==="line"){if(m!==k.materialID){h();m=k.materialID;}j=g(k);var x=k.x1*j[0]+k.y1*j[2]+j[4];var y=k.x1*j[1]+k.y1*j[3]+j[5];var l=k.x2*j[0]+k.y2*j[2]+j[4];var n=k.x2*j[1]+k.y2*j[3]+j[5];var p=e.length>0?e[e.length-1].points:null;if(p&&p[p.length-2]===x&&p[p.length-1]===y){p.push(l,n);}else{e.push({type:"polyline",points:[x,y,l,n]});}s.shift();}else if(k.type==="arc"){if(m!==k.materialID){h();m=k.materialID;}j=g(k);k.cx=k.cx||0;k.cy=k.cy||0;var q=k.cx*j[0]+k.cy*j[2]+j[4];var r=k.cx*j[1]+k.cy*j[3]+j[5];if(k.r){var t=Math.atan2(j[1],j[0]);k.start+=t;k.end+=t;}e.push({type:"arc",cx:q,cy:r,rx:(k.major||k.radius)*(k.s?k.s[0]:1),ry:(k.minor||k.radius)*(k.s?k.s[1]:1),start:k.start>k.end?k.start-Math.PI*2:k.start,end:k.end});s.shift();}else{i++;}}h();}S.prototype.setParametricContent=function(n,p,s){if(p==null){L.warning("Empty parametric content for node "+n);return;}this._resetCurrentScene(s);var e=this.getNode(n,this.sceneId);var h=new E({matrix:[-1,0,0,1,0,0],subelement:true});e.add(h);e=h;if(p.shapes){o(p.shapes);for(var i=0;i<p.shapes.length;i++){var j=p.shapes[i];j.matrix=g(j);j.subelement=true;var k=this._createObject(j);if(k){k.uid+="-s";e.add(k);if(j.materialID){d.pushElementIntoMapArray(this._materialNodesMap,j.materialID,k);}}}e.uid+="-p";e.rerender();}else{p.sid=n;p.name=e.name;p.matrix=E._multiplyMatrices(e.matrix,g(p));var l=this._createObject(p);if(l){l.uid+="-ps";l.userData=e.userData;l.vMask=e.vMask;this._nodes.set(n,l);e.parent.replace(e,l);if(p.materialID){d.pushElementIntoMapArray(this._materialNodesMap,p.materialID,l);}}}};S.prototype._createObject=function(p){if(p.materialID){p.material=this._materialMap.get(p.materialID);}switch(p.type){case"arc":case"ellipticalArc":p.segments=[{type:"arc",cx:p.cx||0,cy:p.cy||0,rx:p.major||p.radius,ry:p.minor||p.radius,start:p.start>p.end?p.start-Math.PI*2:p.start,end:p.end}];return new c(p);case"rectangle":return new R(p);case"line":return new b(p);case"polyline":return new P(p);case"ellipse":case"circle":return new a(p);case"text":return new T(p);case"path":return new c(p);default:L.warning("Unsupported parametric type",p.type);return null;}};S.prototype.createMaterial=function(m){var e=m.id;var h=this._materialMap.get(e);if(!h){h=this._createTemporaryMaterial(e);}h.lineColor=m.lineColour;h.lineWidth=m.lineWidth||0;h.lineStyle={width:m.lineWidth||0,haloWidth:m.lineHaloWidth||0,endCapStyle:m.lineEndRound?1:0,dashPattern:m.lineDashPattern||[],dashPatternScale:m.lineDashPatternScale,widthCoordinateSpace:m.lineWidthCoordinateSpace};if(m.emissiveColour){h.color=m.emissiveColour;}if(h.opacity!==undefined){h.opacity=m.opacity;}var n=this._materialNodesMap.get(e);if(n){for(var j=0;j<n.length;j++){n[j].setMaterial(h,true);}}return[];};S.prototype._createTemporaryMaterial=function(m){var e={materialId:m};this._materialMap.set(m,e);return e;};S.prototype.checkMaterialExists=function(m,t){if(this._materialMap.get(m)==null){if(t){this._createTemporaryMaterial(m);}return false;}return true;};return S;});
