/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)

        (c) Copyright 2009-2015 SAP SE. All rights reserved
    
 */
sap.ui.define(["jquery.sap.global","../thirdparty/three","sap/base/Log","./BBoxSubdivider","./UsageCounter","../totara/TotaraUtils","./OrthographicCamera","./PerspectiveCamera","./DetailView","./AnimationHelper","./Thrustline","../View","./Billboard","./Callout","../BillboardCoordinateSpace","../BillboardTextEncoding","../BillboardStyle","../BillboardBorderLineStyle","../BillboardHorizontalAlignment","../LeaderLineMarkStyle","../DetailViewType","../DetailViewShape","../AnimationPlayback","../AnimationRotateType","../RenderMode","./Material","../ObjectType","../getResourceBundle","./MarchingCubes","./ParametricGenerators","../NodeContentType","./ThreeExtensions","../thirdparty/ie-polyfills","sap/base/util/uid"],function(q,t,L,B,U,T,O,P,D,A,a,V,b,C,c,d,f,g,h,n,o,p,r,s,R,M,u,v,w,x,N,y,z,E){"use strict";var S=function(e,i,j,k){this._id=S._nextId++;S._add(this);this._callouts=new Map();this._cameras=new Map();this._images=new Map();this._imageIdsAndTileWidths=new Map();this._imageTextures=new Map();this._geometries=new Map();this._meshNodes=new Map();this._meshSubmeshes=new Map();this._geometryMeshes=new Map();this._materialMeshes=new Map();this._materialClones=new Map();this._joints=[];this._annotations=new Map();if(e){this._rootNode=e;this._nodes=new Map();this._tracks=new Map();this._trackIdSequenceNodeMap=new Map();this._viewGroups=new Map();this._views=new Map();}else{this._rootNode=null;this._nodes=null;this._tracks=null;this._trackIdSequenceNodeMap=null;this._viewGroups=null;this._views=null;}this._currentSceneId=null;this._sceneIdTreeNodesMap=new Map();this._sceneIdRootNodeMap=new Map();this._sceneIdViewGroupMap=new Map();this._sceneIdViewMap=new Map();this._animationHelper=new A(this);if(i){this._countentResource=i;var l=i.getNodeProxy();var m=l.getNodeHierarchy();this._vkScene=m.getScene();var m1=i.getSource();if(m1&&m1.name){this._sceneIdTreeNodesMap.set(m1.name,this._nodes);this._sceneIdRootNodeMap.set(m1.name,e);this._sceneIdViewGroupMap.set(m1.name,this._viewGroups);this._sceneIdViewMap.set(m1.name,this._views);this._currentSceneId=m1.name;}if(this._rootNode){if(!this._rootNode.userData){this._rootNode.userData={};}this._rootNode.userData.skipIt=!i.name;}}this._viewThumbnails=new Map();this._thrustlines=new Map();this._animations=new Map();this._animationTracks=new Map();this._jointNodesMap=new Map();this._jointParentsMap=new Map();this._resolve=j;this._reject=k;this._voxelThreshold=0.0;};S._nextId=1;S._map=new Map();S.prototype.getId=function(){return this._id;};S.getById=function(i){return this._map.get(i);};S.prototype.getVoxelThreshold=function(){return this._voxelThreshold;};S.prototype.setVoxelThreshold=function(e){this._voxelThreshold=e;return this;};S._add=function(e){S._map.set(e.getId(),e);return this;};var F=[R.Default,R.Default,R.Default,R.LineIllustration,R.SolidOutline,R.ShadedIllustration];S.prototype.setScene=function(i){if(i.result!==1){var e={status:i.result};switch(i.result){case-1:e.errorText=v().getText("LOADER_FILENOTFOUND");break;case-2:e.errorText=v().getText("LOADER_WRONGFILEFORMAT");break;case-3:e.errorText=v().getText("LOADER_WRONGPASSWORD");break;case-4:e.errorText=v().getText("LOADER_ERRORREADINGFILE");break;case-5:e.errorText=v().getText("LOADER_FILECONTENT");break;default:e.errorText=v().getText("LOADER_UNKNOWNERROR");}this._reject(e);}else{this._vkScene.setSceneBuilder(this);var j=this._cameras.get(i.cameraId);this._resolve({node:this._parentNode,camera:j,backgroundTopColor:i.backgroundTopColor,backgroundBottomColor:i.backgroundBottomColor,upAxis:i.upAxis,annotations:this._annotations,contentResource:this._contentResource,builder:this});}};S.prototype.setRootNode=function(e,i,j,k){this._rootNode=e;this._nodes=new Map();this._nodes.set(i,e);if(!this._rootNode.userData){this._rootNode.userData={};}this._tracks=new Map();this._trackIdSequenceNodeMap=new Map();this._sequenceIdToPlaybacks=new Map();this._viewGroups=new Map();this._views=new Map();if(j){this._sceneIdTreeNodesMap.set(j,this._nodes);this._sceneIdRootNodeMap.set(j,e);this._sceneIdViewGroupMap.set(j,this._viewGroups);this._sceneIdViewMap.set(j,this._views);this._currentSceneId=j;}if(k){this._vkScene=k;}return this;};S.prototype._resetCurrentScene=function(e){if(e&&e!==this._currentSceneId){var i=this._sceneIdTreeNodesMap.get(e);if(i){this._nodes=i;}else{this._nodes=null;}var j=this._sceneIdRootNodeMap.get(e);if(j){this._rootNode=j;}else{this._rootNode=null;}this._currentSceneId=e;}};S.prototype.getNode=function(e,i){if(i){this._resetCurrentScene(i);if(this._nodes){return this._nodes.get(e);}}else{var j=this._sceneIdTreeNodesMap.values();var k=j.next();while(!k.done){var l=k.value.get(e);if(l){return l;}k=j.next();}}return null;};S.prototype.hasMesh=function(m){return this._meshSubmeshes.has(m);};S.prototype.hasImage=function(i){return this._images.has(i);};S.prototype.setNodePersistentId=function(e,i,j){if(!e.userData.treeNode){e.userData.treeNode={};}var k=null;if(e.userData.treeNode.sid){k=e.userData.treeNode.sid;delete(e.userData.treeNode.sid);}this._resetCurrentScene(j);e.userData.treeNode.sid=i;if(this._nodes){if(k){this._nodes.delete(k);}this._nodes.set(i,e);return true;}return false;};S.prototype.setAnnotationPersistentId=function(e,i,j){this._resetCurrentScene(j);if(this._annotations){var k=this._annotations.get(e.id);if(k){this._annotations.delete(e.id);k.annotation.id=i;this._annotations.set(i,k);return true;}}return false;};var G=function(e){var m=new THREE.Matrix4();if(e.length===3){m.setPosition(new THREE.Vector3().fromArray(e));}else if(e.length===12){m.set(e[0],e[3],e[6],e[9],e[1],e[4],e[7],e[10],e[2],e[5],e[8],e[11],0.0,0.0,0.0,1.0);}else if(e.length===16){m.set(e[0],e[4],e[8],e[12],e[1],e[5],e[9],e[13],e[2],e[6],e[10],e[14],e[3],e[7],e[11],e[15]);}else{throw"Invalid matrix format";}return m;};var H={r:0.0235,g:0.0235,b:0.0235};var I={r:0.0602,g:0.0602,b:0.0602};S.prototype._createTemporaryMaterial=function(m){var e=new M();var i=e.getMaterialRef();i.userData.defaultHighlightingEmissive=H;i.userData.defaultHighlightingSpecular=I;i.userData.materialUsed=0;i.userData.materialId=m;i.userData.toBeUpdated=true;this._vkScene.setMaterial(m,e);return i;};S.prototype._getMaterialRef=function(m){var e=this._vkScene.getMaterial(m);return e?e.getMaterialRef():null;};S.prototype.checkMaterialExists=function(m,e){if(this._getMaterialRef(m)===null){if(e){this._createTemporaryMaterial(m);}return false;}return true;};S.prototype._attachMaterialClone=function(m,e){T.pushElementIntoMapArray(this._materialClones,m,e);};S.prototype._addDynamicObject=function(e,i,j){var k=this._rootNode.userData;if(!k._vkDynamicObjects){k._vkDynamicObjects=[];}if(k._vkDynamicObjects.indexOf(e)<0){k._vkDynamicObjects.push(e);}e._vkUpdate=i;if(j){e.userData.is2D=true;}};S.prototype.createNode=function(e,j){this._resetCurrentScene(j);var k=new THREE.Group();this._nodes.set(e.sid,k);var i;var l=this._jointNodesMap.get(e.sid);if(l&&l.length){for(i=0;i<l.length;i++){l[i].node=k;}}var m=this._jointParentsMap.get(e.sid);if(m&&m.length){for(i=0;i<m.length;i++){m[i].parent=k;}}var m1=this._nodes.get(e.parentId);(m1||this._rootNode).add(k);var n1=k.userData;n1.treeNode=e;if(e.closed){n1.closed=true;}if(e.selectable===false){n1.selectable=false;}if(e.visualisable===false){n1.skipIt=true;}if(e.metadata){n1.metadata=e.metadata;}if(e.veids){n1.veids=e.veids;}if(e.sid){n1.nodeId=e.sid;}if(e.name){k.name=e.name;}if(e.visible!==undefined){k.layers.mask=e.visible?(1|0):0;}if(m1&&m1.name&&k.name&&k.name===m1.name+" offset geometry"){k.layers=m1.layers;}else{var o1=m1;while(o1){if(o1.userData.closed){k.layers=o1.layers;break;}o1=o1.parent;}}if(j){var p1=m1;while(p1){if((p1.layers.mask&1)===0){k.layers.mask&=~1;break;}p1=p1.parent;}}if(e.renderOrder){k.renderOrder=e.renderOrder;}n1.opacity=e.opacity;if(e.transform){k.applyMatrix(G(e.transform));if(!isFinite(k.quaternion.x)||!isFinite(k.quaternion.y)||!isFinite(k.quaternion.z)||!isFinite(k.quaternion.w)){k.quaternion.set(0,0,0,1);}}k.updateMatrixWorld(true);if(e.transformType){n1.transformType=e.transformType;switch(e.transformType){case"ORTHO2D":n1.originalTransform={p:k.position.clone(),q:k.quaternion.clone(),s:k.scale.clone()};this._addDynamicObject(k,b.prototype._ortho2DUpdate,true);break;case"BILLBOARD_VIEW":this._addDynamicObject(k,b.prototype._billboardViewUpdate,false);break;case"LOCK_TOVIEWPORT":this._addDynamicObject(k,b.prototype._lockToViewportUpdate,true);break;default:break;}}if(e.materialId){n1.materialId=e.materialId;}if(e.meshId){this.setMeshNode(e.sid,e.meshId);}if(e.parametricId){this.setParametricNode(e.sid,e.parametricId,e.visible);}if(k.parent.userData.objectType===u.Hotspot){n1.objectType=u.Hotspot;}else if(k.parent.userData.objectType===u.PMI){n1.objectType=u.PMI;}else if(e.contentType==="HOTSPOT"){n1.objectType=u.Hotspot;}else if(e.contentType==="PMI"){n1.objectType=u.PMI;}if(e.contentType==="REFERENCE"){k._vkSetNodeContentType(N.Reference);}else if(e.contentType==="ANNOTATION"){k._vkSetNodeContentType(N.Annotation);}else if(e.contentType==="BACKGROUND"){k._vkSetNodeContentType(N.Background);}else if(e.contentType==="SYMBOL"){k._vkSetNodeContentType(N.Symbol);}return k;};S.prototype.removeNode=function(e){this._nodes.delete(e._vkPersistentId());this._annotations.forEach(function(i){if(i.node===e){this._annotations.delete(i.annotation.id);}}.bind(this));};function J(e,m,l){var i;if(e.isPolyline){var j=new THREE.LineBasicMaterial({color:0xff0000,linewidth:1});if(m){j.color.copy(m.color);}i=new THREE.LineSegments(e,j);}else{i=new THREE.Mesh(e,m);}if(e.isPositionQuantized){W(i,l.boundingBox);}U.increaseGeometryUsed(e);return i;}S.prototype.getChildNodeIds=function(e,j,k){this._resetCurrentScene(j);var l=this._nodes.get(e);var m=[];if(!l){return m;}if(l&&l.children){for(var i=0;i<l.children.length;i++){var m1=l.children[i];if(m1.userData.treeNode&&m1.userData.treeNode.sid){m.push(m1.userData.treeNode.sid);}else if(k&&m1.userData.submeshInfo&&m1.userData.submeshInfo.id){m.push(m1.userData.submeshInfo.id);}}}return m;};function K(l){for(var i=0;i<l.length;i++){if(l[i].type==="box"&&l[i].data){return l[i];}}return null;}function Q(l){if(Array.isArray(l)){for(var i=0;i<l.length;i++){if(l[i].type===undefined||l[i].type==="mesh"||l[i].type==="line"){return l[i];}}}return null;}function W(m,e){if(e&&e.length===6){m.position.set((e[3]+e[0])*0.5,(e[4]+e[1])*0.5,(e[5]+e[2])*0.5);m.scale.set(Math.max(e[3]-e[0],Number.EPSILON),Math.max(e[4]-e[1],Number.EPSILON),Math.max(e[5]-e[2],Number.EPSILON));m.updateMatrix();}}S.prototype.insertSubmesh=function(e,i){var m=this._getMaterialRef(e.materialId)||this._createTemporaryMaterial(e.materialId);var j,k;if(e.lods){var l=Q(e.lods);if(!l){return false;}k=this._geometries.get(l.id);if(k){j=J(k,m,l);if(k.userData&&k.userData.noNormal&&e.materialId){this.updateMaterialForGeometryWithoutNormal(e.materialId);}}else{var m1=true;var n1=l.boundingBox;if(n1&&i){var o1=(n1[3]-n1[0])/(i[3]-i[0]);var p1=(n1[4]-n1[1])/(i[4]-i[1]);var q1=(n1[5]-n1[2])/(i[5]-i[2]);m1=o1>this._voxelThreshold||p1>this._voxelThreshold||q1>this._voxelThreshold;}var r1;var s1=m1&&K(e.lods);if(s1&&s1.data){var t1=T.base64ToUint8Array(s1.data);var u1=B.unpackSubDividedBoundingBox(t1);r1=w.march(u1);}j=new THREE.Mesh(r1?r1:new THREE.BoxBufferGeometry(1,1,1),m);if(n1&&n1.length===6){var v1=new THREE.Matrix4();v1.scale(new THREE.Vector3(Math.max(n1[3]-n1[0],Number.EPSILON),Math.max(n1[4]-n1[1],Number.EPSILON),Math.max(n1[5]-n1[2],Number.EPSILON)));v1.setPosition(new THREE.Vector3((n1[3]+n1[0])*0.5,(n1[4]+n1[1])*0.5,(n1[5]+n1[2])*0.5));j.geometry.applyMatrix(v1);}j.userData.geometryId=l.id;j.userData.lodInfo=l;T.pushElementIntoMapArray(this._geometryMeshes,l.id,e.meshId);}}else{return false;}if(e.transform){j.applyMatrix(G(e.transform));}j.updateMatrixWorld(true);j.userData.submeshId=e.id;j.userData.initialMaterialId=e.materialId;j.userData.meshId=e.meshId;j.userData.materialId=e.materialId;j.userData.submeshInfo=e;T.pushElementIntoMapArray(this._materialMeshes,e.materialId,e.meshId);T.pushElementIntoMapArray(this._meshSubmeshes,e.meshId,j);var w1=this._meshNodes.get(e.meshId);if(w1){w1.forEach(function(x1){var y1=j.clone();if(x1.userData.transformType==="ORTHO2D"){y1.position.setScalar(0);y1.scale.setScalar(1);}y1.layers=x1.layers;if(x1.userData.materialId){y1.material=this._getMaterialRef(x1.userData.materialId)||j.material;if(!y1.userData){y1.userData={};}y1.userData.materialId=x1.userData.materialId;}x1.add(y1);y1.updateMatrixWorld(true);Y(x1,e.materialId,this._materialClones);}.bind(this));}return true;};function X(e,j,k,m){for(var i=0;i<e.length;i++){var l=e[i];if(j&&l.userData.geometryId===j&&l.geometry!==k){if(l.type==="Mesh"&&!k.isPolyline){l.geometry=k;if(k.isPositionQuantized&&!(l.parent&&l.parent.userData.transformType==="ORTHO2D")){W(l,l.userData.lodInfo.boundingBox);}l.updateMatrixWorld(true);U.increaseGeometryUsed(k);}else{var m1=J(k,l.material,l.userData.lodInfo);m1.userData=l.userData;m1.layers=l.layers;m1.parent=l.parent;e[i]=m1;m1.updateMatrixWorld(true);l.parent=null;}}}}S.prototype._setSubmeshMaterial=function(e,m,i){U.increaseMaterialUsed(m);e.material=m;e.userData.materialId=i;delete e.userData.originalMaterial;e._vkUpdateMaterialOpacity();if(e.material!==m){T.pushElementIntoMapArray(this._materialClones,i,e.material);}};S.prototype._updateMaterial=function(e,m,i){e.children.forEach(function(j){if(j.material&&j.userData.materialId===m){this._setSubmeshMaterial(j,i,m);}}.bind(this));};function Y(e,m,i){e.children.forEach(function(j){if(j.material&&(!m||m===j.material.userData.materialId)){var k=j.material;j._vkUpdateMaterialOpacity();if(j.material!==k){T.pushElementIntoMapArray(i,j.material.userData.materialId,j.material);}}});}function Z(e,l){var m=new Float32Array(e.length);var p0=new THREE.Vector3();var p1=new THREE.Vector3();var p2=new THREE.Vector3();var m1=new THREE.Vector3();var i,n1;for(i=0,n1=l.length;i<n1;i+=3){var pi=[l[i]*3,l[i+1]*3,l[i+2]*3];p0.fromArray(e,pi[0]);p1.fromArray(e,pi[1]).sub(p0);p2.fromArray(e,pi[2]).sub(p0);m1.crossVectors(p1,p2).normalize();for(var j=0;j<3;j++){var k=pi[j];m[k]+=m1.x;m[k+1]+=m1.y;m[k+2]+=m1.z;}}for(i=0,n1=m.length;i<n1;i+=3){m1.fromArray(m,i).normalize().toArray(m,i);}return m;}S.prototype.setGeometry=function(e){var i=new THREE.BufferGeometry();var j=e.data;var k=new THREE.BufferAttribute(new Uint16Array(j.indices),1);var l=new THREE.BufferAttribute(new Float32Array(j.points),3);i.setIndex(k);i.setAttribute("position",l);if(!e.isPolyline){if(!j.normals||j.normals.length!==l.array){j.normals=Z(l.array,k.array);}var m=new THREE.BufferAttribute(new Float32Array(j.normals),3);i.setAttribute("normal",m);if(j.uvs&&j.uvs.length*3===j.points.length*2){i.setAttribute("uv",new THREE.BufferAttribute(new Float32Array(e.data.uvs),2));}}else{i.isPolyline=true;}i.computeBoundingBox();i.computeBoundingSphere();i.isPositionQuantized=e.isPositionQuantized;i.userData.geometryId=e.id;i.userData.geometryUsed=0;this._geometries.set(e.id,i);var m1=this._geometryMeshes.get(e.id);if(m1){for(var mi=0;mi<m1.length;mi++){var o1=m1[mi];var p1=this._meshNodes.get(o1);if(p1){for(var ni=0;ni<p1.length;ni++){X(p1[ni].children,e.id,i);}}var r1=this._meshSubmeshes.get(o1);if(r1){X(r1,e.id,i);}}}if(this._fireSceneUpdated){this._fireSceneUpdated();}return this;};S.prototype.setMeshNode=function(e,m){var i=this._nodes.get(e);if(i){T.pushElementIntoMapArray(this._meshNodes,m,i);var j=this._meshSubmeshes.get(m);if(j){j.forEach(function(k){var l=k.clone();if(i.userData.transformType==="ORTHO2D"){l.position.setScalar(0);l.scale.setScalar(1);}l.layers=i.layers;if(i.userData.materialId){l.material=this._getMaterialRef(i.userData.materialId)||k.material;if(!l.userData){l.userData={};}l.userData.materialId=i.userData.materialId;}i.add(l);}.bind(this));Y(i,null,this._materialClones);}}};S.prototype.setParametricNode=function(e,i,j){var k=this._nodes.get(e);if(k){k.userData.parametricVisible=j!==undefined?j:true;}};S.prototype.progress=function(e){L.log("reading progress:",e);};S.prototype.loadingFinished=function(i){if(this._fireLoadingFinished){this._fireLoadingFinished(i);}};S.prototype.getGeometry=function(e){return this._geometries.get(e);};var $={rect:f.RectangularShape,circle:f.CircularShape,none:f.None,textGlow:f.TextGlow};var _={none:g.None,solid:g.Solid,dash:g.Dash,dot:g.Dot,dashdot:g.DashDot,dashdotdot:g.DashDotDot};var a1={left:h.Left,center:h.Center,right:h.Right};var b1={none:n.None,point:n.Point,arrow:n.Arrow};var c1=new THREE.Color();S.prototype.createAnnotation=function(e,i){this._resetCurrentScene(i);var j=this._nodes.get(e.nodeId);if(!j){L.warning("Annotation node not found",e);return;}var k=j.userData.originalTransform;if(k){j.position.copy(k.p);j.scale.copy(k.s);}var l=e.type;if(l===undefined){this.createLegacyAnnotation(e,j);return;}if(l==="html"){e.id=e.id||E();var m=[];if(e.leaderLines){e.leaderLines.forEach(function(v1){if(v1.start&&v1.start.sid){m.push(this._nodes.get(v1.start.sid));}},this);}this._annotations.set(e.id,{annotation:e,node:j,attachment:(e.attachment&&e.attachment.sid)?this._nodes.get(e.attachment.sid):null,targetNodes:m});return;}var m1=e.label||{};var n1=e.text||{};var o1=m1.colour||[1,1,1,1];var p1=m1.borderColour||[0,0,0,1];var q1={node:j,renderOrder:j.renderOrder||0,style:$[m1.shape]||f.RectangularShape,width:m1.width||64,height:m1.height||64,backgroundColor:c1.fromArray(o1).getStyle(),backgroundOpacity:o1[3],borderColor:c1.fromArray(p1).getStyle(),borderOpacity:p1[3],borderWidth:m1.borderColour?(m1.borderWidth||0):0,borderLineStyle:_[m1.borderLineStyle]||g.Solid,horizontalAlignment:a1[n1.align]};if(n1.html){q1.encoding=d.HtmlText;q1.text=n1.html;}else{q1.encoding=d.PlainText;q1.text=n1.text;q1.font=n1.fontFace||"Arial";q1.fontSize=Math.abs(n1.fontSize)||16;q1.fontWeight=Math.min(n1.fontWeight,900);q1.fontItalic=n1.fontItalic;q1.textColor=c1.fromArray(n1.colour||[0,0,0]).getStyle();}if(l==="text"){var r1=j.position;q1.position=new THREE.Vector3(r1.x*2,r1.y*2,r1.z);var s1=new b(q1);s1.setText(q1.text);this._addDynamicObject(j,s1._update.bind(s1),true);}else if(l==="note"){var t1=e.attachment||{};q1.position=new THREE.Vector3().fromArray(t1.position||[0,0,0]);q1.anchorNode=this._nodes.get(t1.sid)||this._rootNode;q1.depthTest=false;var u1=new C(q1);u1.setText(q1.text);this._callouts.set(e.id,u1);this._addDynamicObject(j,u1._update.bind(u1),false);}else{L.warning("Unsupported annotation type",e);}};var d1=[f.RectangularShape,f.CircularShape,f.None,f.TextGlow];var e1=[c.Viewport,c.Screen,c.World];var f1=[g.None,g.Solid,g.Dash,g.Dot,g.DashDot,g.DashDotDot];var g1=[n.None,n.Point,n.Arrow];var h1=[h.Left,h.Center,h.Right];function i1(e){var i=e.toString(16);if(e.length>=3){i=(((e[0]*255)<<16)|((e[1]*255)<<8)|(e[2]*255)).toString(16);}return"#"+"000000".substring(i.length)+i;}function j1(e){if(!e){return false;}for(var i=0,l=e.length;i<l;i++){if(!isFinite(e[i])){return false;}}return true;}S.prototype.createLegacyAnnotation=function(e,i){var j=e.position;if(!j1(j)){L.warning("Incorrect annotation position",e);return;}e.coordinateSpace|=0;var k=e.backgroundOpacity;if(!k){k=e.backgroundColour?e.backgroundColour[3]:0;}var l=e.borderOpacity;if(!l){l=e.borderColour?e.borderColour[3]:0;}var m={node:i,coordinateSpace:e1[e.coordinateSpace],style:d1[e.shape||0],width:e.width,height:e.height,backgroundColor:e.backgroundColour?i1(e.backgroundColour):"#fff",backgroundOpacity:k,borderColor:e.borderColour?i1(e.borderColour):"#000",borderOpacity:l,borderWidth:e.borderWidth,borderLineStyle:f1[e.borderLineStyle]};if(e.encoding!==undefined){m.encoding=e.encoding?d.HtmlText:d.PlainText;m.font=e.font;m.fontSize=e.fontSize;m.fontWeight=Math.min(e.fontWeight,900);m.fontItalic=e.fontItalic;m.textColor=i1(e.textColor);m.link=e.link;m.horizontalAlignment=h1[e.textHorizontalAlignment];m.position=new THREE.Vector3().fromArray(j);}else if(e.fontFace){m.encoding=d.PlainText;m.font=e.fontFace;m.fontSize=Math.abs(e.fontSize);m.fontWeight=Math.min(e.fontWeight,900);m.textColor=i1(e.textColour);}else{m.encoding=d.HtmlText;}if(e.coordinateSpace<2){if(!m.positions){m.position=new THREE.Vector3(j[0]*2-1,j[1]*-2+1,j[2]);}m.renderOrder=(e.order|0)+1000;var m1=new b(m);m1.setText(e.text);this._addDynamicObject(i,m1._update.bind(m1),true);}else{m.anchorNode=this._nodes.get(e.sid)||this._rootNode;if(!m.postion){m.position=new THREE.Vector3().fromArray(j);}m.depthTest=false;m.renderOrder=e.order|0;if(e.alwaysOnTop){m.renderOrder=1;}var n1=new C(m);n1.setText(e.text);this._callouts.set(e.id,n1);this._addDynamicObject(i,n1._update.bind(n1),false);}};S.prototype.createImageNote=function(e,i){this._resetCurrentScene(i);var j=this._nodes.get(e.nodeId);if(!j){L.warning("Image annotation node not found",e);return;}var k=j.userData.originalTransform;if(k){j.position.copy(k.p);j.scale.copy(k.s);}if(e.type==="image"){var l=e.label||{};var m=this._getMaterialRef(l.materialId);if(!m){L.warning("Image annotation material not found",e);return;}var m1=new b({node:j,renderOrder:j.renderOrder||0,coordinateSpace:c.Screen,position:new THREE.Vector3(j.position.x,j.position.y,0),width:(l.width||200)*j.scale.x*0.5,height:(l.height||200)*j.scale.y*0.5});m1.setMaterial(m);if(j.userData.transformType!=="BILLBOARD_VIEW"){j.position.setScalar(0);j.scale.setScalar(1);this._addDynamicObject(j,m1._update.bind(m1),true);}}else{this.createLegacyImageNote(e,j);}};S.prototype.createLegacyImageNote=function(e,i){var j=new THREE.Vector3().fromArray(e.position);var k=e.width;var l=e.height;if(!e.properlyAligned){j.x+=e.width*0.5;j.y+=e.height*0.5;j.applyMatrix4(i.matrix);k=e.width*0.5*i.matrix.elements[0];l=e.height*0.5*i.matrix.elements[5];}var m=new b({node:i,coordinateSpace:c.Screen,renderOrder:(e.order|0)+1000,position:j,width:k,height:l});var m1=this._getMaterialRef(e.labelMaterialId);m.setMaterial(m1);this._addDynamicObject(i,m._update.bind(m),true);};S.prototype.insertLeaderLine=function(e,j){this._resetCurrentScene(j);var k=this._callouts.get(e.annotationId);if(k){var m=this._getMaterialRef(e.materialId);if(!m){L.warning("Leader line material not found",e);return;}var m1=[];var n1=e.points;for(var i=0,l=n1.length;i<l;i++){m1.push(new THREE.Vector3().fromArray(n1[i]));}var o1;if(e.start){var p1=e.start||{};var q1=e.end||{};var r1=e.extension||{};o1=this._nodes.get(e.start.sid)||this._rootNode;k.addLeaderLine(m1,o1,m,b1[p1.style]||n.None,b1[q1.style]||n.None,p1.size,r1.length||0);}else{o1=this._nodes.get(e.startPointSid)||this._rootNode;k.addLeaderLine(m1,o1,m,g1[e.startPointHeadStyle],g1[e.endPointHeadStyle],e.pointHeadConstant,e.extensionLength);}}};S.prototype._findDetailViewNodes=function(e){var i=[];if(e){e.forEach(function(j){var k=this._nodes.get(j);if(k){i.push(k);}else{L.warning("Unknown detailView node reference",j);}}.bind(this));}return i;};S.prototype.createDetailView=function(i,e){this._resetCurrentScene(e);var j=this._nodes.get(i.nodeId);if(!j){L.warning("Detail view node not found",i);return;}var l=i.label;if(!l){this.createLegacyDetailView(i,j);return;}var k=i.attachment;var m={name:i.name,camera:l.camera?this.createCamera(l.camera):null,type:i.cutaway?o.Cutaway:o.DetailView,borderWidth:l.borderWidth||0,backgroundColor:c1.fromArray(l.colour||[1,1,1]).getStyle(),borderColor:c1.fromArray(l.borderColour||[1,1,1]).getStyle(),origin:new THREE.Vector2(j.position.x*2-1+j.scale.x,j.position.y*-2+1-j.scale.x),size:new THREE.Vector2(j.scale.x,j.scale.y),attachmentPoint:new THREE.Vector3().fromArray(k.position||[0,0,0]),veId:i.veid,visibleNodes:this._findDetailViewNodes(i.visibleNodes),targetNodes:this._findDetailViewNodes(i.targetNodes)};if(l.shape==="rect"){m.shape=!l.leaderStyle||l.leaderStyle==="none"?p.Box:p.BoxLine;}else{m.shape={none:p.Circle,line:p.CircleLine,pointer:p.CirclePointer,arrow:p.CircleArrow,bubbles:p.CircleBubbles}[l.leaderStyle]||p.Circle;}var m1=new D(m);if(!this._rootNode.userData._vkDetailViews){this._rootNode.userData._vkDetailViews=[];}this._rootNode.userData._vkDetailViews.push({detailView:m1,node:j,renderOrder:i.renderOrder||j.renderOrder||0});};S.prototype.createLegacyDetailView=function(i,e){if(!i.properlyAligned){if(!i.shape){i.shape=i.leaderStyle?p.BoxLine:p.Box;}else{i.shape=[p.Circle,p.CircleLine,p.CirclePointer,p.CircleArrow,p.CircleBubbles][i.leaderStyle||0];}i.type=i.cutaway?o.Cutaway:o.DetailView;i.camera=i.camera?this.createCamera(i.camera):null;i.origin=new THREE.Vector2(e.position.x*2-1+e.scale.x,e.position.y*-2+1-e.scale.x);i.size=new THREE.Vector2(e.scale.x,e.scale.y);i.renderOrder=e.renderOrder;}else{i.type=[o.DetailView,o.Cutaway][i.type];i.shape=[p.Box,p.Circle,p.CircleLine,p.CirclePointer,p.CircleArrow,p.CircleBubbles,p.BoxLine,p.BoxNoOutline,p.SolidPointer,p.SolidArrow][i.shape];i.camera=this._cameras.get(i.cameraId);i.origin=new THREE.Vector2().fromArray(i.origin);i.size=new THREE.Vector2().fromArray(i.size);}var j=new D({name:i.name,camera:i.camera,type:i.type,shape:i.shape,borderWidth:i.borderWidth||0,backgroundColor:i.backgroundColour?i1(i.backgroundColour):"#fff",borderColor:i.borderColour?i1(i.borderColour):"#000",origin:i.origin,size:i.size,attachmentPoint:new THREE.Vector3().fromArray(i.attachment),metadata:i.metadata,veId:i.veid,visibleNodes:this._findDetailViewNodes(i.visibleNodes),targetNodes:this._findDetailViewNodes(i.targetNodes)});if(!this._rootNode.userData._vkDetailViews){this._rootNode.userData._vkDetailViews=[];}this._rootNode.userData._vkDetailViews.push({detailView:j,node:e,renderOrder:i.renderOrder||0});};S.prototype.insertThrustline=function(i){var e=this._nodes.get(i.thrustlineId);if(e&&!this._thrustlines.get(i.thrustlineId)){var j=new a({node:e,principleAxis:new THREE.Vector3().fromArray(i.principleAxis),material:this._getMaterialRef(i.materialId)});var k=[];var l=0;var m=0;var m1=0;for(var ii=0;ii<i.itemCount;ii++){var o1={};o1.target=this._nodes.get(i.targets[ii]);o1.majorAxisIndex=i.itemMajorAxisesIndices[ii];var bi;o1.basisAxises=[];m1=l+i.itemBasisAxisesCounts[ii];for(bi=l;bi<m1;bi++){var q1={};q1.x=i.itemBasisAxisesCoordinates[bi*3];q1.y=i.itemBasisAxisesCoordinates[bi*3+1];q1.z=i.itemBasisAxisesCoordinates[bi*3+2];o1.basisAxises.push(q1);}l=m1;o1.dimension={};o1.dimension.x=i.itemDimensionsCoordinates[ii*3];o1.dimension.y=i.itemDimensionsCoordinates[ii*3+1];o1.dimension.z=i.itemDimensionsCoordinates[ii*3+2];o1.center={};o1.center.x=i.itemCentersCoordinates[ii*3];o1.center.y=i.itemCentersCoordinates[ii*3+1];o1.center.z=i.itemCentersCoordinates[ii*3+2];o1.boundPoints=[];m1=m+i.itemBoundPointsCounts[ii];for(bi=m;bi<m1;bi++){var r1={};r1.x=i.itemBoundPointsCoordinates[bi*3];r1.y=i.itemBoundPointsCoordinates[bi*3+1];r1.z=i.itemBoundPointsCoordinates[bi*3+2];o1.boundPoints.push(r1);}m=m1;k.push(o1);}j.setItems(k);var s1=0;var t1=[];for(var si=0;si<i.segmentCount;si++){var v1={};v1.startItemIndex=i.segmentsStartItemIndices[si];v1.endItemIndex=i.segmentsEndItemIndices[si];v1.startBoundIndex=i.segmentsStartBoundIndices[si];v1.endBoundIndex=i.segmentsEndBoundIndices[si];v1.ratios=[];m1=s1+i.segmentRatioCounts[si];for(var ri=0;ri<m1;ri++){var x1={};x1.x=i.segmentRatiosCoordinates[ri*2];x1.y=i.segmentRatiosCoordinates[ri*2+1];v1.ratios.push(x1);}s1=m1;t1.push(v1);}j.setSegments(t1);this._thrustlines.set(i.thrustlineId,j);this._addDynamicObject(e,j._update.bind(j),false);}};S.prototype.updateViewsForReplacedNodes=function(e){var i=new Map();e.forEach(function(l){var m=this._nodes.get(l.sid);if(m){i.set(l.sid,m);}},this);function j(l,i){var e=l.getNodeInfos();e.forEach(function(m){var m1=m.target;if(m1&&m1.userData&&m1.userData.treeNode&&m1.userData.treeNode.sid){var n1=i.get(m1.userData.treeNode.sid);if(n1){m.target=n1;n1.updateMatrixWorld();}}});}function k(l,i){var m;var m1=l.getPlaybacks();for(var pi=0;pi<m1.length;pi++){var o1=m1[pi];var p1=o1.getSequence();if(p1){var q1=false;var r1=p1.getNodeAnimation();for(var ni=0;ni<r1.length;ni++){var t1=r1[ni];var u1=t1.nodeRef;if(u1&&u1.userData&&u1.userData.treeNode&&u1.userData.treeNode.sid){m=i.get(u1.userData.treeNode.sid);if(m){p1.removeNodeAnimation(u1,null,true);for(var v1 in t1){if(v1==="nodeRef"){continue;}p1.setNodeAnimation(m,v1,t1[v1],true);}q1=true;}}}var w1=p1.getJoint();for(var ji=0;w1&&ji<w1.length;ji++){var y1=w1[ji];if(y1.parentSid){m=i.get(y1.parentSid);if(m){y1.parent=m;q1=true;}}if(y1.nodeSid){m=i.get(y1.nodeSid);if(m){y1.node=m;q1=true;}}}if(q1){p1._fireSequenceChanged();}}}e.forEach(function(n1){var s1=n1.target;if(s1&&s1.userData&&s1.userData.treeNode&&s1.userData.treeNode.sid){var m=i.get(s1.userData.treeNode.sid);if(m){n1.target=m;m.updateMatrixWorld();}}});}this._views.forEach(function(l,m){j(l,i);k(l,i);});};S.prototype._decrementResourceCounters=function(e){e.traverse(function(i){if(i.isMesh){U.decreaseMaterialUsed(i.material);U.decreaseGeometryUsed(i.geometry);}});};S.prototype.decrementResourceCountersForDeletedTreeNode=function(e,i){this._resetCurrentScene(i);var j=this;e=[].concat(e);e.forEach(function(k){var l=j._nodes.get(k);if(l){j._decrementResourceCounters(l);j._nodes.delete(k);}});return this;};S.prototype.remove=function(e,j){this._resetCurrentScene(j);var k=this;e=[].concat(e);e.forEach(function(l){var m=k._nodes.get(l);if(m){k._decrementResourceCounters(m);if(m.parent){m.parent.remove(m);}k._nodes.delete(l);for(var i=0;i<m.children.length;i++){var m1=m.children[i];if(m1.userData&&m1.userData.treeNode&&m1.userData.treeNode.sid){k.remove(m1.userData.treeNode.sid,j);}}}});return this;};S.prototype.resourcesCleanUp=function(){var e=this._geometries;e.forEach(function(i){var j=i.userData.geometryUsed;if(j<=0){i.dispose();}});return this;};S.prototype.createCamera=function(e,i){this._resetCurrentScene(i);var j=e.near||1;var k=e.far||200000;if(e.origin.length===3&&e.origin[0]===0&&e.origin[1]===0&&e.origin[2]===0){e.ortho=false;e.rotate=true;}var l;if(e.ortho){l=new THREE.OrthographicCamera(-1,1,1,-1,j,k);l.zoom=e.zoom||-1;}else{l=new THREE.PerspectiveCamera(THREE.Math.radToDeg(e.fov),1,j,k);}if(e.origin){l.position.fromArray(e.origin);}if(e.up){l.up.fromArray(e.up);if(e.notUseDirectionVector){l.up.sub(l.position);}l.up.normalize();}if(e.rotate){l.userData.rotate=e.rotate;l.up.set(0,1,0);}if(e.target){var m=new THREE.Vector3().fromArray(e.target);if(!e.notUseDirectionVector){m.add(l.position);}l.lookAt(m);}this._rootNode.userData.camera=l;var m1=null;if(l.isOrthographicCamera){m1=new O();}else if(l.isPerspectiveCamera){m1=new P();}m1.setCameraRef(l);m1.setUsingDefaultClipPlanes(true);var n1=e.id;if(n1){this._cameras.set(n1,m1);}this._rootNode.userData.camera=m1;return m1;};S.prototype.insertCamera=function(e,i,j){this._resetCurrentScene(j);var k=this._nodes.get(e);var l=this._cameras.get(i);if(k&&l){(k||this._rootNode).add(l.parent?l.clone():l);}return this;};S.prototype.getCamera=function(e){return this._cameras.get(e);};S.prototype.updateMaterialForGeometryWithoutNormal=function(m){var e=this._getMaterialRef(m);if(e&&e.emissive){e.emissive.copy(e.color);e.side=THREE.DoubleSide;}return this;};S.prototype.createMaterial=function(m){var e=[];var i=m.id;var j=this._getMaterialRef(i);if(m.lineWidth>0){if(!j||!j.isLineBasicMaterial){j=new THREE.LineBasicMaterial();var k=new M(true);k.setMaterialRef(j);this._vkScene.setMaterial(i,k);}j.color=new THREE.Color(m.lineColour[0],m.lineColour[1],m.lineColour[2]);j.linewidth=m.lineWidth;j.userData.lineStyle={width:m.lineWidth,haloWidth:m.lineHaloWidth||0,endCapStyle:m.lineEndRound?1:0,dashPattern:m.lineDashPattern||[],dashPatternScale:m.lineDashPatternScale,widthCoordinateSpace:m.lineWidthCoordinateSpace};j.userData.materialInfo=m;j.userData.materialId=i;return e;}if(!j){j=this._createTemporaryMaterial(i);}delete j.userData.toBeUpdated;j.userData.materialInfo=m;if(m.diffuseColour){j.color.fromArray(m.diffuseColour);}if(m.specularColour){j.specular.fromArray(m.specularColour);}var l=true;if(m.emissiveColour){j.emissive.fromArray(m.emissiveColour);if(j.emissive.r!==0||j.emissive.g!==0||j.emissive.b!==0){l=false;j.depthFunc=THREE.LessDepth;}}if(l&&m.ambientColour){j.emissive.fromArray(m.ambientColour);j.emissive.multiplyScalar(0.2);}if(j.opacity!==undefined){j.opacity=m.opacity;j.transparent=m.opacity<0.99;if(j.transparent){j.side=THREE.DoubleSide;}}var m1=j.glossiness?j.glossiness:0;var n1=j.specularLevel?j.specularLevel:0;j.shininess=m1*2+n1*3;j.userData.defaultHighlightingEmissive=H;j.userData.defaultHighlightingSpecular=I;e=this.updateTextureMaps(i);if(e.length>0){j.userData.imageIdsToLoad=new Set();for(var ti=0;ti<e.length;ti++){var p1=e[ti];T.pushElementIntoMapArray(this._imageTextures,p1.imageId,{textureType:p1.textureType,materialId:i});j.userData.imageIdsToLoad.add(p1.imageId);}}var q1=this._materialMeshes.get(i);if(q1){for(var mi=0;mi<q1.length;mi++){var s1=q1[mi];var t1=this._meshNodes.get(s1);if(t1){for(var ni=0;ni<t1.length;ni++){this._updateMaterial(t1[ni],i,j);}}}}return e;};S.prototype.getMaterial=function(m){return this._getMaterialRef(m);};var k1=function(i){var j="";try{var k=0x8000;var l=0;var m=i.length;var m1;while(l<m){m1=i.slice(l,Math.min(l+k,m));j+=String.fromCharCode.apply(null,m1);l+=k;}}catch(e){j="";}return j;};S.prototype.createImage=function(e){if(e.binaryData.length<32){L.warning("SceneBuilder.createImage()","Can't create image from empty data");return this;}var j=new DataView(e.binaryData.buffer);var k=true;if(j.getUint8(0,true)===parseInt("0xFF",16)&&j.getUint8(1,true)===parseInt("0xD8",16)){k=false;}var l=k1(e.binaryData);var m="data:image/"+(k?"png":"jpeg")+";base64,"+btoa(l);this._images.set(e.id,m);var m1=this._imageTextures.get(e.id);if(m1){this._imageTextures.delete(e.id);for(var i=0;i<m1.length;i++){var n1=m1[i];this.updateTextureMap(n1.materialId,n1.textureType);}}return this;};var l1=new THREE.TextureLoader();S.TextureType={Diffuse:0,Bump:1,Opacity:2,Reflection:3,Refraction:4,Specular:5,Ambient:6,Emissive:7,SpecularLevel:8,Glosiness:9,AmbientOcclusion:10,Decal:11};S.prototype.updateTextureMaps=function(m){var e=[];var i=this._getMaterialRef(m);if(!i){return e;}var j=i.userData.materialInfo;if(!j){return e;}if(j.textureDiffuse){var k=this.updateTextureMap(m,S.TextureType.Diffuse);if(k.imageId){e.push(k);}}if(j.textureBump){var l=this.updateTextureMap(m,S.TextureType.Bump);if(l.imageId){e.push(l);}}if(j.textureOpacity){var m1=this.updateTextureMap(m,S.TextureType.Opacity);if(m1.imageId){e.push(m1);}}if(j.textureEmissive){var n1=this.updateTextureMap(m,S.TextureType.Emissive);if(n1.imageId){e.push(n1);}}if(j.textureAmbientOcclusion){var o1=this.updateTextureMap(m,S.TextureType.AmbientOcclusion);if(o1.imageId){e.push(o1);}}if(j.textureReflection){var p1=this.updateTextureMap(m,S.TextureType.Reflection);if(p1.imageId){e.push(p1);}}return e;};S.prototype.updateTextureMap=function(e,i){var j={textureType:i,imageId:null};var k=this._getMaterialRef(e);if(!k){return j;}var l=k.userData.materialInfo;if(!l){return j;}var m1=null;switch(i){case S.TextureType.Diffuse:m1=l.textureDiffuse;break;case S.TextureType.Bump:m1=l.textureBump;break;case S.TextureType.Opacity:m1=l.textureOpacity;break;case S.TextureType.Reflection:m1=l.textureReflection;break;case S.TextureType.Emissive:m1=l.textureEmissive;break;case S.TextureType.AmbientOcclusion:m1=l.textureAmbientOcclusion;break;default:break;}if(!m1){return j;}var n1=m1[0]||m1;var o1=this._images.get(n1.imageId);if(!o1){j.imageId=n1.imageId;return j;}if(k.userData.imageIdsToLoad){k.userData.imageIdsToLoad.delete(n1.imageId);if(k.userData.imageIdsToLoad.size===0){delete k.userData.imageIdsToLoad;}}if(k.userData.parametricType==="sphere"){n1.uvHorizontalScale=-1;}var p1=l1.load(o1,this._fireSceneUpdated);p1.wrapS=n1.uvHorizontalTilingEnabled?THREE.RepeatWrapping:THREE.ClampToEdgeWrapping;p1.wrapT=n1.uvVerticalTilingEnabled?THREE.RepeatWrapping:THREE.ClampToEdgeWrapping;p1.magFilter=n1.filterMode===1?THREE.NearestFilter:THREE.LinearFilter;p1.minFilter=n1.filterMode===1?THREE.NearestFilter:THREE.LinearMipMapLinearFilter;p1.anisotropy=4;var q1=n1.influence!==undefined?n1.influence:0;var r1=(n1.uvHorizontalScale!==undefined&&n1.uvHorizontalScale!==0)?n1.uvHorizontalScale:1;var s1=(n1.uvVerticalScale!==undefined&&n1.uvVerticalScale!==0)?n1.uvVerticalScale:1;var t1=n1.uvHorizontalOffset!==undefined?n1.uvHorizontalOffset:0;var u1=n1.uvVerticalOffset!==undefined?n1.uvVerticalOffset:0;p1.repeat.set(r1,s1);p1.center.set(-t1,-u1);p1.offset.set(t1,u1);p1.rotation=-n1.uvRotationAngle;function v1(m){switch(i){case S.TextureType.Diffuse:m.map=p1;m.transparent|=o1.startsWith("data:image/png");break;case S.TextureType.Bump:m.bumpMap=p1;m.bumpScale=q1;break;case S.TextureType.Opacity:m.alphaMap=p1;break;case S.TextureType.Reflection:p1.mapping=THREE.SphericalReflectionMapping;m.envMap=p1;m.combine=THREE.AddOperation;m.reflectivity=q1;break;case S.TextureType.Emissive:m.emissiveMap=p1;m.emissive.setRGB(1,1,1);break;case S.TextureType.AmbientOcclusion:m.aoMap=p1;break;default:}m.needsUpdate=true;}k.side=t.DoubleSide;v1(k);var w1=this._materialClones.get(e);if(w1){w1.forEach(function(m){v1(m);});}return j;};S.prototype.insertPlayback=function(e,i,j){this._resetCurrentScene(j);var k=this._vkScene.findSequence(e.sequenceId);var l=new r(e.id,{sequence:k,timeScale:e.speed?1.0/e.speed:1,preDelay:e.preDelay?e.preDelay:0,postDelay:e.postDelay?e.postDelay:0,repeats:e.repeat?Math.abs(e.repeat):0,reversed:e.reversed?true:false,startTime:e.start?e.start:0});var m=this._views.get(i);if(m){m.addPlayback(l);}if(!k){T.pushElementIntoMapArray(this._sequenceIdToPlaybacks,e.sequenceId,l);}return this;};S.prototype.insertSequence=function(i,e){var j=this._vkScene.findSequence(i.id);if(j){return this;}var k;if(i.endTime){if(i.startTime){k=i.endTime-i.startTime;}else{k=i.endTime;}}else{k=1.0;}j=this._vkScene.createSequence(i.id,{name:i.name,duration:k});if(Array.isArray(i.joints)){i.joints.forEach(function(o1){var p1=this._joints[o1];if(p1){j.setJoint(p1,true);}}.bind(this));}if(i.nodes&&i.nodes.length>0){for(var l=0;l<i.nodes.length;l++){var m=i.nodes[l];if(m.empty){m.type=m.binding;var m1=this._nodes.get(m.sid);this._animationHelper.insertEmptyTrack(m,j,m1,this._vkScene);continue;}T.pushElementIntoMapArray(this._trackIdSequenceNodeMap,m.trackId,{sequenceId:i.id,targetId:m.sid,type:m.binding,pivot:m.pivot,isAbsoluteValue:m.isAbsoluteValue});}}var n1=this._sequenceIdToPlaybacks.get(i.id);if(n1){n1.forEach(function(o1){o1.setSequence(j);});}return this;};S.prototype.insertTracks=function(e){this._animationHelper.insertTracks(e,this._trackIdSequenceNodeMap,this._nodes,this._vkScene);return this;};S.prototype.insertJoints=function(j,e){this._resetCurrentScene(e);this._joints=[];j.forEach(function(i){var k=this._nodes.get(i.childSid);var l=this._nodes.get(i.parentSid);var m={id:i.id,node:k,parent:l,translation:new Float32Array(i.t?i.t:[0,0,0]),quaternion:new Float32Array(i.q?i.q:[0,0,0,1]),scale:new Float32Array(i.s?i.s:[1,1,1])};if(!k){var m1=this._jointNodesMap.get(i.childSid);if(!m1){m1=[];}m1.push(m);this._jointNodesMap.set(i.childSid,m1);}if(!l){var n1=this._jointParentsMap.get(i.parentSid);if(!n1){n1=[];}n1.push(m);this._jointParentsMap.set(i.parentSid,n1);}this._joints.push(m);}.bind(this));return this;};S.prototype.finalizeAnimation=function(){var e=this._rootNode;if(e){while(e.parent){e=e.parent;}if(!e.userData){e.userData={};}e.userData.tracks=this._tracks;}return this;};S.prototype.finalizePlaybacks=function(){var e=this._rootNode;if(e){while(e.parent){e=e.parent;}if(!e.userData){e.userData={};}}else{return this;}if(!e.userData.animationNodeOriginalData){e.userData.animationNodeOriginalData=new Map();}var i;var j=this._viewGroups.entries();var k=j.next();while(!k.done){i=k.value[1];k=j.next();var l=[];for(var m=0;m<i.getViews().length;m++){if(i.getViews()[m].id){var m1=this._views.get(i.getViews()[m].id);if(m1){l.push(m1);}}}}return this;};S.prototype.finalizeViewGroups=function(e){this._resetCurrentScene(e);var i=this._viewGroups.entries();var j=i.next();while(!j.done){var k=j.value[1];var l=j.value[0];if(!k||!k.views||!k.views.length){j=i.next();continue;}k.removeViews();for(var m=0;m<k.views.length;m++){var m1=k.views[m].id;var n1=this._views.get(m1);if(n1&&n1.userData.viewInfo.thumbnailId&&!n1.thumbnailData){var o1=this._images.get(n1.userData.viewInfo.thumbnailId);if(o1){n1.thumbnailData=o1;}}if(n1){n1.viewGroupId=l;k.addView(n1);}}j=i.next();}return this;};S.prototype.insertViewGroup=function(i,e){this._resetCurrentScene(e);var j=this._viewGroups.get(i.id);if(!j){j=this._vkScene.createViewGroup({viewGroupId:i.id,name:i.name,description:i.description});this._viewGroups.set(i.id,j);}else{j.setViewGroupId(i.id);j.setName(i.name);j.setDescription(i.description);}j.type=i.type;j.metadata=i.metadata;j.veids=i.veids;j.views=i.views;j.sceneId=i.sceneId;return this;};S.prototype.getViewGroup=function(e,i){this._resetCurrentScene(i);var j=this._viewGroups.get(e);var k=[];if(j&&j.views){for(var l=0;l<j.views.length;l++){var m=j.views[l].id;var m1=this._views.get(m);if(m1){k.push(m1);}}}return k;};S.prototype.insertView=function(e,i){this._resetCurrentScene(i);if(e.description){var j=new RegExp("^<[^>]*?>");if(j.test(e.description)){var k=new RegExp("(^(<[^>]*?>\s*)+)|((<[^>]*?>\s*)+$)","g");var l=e.description.replace(k,"");if(!l){e.description=l;}}}var m=this._vkScene.createView({viewId:e.viewId,name:e.name,description:e.description?"<pre style=\"white-space: pre-wrap;\">"+e.description+"</pre>":e.description,aspectRatio:e.safeAreaAspectRatio});m.userData={};m.userData.viewInfo=e;if(e.thumbnailId){var m1=this._images.get(e.thumbnailId);if(m1){m.thumbnailData=m1;}else{this._viewThumbnails.set(e.thumbnailId,m);}}if(e.animatedThumbnailId){var n1=this._images.get(e.animatedThumbnailId);if(n1){m.animatedThumbnailData=n1;m.tileWidth=this._imageIdsAndTileWidths.get(e.animatedThumbnailId);}}if(e.cameraId){m.setCamera(this._cameras.get(e.cameraId));}m.type=e.type;m.flyToTime=e.flyToTime;m.preDelay=e.preDelay;m.postDelay=e.postDelay;m.navigationMode=e.navigationMode;m.topColor=e.topColor;m.bottomColor=e.bottomColor;m.renderMode=F[e.renderMethod];m.dimension=e.dimension;m.query=e.query;m.metadata=e.metadata;m.veids=e.veids;m.viewGroupId=e.viewGroupId;m.id=e.viewId;this._views.set(e.viewId,m);if(m.viewGroupId){var o1=this._viewGroups.get(m.viewGroupId);if(o1){o1.addView(m);}}return this;};S.prototype.setModelViewVisibilitySet=function(i){var e=this._views.get(i.viewId);var j=[];i.visibleNodes.forEach(function(k){var l=this._nodes.get(k);if(l){j.push({target:l,visible:true});}else{L.warning("Unknown modelView visible node reference",k);}}.bind(this));e.updateNodeInfos(j);};S.prototype.recordHighlightedNodeInView=function(e,i,j,k){this._resetCurrentScene(k);var l=this._views.get(j);if(!l){return this;}var m=this._nodes.get(i);if(!m){return this;}l.addHighlightedNodes(e,m);return this;};S.prototype.insertHighlightStyle=function(i){var e=this._vkScene.getHighlight(i.id);if(e){return this;}this._vkScene.createHighlight(i.id,i);return this;};S.prototype.insertModelViewHighlight=function(i){var e=this._views.get(i.viewId);if(e){var j=[];i.highlightNodes.forEach(function(m1){var n1=this._nodes.get(m1);if(n1){j.push(n1);}else{}}.bind(this));var k={duration:i.duration,cycles:i.cycles};if(!i.id){i.id=THREE.Math.generateUUID().toLowerCase();}var l=new THREE.Color(i.color1).toArray();var m=new THREE.Color(i.color2).toArray();l[3]=((i.color1>>>24)&255)/255;m[3]=((i.color2>>>24)&255)/255;k.colours=[l,m];k.opacities=[i.opacity1,i.opacity2];this._vkScene.createHighlight(i.id,k);e.addHighlightedNodes(i.id,j);}};S.prototype.createThumbnail=function(i){var e=this._viewThumbnails.get(i.imageId);if(e){e.thumbnailData="data:image/"+"jpeg"+";base64,"+window.btoa(String.fromCharCode.apply(null,i.data));if(this._fireThumbnailLoaded){this._fireThumbnailLoaded({modelView:e});}}};S.prototype.highlightStyleExists=function(i){var e=this._vkScene.getHighlight(i);return e!==undefined;};S.prototype.getView=function(e,i){this._resetCurrentScene(i);return this._views.get(e);};S.prototype.getSequence=function(e){return this._vkScene.findSequence(e);};S.prototype.setViewCamera=function(e,i,j){this._resetCurrentScene(j);var k=this._cameras.get(e);var l=this._views.get(i);if(k&&l){l.setCamera(k);}return this;};S.prototype.setViewNodeInfos=function(e,i,j){this._resetCurrentScene(j);var k=this._views.get(i);k.setNodeInfos(e);return this;};S.prototype.setViewThumbnail=function(i,e,j,k){this._resetCurrentScene(j);var l=this._views.get(e);var m=this._images.get(i);if(l&&m){if(l.userData!==undefined){if(l.userData.viewInfo.thumbnailId===i){l.thumbnailData=m;}else if(l.userData.viewInfo.animatedThumbnailId===i){l.animatedThumbnailData=m;l.tileWidth=k;}}}return this;};S.prototype.cleanup=function(){this._rootNode=null;if(this._vkScene){this._vkScene.clearMaterials();}this._callouts.clear();this._cameras.clear();this._images.clear();this._imageIdsAndTileWidths.clear();this._imageTextures.clear();this._geometries.clear();this._meshNodes.clear();this._meshSubmeshes.clear();this._geometryMeshes.clear();this._materialMeshes.clear();this._materialClones.clear();this._currentSceneId=null;if(this._nodes){this._nodes.clear();}if(this._tracks){this._tracks.clear();}if(this._trackIdSequenceNodeMap){this._trackIdSequenceNodeMap.clear();}if(this._viewGroups){this._viewGroups.clear();}if(this._views){this._views.clear();}this._sceneIdTreeNodesMap.clear();this._sceneIdRootNodeMap.clear();this._sceneIdViewGroupMap.clear();this._sceneIdViewMap.clear();S._map.delete(this._id);};S.prototype.insertAnimationGroup=function(i){var e=this._vkScene.findSequence(i.animationGroupRef.toString());if(!e){var j;if(i.endTime){j=i.endTime-i.startTime;if(!i.startTime){i.startTime=0;}}e=this._vkScene.createSequence(i.animationGroupRef.toString(),{name:i.name,duration:j});if(!e.userData){e.userData={};}e.userData.animations=[];}if(i.modelViewRef){var m=this._views.get(i.modelViewRef);if(m){var k=this._vkScene.findSequence(i.animationGroupRef.toString());var l=new r({sequence:k,timeScale:i.playbackSpeed?1.0/i.playbackSpeed:1,preDelay:i.playbackPreDelay?i.playbackPreDelay:0,postDelay:i.playbackPostDelay?i.playbackPostDelay:0,repeat:i.playbackRepeat?Math.abs(i.playbackRepeat):0,reversed:i.playbackReversed?true:false,startTime:0});m.addPlayback(l);}}};S.prototype.insertAnimation=function(i){var e=this._animations.get(i.animationRef);if(!e){e={};e.type=i.animationType;e.targetRefs=[];e.targetPivots=[];e.sequenceId=i.animationGroupRef.toString();e.trackIds=new Set();e.tracks=[];this._animations.set(i.animationRef,e);}if(i.animationGroupRef){var j=this._vkScene.findSequence(i.animationGroupRef.toString());if(!j.userData.animations.includes(i.animationRef)){j.userData.animations.push(i.animationRef);}}};S.prototype.insertAnimationTarget=function(i){var e=this._animations.get(i.animationRef);if(e){if(!e.targetRefs.includes(i.targetRef)){e.targetRefs.push(i.targetRef);e.targetPivots.push({x:i.targetPivotX,y:i.targetPivotY,z:i.targetPivotZ});}}};S.prototype.insertAnimationTrack=function(i){var e=this._animationTracks.get(i.animationTrackRef);var j=i.animationRef;if(!e){delete i.animationRef;e=i;this._animationTracks.set(i.animationTrackRef,e);}if(!j){return;}var k=this._animations.get(j);if(!k||!k.sequenceId){return;}if(k.trackIds.has(e.animationTrackRef)){return;}k.trackIds.add(e.animationTrackRef);for(var l=0;k.targetRefs&&l<k.targetRefs.length;l++){var m=k.targetRefs[l];var m1=k.targetPivots[l];var n1=this._nodes.get(m);if(!n1){continue;}var o1;if(m1.x!==0||m1.y!==0||m1.z!==0){o1=[m1.x,m1.y,m1.z];}var p1=["OPACITY","COLOUR","TRANSLATE","SCALE","ROTATE"][e.type]||"";T.pushElementIntoMapArray(this._trackIdSequenceNodeMap,i.animationTrackRef,{sequenceId:k.sequenceId,targetId:m,type:p1,pivot:o1,isAbsoluteValue:true});var q1={};q1.times=Array.prototype.slice.call(e.times);q1.values=Array.prototype.slice.call(e.values);q1.id=i.animationTrackRef;q1.cyclicInfo={};q1.cyclicInfo.cyclicStart=e.cyclicStart;q1.cyclicInfo.cyclicEnd=e.cyclicEnd;var ki;if(k.type===0){if(e.dataType===0){if(e.values.length!==e.keyCount||e.times.length!==e.keyCount){continue;}if(e.type===3){q1.values=[];for(ki=0;ki<e.keyCount;ki++){q1.values.push(e.values[ki]);q1.values.push(e.values[ki]);q1.values.push(e.values[ki]);}}}else if(e.dataType===1||e.dataType===3){if(e.values.length!==3*e.keyCount||e.times.length!==e.keyCount){continue;}}else if(e.dataType===4||e.dataType===5||e.dataType===6){if(e.values.length!==4*e.keyCount||e.times.length!==e.keyCount){continue;}if(e.dataType===4){q1.rotateType=s.AngleAxis;}else if(e.dataType===6){q1.rotateType=s.Euler;}else{q1.rotateType=s.Quaternion;for(var vi=3;vi<q1.values.length;vi=vi+4){q1.values[vi]=-q1.values[vi];}}}}k.tracks.push(q1);}};S.prototype.setAnimationTracks=function(e){var i=this._animations.get(e);if(i){this._animationHelper.insertTracks(i.tracks,this._trackIdSequenceNodeMap,this._nodes,this._vkScene);}};S.prototype.setAnimationPlaybacks=function(i){var e=this._viewGroups.get(i.viewGroupId);this._animationHelper.setInitialNodePositionsFromSubsequentViews(e.getViews(),this._vkScene);this._animationHelper.setInitialNodePositionsFromPreviousViews(e.getViews(),this._vkScene);this._animationHelper.setInitialNodePositionsFromCurrenetViews(e.getViews(),this._vkScene);this._animationHelper.setPlaybackStartTimes(e.getViews(),this._vkScene);this._animationHelper.buildViewsInitialState(e.getViews(),this._vkScene);};S.prototype.getSphere=function(e,i,m){var j=x.generateSphere(i,m);if(e.userData&&e.userData.nodeContentType){j.userData.nodeContentType=e.userData.nodeContentType;}j.layers=e.layers;e.add(j);};S.prototype.getPlane=function(e,i,m){var j=x.generatePlane(i,m);if(e.userData&&e.userData.nodeContentType){j.userData.nodeContentType=e.userData.nodeContentType;}j.layers=e.layers;e.add(j);};S.prototype.setParametricContent=function(e,i,j){this._resetCurrentScene(j);var k={"sphere":this.getSphere.bind(this),"plane":this.getPlane.bind(this)};var l=i.type;var m=this.getNode(e,this.sceneId);var m1=i.materialID;var n1=null;if(m1){n1=this._getMaterialRef(m1)||this._createTemporaryMaterial(m1);if(m.userData.parametricVisible){n1.userData.parametricType=l;}}k[l](m,i,n1);};return S;});
