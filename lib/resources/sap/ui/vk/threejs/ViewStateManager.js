/*!
* SAP UI development toolkit for HTML5 (SAPUI5)

        (c) Copyright 2009-2015 SAP SE. All rights reserved
    
*/
sap.ui.define(["../Core","../ViewStateManagerBase","../thirdparty/three","../cssColorToColor","../colorToCSSColor","../abgrToColor","../colorToABGR","./Scene","../ObjectType","../RotationType","./NodesTransitionHelper","./OutlineRenderer","./HighlightPlayer","../HighlightDisplayState","../Highlight","../AnimationTrackType","../AnimationTrackValueType","../AnimationMath"],function(a,V,t,b,d,e,f,S,O,R,N,g,H,h,m,A,n,o){"use strict";var p;var q=V.extend("sap.ui.vk.threejs.ViewStateManager",{metadata:{}});var r=q.getMetadata().getParent().getClass().prototype;q.prototype.init=function(){if(r.init){r.init.call(this);}this._channel=0;this._layers=new THREE.Layers();this._layers.set(this._channel);this._nodeHierarchy=null;this._nodeStates=new Map();this._selectedNodes=new Set();this._outlineRenderer=new g(1.0);this._outlinedNodes=new Set();this.setOutlineColor("rgba(255, 0, 255, 1.0)");this.setOutlineWidth(1.0);this._visibilityTracker=new p();this._showSelectionBoundingBox=true;this._boundingBoxesScene=new THREE.Scene();this._selectionColor=new THREE.Color(0xC0C000);this.setHighlightColor("rgba(255, 0, 0, 1.0)");this._joints=[];this._nodesTransitionHelper=new N();this._nodesTransitionHelper.setViewStateManager(this);this._highlightPlayer=new H();this._transitionHighlightPlayer=new H();a.getEventBus().subscribe("sap.ui.vk","activateView",this._onViewActivated,this);};q.prototype.exit=function(){a.getEventBus().unsubscribe("sap.ui.vk","activateView",this._onViewActivated,this);};q.prototype._setContent=function(c){var s=null;if(c&&c instanceof S){s=c;}this._setScene(s);if(s){var i=s.getInitialView();if(i){this._currentView=i;this._resetNodesMaterialAndOpacityByCurrenView(this._currentView);}}return this;};q.prototype._setScene=function(s){this._boundingBoxesScene=new THREE.Scene();this._setNodeHierarchy(s?s.getDefaultNodeHierarchy():null);if(s){s.setViewStateManager(this);}this._scene=s;if(this._scene){var i=this._scene.getInitialView();if(i){this.activateView(i);}}return this;};q.prototype._setNodeHierarchy=function(c){var i=this._nodeHierarchy;if(this._nodeHierarchy){this._nodeHierarchy=null;this._nodeStates.clear();this._selectedNodes.clear();this._outlinedNodes.clear();this._visibilityTracker.clear();}if(c){this._nodeHierarchy=c;this._nodeHierarchy.attachNodeReplaced(this._handleNodeReplaced,this);this._nodeHierarchy.attachNodeUpdated(this._handleNodeUpdated,this);this._nodeHierarchy.attachNodeRemoving(this._handleNodeRemoving,this);this._initialState={visible:[],hidden:[]};var j=this;var k=c.findNodesByName();k.forEach(function(l){(l.layers.test(j._layers)?j._initialState.visible:j._initialState.hidden).push(l);});this.fireVisibilityChanged({visible:this._initialState.visible,hidden:this._initialState.hidden});}if(c!==i){this.fireNodeHierarchyReplaced({oldNodeHierarchy:i,newNodeHierarchy:c});}return this;};q.prototype._getJointByChildNode=function(c){var j;if(this._jointCollection){for(var i=0;i<this._jointCollection.length;i++){if(this._jointCollection[i].node===c){j=this._jointCollection[i];break;}}}return j;};q.prototype._handleNodeReplaced=function(c){var i=c.getParameter("ReplacedNodeRef");var j=c.getParameter("ReplacementNodeRef");if(this.getSelectionState(i)){this.setSelectionState(j,true);this.setSelectionState(i,false);}};q.prototype._handleNodeUpdated=function(c){var i=c.getParameter("nodeRef");if(this.getSelectionState(i)){this.setSelectionState(i,false);this.setSelectionState(i,true);}};q.prototype._handleNodeRemoving=function(c){var j=c.getParameter("nodeRef");if(this._jointCollection){for(var i=0;i<this._jointCollection.length;i++){if(this._jointCollection[i].node===j){this._jointCollection[i].node=null;break;}if(this._jointCollection[i].parent===j){this._jointCollection[i].parent=null;break;}}}if(this.getSelectionState(j)){this.setSelectionState(j,false,true,true);}};q.prototype._renderOutline=function(i,s,j){var c=e(this._outlineColorABGR);var k=new THREE.Color(c.red/255.0,c.green/255.0,c.blue/255.0);this._outlineRenderer.render(i,s,j,Array.from(this._outlinedNodes),k,this._jointCollection);};q.prototype.getNodeHierarchy=function(){return this._nodeHierarchy;};q.prototype.getVisibilityChanges=function(){return this.getShouldTrackVisibilityChanges()?this._visibilityTracker.getInfo(this.getNodeHierarchy()):null;};q.prototype.getCurrentView=function(){var v=sap.ui.getCore().byId(this.getViewManager());if(!v){return null;}var c=v.getActiveView();return c;};q.prototype.resetNodeProperty=function(c,i){var j=this.getCurrentView();if(!j){return;}var k=j.getNodeInfos();if(k){var l=[];l.push(c);if(this._jointCollection&&this._jointCollection.length>0){for(var s=0;s<this._jointCollection.length;s++){var v=this._jointCollection[s];if(!v.node||!v.parent){continue;}var w=v.parent;if(w!==c){break;}l.push(v.node);}}k.forEach(function(x){if(!l.includes(x.target)){return;}if(!i||i!==A.Opacity){var y={nodeRefs:[],positions:[]};var z;var B;var C;if(x.transform){var D=new THREE.Vector3();var E=new THREE.Quaternion();var F=new THREE.Vector3();var G=u(x.transform);G.decompose(D,E,F);z=D.toArray();B=E.toArray();C=F.toArray();}else if(x[A.Scale]&&x[A.Rotate]&&x[A.Translate]){z=x[A.Translate].slice();B=x[A.Rotate].slice();C=x[A.Scale].slice();}if(z){y.nodeRefs.push(x.target);y.positions.push({translation:z,quaternion:B,scale:C});this.setTransformation(y.nodeRefs,y.positions);}}else{c._vkSetOpacity(x.opacity,this._jointCollection);var I={changed:c,opacity:k.opacity};this.fireOpacityChanged(I);}}.bind(this));}};q.prototype.getVisibilityComplete=function(){var c=this.getNodeHierarchy(),i=c.findNodesByName(),v=[],j=[];i.forEach(function(k){var l=c.createNodeProxy(k);var s=l.getVeId();c.destroyNodeProxy(l);if(s){if(this.getVisibilityState(k)){v.push(s);}else{j.push(s);}}},this);return{visible:v,hidden:j};};q.prototype.resetVisibility=function(){this.setVisibilityState(this._initialState.visible,true,false);this.setVisibilityState(this._initialState.hidden,false,false);this._visibilityTracker.clear();};q.prototype.getVisibilityState=function(c){var l=this._layers;if(Array.isArray(c)){return c.map(function(i){return i?i.layers.test(l):false;});}return c?c.layers.test(l):false;};q.prototype.setVisibilityState=function(c,v,i){if(!Array.isArray(c)){c=[c];}var j=Array.isArray(v);var k=[];var l=c;if(i){l=[];c.forEach(function(C,D){var E=this._collectNodesRecursively(C);l=l.concat(E);var F=k.length;k.length=F+E.length;k.fill(j?v[D]:v,F);},this);}else if(!j){k.length=l.length;k.fill(v);}else{k=v;}var s=[];var w=new Set();var x=this._layers,y=this._channel;var z=l.filter(function(C,D){if(w.has(C)){return false;}w.add(C);var z=C?C.layers.test(x)!=k[D]:false;if(z){s.push(k[D]);}return z;},this);if(z.length>0){var B={visible:[],hidden:[]};z.forEach(function(C,D){if(s[D]){C.layers.enable(y);B.visible.push(C);}else{C.layers.disable(y);B.hidden.push(C);}},this);if(this.getShouldTrackVisibilityChanges()){z.forEach(this._visibilityTracker.trackNodeRef,this._visibilityTracker);}this.fireVisibilityChanged(B);}return this;};q.prototype.enumerateSelection=function(c){this._selectedNodes.forEach(c);return this;};q.prototype.enumerateOutlinedNodes=function(c){this._outlinedNodes.forEach(c);return this;};q.prototype.getSelectionState=function(c){var s=this._selectedNodes;function i(j){return s.has(j);}return Array.isArray(c)?c.map(i):i(c);};q.prototype._getSelectionComplete=function(){var c=this.getNodeHierarchy(),s=[],i=[];function j(k){var l=c.createNodeProxy(k);var v=l.getVeId();c.destroyNodeProxy(l);return v;}this._selectedNodes.forEach(function(k){var v=j(k);if(v){s.push(v);}});this._outlinedNodes.forEach(function(k){var v=j(k);if(v){i.push(v);}});return{selected:s,outlined:i};};q.prototype._isAChild=function(c,i){var j=c.parent;while(j){if(i.has(j)){return true;}j=j.parent;}return false;};q.prototype._AddBoundingBox=function(c){if(c.userData.boundingBox===undefined){c.userData.boundingBox=new THREE.Box3();c._vkCalculateObjectOrientedBoundingBox();}if(!c.userData.boundingBox.isEmpty()&&this._boundingBoxesScene&&c.userData.boxHelper===undefined){var i=new THREE.Box3Helper(c.userData.boundingBox,0xffff00);i.material.color=this._selectionColor;this._boundingBoxesScene.add(i);i.parent=c;c.userData.boxHelper=i;}};q.prototype._RemoveBoundingBox=function(c){if(c.userData.boundingBox!==undefined){delete c.userData.boundingBox;}if(c.userData.boxHelper!==undefined){this._boundingBoxesScene.remove(c.userData.boxHelper);delete c.userData.boxHelper;}};q.prototype._updateBoundingBoxesIfNeeded=function(){var c=new Set();this._selectedNodes.forEach(function(i){var j=i.parent;while(j){if(this._selectedNodes.has(j)){c.add(j);}j=j.parent;}}.bind(this));c.forEach(function(i){i._vkCalculateObjectOrientedBoundingBox();});};q.prototype._updateBoundingBoxes=function(){this._selectedNodes.forEach(function(c){if(c.userData.boundingBox){c._vkCalculateObjectOrientedBoundingBox();}});};q.prototype.setShowSelectionBoundingBox=function(v){this._showSelectionBoundingBox=v;if(this._showSelectionBoundingBox){this._selectedNodes.forEach(function(c){this._AddBoundingBox(c);}.bind(this));}else{this._selectedNodes.forEach(function(c){this._RemoveBoundingBox(c);}.bind(this));}this.fireSelectionChanged({selected:this._selectedNodes,unselected:[]});};q.prototype.getShowSelectionBoundingBox=function(){return this._showSelectionBoundingBox;};q.prototype._isAncestorSelected=function(c){c=c.parent;while(c){if(this._selectedNodes.has(c)){return true;}c=c.parent;}return false;};q.prototype._updateHighlightColor=function(c,j){var s=j||this._selectedNodes.has(c);c.userData.highlightColor=s?this._highlightColorABGR:undefined;c._vkUpdateMaterialColor();var k=c.children;for(var i=0,l=k.length;i<l;i++){var v=k[i].userData;if(v&&v.objectType===O.Hotspot){continue;}this._updateHighlightColor(k[i],s);}};q.prototype.setSelectionState=function(c,s,i,j){if(!Array.isArray(c)){c=[c];}c=(i||this.getRecursiveSelection()?this._collectNodesRecursively(c):c).filter(function(v,l,w){return w.indexOf(v)===l;});if(this.getRecursiveSelection()&&!s){c=this._nodeHierarchy._appendAncestors(c);}var k=c.filter(function(l){return this._selectedNodes.has(l)!==s;},this);if(k.length>0){k.forEach(function(l){if(l){this._selectedNodes[s?"add":"delete"](l);if(this._showSelectionBoundingBox){this[s?"_AddBoundingBox":"_RemoveBoundingBox"](l);}}},this);k.forEach(function(l){if(l){this._updateHighlightColor(l,s||this._isAncestorSelected(l));}},this);if(!j){this.fireSelectionChanged({selected:s?k:[],unselected:s?[]:k});}}return this;};q.prototype.setSelectionStates=function(s,c,i,j){if(!Array.isArray(s)){s=[s];}if(!Array.isArray(c)){c=[c];}s=(i||this.getRecursiveSelection()?this._collectNodesRecursively(s):s);c=(i||this.getRecursiveSelection()?this._collectNodesRecursively(c):c);if(this.getRecursiveSelection()){c=this._nodeHierarchy._appendAncestors(c,s);}var k=s.filter(function(v){return this._selectedNodes.has(v)===false;},this);var l=c.filter(function(v){return this._selectedNodes.has(v)===true;},this);if(k.length>0||l.length>0){k.forEach(function(v){this._selectedNodes.add(v);this._updateHighlightColor(v,true);if(this._showSelectionBoundingBox){this._AddBoundingBox(v);}},this);l.forEach(function(v){this._selectedNodes.delete(v);if(this._showSelectionBoundingBox){this._RemoveBoundingBox(v);}},this);l.forEach(function(v){this._updateHighlightColor(v,this._isAncestorSelected(v));},this);if(!j){this.fireSelectionChanged({selected:k,unselected:l});}}return this;};q.prototype.setOutlineColor=function(c){switch(typeof c){case"number":this._outlineColorABGR=c;break;case"string":if(sap.ui.core.CSSColor.isValid(c)){this._outlineColorABGR=f(b(c));}break;default:return this;}this.fireOutlineColorChanged({outlineColor:d(e(this._outlineColorABGR)),outlineColorABGR:this._outlineColorABGR});return this;};q.prototype.getOutlineColor=function(i){return i?this._outlineColorABGR:d(e(this._outlineColorABGR));};q.prototype.getOutliningState=function(c){var i=this._outlinedNodes;function j(k){return i.has(k);}return Array.isArray(c)?c.map(j):j(c);};q.prototype.setOutliningStates=function(c,i,j,k){if(!Array.isArray(c)){c=[c];}if(!Array.isArray(i)){i=[i];}c=(j||this.getRecursiveOutlining()?this._collectNodesRecursively(c):c);i=(j||this.getRecursiveOutlining()?this._collectNodesRecursively(i):i);if(this.getRecursiveOutlining()){i=this._nodeHierarchy._appendAncestors(i,c);}var l=c.filter(function(v){return this._outlinedNodes.has(v)===false;},this);var s=i.filter(function(v){return this._outlinedNodes.has(v)===true;},this);if(l.length>0||s.length>0){l.forEach(function(v){this._outlinedNodes.add(v);},this);s.forEach(function(v){this._outlinedNodes.delete(v);},this);if(!k){this.fireOutliningChanged({outlined:l,unoutlined:s});}}return this;};q.prototype.setOutlineWidth=function(w){this._outlineWidth=w;this._outlineRenderer.setOutlineWidth(w);this.fireOutlineWidthChanged({width:w});return this;};q.prototype.getOutlineWidth=function(){return this._outlineWidth;};q.prototype._collectNodesRecursively=function(c){var i=[],j=this;if(!Array.isArray(c)){c=[c];}c.forEach(function collectChildNodes(k){i.push(k);j._nodeHierarchy.enumerateChildren(k,collectChildNodes,false,true);});return i;};q.prototype._getOpacity=function(c){return c.userData.opacity!==undefined?c.userData.opacity:null;};q.prototype.getOpacity=function(c){if(Array.isArray(c)){return c.map(this._getOpacity,this);}else{return this._getOpacity(c);}};q.prototype.setOpacity=function(c,i,j){if(!Array.isArray(c)){c=[c];}var k=Array.isArray(i);if(i==null){i=undefined;}else if(k){i.forEach(function(z,B){if(z==null){i[B]=undefined;}});}var l=[];var s=c;if(!k){l.length=s.length;l.fill(i);}else{l=i;}var v=[];var w=new Set();var x=s.filter(function(z,B){if(w.has(z)){return false;}w.add(z);var x=z?z.userData.opacity!==l[B]:false;if(x){v.push(l[B]);}return x;},this);if(x.length>0){x.forEach(function(z,B){z._vkSetOpacity(v[B],this._jointCollection);},this);var y={changed:x,opacity:k?v:v[0]};this.fireOpacityChanged(y);}return this;};q.prototype._getTintColorABGR=function(c){return c.userData.tintColor!==undefined?c.userData.tintColor:null;};q.prototype._getTintColor=function(c){return c.userData.tintColor!==undefined?d(e(c.userData.tintColor)):null;};q.prototype.getTintColor=function(c,i){var j=i?"_getTintColorABGR":"_getTintColor";if(Array.isArray(c)){return c.map(this[j],this);}else{return this[j](c);}};q.prototype.setTintColor=function(c,i,j){if(!Array.isArray(c)){c=[c];}var k=function(C){var D=null;switch(typeof C){case"number":D=C;break;case"string":if(sap.ui.core.CSSColor.isValid(C)){D=f(b(C));}break;default:D=undefined;break;}return D;};var l=Array.isArray(i);var s=[];var v=c;if(j){v=[];c.forEach(function(C,D){var E=this._collectNodesRecursively(C);v=v.concat(E);var F=s.length;s.length=F+E.length;s.fill(l?i[D]:i,F);},this);}else if(!l){s.length=v.length;s.fill(i);}else{s=i;}var w=[];var x=new Set();var y=v.filter(function(C,D){if(x.has(C)){return false;}x.add(C);var y=C?C.userData.tintColor!==k(s[D]):false;if(y){w.push(s[D]);}return y;},this);if(y.length>0){var z=[];y.forEach(function(C,D){var E=k(w[D]);C._vkSetTintColor(E);z.push(E);},this);var B={changed:y,tintColor:l?w:w[0],tintColorABGR:l?z:z[0]};this.fireTintColorChanged(B);}return this;};q.prototype.setHighlightColor=function(c){switch(typeof c){case"number":this._highlightColorABGR=c;break;case"string":if(sap.ui.core.CSSColor.isValid(c)){this._highlightColorABGR=f(b(c));}break;default:return this;}if(this._selectedNodes.size>0){this._selectedNodes.forEach(function(i){this._updateHighlightColor(i,true);},this);}this.fireHighlightColorChanged({highlightColor:d(e(this._highlightColorABGR)),highlightColorABGR:this._highlightColorABGR});return this;};q.prototype.getHighlightColor=function(i){return i?this._highlightColorABGR:d(e(this._highlightColorABGR));};q.prototype.getRestTransformationUsingJoint=function(c){var j=this._getJointByChildNode(c);if(j&&j.translation&&j.scale&&j.quaternion){return j;}else{return this.getRestTransformation(c);}};q.prototype.getRelativeTransformation=function(c){var i=function(k){var l=this.getRestTransformation(k);var s=[k.position.x-l.translation[0],k.position.y-l.translation[1],k.position.z-l.translation[2]];var v=new THREE.Quaternion().fromArray(l.quaternion).inverse().premultiply(k.quaternion).toArray();var w=[k.scale.x/l.scale[0],k.scale.y/l.scale[1],k.scale.z/l.scale[2]];return{translation:s,quaternion:v,scale:w};}.bind(this);if(!Array.isArray(c)){return i(c);}var j=[];c.forEach(function(k){j.push(i(k));});return j;};q.prototype.getTransformationWorld=function(c){var i=function(k){var l=new THREE.Vector3();var s=new THREE.Vector3();var v=new THREE.Quaternion();k.updateMatrixWorld();k.matrixWorld.decompose(l,v,s);return{translation:l.toArray(),quaternion:v.toArray(),scale:s.toArray()};};if(!Array.isArray(c)){return i(c);}var j=[];c.forEach(function(k){j.push(i(k));});return j;};q.prototype.getTransformation=function(c){var i=function(k){return{translation:this.getTranslation(k),quaternion:this.getRotation(k,R.Quaternion),scale:this.getScale(k)};}.bind(this);if(!Array.isArray(c)){return i(c);}var j=[];c.forEach(function(k){j.push(i(k));});return j;};q.prototype.getTranslation=function(c){var i=function(k){return k.position.toArray();};if(!Array.isArray(c)){return i(c);}var j=[];c.forEach(function(k){j.push(i(k));});return j;};q.prototype.getScale=function(c){var i=function(k){return k.scale.toArray();};if(!Array.isArray(c)){return i(c);}var j=[];c.forEach(function(k){j.push(i(k));});return j;};q.prototype._convertQuaternionToAngleAxis=function(c){if(c.w>1){c.normalize();}if(c.w>0.9999&&c.x<0.0001&&c.y<0.0001&&c.z<0.0001){c.w=1;c.x=0;c.y=0;c.z=0;}var i=2*Math.acos(c.w);var x;var y;var z;var s=Math.sqrt(1-c.w*c.w);if(s<0.0001){x=1;y=0;z=0;}else{x=c.x/s;y=c.y/s;z=c.z/s;}return[x,y,z,i];};q.prototype.getRotation=function(c,i){var j=function(l){var s=l.quaternion;var k;switch(i){case R.AngleAxis:k=this._convertQuaternionToAngleAxis(s);break;case R.Euler:var v=new THREE.Euler();v.setFromQuaternion(s);k=v.toArray();break;default:k=s.toArray();}return k;};if(!Array.isArray(c)){return j(c);}var k=[];c.forEach(function(l){k.push(j(l));});return k;};q.prototype.setTransformation=function(c,i){var j=Array.isArray(c);if(!Array.isArray(c)){c=[c];}var k={changed:[],transformation:[]};var l=function(s){return{position:s.position.toArray(),quaternion:s.quaternion.toArray(),scale:s.scale.toArray()};};if(!i){c.forEach(function(s){if(s.userData.position&&s.userData.quaternion&&s.userData.scale){s.position=s.userData.position;s.quaternion=s.userData.quaternion;s.scale=s.userData.scale;s.updateMatrix();delete s.userData.position;delete s.userData.quaternion;delete s.userData.scale;}k.changed.push(s);k.transformation.push(l(s));},this);}else{if(!Array.isArray(i)){i=[i];}c.forEach(function(s,v){var w=s.userData;if(!w){return;}if(!w.position){w.position=s.position.clone();}if(!w.quaternion){w.quaternion=s.quaternion.clone();}if(!w.scale){w.scale=s.scale.clone();}var x=i[v];if(x.transform){var y=u(x.transform);y.decompose(s.position,s.quaternion,s.scale);}else{s.position.fromArray(x.translation);s.scale.fromArray(x.scale);if(x.quaternion){s.quaternion.fromArray(x.quaternion);}else if(x.angleAxis){var z=new THREE.Vector3(x.angleAxis[0],x.angleAxis[1],x.angleAxis[2]);s.quaternion.setFromAxisAngle(z,x.angleAxis[3]);}else if(x.euler){var B=new THREE.Euler();B.fromArray(x.euler[0],x.euler[1],x.euler[2],x.euler[3]);s.quaternion.setFromEuler(B);}}s.updateMatrix();k.changed.push(s);k.transformation.push(l(s));},this);}if(!j){k.changed=k.changed[0];k.transformation=k.transformation[0];}this.fireTransformationChanged(k);return this;};q.prototype.getJoints=function(){return this._jointCollection;};q.prototype.setJoints=function(j,c){this._jointCollection=[];this._playbackAssociatedWithJoints=null;if(!j){return this;}var i=new Set();var k=new Map();j.forEach(function(s){if(!s.node||!s.parent){return;}i.add(s.node);k.set(s.node,s);});while(i.size>0){var l=i.values().next().value;i.delete(l);var s=k.get(l);var v=[s];var w=[];var x=s.parent;while(x){s=k.get(x);if(s!==undefined){if(i.delete(x)){v.push(s);}if(w.length>0){s.nodesToUpdate=s.nodesToUpdate||[];while(w.length>0){var y=w.pop();if(s.nodesToUpdate.indexOf(y)>=0){break;}s.nodesToUpdate.push(y);}}w.length=0;x=s.parent;}else{w.push(x);x=x.parent;}}while(v.length>0){this._jointCollection.push(v.pop());}}if(this._jointCollection&&this._jointCollection.length>0){this._playbackAssociatedWithJoints=c;this._jointCollection.forEach(function(s){if(!s.node||!s.parent){return;}s.translation=null;s.scale=null;s.quaternion=null;s.opacity=null;if(s.node.userData){s.node.userData.offsetTranslation=null;s.node.userData.offsetQuaternion=null;s.node.userData.offsetScale=null;s.node.userData.originalRotationType=null;s.node.userData.offsetOpacity=null;}});this._jointCollection.forEach(function(s){this._updateJointNode(s,this._playbackAssociatedWithJoints);}.bind(this));}return this;};q.prototype._updateJointNode=function(j,c){if(!j.node||!j.parent){return;}if(j.translation&&j.quaternion&&j.scale&&j.opacity){return;}var i=new Map();if(this._jointCollection&&this._jointCollection.length>0){this._jointCollection.forEach(function(j){if(!j.node||!j.parent){return;}i.set(j.node,j);});}var k,s,l,v,w,x;var y=j.node;var z=new THREE.Matrix4();var B,C=1;while(y){x=this.getRestOpacity(y);w=this.getRestTransformation(y);if(!w){y=y.parent;continue;}k=new THREE.Vector3(w.translation[0],w.translation[1],w.translation[2]);s=new THREE.Vector3(w.scale[0],w.scale[1],w.scale[2]);l=new THREE.Quaternion(w.quaternion[0],w.quaternion[1],w.quaternion[2],w.quaternion[3]);B=x;if(c){var D=this._getEndPropertyInPreviousPlayback(y,A.Translate,c,true);if(D){k.x+=D[0];k.y+=D[1];k.z+=D[2];}var E=this._getEndPropertyInPreviousPlayback(y,A.Scale,c,true);if(E){s.x*=E[0];s.y*=E[1];s.z*=E[2];}var F=this._getEndPropertyInPreviousPlayback(y,A.Rotate,c,true);if(F){var G=new THREE.Quaternion(F[0],F[1],F[2],F[3]);l=G.multiply(l);}var I=this._getEndPropertyInPreviousPlayback(y,A.Opacity,c,true);if(I!=null){B*=I;}}v=new THREE.Matrix4().compose(k,l,s);z.premultiply(v);C*=B;y=y.parent;}var J=j.parent;var P=new THREE.Matrix4();var K=1;while(J){var L=i.get(J);if(L){if(!L.translation){this._updateJointNode(L);}k=new THREE.Vector3(L.translation[0],L.translation[1],L.translation[2]);s=new THREE.Vector3(L.scale[0],L.scale[1],L.scale[2]);l=new THREE.Quaternion(L.quaternion[0],L.quaternion[1],L.quaternion[2],L.quaternion[3]);B=L.opacity;J=L.parent;}else{x=this.getRestOpacity(J);w=this.getRestTransformation(J);if(!w){J=J.parent;continue;}k=new THREE.Vector3(w.translation[0],w.translation[1],w.translation[2]);s=new THREE.Vector3(w.scale[0],w.scale[1],w.scale[2]);l=new THREE.Quaternion(w.quaternion[0],w.quaternion[1],w.quaternion[2],w.quaternion[3]);B=x;if(c){var M=this._getEndPropertyInPreviousPlayback(J,A.Translate,c,true);if(M){k.x+=M[0];k.y+=M[1];k.z+=M[2];}var Q=this._getEndPropertyInPreviousPlayback(J,A.Scale,c,true);if(Q){s.x*=Q[0];s.y*=Q[1];s.z*=Q[2];}var T=this._getEndPropertyInPreviousPlayback(J,A.Rotate,c,true);if(T){var U=new THREE.Quaternion(T[0],T[1],T[2],T[3]);l=U.multiply(l);}var W=this._getEndPropertyInPreviousPlayback(J,A.Opacity,c,true);if(W!=null){B*=W;}}J=J.parent;}v=new THREE.Matrix4().compose(k,l,s);P.premultiply(v);K*=B;}var X=P.getInverse(P).multiply(z);X.decompose(k,l,s);j.translation=k.toArray();j.quaternion=l.toArray();j.scale=s.toArray();var Y=function(Z,$){if(Z===$){return 1;}else if(Math.abs($)<0.0001){return 1;}return Z/$;};j.opacity=Y(C,K);};q.prototype._propagateOpacityToJointChildren=function(c,i){if(!c||!i||c.length!==i.length){return this;}if(!this._jointCollection||!this._jointCollection.length){return this;}var j=new Map();this._jointCollection.forEach(function(l){var s=j.get(l.parent);if(!s){s=[];j.set(l.parent,s);}s.push(l);});var k=function(l,s){if(l.opacity!=null&&l.node&&l.node.userData){l.node.userData.opacity=l.opacity*s;if(l.node.userData.offsetOpacity!=null){l.node.userData.opacity*=l.node.userData.offsetOpacity;}}};c.forEach(function(l,s){var v=j.get(l);if(v){v.forEach(function(w){k(w,i[s]);});}});return this;};q.prototype._updateMaterialInNode=function(c){var j=c.target;for(var i=0,l=j.children.length;i<l;i++){var k=j.children[i];if(k.userData.animatedColor){k._vkUpdateMaterialColor();}}var s=c.materialId;if(j.userData.materialId!==s){j.userData.materialId=s;this._scene._setNodeMaterial(j,s);}};function u(c){return new THREE.Matrix4().set(c[0],c[1],c[2],c[3],c[4],c[5],c[6],c[7],c[8],c[9],c[10],c[11],0,0,0,1);}q.prototype._resetNodesStatusByCurrenView=function(v,s,c){var i=this.getNodeHierarchy();if(i){var j;if(v){j=v.getPlaybacks();}var k=v.getNodeInfos();if(k){this._nodesTransitionHelper.clear();var l={nodeRefs:[],positions:[]};var w=new THREE.Vector3();var x=new THREE.Quaternion();var y=new THREE.Vector3();k.forEach(function(C){if(C.target===null){return;}if(C.transform){var D=u(C.transform);if(!o.equalMatrices(D,C.target.matrix,1e-6)){if((!j||!j.length)&&c){var E=i.createNodeProxy(C.target);this._nodesTransitionHelper.setNodeForDisplay(E,D);}else{D.decompose(w,x,y);l.nodeRefs.push(C.target);l.positions.push({translation:w.toArray(),quaternion:x.toArray(),scale:y.toArray()});}}}else if(C[A.Scale]&&C[A.Rotate]&&C[A.Translate]){l.nodeRefs.push(C.target);l.positions.push({translation:C[A.Translate].slice(),quaternion:C[A.Rotate].slice(),scale:C[A.Scale].slice()});}}.bind(this));if(v.userData&&v.userData.nodeStartDataByAnimation){v.userData.nodeStartDataByAnimation.forEach(function(C,D){if(C[A.Translate]&&C[A.Rotate]&&C[A.Scale]){l.nodeRefs.push(D);l.positions.push({translation:C[A.Translate].slice(),quaternion:C[A.Rotate].slice(),scale:C[A.Scale].slice()});}},this);}if(l.nodeRefs.length){this.setTransformation(l.nodeRefs,l.positions);}if(s){var z=[];var B=[];k.forEach(function(C){(C.visible?z:B).push(C.target);});this.setVisibilityState(i.getChildren()[0].children,false,true);this.setVisibilityState(z,true,false);this.setVisibilityState(B,false,false);this._startViewChangeNodeTransition();}}}};q.prototype._startViewChangeNodeTransition=function(){this._nodesTransitionHelper.startDisplay(500);var c=true;this._nodesTransitionHelper.attachEventOnce("displayed",function(){c=false;});var i=function(){if(c){this._nodesTransitionHelper.displayNodesMoving();window.requestAnimationFrame(i);}}.bind(this);window.requestAnimationFrame(i);};q.prototype._resetNodesMaterialAndOpacityByCurrenView=function(v){if(!v){return;}var c=v.getNodeInfos();if(c){c.forEach(function(j){if(!j.target){return;}this._updateMaterialInNode(j);}.bind(this));c.forEach(function(j){if(!j.target||!j.target.userData){return;}j.target.userData.opacity=j.opacity;});var i=this._scene.getSceneRef();i._vkSetOpacity(undefined,this._jointCollection);}this._selectedNodes.forEach(function(j){this._updateHighlightColor(j);}.bind(this));};q.prototype._onViewActivated=function(c,i,j){var v=this.getViewManager();if(!v||j.source.getId()!==v){return;}this.activateView(j.view,false,j.playViewGroup,j.notAnimateCameraChange);};q.prototype.activateView=function(v,i,c,j){this.fireViewStateApplying({view:v});this.setJoints(undefined);this._resetNodesMaterialAndOpacityByCurrenView(v);this._resetTransitionHighlight(v);this._resetNodesStatusByCurrenView(v,true,true);this._highlightPlayer.reset(v,this._scene);this.fireViewStateApplied({view:v,ignoreAnimationPosition:i,notAnimateCameraChange:j,playViewGroup:c});a.getEventBus().publish("sap.ui.vk","viewStateApplied",{source:this,view:v,ignoreAnimationPosition:i,notAnimateCameraChange:j,playViewGroup:c});return this;};q.prototype.setHighlightDisplayState=function(s){if(s===h.playing){this._highlightPlayer.start((new Date()).getTime());}else if(s===h.stopped){this._highlightPlayer.stop();}else if(s===h.pausing){this._highlightPlayer.pause((new Date()).getTime());}this.fireHighlightColorChanged({highlightColor:d(e(this._highlightColorABGR)),highlightColorABGR:this._highlightColorABGR});return this;};q.prototype._startHighlight=function(){this._highlightPlayer.start((new Date()).getTime());return this;};q.prototype._playHighlight=function(){return this._highlightPlayer.play((new Date()).getTime());};q.prototype._resetTransitionHighlight=function(v){this._transitionHighlightPlayer.reset();this._transitionHighlightPlayer.fadeInNodes=[];this._transitionHighlightPlayer.fadeOutNodes=[];this._transitionHighlightPlayer.setViewStateManager(this);var c=v.getNodeInfos();if(!c){return;}var j=function(w,x,y){if(!w||!w.length){return;}for(var i=0;i<w.length;i++){var z=w[i];if(z.type==="Mesh"&&(!y||(y&&!y.includes(z)))){x.push(z);}j(z.children,x,y);}};var k=[];var l=[];var s=this;c.forEach(function(i){var w=i.target;var x=w.layers.test(s._layers);if(x&&!i.visible){k.push(w);}if(!x&&i.visible){l.push(w);}});j(l,this._transitionHighlightPlayer.fadeInNodes);j(k,this._transitionHighlightPlayer.fadeOutNodes,this._transitionHighlightPlayer.fadeInNodes);};q.prototype._startTransitionHighlight=function(c){var i=this._transitionHighlightPlayer.fadeInNodes;var j=this._transitionHighlightPlayer.fadeOutNodes;if(i&&i.length){var k=new m("FadeIn",{duration:c/500.0,opacities:[0.0,1.0],cycles:1});this._transitionHighlightPlayer.addHighlights(k,i);}if(j&&j.length){var l=new m("FadeOut",{duration:c/500.0,opacities:[1.0,0.0],cycles:1,fadeOut:true});this._transitionHighlightPlayer.addHighlights(l,j);}if((i&&i.length)||(j&&j.length)){this._transitionHighlightPlayer.start((new Date()).getTime());this._transitionHighlightPlayer.play((new Date()).getTime());return c;}else{return 0;}return 0;};q.prototype._playTransitionHighlight=function(){return this._transitionHighlightPlayer.play((new Date()).getTime());};q.prototype.updateRestTransformation=function(c){var i=this.getCurrentView();if(!i){return this;}var j=i.getNodeInfos();if(j){j.forEach(function(k){if(k.target!==c){return;}c.updateMatrix();var l=c.matrix.elements;var v=[l[0],l[4],l[8],l[12],l[1],l[5],l[9],l[13],l[2],l[6],l[10],l[14]];k.transform=v;});}if(this._jointCollection&&this._jointCollection.length>0){this._jointCollection.forEach(function(k){if(!k.node||!k.parent){return;}if(k.parent===c||k.node===c){k.translation=null;k.scale=null;k.quaternion=null;if(k.node.userData){k.node.userData.offsetTranslation=null;k.node.userData.offsetQuaternion=null;k.node.userData.offsetScale=null;k.node.userData.originalRotationType=null;}}});this._jointCollection.forEach(function(k){if(!k.node||!k.parent){return;}if(k.parent===c){this._updateJointNode(k,this._playbackAssociatedWithJoints);this.restoreRestTransformation(k.node);}}.bind(this));this._jointCollection.forEach(function(k){if(!k.node||!k.parent){return;}if(k.node===c){this._updateJointNode(k,this._playbackAssociatedWithJoints);}},this);if(this._playbackAssociatedWithJoints){var s=this._playbackAssociatedWithJoints.getSequence();if(s){s._fireSequenceChanged();}}}return this;};q.prototype.restoreRestTransformation=function(c){var i=this.getCurrentView();if(!i){return this;}var j=i.getNodeInfos();if(j){j.forEach(function(l){if(l.target!==c){return;}if(l.transform){var s=u(l.transform);s.decompose(c.position,c.quaternion,c.scale);}else if(l[A.Scale]&&l[A.Rotate]&&l[A.Translate]){c.position.set(l[A.Translate][0],l[A.Translate][1],l[A.Translate][2]);c.quaternion.set(l[A.Rotate][0],l[A.Rotate][1],l[A.Rotate][2],l[A.Rotate][3]);c.scale.set(l[A.Scale][0],l[A.Scale][1],l[A.Scale][2]);}c.updateMatrix();});}var k={changed:[c],transformation:[{position:c.position.toArray(),quaternion:c.quaternion.toArray(),scale:c.scale.toArray()}]};this.fireTransformationChanged(k);return this;};q.prototype.setRestTransformation=function(c,i,j,s){var k=this.getCurrentView();if(!k){return this;}var l=k.getNodeInfos();if(l){l.forEach(function(w){if(w.target!==c){return;}if(!i||!j||!s){if(w.transform){var x=new THREE.Vector3();var y=new THREE.Quaternion();var z=new THREE.Vector3();var B=u(w.transform);B.decompose(x,y,z);if(!i){i=[x.x,x.y,x.z];}if(!s){s=[z.x,z.y,z.z];}if(!j){j=[y.x,y.y,y.z,y.w];}}else if(w[A.Scale]&&w[A.Rotate]&&w[A.Translate]){if(!i){i=w[A.Translate].slice();}if(!s){s=w[A.Scale].slice();}if(!j){j=w[A.Rotate].slice();}}}var C=new THREE.Vector3(i[0],i[1],i[2]);var D=new THREE.Quaternion(j[0],j[1],j[2],j[3]);var E=new THREE.Vector3(s[0],s[1],s[2]);var F=new THREE.Matrix4();F.compose(C,D,E);var G=F.elements;w.transform=[G[0],G[4],G[8],G[12],G[1],G[5],G[9],G[13],G[2],G[6],G[10],G[14]];});}if(this._jointCollection&&this._jointCollection.length>0){this._jointCollection.forEach(function(w){if(!w.node||!w.parent){return;}if(w.parent===c||w.node===c){w.translation=null;w.scale=null;w.quaternion=null;if(w.node.userData){w.node.userData.offsetTranslation=null;w.node.userData.offsetQuaternion=null;w.node.userData.offsetScale=null;w.node.userData.originalRotationType=null;}}});this._jointCollection.forEach(function(w){if(!w.node||!w.parent){return;}if(w.parent===c){this._updateJointNode(w,this._playbackAssociatedWithJoints);this.restoreRestTransformation(w.node);}},this);this._jointCollection.forEach(function(w){if(!w.node||!w.parent){return;}if(w.node===c){this._updateJointNode(w,this._playbackAssociatedWithJoints);}},this);if(this._playbackAssociatedWithJoints){var v=this._playbackAssociatedWithJoints.getSequence();if(v){v._fireSequenceChanged();}}}return this;};q.prototype.getRestOpacity=function(c){var j;var k=this.getCurrentView();if(k){j=k.getNodeInfos();}var l=1;if(j&&j.length){for(var i=0;i<j.length;i++){var s=j[i];if(s.target!==c){continue;}if(s.opacity!==undefined&&s.opacity!==null){l=s.opacity;}break;}}return l;};q.prototype.setRestOpacity=function(c,i){var j;var k=this.getCurrentView();if(k){j=k.getNodeInfos();}if(j){j.forEach(function(l){if(l.target!==c){return;}l.opacity=i;});}return this;};q.prototype.restoreRestOpacity=function(c){var i;var j=this.getCurrentView();if(j){i=j.getNodeInfos();}if(i){i.forEach(function(k){if(k.target!==c){return;}var l=1;if(k.opacity!==undefined){l=k.opacity;}this.setOpacity(c,l);}.bind(this));}if(this._jointCollection&&this._jointCollection.length>0){this._jointCollection.forEach(function(k){if(!k.node||!k.parent){return;}if(k.parent===c||k.node===c){k.opacity=null;if(k.node.userData){k.node.userData.offsetOpacity=null;}}});this._jointCollection.forEach(function(k){if(!k.node||!k.parent){return;}if(k.parent===c){this._updateJointNode(k,this._playbackAssociatedWithJoints);this.restoreRestOpacity(k.node);}},this);this._jointCollection.forEach(function(k){if(!k.node||!k.parent){return;}if(k.node===c){this._updateJointNode(k,this._playbackAssociatedWithJoints);}},this);if(this._playbackAssociatedWithJoints){var s=this._playbackAssociatedWithJoints.getSequence();if(s){s._fireSequenceChanged();}}}return this;};q.prototype.updateRestOpacity=function(c){var i;var j=this.getCurrentView();if(j){i=j.getNodeInfos();}if(i){i.forEach(function(k){if(k.target!==c){return;}if(c.userData&&c.userData.opacity!==undefined&&c.userData.opacity!==null){k.opacity=c.userData.opacity;}else{delete k.opacity;}});}if(this._jointCollection&&this._jointCollection.length>0){this._jointCollection.forEach(function(k){if(!k.node||!k.parent){return;}if(k.parent===c||k.node===c){k.opacity=null;if(k.node.userData){k.node.userData.offsetOpacity=null;}}});this._jointCollection.forEach(function(k){if(!k.node||!k.parent){return;}if(k.node===c){this._updateJointNode(k,this._playbackAssociatedWithJoints);}},this);if(this._playbackAssociatedWithJoints){var s=this._playbackAssociatedWithJoints.getSequence();if(s){s._fireSequenceChanged();}}}return this;};q.prototype.getRestTransformationWorld=function(c){var j;var k=this.getCurrentView();if(k){j=k.getNodeInfos();}var l;if(j){var w=new THREE.Matrix4();while(c){for(var i=0;i<j.length;i++){var s=j[i];if(s.target!==c){continue;}var v;if(s.transform){v=u(s.transform);}else if(s[A.Scale]&&s[A.Rotate]&&s[A.Translate]){var x=new THREE.Vector3(s[A.Translate][0],s[A.Translate][1],s[A.Translate][2]);var y=new THREE.Quaternion(s[A.Rotate][0],s[A.Rotate][1],s[A.Rotate][2],s[A.Rotate][3]);var z=new THREE.Vector3(s[A.Scale][0],s[A.Scale][1],s[A.Scale][2]);v=new THREE.Matrix4().compose(x,y,z);}if(v){w.premultiply(v);}break;}c=c.parent;}var B=new THREE.Vector3();var C=new THREE.Quaternion();var D=new THREE.Vector3();w.decompose(B,C,D);l={};l.translation=B.toArray();l.quaternion=C.toArray();l.scale=D.toArray();}if(!l){l=this.getTransformationWorld(c);}return l;};q.prototype.getRestTransformation=function(c){var i;var j=this.getCurrentView();if(j){i=j.getNodeInfos();}var k;if(i){i.forEach(function(l){if(l.target!==c){return;}if(l.transform){var s=new THREE.Vector3();var v=new THREE.Quaternion();var w=new THREE.Vector3();var x=u(l.transform);x.decompose(s,v,w);k={};k.translation=s.toArray();k.quaternion=v.toArray();k.scale=w.toArray();}else if(l[A.Scale]&&l[A.Rotate]&&l[A.Translate]){k={};k.translation=l[A.Translate].slice();k.quaternion=l[A.Rotate].slice();k.scale=l[A.Scale].slice();}});}if(!k&&c){k={};k.translation=c.userData.position?c.userData.position.toArray():c.position.toArray();k.quaternion=c.userData.quaternion?c.userData.quaternion.toArray():c.quaternion.toArray();k.scale=c.userData.scale?c.userData.scale.toArray():c.scale.toArray();k.matrix=c.matrix.clone();}return k;};q.prototype._addToTransformation=function(c,j,k,s,l,v){var w={};var i;if(j){w.translation=[];for(i=0;i<3;i++){w.translation.push(j[i]+c.translation[i]);}}else{w.translation=c.translation;}if(s){w.scale=[];for(i=0;i<3;i++){w.scale.push(s[i]*c.scale[i]);}}else{w.scale=c.scale;}if(k){var x=new THREE.Quaternion(c.quaternion[0],c.quaternion[1],c.quaternion[2],c.quaternion[3]);var y=new THREE.Quaternion(k[0],k[1],k[2],k[3]);if(l===R.Euler){var z=v?v[3]:6;var B=o.threeQuatToNeutralEuler(x,z);var C=v?v:o.threeQuatToNeutralEuler(y,z);B[0]+=C[0];B[1]+=C[1];B[2]+=C[2];w.quaternion=o.glMatrixQuatToNeutral(o.neutralEulerToGlMatrixQuat(B));}else{var D=new THREE.Matrix4().makeRotationFromQuaternion(x);var E=new THREE.Matrix4().makeRotationFromQuaternion(y);D.premultiply(E);x.setFromRotationMatrix(D);w.quaternion=[x.x,x.y,x.z,x.w];}}else{w.quaternion=c.quaternion;}return w;};q.prototype.setInterpolatedRelativeValues=function(c,v){if(!c.userData){c.userData={};}if(v.rtranslate){c.userData.offsetTranslation=v.rtranslate;}else{c.userData.offsetTranslation=null;}if(v.rscale){c.userData.offsetScale=v.rscale;}else{c.userData.offsetScale=null;}if(v.rrotate){c.userData.offsetQuaternion=v.rrotate;c.userData.originalRotationType=v.originalRotationType;}else{c.userData.offsetQuaternion=null;c.userData.originalRotationType=null;}if(v.Euler){c.userData.Euler=v.Euler;}else{c.userData.Euler=null;}if(v.ropacity!=null){c.userData.offsetOpacity=v.ropacity;}else{c.userData.offsetOpacity=null;}return this;};q.prototype._setJointNodeMatrix=function(){if(this._jointCollection&&this._jointCollection.length>0){this._jointCollection.forEach(function(j){if(!j.node||!j.parent){return;}var c=j.node;if(c.userData.skipUpdateJointNode){return;}var i={};i.translation=j.translation.slice();i.scale=j.scale.slice();i.quaternion=j.quaternion.slice();var k=this._addToTransformation(i,c.userData.offsetTranslation,c.userData.offsetQuaternion,c.userData.offsetScale,c.userData.originalRotationType,c.userData.Euler);c.position.fromArray(k.translation);c.scale.fromArray(k.scale);c.quaternion.fromArray(k.quaternion);c.updateMatrix();var l=c.quaternion.clone();var s=new THREE.Matrix4();if(j.parent){j.parent.updateMatrixWorld();s=j.parent.matrixWorld.clone();c.matrixWorld.multiplyMatrices(j.parent.matrixWorld,c.matrix);}else{c.matrixWorld.copy(c.matrix);}var v=new THREE.Matrix4();if(c.parent){v=c.parent.matrixWorld.clone();c.matrix.getInverse(c.parent.matrixWorld).multiply(c.matrixWorld);}else{c.matrix.copy(c.matrixWorld);}c.matrix.decompose(c.position,c.quaternion,c.scale);var w=[c.scale.x,c.scale.y,c.scale.z];this._adjustQuaternionAndScale(s,v,l,c.quaternion,k.scale,w);c.scale.x=w[0];c.scale.y=w[1];c.scale.z=w[2];if(j.nodesToUpdate){j.nodesToUpdate.forEach(function(x){if(x.matrixAutoUpdate){x.updateMatrix();}x.matrixWorld.multiplyMatrices(x.parent.matrixWorld,x.matrix);});}}.bind(this));}};q.prototype._getEndPropertyInLastPlayback=function(c,i){var j;var l=this.getCurrentView();if(!l){return j;}var s=l.getPlaybacks();if(!s||!s.length){return j;}for(var k=s.length-1;k>=0;k--){var v=s[k];var w=v.getSequence();if(w._convertedFromAbsolute){return j;}j=v.getNodeBoundaryProperty(c,i,true);if(j){break;}}return j;};q.prototype._getEndPropertyInPreviousPlayback=function(c,k,l,s){var v;var w=this._getJointByChildNode(c);if(w&&!s){return v;}var x=l.getSequence();if(x&&x._convertedFromAbsolute){return v;}var y=this.getCurrentView();if(!y){return v;}var z=y.getPlaybacks();for(var i=1;i<z.length;i++){var B=z[i];if(B!==l){continue;}for(var j=i-1;j>=0;j--){var C=z[j];v=C.getNodeBoundaryProperty(c,k,true);if(v){break;}}}return v;};q.prototype._convertTracksToRelative=function(s,c){if((c&&s._convertionDoneForReversed)||(!c&&s._convertionDone)){return this;}s._convertedFromAbsolute=false;var l=this.getCurrentView();if(!l){return this;}var v=s.getNodeAnimation();if(!v||!v.length){return this;}var w=l.getNodeInfos();if(w){w.forEach(function(x){var y;for(var i=0;i<v.length;i++){if(x.target===v[i].nodeRef){y=v[i];break;}}if(!y){return;}var z=[0,0,0];var B=[1,1,1];var C=new THREE.Quaternion();var D=new THREE.Vector3();var E=new THREE.Vector3();if(x.transform){var F=u(x.transform);F.decompose(D,C,E);z=D.toArray();B=E.toArray();}else if(x[A.Scale]&&x[A.Rotate]&&x[A.Translate]){z=x[A.Translate].slice();C=new THREE.Quaternion(x[A.Rotate][0],x[A.Rotate][1],x[A.Rotate][2],x[A.Rotate][3]);B=x[A.Scale].slice();}else{x.target.matrix.decompose(D,C,E);z=D.toArray();B=E.toArray();}var j,G,I,J;var K=y[A.Translate];if(K&&K.getIsAbsoluteValue()){G=K.getKeysCount();for(j=0;j<G;j++){I=K.getKey(j);J=[I.value[0]-z[0],I.value[1]-z[1],I.value[2]-z[2]];K.updateKey(j,J,true);}K.setIsAbsoluteValue(false);s._convertedFromAbsolute=true;}var L=y[A.Scale];if(L&&L.getIsAbsoluteValue()){G=L.getKeysCount();for(j=0;j<G;j++){I=L.getKey(j);J=[I.value[0]/B[0],I.value[1]/B[1],I.value[2]/B[2]];L.updateKey(j,J,true);}L.setIsAbsoluteValue(false);s._convertedFromAbsolute=true;}var M=y[A.Opacity];if(M&&M.getIsAbsoluteValue()){var P=this.getRestOpacity(x.target);if(!P){P=1.0;}G=M.getKeysCount();for(j=0;j<G;j++){I=M.getKey(j);J=I.value/P;M.updateKey(j,J,true);}M.setIsAbsoluteValue(false);s._convertedFromAbsolute=true;}var Q=y[A.Rotate];if(Q&&Q.getIsAbsoluteValue()){var T;var U=new THREE.Matrix4().makeRotationFromQuaternion(C);var W=new THREE.Matrix4().getInverse(U);var X=new THREE.Matrix4();var Y=new THREE.Matrix4();G=Q.getKeysCount();var Z=Q.getKeysType();for(j=0;j<G;j++){I=Q.getKey(j);if(Z===n.Quaternion){T=new THREE.Quaternion(I.value[0],I.value[1],I.value[2],I.value[3]);X.makeRotationFromQuaternion(T);Y.multiplyMatrices(X,W);T.setFromRotationMatrix(Y);J=T.toArray();Q.updateKey(j,J,true);}else if(Z===n.Euler){var k=I.value;var $=o.threeQuatToNeutralEuler(C,k[3]);J=[k[0]-$[0]+o.getModulatedAngularValue(k[0]),k[1]-$[1]+o.getModulatedAngularValue(k[1]),k[2]-$[2]+o.getModulatedAngularValue(k[2]),k[3]];Q.updateKey(j,J,true);}else if(j===0){var _=new THREE.Vector3(I.value[0],I.value[1],I.value[2]);X.makeRotationAxis(_,I.value[3]);Y.multiplyMatrices(X,W);T=new THREE.Quaternion().setFromRotationMatrix(Y);J=this._convertQuaternionToAngleAxis(T);Q.updateKey(j,J,true);break;}}Q.setIsAbsoluteValue(false);s._convertedFromAbsolute=true;}}.bind(this));}if(!c){s._convertionDone=true;s._convertionDoneForReversed=false;}else{s._convertionDone=false;s._convertionDoneForReversed=true;}return this;};q.prototype._getTrackKeys=function(c){var k=[];var i=c.getKeysCount();for(var j=0;j<i;j++){var l=c.getKey(j);var v;if(Array.isArray(l.value)){v=l.value.slice();}else{v=l.value;}k.push({time:l.time,value:v});}return k;};q.prototype._setJointNodeOffsets=function(c,i){var j=this._getJointByChildNode(c);if(j){var k=new THREE.Matrix4();if(c.parent){k=c.parent.matrixWorld.clone();}var l=new THREE.Matrix4();c.updateMatrixWorld();var s=new THREE.Matrix4();if(j.parent){j.parent.updateMatrixWorld();s=j.parent.matrixWorld.clone();l.getInverse(j.parent.matrixWorld).multiply(c.matrixWorld);}else{l.copy(c.matrixWorld);}var v=new THREE.Vector3();var w=new THREE.Vector3();var x=new THREE.Quaternion();l.decompose(v,x,w);if(i===A.Translate){var y=v.toArray();c.userData.offsetTranslation=[y[0]-j.translation[0],y[1]-j.translation[1],y[2]-j.translation[2]];}else if(i===A.Scale){var z=w.toArray();this._adjustQuaternionAndScale(k,s,c.quaternion,x,c.scale.toArray(),z);c.userData.offsetScale=[z[0]/j.scale[0],z[1]/j.scale[1],z[2]/j.scale[2]];}else{this._adjustQuaternionAndScale(k,s,c.quaternion,x,c.scale.toArray(),w.toArray());var B=new THREE.Quaternion(j.quaternion[0],j.quaternion[1],j.quaternion[2],j.quaternion[3]);var C=new THREE.Matrix4().makeRotationFromQuaternion(B);var D=new THREE.Matrix4().getInverse(C);var M=new THREE.Matrix4().makeRotationFromQuaternion(x);var E=new THREE.Matrix4().multiplyMatrices(M,D);var F=new THREE.Quaternion().setFromRotationMatrix(E);c.userData.offsetQuaternion=F.toArray();}}return this;};q.prototype.setTranslationKey=function(c,i,j,k){var s=j.getSequence();if(!s){return null;}var l;var v=new THREE.Vector3();c.matrix.decompose(v,new THREE.Quaternion(),new THREE.Vector3());var w=this._getJointByChildNode(c);if(w){l=w.translation.slice();c.updateMatrixWorld();var x=new THREE.Matrix4();if(w.parent){w.parent.updateMatrixWorld();x.getInverse(w.parent.matrixWorld).multiply(c.matrixWorld);}else{x.matrix.copy(c.matrixWorld);}x.decompose(v,new THREE.Quaternion(),new THREE.Vector3());}else{var y=this.getRestTransformation(c);l=y.translation;}var z=v.toArray();var B=[z[0]-l[0],z[1]-l[1],z[2]-l[2]];var C=this._getEndPropertyInPreviousPlayback(c,A.Translate,j);if(C){B[0]-=C[0];B[1]-=C[1];B[2]-=C[2];}var D=s.getNodeAnimation(c,A.Translate);var E;if(!D){D=this._scene.createTrack(null,{trackValueType:n.Vector3,isAbsoluteValue:false});s.setNodeAnimation(c,A.Translate,D,true);}else{E=this._getTrackKeys(D);}D.insertKey(i,B,k);var F=this._getTrackKeys(D);return{KeyValue:B,absoluteValue:z,offset:C,PreviousTrack:E,CurrentTrack:F};};q.prototype._adjustQuaternionAndScale=function(c,j,k,l,s,w){function x(v,P,Q,T){var U=Math.abs(v.dot(P));var W=Math.abs(v.dot(Q));var X=Math.abs(v.dot(T));if(U>=W&&U>=X){return 0;}else if(W>=U&&W>=X){return 1;}else{return 2;}}if(s[0]>0&&s[1]>0&&s[2]>0){return;}var y=c.clone().multiply(new THREE.Matrix4().makeRotationFromQuaternion(k));var z=new THREE.Matrix4().makeRotationFromQuaternion(l);var B=j.clone().multiply(z);var C=new THREE.Vector3();var D=new THREE.Vector3();var E=new THREE.Vector3();y.extractBasis(C,D,E);var F=[C,D,E];var G=new THREE.Vector3();var I=new THREE.Vector3();var J=new THREE.Vector3();B.extractBasis(G,I,J);var K=[1,1,1];for(var i=0;i<3;i++){var L=x(F[i],G,I,J);if(s[i]*w[L]<0){K[L]=-1;w[L]=-w[L];}}z.scale(new THREE.Vector3(K[0],K[1],K[2]));var M=new THREE.Quaternion().setFromRotationMatrix(z);l.x=M.x;l.y=M.y;l.z=M.z;l.w=M.w;};q.prototype.setScaleKey=function(c,i,j,k){var s=j.getSequence();if(!s){return null;}var l;var v=c.scale.toArray();var w=c.quaternion.clone();var x=this._getJointByChildNode(c);if(x){var y=new THREE.Matrix4();if(c.parent){y=c.parent.matrixWorld.clone();}l=x.scale.slice();c.updateMatrixWorld();var z=new THREE.Matrix4();var B=new THREE.Matrix4();if(x.parent){x.parent.updateMatrixWorld();B=x.parent.matrixWorld.clone();z.getInverse(x.parent.matrixWorld).multiply(c.matrixWorld);}else{z.copy(c.matrixWorld);}var C=new THREE.Quaternion();var D=new THREE.Vector3();z.decompose(new THREE.Vector3(),C,D);var E=D.toArray();this._adjustQuaternionAndScale(y,B,w,C,v,E);v=E;}else{var F=this.getRestTransformation(c);l=F.scale;}var G=[v[0]/l[0],v[1]/l[1],v[2]/l[2]];var I=this._getEndPropertyInPreviousPlayback(c,A.Scale,j);if(I){G[0]/=I[0];G[1]/=I[1];G[2]/=I[2];}var J=s.getNodeAnimation(c,A.Scale);var K;if(!J){J=this._scene.createTrack(null,{trackValueType:n.Vector3,isAbsoluteValue:false});s.setNodeAnimation(c,A.Scale,J,true);}else{K=this._getTrackKeys(J);}J.insertKey(i,G,k);var L=this._getTrackKeys(J);return{KeyValue:G,absoluteValue:v,offset:I,PreviousTrack:K,CurrentTrack:L};};q.prototype.setRotationKey=function(c,i,j,k,l){var s=k.getSequence();if(!s){return null;}var v=36;var w=[j[0],j[1],j[2],v];var x=s.getNodeAnimation(c,A.Rotate);if(x&&x.getKeysType()!==n.Euler){return null;}var y;if(!x){x=this._scene.createTrack(null,{trackValueType:n.Euler,isAbsoluteValue:false});s.setNodeAnimation(c,A.Rotate,x,true);}else{y=this._getTrackKeys(x);}x.insertKey(i,w,l);var z=this._getTrackKeys(x);var B=new THREE.Quaternion();var C=new THREE.Euler(j[0],j[1],j[2]);B.setFromEuler(C);var D=this._getEndPropertyInPreviousPlayback(c,A.Rotate,k);if(D){var E=new THREE.Quaternion(D[0],D[1],D[2],D[3]);B.multiply(E);}var F=this._getJointByChildNode(c);var G=new THREE.Quaternion();if(F){G.fromArray(F.quaternion);}else{var I=this.getRestTransformation(c);G.fromArray(I.quaternion);}B.multiply(G);return{KeyValue:w,absoluteValue:B.toArray(),offset:D,PreviousTrack:y,CurrentTrack:z};};q.prototype.setAxisAngleRotationKey=function(c,i,j,k,l){var s=k.getSequence();if(!s){return null;}var v=s.getNodeAnimation(c,A.Rotate);if(v&&v.getKeysType()!==n.AngleAxis){if(!v.setKeysType(n.AngleAxis)){return null;}}var w=[j[0],j[1],j[2],j[3]];var x;if(!v){v=this._scene.createTrack(null,{trackValueType:n.AngleAxis,isAbsoluteValue:false});s.setNodeAnimation(c,A.Rotate,v,true);}else{x=this._getTrackKeys(v);}v.insertKey(i,w,l);var y=this._getTrackKeys(v);return{KeyValue:w,PreviousTrack:x,CurrentTrack:y};};q.prototype.getTotalOpacity=function(c){return c._vkGetTotalOpacity(this._jointCollection);};q.prototype.setTotalOpacity=function(c,i){var j=1;var k=this._getJointByChildNode(c);if(k&&k.parent){j=k.parent._vkGetTotalOpacity(this._jointCollection);}else if(c.parent){j=c.parent._vkGetTotalOpacity(this._jointCollection);}if(!c.userData){c.userData={};}var l=this.getOpacity(c);if(j!==0.0){l=i/j;}else{i=0.0;}c._vkSetOpacity(l,this._jointCollection);var s={changed:c,opacity:l};this.fireOpacityChanged(s);return{opacity:l,totalOpacity:i};};q.prototype.setOpacityKey=function(c,i,j,k){var s=j.getSequence();if(!s){return null;}var v=1;if(c.userData&&c.userData.opacity!==undefined&&c.userData.opacity!==null){v=c.userData.opacity;}var l=this.getRestOpacity(c);if(!l&&s._convertedFromAbsolute){l=1;}v/=l;var w=this._getEndPropertyInPreviousPlayback(c,A.Opacity,j);if(w){v/=w;}var x=s.getNodeAnimation(c,A.Opacity);var y;if(!x){x=this._scene.createTrack(null,{trackValueType:n.Opacity});s.setNodeAnimation(c,A.Opacity,x,true);}else{y=this._getTrackKeys(x);}x.insertKey(i,v,k);var z=this._getTrackKeys(x);return{KeyValue:v,totalOpacity:this.getTotalOpacity(c),PreviousTrack:y,CurrentTrack:z};};p=function(){this._visibilityChanges=new Set();};p.prototype.getInfo=function(c){var i=[];this._visibilityChanges.forEach(function(j){var k=c.createNodeProxy(j);var v=k.getVeId();c.destroyNodeProxy(k);if(v){i.push(v);}else{i.push(c.getScene().nodeRefToPersistentId(j));}});return i;};p.prototype.clear=function(){this._visibilityChanges.clear();};p.prototype.trackNodeRef=function(c){if(this._visibilityChanges.has(c)){this._visibilityChanges.delete(c);}else{this._visibilityChanges.add(c);}};return q;});
