/*
 * ! SAPUI5

		(c) Copyright 2009-2020 SAP SE. All rights reserved
	
 */
sap.ui.define(["sap/m/library","sap/m/List","sap/m/Popover","sap/m/StandardListItem",'sap/m/MultiInput','sap/m/MultiComboBox','sap/m/Token','sap/m/Tokenizer','sap/ui/comp/smartfield/SmartField','sap/ui/comp/odata/MetadataAnalyser',"sap/ui/model/ParseException","sap/ui/model/ValidateException",'sap/ui/model/BindingMode','sap/ui/comp/odata/ODataType','sap/ui/comp/providers/ValueHelpProvider',"sap/ui/comp/util/FormatUtil","sap/ui/core/format/DateFormat","sap/ui/comp/smartfilterbar/FilterProvider","sap/base/Log","sap/base/util/deepEqual","sap/ui/comp/library","sap/ui/core/library","sap/ui/core/ResizeHandler","sap/base/util/isEmptyObject"],function(M,L,P,S,a,b,T,c,d,e,f,V,B,O,g,F,D,h,j,k,l,m,R,n){"use strict";var o=l.valuehelpdialog.ValueHelpRangeOperation;var p=l.smartfilterbar.DisplayBehaviour;var q=m.ValueState;var r=M.PlacementType;var I="-mInput";var s="-mInputTokenizer";var t=d.extend("sap.ui.comp.smartmultiinput.SmartMultiInput",{metadata:{library:"sap.ui.comp",properties:{supportRanges:{type:"boolean",defaultValue:false},supportMultiSelect:{type:"boolean",defaultValue:true},enableODataSelect:{type:"boolean",defaultValue:false},requestAtLeastFields:{type:"string",defaultValue:""}},events:{beforeCreate:{allowPreventDefault:true,parameters:{oData:{type:"object"},mParameters:{type:"object"}}},beforeRemove:{allowPreventDefault:true,parameters:{mParameters:{type:"object"}}},tokenUpdate:{parameters:{type:{type:"string"},addedTokens:{type:"sap.m.Token[]"},removedTokens:{type:"sap.m.Token[]"}}},selectionChange:{parameters:{changedItem:{type:"sap.ui.core.Item"},selected:{type:"boolean"}}}}},renderer:function(i,C){d.getMetadata().getRenderer().render(i,C);}});t.prototype.getTokens=function(){if(this._isReadMode()&&this._oTokenizer){return this._oTokenizer.getTokens();}else if(this._oMultiComboBox){return this._oMultiComboBox.getAggregation("tokenizer").getTokens();}else if(this._oMultiInput){return this._oMultiInput.getTokens();}};t.prototype.getValue=function(){return this.getTokens();};t.prototype._createMultiInput=function(){var A=this._createAttributes();this._oMultiInput=new a(this.getId()+I,A);this._oMultiInput.attachChange(function(E){this._validateValueOnChange(E.getParameter("value"));},this);if(this.getBindingContext()){this._bindMultiInput();}this._oMultiInput.attachTokenUpdate(function(E){this._validateValueOnChange(this._oMultiInput.getValue());var v=E.getParameters();delete v.id;this.fireTokenUpdate(v);},this);var i={control:this._oMultiInput,onCreate:"_onMultiInputCreate",params:{type:{type:this._getType(),property:this._oFactory._oMetaData.property}}};this._initMultiInputValueHelp(i);return i;};t.prototype._createMultiComboBox=function(){var A=this._createAttributes();this._oMultiComboBox=new b(this.getId()+"mComboBox",A);if(this.getBindingContext()){this._bindMultiComboBox();}else{this._oMultiInput=this._oMultiComboBox._oTokenizer;}this._oMultiComboBox.attachSelectionChange(function(E){var v=E.getParameters();delete v.id;this.fireSelectionChange(v);},this);var i={control:this._oMultiComboBox,onCreate:"_onCreate",params:{type:{type:this._getType(),property:this._oFactory._oMetaData.property},valuehelp:{annotation:this._getValueListAnnotation(),aggregation:"items",noDialog:true,noTypeAhead:true}}};return i;};t.prototype._createAttributes=function(){var N={width:true,textAlign:true,placeholder:true,tooltip:true,name:true,valueState:true,valueStateText:true};var A=this._oFactory.createAttributes(null,this._oFactory._oMetaData.property,N,{event:"change",parameter:"value"});return A;};function u(C){var v=C.getParameter("tokens"),w,K,i=0,x=[],y=null,z;this._onCancel();if(this.oControl instanceof sap.m.MultiInput){this.oControl.setValue("");var A=this.oControl.getTokens();var E=[];var G=[];var N=[];A.forEach(function(H){var J=v.some(function(U){return H.getKey()===U.getKey();});if(!J){G.push(H);}else{var Q=v.filter(function(U){return H.getKey()===U.getKey();})[0];N.push(Q);}});v.forEach(function(H){var J=A.some(function(Q){return Q.getKey()===H.getKey();});if(!J){E.push(H);N.push(H);}});this.oControl.setTokens(N);this.oControl.fireTokenUpdate({type:"tokensChanged",removedTokens:G,addedTokens:E});i=v.length;while(i--){y=v[i].data("row");if(y){x.push(y);}}}else{if(v[0]){if(this.bIsSingleIntervalRange){w=v[0].data("range");if(w){if(this._sType==="datetime"){z=D.getDateTimeInstance(Object.assign({},this._oDateFormatSettings,{UTC:false}));if(typeof w.value1==="string"){w.value1=new Date(w.value1);}if(w.operation==="BT"){if(typeof w.value2==="string"){w.value2=new Date(w.value2);}K=z.format(w.value1)+"-"+z.format(w.value2);}else{K=z.format(w.value1);}}else{if(w.operation==="BT"){K=w.value1+"-"+w.value2;}else{K=w.value1;}}}}else{K=v[0].getKey();}y=v[0].data("row");if(y){x.push(y);}}this.oControl.setValue(K);this.oControl.fireChange({value:K,validated:true});}this._calculateAndSetFilterOutputData(x);}t.prototype._initMultiInputValueHelp=function(i){var v=this._getFilterType(this._oFactory._oMetaData.property.property),w={},x=this._getDateFormatSettings(),y;this._oFactory._getValueHelpDialogTitle(w);if(this._getValueListAnnotation()){i.params.valuehelp={annotation:this._getValueListAnnotation(),aggregation:"suggestionRows",noDialog:false,noTypeAhead:false,supportMultiSelect:this.getSupportMultiSelect(),supportRanges:this.getBindingContext()?false:this.getSupportRanges(),type:v,displayBehaviour:this._getDisplayBehaviour()};}else if(this.getSupportRanges()&&!this.getBindingContext()){y=new g({fieldName:this._getPropertyName(),preventInitialDataFetchInValueHelpDialog:true,model:this.getModel(),control:this._oMultiInput,title:w.dialogtitle,supportMultiSelect:this.getSupportMultiSelect(),supportRanges:true,type:v,dateFormatSettings:x,isUnrestrictedFilter:this._isTimeType(v),displayBehaviour:this._getDisplayBehaviour()});y._onOK=u;this._oMultiInput.addValidator(this._validateToken.bind(this));}else{this._oMultiInput.setShowValueHelp(false);this._oMultiInput.addValidator(this._validateToken.bind(this));}};t.prototype._bindMultiInput=function(){var i=this.getBinding("value").getBindingMode();switch(i){case B.OneTime:this._bindMultiInputOneTime();break;case B.OneWay:this._bindMultiInputOneWay();break;case B.TwoWay:default:this._bindMultiInputTwoWay();}};t.prototype._bindMultiInputOneTime=function(){var i=this;this._readNavigationPropertySet().then(function(v){v.results.forEach(function(w){var K=w[i._getPropertyName()];var x=i._getDescriptionFieldName();var y=x?w[x]:"";i._oMultiInput.addToken(i._createToken(K,y));});});};t.prototype._bindMultiInputOneWay=function(){this._bindMultiInputTokens(this._oMultiInput);};t.prototype._bindMultiInputTwoWay=function(){this._bindMultiInputTokens(this._oMultiInput);this._oMultiInput.attachTokenUpdate(function(E){E.getParameter("addedTokens").forEach(this._addToken.bind(this));E.getParameter("removedTokens").forEach(this._removeToken.bind(this));},this);};t.prototype._bindMultiInputTokens=function(i){var N=this._getNavigationPath(),v=this._getSelectExpandParameter();if(!n(v)){i.bindAggregation("tokens",{path:N,parameters:v,factory:this._tokensFactory.bind(this)});}else{i.bindAggregation("tokens",{path:N,factory:this._tokensFactory.bind(this)});}};t.prototype._getSelectExpandParameter=function(){var i={};if(this.getEnableODataSelect()){i.select=this._addODataSelectParameters();}if(this._oFactory._oMetaData.annotations.text&&this._oFactory._oMetaData.annotations.text.navigationPathHelp){i.expand=this._oFactory._oMetaData.annotations.text.navigationPathHelp;}return i;};t.prototype._addODataSelectParameters=function(i){var v=this._getPropertyName();if(this._getDescriptionFieldName()){v=v+","+this._getDescriptionFieldName();}if(this.getRequestAtLeastFields()){v=v+","+this.getRequestAtLeastFields();}return v;};t.prototype._bindMultiComboBox=function(){var i=this.getBinding("value").getBindingMode();switch(i){case B.OneTime:this._bindMultiComboBoxOneTime();break;case B.OneWay:this._bindMultiComboBoxOneWay();break;case B.TwoWay:default:this._bindMultiComboBoxTwoWay();}};t.prototype._bindMultiComboBoxOneTime=function(){var i=this;this._readNavigationPropertySet().then(function(v){var K=v.results.map(function(w){return w[i._getPropertyName()];});i._oMultiComboBox.setSelectedKeys(K);});};t.prototype._bindMultiComboBoxOneWay=function(){this._createAndAttachHelperMultiInput();};t.prototype._bindMultiComboBoxTwoWay=function(){this._createAndAttachHelperMultiInput();this._oMultiComboBox.attachSelectionChange(function(E){var i=E.getParameter("selected"),v=E.getParameter("changedItem"),w={},x,y,z;if(i){w[this._getPropertyName()]=v.getKey();z=v.getBindingContext("list")||v.getBindingContext();x=z.getProperty();this._getEntityType().key.propertyRef.forEach(function(K){if(x&&x[K.name]){w[K.name]=x[K.name];}});}else{y=this._oMultiInput.getTokens().filter(function(A){return A.getKey()===v.getKey();})[0];}if(i){this._createEntity(w);}else{this._removeEntity(y.getBindingContext());}},this);};t.prototype._readNavigationPropertySet=function(){var i=this;return new Promise(function(v,w){var C=i.getBindingContext(),x=i._getModel(),N=i._getNavigationPath();x.read(N,{context:C,success:function(y){v(y);},error:function(E){i.setValueState(q.Error);i.setValueStateText(E.responseText);w(E);}});});};t.prototype._createAndAttachHelperMultiInput=function(){this._oMultiInput=new a();this._oMultiInput.setBindingContext(this.getBindingContext());this._oMultiInput.setModel(this._getModel());this._bindMultiInputTokens(this._oMultiInput);var i=this._oMultiInput.getBinding("tokens");function v(){var K=this._oMultiInput.getTokens().map(function(w){return w.getKey();});this._oMultiComboBox.setSelectedKeys(K);}v.call(this);i.attachChange(v,this);};t.prototype._getReadTokenList=function(){if(!this.oReadTokenList){this.oReadTokenList=new L();this.addDependent(this.oReadTokenList);}return this.oReadTokenList;};t.prototype._getReadTokenListPopover=function(){if(!this.oReadTokenListPopover){this.oReadTokenListPopover=new P({showArrow:true,placement:r.Auto,showHeader:false,contentMinWidth:"auto",content:[this.oReadTokenList]});this.addDependent(this.oReadTokenListPopover);}return this.oReadTokenListPopover;};t.prototype._handleNMoreIndicatorPress=function(){var v=this.getTokens();if(!v){return;}var w=this._getReadTokenList();var x=this._getReadTokenListPopover();w.removeAllItems();for(var i=0,y=v.length;i<y;i++){var z=v[i],A=new S({title:z.getText()});w.addItem(A);}if(this._oTokenizer._oIndicator&&this._oTokenizer._oIndicator.length>0){x.openBy(this._oTokenizer._oIndicator[0]);}};t.prototype._onResize=function(){if(this._isReadMode()&&this._oTokenizer){this._deregisterResizeHandler();this._oTokenizer.setMaxWidth(this.$().width()+"px");this._oTokenizer.setRenderMode("Narrow");this._oTokenizer.scrollToEnd();this._registerResizeHandler();}};t.prototype._initTokenizerCollapseMode=function(){this._oTokenizer.addEventDelegate({onclick:function(E){E.preventDefault();this._handleNMoreIndicatorPress();}.bind(this)});this._oTokenizer.setRenderMode(M.TokenizerRenderMode.Narrow);this._oTokenizer.addEventDelegate({onAfterRendering:this._onResize.bind(this)});};t.prototype.onBeforeRendering=function(){if(d.prototype.onBeforeRendering){d.prototype.onBeforeRendering.apply(this,arguments);}this._deregisterResizeHandler();};t.prototype.onAfterRendering=function(){if(d.prototype.onAfterRendering){d.prototype.onAfterRendering.apply(this,arguments);}this._registerResizeHandler();};t.prototype._registerResizeHandler=function(){if(!this._iResizeHandlerId){this._iResizeHandlerId=R.register(this,this._onResize.bind(this));}};t.prototype._deregisterResizeHandler=function(){if(this._iResizeHandlerId){R.deregister(this._iResizeHandlerId);this._iResizeHandlerId=null;}};t.prototype._createTokenizer=function(){this._oTokenizer=new c(this.getId()+s,{editable:false,width:"100%"});this._initTokenizerCollapseMode();if(this.getBindingContext()){this._bindMultiInputTokens(this._oTokenizer);}else{this.attachInnerControlsCreated(this._mirrorTokensToDisplayTokenizer,this);}return{control:this._oTokenizer,onCreate:"_onCreate"};};t.prototype._mirrorTokensToDisplayTokenizer=function(){if(this.getMode()==="display"&&typeof this._oMultiInput!=="undefined"){this._oTokenizer.removeAllTokens();this._oMultiInput.getTokens().forEach(function(i){var N=new T({text:i.getText(),key:i.getKey()});this._oTokenizer.addToken(N);},this);}};t.prototype._tokensFactory=function(C,i){var v;if(this._oFactory){var w=i.getProperty(this._getPropertyName());var K=this._formatValue(w);var x=this._getDescriptionFieldName();var y=x?i.getProperty(x):"";v=this._createToken(K,y,i);}else{v=new T();}return v;};t.prototype._createToken=function(K,i,C){var v=this._getFormattedText(K,i);var w;w=new T();w.setKey(K);w.setText(v);return w;};t.prototype._addToken=function(i){var v={},C,w=i.data("row"),x=i.data("range");v[this._getPropertyName()]=i.getKey();if(w){this._getEntityType().key.propertyRef.forEach(function(K){if(w[K.name]){v[K.name]=w[K.name];}});}if(x){v["range"]=x;}this.setValueState(q.None);C=this._createEntity(v);i.setBindingContext(C);};t.prototype._createEntity=function(i){var v=this._getModel(),A=this._getEntitySetName(),w=v._resolveGroup(A),x=this._getNavigationPath(),y=this.fireBeforeCreate({oData:i,mParameters:w});w.refreshAfterChange=true;w.context=this.getBindingContext();if(y){w.properties=i;var C=v.createEntry(x,w);return C;}};t.prototype._removeToken=function(i){this._removeEntity(i.getBindingContext());i.destroy();};t.prototype._removeEntity=function(C){var i=this._getModel(),A=this._getEntitySetName(),v=i._resolveGroup(A),w=this.fireBeforeRemove({mParameters:v});var x=i.getDeferredGroups().indexOf(v.groupId)>=0||i.getDeferredBatchGroups().indexOf(v.groupId)>=0;if(x&&this._entityHasPendingCreateChange(i,C)){i.deleteCreatedEntry(C);w=false;}v.refreshAfterChange=true;v.context=C;if(w){var y="";i.remove(y,v);}};t.prototype._entityHasPendingCreateChange=function(i,C){var v=i.getPendingChanges();var K=i.getKey(C);return!!v[K]&&k(v[K],C.getObject());};t.prototype._getEntityKeyProperties=function(C){var i=this._getModel(),E=i.oMetadata._getEntityTypeByPath(C.getPath()),K={};E.key.propertyRef.forEach(function(v){var w=v.name;K[w]=C.getProperty(w);});return K;};t.prototype.checkClientError=function(){if(this.getMode()==="display"){return false;}return!this._validateMultiInput();};t.prototype.getRangeData=function(){var i=this.getTokens(),v=[];i.forEach(function(w){var x;if(w.data("range")){x=w.data("range");}else{x=this._getDefaultTokenRangeData(w);}v.push(x);},this);return v;};t.prototype.setRangeData=function(v){if(!this.getBindingContext()){var i=Array.isArray(v)?v:[v];if(!this._oMultiInput){var E=this.getEditable(),w=this.getEnabled(),C=this.getContextEditable();this.setEditable(true);this.setEnabled(true);this.setContextEditable(true);this.setEditable(E);this.setEnabled(w);this.setContextEditable(C);}this._oMultiInput.removeAllTokens();i.forEach(function(x){var y=this._getTokenTextFromRangeData(x);var z=new T({text:y,key:y});z.data("range",x);this._oMultiInput.addToken(z);},this);this._mirrorTokensToDisplayTokenizer();}else{j.warning("setRangeData can only be used without property binding");}};t.prototype._getTokenTextFromRangeData=function(i){var v="";switch(i.operation){case o.EQ:v="="+i.value1;break;case o.GT:v=">"+i.value1;break;case o.GE:v=">="+i.value1;break;case o.LT:v="<"+i.value1;break;case o.LE:v="<="+i.value1;break;case o.Contains:v="*"+i.value1+"*";break;case o.StartsWith:v=i.value1+"*";break;case o.EndsWith:v="*"+i.value1;break;case o.BT:v=i.value1+"...";if(i.value2){v+=i.value2;}break;default:v="";}if(i.exclude&&v!==""){v="!("+v+")";}return v;};t.prototype.getFilter=function(){var i=[this._getPropertyName()],v={},w=this.getRangeData(),x;v[this._getPropertyName()]={ranges:w,items:[]};x=h.generateFilters(i,v);return x&&x.length===1&&x[0];};t.prototype._getDefaultTokenRangeData=function(i){var v={exclude:false,operation:o.EQ,value1:this._parseValue(i.getKey()),value2:"",keyField:this._getPropertyName()};return v;};t.prototype._validateToken=function(A){var i=A.text;var v=this._validateValue(i);if(v){var w=new T({key:i,text:i});if(this.getSupportRanges()){var x=this._getDefaultTokenRangeData(w);w.data("range",x);w.setText("="+i);}return w;}};t.prototype._validateMultiInput=function(){if(this._oMultiInput.getValueState()!==q.None){return false;}if(this.getRequired()&&this.getTokens().length===0){this.setValueStateText(sap.ui.getCore().getLibraryResourceBundle("sap.ui.comp").getText("VALUEHELPVALDLG_FIELDMESSAGE"));this.setValueState(q.Error);return false;}else{this.setValueState(q.None);return true;}};t.prototype._validateValueOnChange=function(v){if(v===""){this.setValueState(q.None);this._validateMultiInput();}else{this._validateValue(v);}};t.prototype._parseValue=function(v){return this._getType().parseValue(v,"string");};t.prototype._formatValue=function(v){return this._getType().formatValue(v,"string");};t.prototype._validateValue=function(v){try{var i=this._parseValue(v);this._getType().validateValue(i);this.setValueState(q.None);return true;}catch(E){this.setValueState(q.Error);this.setValueStateText(E.message);var w={element:this._oMultiInput,property:"value",type:this._getType(),newValue:v,oldValue:null,exception:E,message:E.message};if(E instanceof f){this.fireParseError(w);}else if(E instanceof V){this.fireValidationError(w);}return false;}};t.prototype._getModel=function(){if(this._oFactory){return this._oFactory._oModel;}};t.prototype._getDateFormatSettings=function(){var i=this.data("dateFormatSettings");if(typeof i==="string"){try{i=JSON.parse(i);}catch(v){}}return i;};t.prototype._getNavigationPath=function(){return this._oFactory._oMetaData.navigationPath;};t.prototype._getDescriptionFieldName=function(){var i=this._oFactory._oMetaData.annotations.text;if(i){if(i.navigationPathHelp){return i.navigationPathHelp+"/"+i.property.property.name;}return i.property.property.name;}};t.prototype._getType=function(){if(!this._oType){var i;if(this._isEdmTimeType()){i=this._getDateFormatSettings();}this._oType=this._oFactory._oTypes.getType(this._oFactory._oMetaData.property,i);}return this._oType;};t.prototype._isEdmTimeType=function(){var i=["Edm.DateTime","Edm.DateTimeOffset","Edm.Time"];return i.indexOf(this._oFactory._oMetaData.property.property.type)>-1;};t.prototype._isTimeType=function(i){var v=["date","datetime","time"];return v.indexOf(i)>-1;};t.prototype._getPropertyName=function(){return this._oFactory._oMetaData.property.property.name;};t.prototype._getEntitySetName=function(){return this._oFactory._oMetaData.entitySet.name;};t.prototype._getEntityType=function(){return this._oFactory._oMetaData.entityType;};t.prototype._getValueListAnnotation=function(){return this._oFactory._oMetaData.annotations.valuelist;};t.prototype._getDisplayBehaviour=function(){var i=this._oFactory._getDisplayBehaviourConfiguration("defaultInputFieldDisplayBehaviour");if(!i||i===p.auto){i=p.descriptionAndId;}return i;};t.prototype._getFormattedText=function(K,i){var v=this._getDisplayBehaviour();return F.getFormattedExpressionFromDisplayBehaviour(v,K,i);};t.prototype._getFilterType=function(i){if(O.isNumeric(i.type)){return"numeric";}else if(i.type==="Edm.DateTime"&&i["sap:display-format"]==="Date"){return"date";}else if(i.type==="Edm.String"){return"string";}else if(i.type==="Edm.Boolean"){return"boolean";}else if(i.type==="Edm.Time"){return"time";}else if(i.type==="Edm.DateTimeOffset"){return"datetime";}return undefined;};t.prototype.setEntitySet=function(){d.prototype.setEntitySet.apply(this,arguments);this.updateBindingContext(false,this._getModel());return this;};t.prototype.bindProperty=function(i,A){d.prototype.bindProperty.apply(this,arguments);if(i==="value"){this.updateBindingContext(false,this._getModel());}return this;};t.prototype._checkComboBox=function(){var C=this._oFactory._oSelector.checkComboBox();return C&&C.combobox;};t.prototype._isReadMode=function(){return!this.getEditable()||!this.getEnabled()||!this.getContextEditable();};function _(){this._onCreate.apply(this,arguments);if(this._aProviders.length>0){this._aProviders[0]._onOK=u;}}t.prototype._init=function(){var i=this;d.prototype._init.apply(this,arguments);if(this._oFactory){this._oFactory._createMultiInput=this._createMultiInput.bind(this);this._oFactory._createMultiComboBox=this._createMultiComboBox.bind(this);this._oFactory._createTokenizer=this._createTokenizer.bind(this);this._oFactory._onMultiInputCreate=_;this._oFactory._oSelector.getCreator=function(){if(i._isReadMode()){return"_createTokenizer";}else if(i._checkComboBox()){return"_createMultiComboBox";}else{return"_createMultiInput";}};}};t.prototype.exit=function(){this._deregisterResizeHandler();if(this.getBindingContext()){if(this._oMultiInput){this._oMultiInput.unbindAggregation("tokens");}if(this._oMultiComboBox){this._oMultiComboBox.unbindItems();}if(this._oTokenizer){this._oTokenizer.unbindAggregation("tokens");}}d.prototype.exit.apply(this,arguments);};return t;});
