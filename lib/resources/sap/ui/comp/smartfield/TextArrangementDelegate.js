/*!
 * SAPUI5

		(c) Copyright 2009-2020 SAP SE. All rights reserved
	
 */
sap.ui.define(["sap/ui/comp/library","sap/ui/base/Object","sap/ui/model/Filter","sap/ui/model/FilterOperator","sap/base/assert"],function(c,B,F,a,b){"use strict";var T=c.smartfield.TextInEditModeSource;var d=B.extend("sap.ui.comp.smartfield.TextArrangementDelegate",{constructor:function(f){B.apply(this,arguments);this.oTextArrangementType=null;this.oFactory=f;this.oSmartField=f._oParent;this.bValidMetadata=false;this.sBindingContextPath="";}});d.prototype.setValue=function(v,o){var s=this.oSmartField,C=s._oControl;if(this.bValidMetadata&&(v!==o)&&C){var i=C[C.current],f=i&&i.getBinding("value");if(!f){return;}var m=s.isPropertyBeingUpdatedByModel("value");switch(s._getComputedTextInEditModeSource()){case T.NavigationProperty:var D=!!s.getModel().getData(f.getBindings()[1].getPath(),s.getBindingContext(),true);if((m&&!D)||!m){i.setValue(v);}return;case T.ValueList:if(!m){i.setValue(v);}return;}}};d.getPaths=function(t,m){switch(t){case T.NavigationProperty:var n=m.annotations.text;if(!n){return{};}return{keyField:n.entityType.key.propertyRef[0].name,descriptionField:n.property.typePath,entitySetName:n.entitySet.name};case T.ValueList:var v=m.property.valueListAnnotation;if(!v){return{};}return{keyField:v.keyField,descriptionField:v.descriptionField,entitySetName:m.property.valueListEntitySet&&m.property.valueListEntitySet.name};}};d.prototype.getBindingInfo=function(s){var f={},S=this.oSmartField,o=this.oFactory,m=o._oMetaData;this.oTextArrangementType=s&&s.type;if(!this.oTextArrangementType){var h=S.getBindingInfo("value");this.oTextArrangementType=(h&&h.type)||{};var t=d.getPaths(o._bTextInDisplayModeValueList?T.ValueList:S._getComputedTextInEditModeSource(),m);if(s.sDisplayFormat){f.displayFormat=s.sDisplayFormat;}this.oTextArrangementType=o._oTypes.getType(m.property,Object.assign(f,this.oTextArrangementType.oFormatOptions),this.oTextArrangementType.oConstraints,{composite:true,keyField:t.keyField,descriptionField:t.descriptionField});}var i=this.getTextAnnotationPropertyPath();if(i===""){i="__$$SmartFieldNotExistingBindingPath";}return{model:m.model,type:this.oTextArrangementType,parts:[{path:m.path},{path:i}]};};d.prototype.getTextAnnotationPropertyPath=function(s){s=s||{};var t=s.textInEditModeSource||this.oSmartField._getComputedTextInEditModeSource(),f=this.oFactory,m=f._oMetaData;if(f._bTextInDisplayModeValueList){t=T.ValueList;}switch(t){case T.NavigationProperty:var o=s.textAnnotation||m.annotations.text;return f._oHelper.getTextAnnotationPropertyPath(o);case T.ValueList:var E=s.edmValueListKeyProperty||m.property.valueListKeyProperty,h=s.bindingContextPath||this.sBindingContextPath;return f._oHelper.getAbsolutePropertyPathToValueListEntity({property:E,bindingContextPath:h});case T.None:return"";default:return"";}};d.prototype.checkRequiredMetadata=function(t,s){var f=this.oFactory,m=f._oMetaData;switch(t){case T.None:return false;case T.NavigationProperty:var n=m.annotations.text,E;if(n){E=n.entityType;}var C={propertyName:m.property&&m.property.property&&m.property.property.name,entityType:m.entityType,entityTypeOfNavigationProperty:E,textAnnotation:m.property&&m.property.property&&m.property.property["com.sap.vocabularies.Common.v1.Text"]};if(s){return f._oHelper.checkNavigationPropertyRequiredMetadataNoAsserts(C);}else{return f._oHelper.checkNavigationPropertyRequiredMetadata(C);}break;case T.ValueList:var v={propertyName:m.property&&m.property.property&&m.property.property.name,entityType:m.entityType,valueListAnnotation:m.property&&m.property.valueListAnnotation};if(s){return f._oHelper.checkValueListRequiredMetadataForTextArrangmentNoAsserts(v);}else{return f._oHelper.checkValueListRequiredMetadataForTextArrangment(v);}break;default:return false;}};d.prototype.onBeforeValidateValue=function(v,s){var S=this.oSmartField;if(!S.getBindingContext()){return;}var o=this.onFetchIDAndDescriptionCollectionSuccess.bind(this,{success:s.success});var O=this.onFetchIDAndDescriptionCollectionError.bind(this,{error:s.error});var f={value:v,success:o,error:O,filterFields:s.filterFields};this.fetchIDAndDescriptionCollection(f);var i=S._oControl.edit;if(i){i.setBusyIndicatorDelay(300);i.setBusy(true);}};d.prototype.fetchIDAndDescriptionCollectionIfRequired=function(){var s=this.oSmartField;if(s._getComputedTextInEditModeSource()===T.ValueList||this.oFactory._bTextInDisplayModeValueList){var I="value",v=s.getBinding(I).getValue(),u=(v==null)||(v==="");if(!u){var f=["keyField"];var S={value:v,oldValue:v,updateBusyIndicator:false,initialRendering:true};this.fetchIDAndDescriptionCollection({value:v,filterFields:f,success:this.onFetchIDAndDescriptionCollectionSuccess.bind(this,S)});}}};d.prototype.fetchIDAndDescriptionCollection=function(s){var v=s.value;if((v==null)||(v==="")){return;}var S=this.oSmartField,i=S._oControl.edit,I=i&&i.getBindingInfo("value"),V=!!(I&&I.skipPropertyUpdate),f=S.isPropertyBeingUpdatedByModel("value");if(V&&!f){i.attachEventOnce("change",function onTextInputFieldChange(C){var h=!!C.getParameter("validated");if(h){s.filterFields=["keyField"];}this.readODataModel(s);},this);}else{if(f){s.filterFields=["keyField"];}this.readODataModel(s);}};d.prototype.readODataModel=function(s){var S=this.oSmartField,t=S._getComputedTextInEditModeSource(),m=S.getControlFactory().getMetaData(),f=d.getPaths(this.oFactory._bTextInDisplayModeValueList?T.ValueList:t,m),k=f.keyField,D=f.descriptionField;if(!D){return;}var o={keyFieldPath:k,descriptionFieldPath:D,aFilterFields:s.filterFields};if(this.oTextArrangementType&&this.oTextArrangementType.oFormatOptions&&this.oTextArrangementType.oFormatOptions.displayFormat==="UpperCase"){s.value=s.value.toUpperCase();}var h=this.getFilters(s.value,o);var u={"$select":k+","+D,"$top":2};var p="/"+f.entitySetName;var i={filters:h,urlParameters:u,success:s.success,error:s.error};var O=S.getModel();O.read(p,i);};d.prototype.onFetchIDAndDescriptionCollectionSuccess=function(s,D,r){s=Object.assign({updateBusyIndicator:true},s);if(!this.oSmartField){return;}var S=this.oSmartField,i=S._oControl.edit,I=i&&i.getBinding("value"),o=S._oControl.display;if(I&&s.updateBusyIndicator){i.setBusyIndicatorDelay(0);i.setBusy(false);}if(typeof s.success==="function"){s.success(D.results);}if(S.getMode()==="display"){var u=function(){var O=S.getModel();b(Array.isArray(D.results)," - "+this.getMetadata().getName());if(O){var v=O.getKey(D.results[0]);if(typeof v==="string"){this.sBindingContextPath="/"+v;this.bindPropertyForValueList("text",o);}}};if(s.initialRendering){u.call(this);}}if(I&&S.getMode()==="edit"&&S.isTextInEditModeSourceNotNone()){var f=function(){var O=S.getModel();b(Array.isArray(D.results)," - "+this.getMetadata().getName());if(O){var v=O.getKey(D.results[0]);if(typeof v==="string"){this.sBindingContextPath="/"+v;this.bindPropertyForValueList("value",i);}}};if(s.initialRendering){f.call(this);}i.attachEventOnce("validationSuccess",f,this);}};d.prototype.onFetchIDAndDescriptionCollectionError=function(s,E){var i=this.oSmartField._oControl.edit;if(i){i.setBusyIndicatorDelay(0);i.setBusy(false);}if(typeof s.error==="function"){s.error();}};d.prototype.bindPropertyForValueList=function(p,i){var s=this.oSmartField,S,t,o,f;if(s._getComputedTextInEditModeSource()===T.ValueList||this.oFactory._bTextInDisplayModeValueList){o=i&&i.getBinding(p);if(this.oFactory&&o){f=o.getType();if((!f||!f.isA("sap.ui.comp.smartfield.type.TextArrangement"))&&this.oFactory._getTextArrangementType){t=this.oFactory._getTextArrangementType();if(t){f=t;}}if(f){S={type:f};}i.bindProperty(p,this.getBindingInfo(S));}}};d.prototype.getFilters=function(v,s){this.destroyFilters();var f=s.aFilterFields;if(f.length===1){switch(f[0]){case"keyField":this.oIDFilter=g(v,s);return[this.oIDFilter];case"descriptionField":this.oDescriptionFilter=e(v,s);return[this.oDescriptionFilter];}}this.oIDFilter=g(v,s);this.oDescriptionFilter=e(v,s);this.oFilters=new F({and:false,filters:[this.oIDFilter,this.oDescriptionFilter]});return[this.oFilters];};function g(v,s){return new F({value1:v,path:s.keyFieldPath,operator:a.EQ});}function e(v,s){return new F({value1:v,path:s.descriptionFieldPath,operator:a.Contains});}d.prototype.destroyFilters=function(){if(this.oIDFilter){this.oIDFilter.destroy();this.oIDFilter=null;}if(this.oDescriptionFilter){this.oDescriptionFilter.destroy();this.oDescriptionFilter=null;}if(this.oFilters){this.oFilters.destroy();this.oFilters=null;}};d.prototype.destroy=function(){this.oSmartField=null;this.bValidMetadata=false;this.sBindingContextPath="";this.destroyFilters();};return d;});
