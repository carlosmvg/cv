// Copyright (c) 2009-2020 SAP SE, All Rights Reserved
sap.ui.define(["sap/ui/Device","sap/ushell/Config","sap/ushell/EventHub","sap/ushell/resources"],function(D,C,E,r){"use strict";var A=function(){};A.prototype={bFocusOnShell:true,bFocusPassedToExternalHandlerFirstTime:true,isFocusHandledByAnotherHandler:false,fnExternalKeysHandler:null,sLastExternalKeysHandlerUrl:null,fnExternalShortcuts:null,isleftAltPressed:false,bForwardNavigation:true,aShortcutsDescriptions:[],appOpenedHandler:function(){var c=hasher.getHash();if(c!==this.sLastExternalKeysHandlerUrl){this.fnExternalKeysHandler=null;}this.sLastExternalKeysHandlerUrl=c;},_focusItemInOverflowPopover:function(i,c){var o=sap.ui.getCore().byId("headEndItemsOverflow");if(o&&o.isOpen()){if(o.getContent().length){this._focusIteminPopover(i,o.getContent()[0].getItems());}}else if(c<10){var O=window.document.getElementById("endItemsOverflowBtn");if(O){O.click();var t=this;window.setTimeout(function(){t._focusItemInOverflowPopover(i,++c);},300);}}},_focusItemInUserMenu:function(i,c){var u=sap.ui.getCore().byId("sapUshellMeAreaPopover");if(u&&u.isOpen()){if(u.getContent().length){this._focusIteminPopover(i,u.getContent()[0].getItems());}}else if(c<10){var t=this;E.emit("showMeArea",Date.now());window.setTimeout(function(){t._focusItemInUserMenu(i,++c);},300);}},_focusIteminPopover:function(I,b){for(var i=0;i<b.length;i++){var c=b[i].getId().split("-");if(c[c.length-1]===I){b[i].getDomRef().focus();return;}}},_handleAccessOverviewKey:function(b){var s=this.oModel.getProperty("/searchAvailable"),p=this.oModel.getProperty("/personalization"),e=C.last("/core/catalog/enabled"),c=C.last("/core/shell/model/enableNotifications");if(D.browser.msie){document.addEventListener("help",this._cancelHelpEvent);}var S=[];S=S.concat(this.aShortcutsDescriptions);var d,f;if(D.os.macintosh){d=r.i18n.getText("OptionKey");f=r.i18n.getText("CommandKey");}else{d=r.i18n.getText("AltKey");f=r.i18n.getText("ControlKey");}if(window.document.getElementById("shell-header")){if(e&&b){S.push({text:d+" + A",description:r.i18n.getText("hotkeyFocusOnAppFinderButton")});}if(s){S.push({text:d+" + F",description:r.i18n.getText("hotkeyFocusOnSearchButton")});}S.push({text:d+" + H",description:r.i18n.getText("hotkeyHomePage")});S.push({text:d+" + M",description:r.i18n.getText("hotkeyFocusOnUserActionMenu")});if(c){S.push({text:d+" + N",description:r.i18n.getText("hotkeyFocusOnNotifications")});}if(b){S.push({text:d+" + S",description:r.i18n.getText("hotkeyFocusOnSettingsButton")});S.push({text:r.i18n.getText("ControlKey")+" + "+r.i18n.getText("CommaKey"),description:r.i18n.getText("hotkeyOpenSettings")});}if(p&&e){S.push({text:r.i18n.getText("ControlKey")+" + "+r.i18n.getText("EnterKey"),description:r.i18n.getText("hotkeyExitEditing")});}if(s){S.push({text:f+" + "+r.i18n.getText("ShiftKey")+" + F",description:r.i18n.getText("hotkeyFocusOnSearchField")});}}sap.ui.require(["sap/m/Label","sap/m/MessageBox","sap/m/Text","sap/m/VBox"],function(L,M,T,V){var v=new V();S.forEach(function(o){v.addItem(new L({text:o.description}));v.addItem(new T({text:o.text}).addStyleClass("sapUiSmallMarginBottom"));});M.show(v,{id:"hotKeysGlossary",title:r.i18n.getText("hotKeysGlossary"),styleClass:"sapContrastPlus"});});},_focusAppFinderButton:function(){if(!C.last("/core/catalog/enabled")){return;}if(this._isFocusInDialog()){return;}var o=window.document.getElementById("openCatalogBtn");if(o){o.focus();return;}var c=sap.ushell.Container.getRenderer("fiori2").getShellConfig();if(c.moveAppFinderActionToShellHeader){this._focusItemInOverflowPopover("openCatalogBtn",0);return;}this._focusItemInUserMenu("openCatalogBtn",0);},_focusSettingsButton:function(){if(this._isFocusInDialog()){return;}var s=window.document.getElementById("userSettingsBtn");if(s){s.focus();return;}var c=sap.ushell.Container.getRenderer("fiori2").getShellConfig();if(c.moveUserSettingsActionToShellHeader){this._focusItemInOverflowPopover("userSettingsBtn",0);return;}this._focusItemInUserMenu("userSettingsBtn",0);},_blockBrowserDefault:function(e){return new Promise(function(b){if(D.browser.name==="ie"){var s=window.document.getElementById("shell-header");if(s){s.setAttribute("accesskey",e.key);window.setTimeout(function(){s=window.document.getElementById("shell-header");if(s){s.removeAttribute("accesskey");b();}},0);}}else{b();}e.preventDefault();});},_handleAltShortcutKeys:function(e,b){var s=sap.ui.getCore().byId("shell-header"),u=sap.ui.getCore().byId("sapUshellMeAreaPopover"),n=sap.ui.getCore().byId("shellNotificationsPopover");if(s){if(b){if(e.keyCode===65){this._blockBrowserDefault(e).then(this._focusAppFinderButton.bind(this));}else if(e.keyCode===83){this._blockBrowserDefault(e).then(this._focusSettingsButton.bind(this));}}if(e.keyCode===70){this._blockBrowserDefault(e).then(function(){if(this._isFocusInDialog()){return;}var S=window.document.getElementById("sf"),o=window.document.getElementById("searchFieldInShell-button");if(S){S.focus();}else if(o){o.focus();}else{this._focusItemInOverflowPopover("sf",0);}}.bind(this));}else if(e.keyCode===72){this._blockBrowserDefault(e).then(function(){if(this._isFocusInDialog()){return;}window.hasher.setHash(s.getHomeUri());if(u&&u.isOpen()){E.emit("showMeArea",false);}if(n&&n.isOpen()){E.emit("showNotifications",false);}var o=window.document.getElementById("shellAppTitle");if(o){o.focus();}}.bind(this));}else if(e.keyCode===77){this._blockBrowserDefault(e).then(function(){if(this._isFocusInDialog()){return;}if(!(u&&u.isOpen())){E.emit("showMeArea",Date.now());}}.bind(this));}else if(e.keyCode===78){this._blockBrowserDefault(e).then(function(){if(this._isFocusInDialog()){return;}if(!(n&&n.isOpen())){E.emit("showNotifications",Date.now());}}.bind(this));}}},_handleCtrlShortcutKeys:function(e,b){if(e.shiftKey){if(e.keyCode===70){if(this._isFocusInDialog()){e.preventDefault();e.stopPropagation();return;}var s=sap.ui.getCore().byId("sf");if(s){s.firePress();e.preventDefault();e.stopPropagation();}}}else if(e.keyCode===188&&b){if(this._isFocusInDialog()){e.preventDefault();e.stopPropagation();return;}var S=sap.ui.getCore().byId("userSettingsBtn");if(S&&!this._isFocusInSmartTable()){S.firePress();e.preventDefault();e.stopPropagation();}}else if(e.keyCode===112){if(this._isFocusInDialog()){e.preventDefault();e.stopPropagation();return;}this._handleAccessOverviewKey(b);}else if(e.keyCode===83){if(this._isFocusInDialog()){e.preventDefault();e.stopPropagation();return;}var c=window.document.getElementById("appFinderSearch-I");if(c){c.focus();e.preventDefault();e.stopPropagation();}}else if(e.keyCode===13){if(this._isFocusInDialog()){e.preventDefault();e.stopPropagation();return;}var d=sap.ui.getCore().byId("sapUshellDashboardFooterDoneBtn");if(d&&d.getDomRef()){d.firePress();e.preventDefault();e.stopPropagation();}}},handleShortcuts:function(e,b){if(D.os.macintosh&&e.metaKey&&e.shiftKey&&e.keyCode===70){var s=window.document.getElementById("sf");if(s){s.firePress();e.preventDefault();e.stopPropagation();}e.preventDefault();}else if(e.altKey&&!e.shiftKey&&!e.ctrlKey){this._handleAltShortcutKeys(e,b);}else if(e.ctrlKey&&!e.altKey){this._handleCtrlShortcutKeys(e,b);}},registerAppKeysHandler:function(h){this.fnExternalKeysHandler=h;this.sLastExternalKeysHandlerUrl=hasher.getHash();},resetAppKeysHandler:function(){this.fnExternalKeysHandler=null;},getAppKeysHandler:function(){return this.fnExternalKeysHandler;},registerAppShortcuts:function(h,s){this.fnExternalShortcuts=h;this.aShortcutsDescriptions=s;},_handleFocusBackToMe:function(e,i){this.bFocusOnShell=true;var f;if(i){f=window.document.getElementById(i);}else{this.fromOutside=true;if(e){e.preventDefault();this.bForwardNavigation=!e.shiftKey||e.key==="F6";}f=window.document.getElementById("sapUshellHeaderAccessibilityHelper");}if(f){f.focus();this.fromOutside=false;}this.bFocusPassedToExternalHandlerFirstTime=true;},setIsFocusHandledByAnotherHandler:function(h){this.isFocusHandledByAnotherHandler=h;},sendFocusBackToShell:function(p){var e,i;if(typeof p==="string"){i=p;}else if(typeof p==="object"){e=p;}this._handleFocusBackToMe(e,i);},_handleEventUsingExternalKeysHandler:function(e){if(!this.bFocusOnShell&&!this.isFocusHandledByAnotherHandler){if(typeof this.fnExternalKeysHandler==="function"){this.fnExternalKeysHandler(e,this.bFocusPassedToExternalHandlerFirstTime);this.bFocusPassedToExternalHandlerFirstTime=false;}}this.setIsFocusHandledByAnotherHandler(false);},_cancelHelpEvent:function(e){e.preventDefault();document.removeEventListener("help",this._cancelHelpEvent);},_isFocusInDialog:function(){var e=document.activeElement;for(;e!==document.body;e=e.parentNode){if(e.classList.contains("sapMDialog")){return true;}}return false;},_isFocusInSmartTable:function(){var e=document.activeElement,c;for(;e!==document.body;e=e.parentNode){c=e.classList;if(c.contains("sapUiCompSmartTable")||c.contains("sapUiMdcTable")){return true;}}return false;},init:function(m){this.oModel=m;document.addEventListener("keydown",function(e){if(e.keyCode===16){return;}this.bForwardNavigation=!e.shiftKey;if(e.key==="Tab"||e.key==="F6"){setTimeout(function(){this._handleEventUsingExternalKeysHandler(e);}.bind(this),0);}else{this._handleEventUsingExternalKeysHandler(e);}if(e.keyCode===18){if(e.location===window.KeyboardEvent.DOM_KEY_LOCATION_LEFT){this.isleftAltPressed=true;}else{this.isleftAltPressed=false;}}if(this.isleftAltPressed||!e.altKey){var c=C.last("/core/shell/model/currentState/stateName");if(c!=="headerless"&&c!=="headerless-home"){var b=(c==="home"||c==="app"||c==="minimal");this.handleShortcuts(e,b);}if(this.fnExternalShortcuts){this.fnExternalShortcuts(e);}}}.bind(this),true);this._cancelHelpEvent=this._cancelHelpEvent.bind(this);}};var a=new A();E.on("AppRendered").do(A.prototype.appOpenedHandler.bind(a));return a;},true);
