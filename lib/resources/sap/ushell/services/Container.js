// Copyright (c) 2009-2020 SAP SE, All Rights Reserved
sap.ui.define(["sap/ushell/utils","sap/ushell/System","sap/ushell/Ui5ServiceFactory","sap/ushell/Ui5NativeServiceFactory","sap/ui/base/EventProvider","sap/ui/core/service/ServiceFactoryRegistry","sap/ui/core/Control","sap/ui/performance/Measurement","sap/ui/thirdparty/URI","sap/ui/util/Mobile","sap/base/util/uid","sap/base/assert"],function(u,S,U,a,E,b,C,M,c,d,f,g){"use strict";var h="sap.ushell.services.Container",j="sap.ushell.Container.dirtyState.",o={},k,p,F,A=[];function l(){close();}function r(){document.location="about:blank";}function m(P){if(p&&p[P]){return p[P];}return"sap.ushell.adapters."+P;}function n(e){return(k.services&&k.services[e])||{};}function q(N,e,P,i){var v=n(N).adapter||{},w=v.module||m(e.getPlatform())+"."+N+"Adapter";function x(){return new(jQuery.sap.getObject(w))(e,P,{config:v.config||{}});}if(i){return new Promise(function(y,z){var B=w.replace(/\./g,"/");sap.ui.require([B],function(){try{y(x());}catch(D){z(D);}},z);});}jQuery.sap.require(w);return x();}function s(v){var w=new E(),x=false,R=[],y={},z="sap.ushell.Container."+v.getSystem().getPlatform()+".remoteSystem.",B={},G,D,L=u.getLocalStorage(),H=new u.Map(),I=new u.Map(),J="sap.ushell.Container."+v.getSystem().getPlatform()+".sessionTermination",K=this;this.cancelLogon=function(){if(this.oFrameLogonManager){this.oFrameLogonManager.cancelLogon();}};this.createRenderer=function(e,i){var P,Q,T;M.start("FLP:Container.InitLoading","Initial Loading","FLP");u.setPerformanceMark("FLP - renderer created");e=e||k.defaultRenderer;if(!e){throw new Error("Missing renderer name");}T=(k.renderers&&k.renderers[e])||{};Q=T.module||(e.indexOf(".")<0?"sap.ushell.renderers."+e+".Renderer":e);if(T.componentData&&T.componentData.config){P={config:T.componentData.config};}function V(){var W=new(jQuery.sap.getObject(Q))({componentData:P}),X=W instanceof sap.ui.core.UIComponent?new sap.ui.core.ComponentContainer({component:W,height:"100%",width:"100%"}):W;if(!(X instanceof C)){throw new Error("Unsupported renderer type for name "+e);}X.placeAt=function(Y,Z){var $=Y,a1="canvas",b1=document.body;if(Y===b1.id){$=document.createElement("div");$.setAttribute("id",a1);$.classList.add("sapUShellFullHeight");switch(Z){case"first":if(b1.firstChild){b1.insertBefore($,b1.firstChild);break;}case"only":b1.innerHTML="";default:b1.appendChild($);}Y=a1;Z="";}C.prototype.placeAt.call(this,Y,Z);};y[e]=W;w.fireEvent("rendererCreated",{renderer:W});return X;}if(i){return new Promise(function(W,X){var Y=Q.replace(/\./g,"/");sap.ui.require([Y],function(){try{W(V());}catch(Z){X(Z);}});});}jQuery.sap.require(Q);return V();};this.getRenderer=function(e){var i,P;e=e||k.defaultRenderer;if(e){i=y[e];}else{P=Object.keys(y);if(P.length===1){i=y[P[0]];}else{jQuery.sap.log.warning("getRenderer() - cannot determine renderer, because no default renderer is configured and multiple instances exist.",undefined,h);}}if(i&&i.isA("sap.ui.core.ComponentContainer")){return i.getComponentInstance();}return i;};this.DirtyState={CLEAN:"CLEAN",DIRTY:"DIRTY",MAYBE_DIRTY:"MAYBE_DIRTY",PENDING:"PENDING",INITIAL:"INITIAL"};this.getGlobalDirty=function(){var i,P=new jQuery.Deferred(),Q=f(),T,V=0,W=this.DirtyState.CLEAN;function X(){if(V===0||W===K.DirtyState.DIRTY){P.resolve(W);jQuery.sap.log.debug("getGlobalDirty() Resolving: "+W,null,"sap.ushell.Container");}}function Y(Z){if(Z.key.indexOf(j)===0&&Z.newValue!==K.DirtyState.INITIAL&&Z.newValue!==K.DirtyState.PENDING){jQuery.sap.log.debug("getGlobalDirty() Receiving event key: "+Z.key+" value: "+Z.newValue,null,"sap.ushell.Container");if(Z.newValue===K.DirtyState.DIRTY||Z.newValue===K.DirtyState.MAYBE_DIRTY){W=Z.newValue;}V-=1;X();}}try{L.setItem(Q,"CHECK");L.removeItem(Q);}catch(e){jQuery.sap.log.warning("Error calling localStorage.setItem(): "+e,null,"sap.ushell.Container");return P.resolve(this.DirtyState.MAYBE_DIRTY).promise();}if(G){throw new Error("getGlobalDirty already called!");}G=P;window.addEventListener("storage",Y);P.always(function(){window.removeEventListener("storage",Y);G=undefined;});for(i=L.length-1;i>=0;i-=1){T=L.key(i);if(T.indexOf(j)===0){if(L.getItem(T)==="PENDING"){L.removeItem(T);jQuery.sap.log.debug("getGlobalDirty() Cleanup of unresolved 'PENDINGS':"+T,null,"sap.ushell.Container");}else{V+=1;u.localStorageSetItem(T,this.DirtyState.PENDING,true);jQuery.sap.log.debug("getGlobalDirty() Requesting status for: "+T,null,"sap.ushell.Container");}}}X();setTimeout(function(){if(P.state()!=="resolved"){P.resolve("MAYBE_DIRTY");jQuery.sap.log.debug("getGlobalDirty() Timeout reached, - resolved 'MAYBE_DIRTY'",null,"sap.ushell.Container");}},V*2000);return P.promise();};this.getLogonSystem=function(){return v.getSystem();};this.getUser=function(){return v.getUser();};this.getDirtyFlag=function(){var e=x;var P=sap.ushell.Container.getService("ShellNavigation").getNavigationContext();for(var i=0;i<R.length;i++){e=e||R[i](P);}return e;};this.setDirtyFlag=function(i){x=i;};this.sessionKeepAlive=function(){if(v.sessionKeepAlive){v.sessionKeepAlive();}};this.registerDirtyStateProvider=function(e){if(typeof e!=="function"){throw new Error("fnDirty must be a function");}R.push(e);};this.deregisterDirtyStateProvider=function(e){if(typeof e!=="function"){throw new Error("fnDirty must be a function");}var P=-1;for(var i=R.length-1;i>=0;i--){if(R[i]===e){P=i;break;}}if(P===-1){return;}R.splice(P,1);};this.getService=function(e,P,i){var Q={},T,V,W,X,Y,Z;function $(d1){var e1=new jQuery.Deferred();if(!d1){throw new Error("Missing system");}e1.resolve(q(e,d1,P));sap.ushell.Container.addRemoteSystem(d1);return e1.promise();}if(!e){throw new Error("Missing service name");}if(e.indexOf(".")>=0){throw new Error("Unsupported service name");}Y=n(e);T=Y.module||"sap.ushell.services."+e;V=T+"/"+(P||"");Z={config:Y.config||{}};function a1(d1,X){Q.createAdapter=$;return new d1(X,Q,P,Z);}function b1(W,i){var d1;if(W.hasNoAdapter){d1=new W(Q,P,Z);}else{X=q(e,v.getSystem(),P,i);if(i){return X.then(function(e1){var d1=a1(W,e1);H.put(V,d1);return d1;});}d1=a1(W,X);}H.put(V,d1);return i?Promise.resolve(d1):d1;}if(!H.containsKey(V)){if(i){if(!I.containsKey(V)){var c1=new Promise(function(d1,e1){sap.ui.require([T.replace(/[.]/g,"/")],function(f1){d1(b1(f1,true));},e1);});I.put(V,c1);return c1;}return I.get(V);}W=sap.ui.requireSync(T.replace(/[.]/g,"/"));return b1(W);}if(i){return Promise.resolve(H.get(V));}return H.get(V);};this.getServiceAsync=function(e,P){return Promise.resolve(this.getService(e,P,true));};function N(){var P,Q,i,T;for(i=L.length-1;i>=0;i-=1){T=L.key(i);if(T.indexOf(z)===0){try{P=T.substring(z.length);Q=JSON.parse(L.getItem(T));B[P]=new S(Q);}catch(e){L.removeItem(T);}}}return B;}function O(){if(typeof OData==="undefined"){return;}function e(i,P,Q){jQuery.sap.log.warning(i,null,"sap.ushell.Container");if(Q){setTimeout(Q.bind(null,i),5000);}return{abort:function(){return;}};}OData.read=function(i,P,Q){return e("OData.read('"+(i&&i.Uri?i.requestUri:i)+"') disabled during logout processing",P,Q);};OData.request=function(i,P,Q){return e("OData.request('"+(i?i.requestUri:"")+"') disabled during logout processing",P,Q);};}this.addRemoteSystem=function(e){var i=e.getAlias(),P=B[i];if(this._isLocalSystem(e)){return;}if(P){if(P.toString()===e.toString()){return;}jQuery.sap.log.warning("Replacing "+P+" by "+e,null,"sap.ushell.Container");}else{jQuery.sap.log.debug("Added "+e,null,"sap.ushell.Container");}B[i]=e;u.localStorageSetItem(z+i,e);};this._isLocalSystem=function(e){var i=e.getAlias();if(i&&i.toUpperCase()==="LOCAL"){return true;}var P=new c(u.getLocationHref()),Q=this.getLogonSystem().getClient()||"";if(e.getBaseUrl()===P.origin()&&e.getClient()===Q){return true;}return false;};this.addRemoteSystemForServiceUrl=function(e){var i,P={baseUrl:";o="};if(!e||e.charAt(0)!=="/"||e.indexOf("//")===0){return;}i=/^[^?]*;o=([^\/;?]*)/.exec(e);if(i&&i.length>=2){P.alias=i[1];}e=e.replace(/;[^\/?]*/g,"");if(/^\/sap\/(bi|hana|hba)\//.test(e)){P.platform="hana";P.alias=P.alias||"hana";}else if(/^\/sap\/opu\//.test(e)){P.platform="abap";}if(P.alias&&P.platform){this.addRemoteSystem(new S(P));}};this.attachLogoutEvent=function(e,P){var Q=false;if(P===true){g(typeof(e)==="function","Container.attachLogoutEvent: fnFunction must be a function");for(var i=0;i<A.length;i++){if(A[i]===e){Q=true;break;}}if(!Q){A.push(e);}}else{w.attachEvent("Logout",e);}};this.detachLogoutEvent=function(e){w.detachEvent("Logout",e);for(var i=0;i<A.length;i++){if(A[i]===e){A.splice(i,1);break;}}};this.attachRendererCreatedEvent=function(e){w.attachEvent("rendererCreated",e);};this.detachRendererCreatedEvent=function(e){w.detachEvent("rendererCreated",e);};this.defaultLogout=function(){var P=new jQuery.Deferred();function Q(){v.logout(true).always(function(){L.removeItem(J);P.resolve();});}function T(){var e=new jQuery.Deferred(),W=e.promise(),X=[];if(A.length>0){for(var i=0;i<A.length;i++){X.push(A[i]());}Promise.all(X).then(e.resolve);setTimeout(e.resolve,4000);}else{e.resolve();}W.done(function(){if(w.fireEvent("Logout",true)){Q();}else{setTimeout(Q,1000);}});}function V(){var B,i=[];if(D){window.removeEventListener("storage",D);}u.localStorageSetItem(J,"pending");K._suppressOData();B=K._getRemoteSystems();Object.keys(B).forEach(function(W){try{i.push(q("Container",B[W]).logout(false));}catch(e){jQuery.sap.log.warning("Could not create adapter for "+W,e.toString(),"sap.ushell.Container");}L.removeItem(z+W);});jQuery.when.apply(jQuery,i).done(T);}if(typeof v.addFurtherRemoteSystems==="function"){v.addFurtherRemoteSystems().always(V);}else{V();}return P.promise();};this.logout=this.defaultLogout;this.registerLogout=function(e){this.logout=e;};this.setLogonFrameProvider=function(e){if(this.oFrameLogonManager){this.oFrameLogonManager.logonFrameProvider=e;}};this.setXhrLogonTimeout=function(P,T){if(this.oFrameLogonManager){this.oFrameLogonManager.setTimeout(P,T);}};this.getFLPConfig=function(){var K=this,P=new Promise(function(e,i){var Q={URL:K.getFLPUrl()};if(o.CDMPromise){o.CDMPromise.then(function(T){T.getSite().then(function(V){Q.scopeId=V.site.identification.id;e(Q);});});}else{e(Q);}});return P;};this.getFLPUrl=function(i){var e=u.getLocationHref(),P=e.indexOf(this.getService("URLParsing").getShellHash(e));if(P===-1||i===true){return e;}return e.substr(0,P-1);};this._closeWindow=l;this._redirectWindow=r;this._getRemoteSystems=N;this._suppressOData=O;sap.ui.getCore().getEventBus().subscribe("sap.ushell.Container","addRemoteSystemForServiceUrl",function(e,i,P){K.addRemoteSystemForServiceUrl(P);});if(typeof v.logoutRedirect==="function"){D=function(e){function i(){K._closeWindow();K._redirectWindow();}if(sap.ushell.Container!==K){return;}if(e.key.indexOf(z)===0&&e.newValue&&e.newValue!==L.getItem(e.key)){u.localStorageSetItem(e.key,e.newValue);}if(e.key===J){if(e.newValue==="pending"){K._suppressOData();if(w.fireEvent("Logout",true)){i();}else{setTimeout(i,1000);}}}};window.addEventListener("storage",D);}this._getFunctionsForUnitTest=function(){return{createAdapter:q};};}function t(e,i){e.forEach(function(v){var w=U.createServiceFactory(v,i);b.register("sap.ushell.ui5service."+v,w);});}function _(e){e.forEach(function(i){var v=a.createServiceFactory(i);b.register("sap.ushell.ui5service."+i,v);});}sap.ushell.bootstrap=function(P,e){var i,D=new jQuery.Deferred();d.init();if(sap.ushell.Container!==undefined){i=new Error("Unified shell container is already initialized - cannot initialize twice.\nStacktrace of first initialization:"+F);jQuery.sap.log.error(i,i.stack,h);throw i;}F=(new Error()).stack;k=jQuery.extend({},true,window["sap-ushell-config"]||{});p=e;if(typeof window["sap.ushell.bootstrap.callback"]==="function"){setTimeout(window["sap.ushell.bootstrap.callback"]);}if(k.modulePaths){Object.keys(k.modulePaths).forEach(function(w){jQuery.sap.registerModulePath(w,k.modulePaths[w]);});}t(["Personalization","URLParsing","CrossApplicationNavigation"],true);t(["Configuration"],false);_(["CardNavigation","CardUserRecents","CardUserFrequents"]);var v=new S({alias:"",platform:k.platform||P});q("Container",v,null,true).then(function(w){w.load().then(function(){function x(){var z,B;var G=window["sap-ushell-config"];if(!G||!G.services){return false;}z=G.services.PluginManager;B=z&&z.config;return B&&B.loadPluginsFromSite;}sap.ushell.Container=new s(w);var y=[sap.ushell.Container.getServiceAsync("PluginManager")];if(x()){o.CDMPromise=sap.ushell.Container.getServiceAsync("CommonDataModel");y.push(o.CDMPromise);}Promise.all(y).then(function(z){var B=z[0],G=z[1];var H=G?G.getPlugins():jQuery.when({});H.then(function(I){var J=jQuery.extend(true,{},k.bootstrapPlugins,I);B.registerPlugins(J);});}).then(function(){if(u.hasFLPReady2NotificationCapability()){sap.ui.require(["sap/ushell/NWBCInterface"],function(N){u.getPrivateEpcm().doEventFlpReady2(N);});}else if(u.hasFLPReadyNotificationCapability()){u.getPrivateEpcm().doEventFlpReady();}sap.ui.require(["sap/ushell/Config"],function(z){if(z.last("/core/darkMode/enabled")){sap.ushell.Container.getService("DarkModeSupport").setup();}});});D.resolve();});});return D.promise();};});
