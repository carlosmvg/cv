// Copyright (c) 2009-2020 SAP SE, All Rights Reserved
sap.ui.define(["sap/m/Button","sap/m/Dialog","sap/m/MessageBox","sap/m/Text","sap/m/VBox","sap/ui/layout/form/SimpleForm","sap/ushell/resources","sap/base/util/isEmptyObject","sap/base/Log","sap/ui/model/json/JSONModel","sap/ui/core/library","sap/m/library","sap/ui/layout/library","sap/ui/Device","sap/ushell/Config","./AddBookmarkButtonRenderer"],function(B,D,M,T,V,S,r,i,L,J,c,m,l,a,C){"use strict";var b=m.ButtonType;var d=c.ValueState;var e=l.form.SimpleFormLayout;var f=c.mvc.ViewType;var A=B.extend("sap.ushell.ui.footerbar.AddBookmarkButton",{metadata:{library:"sap.ushell",properties:{beforePressHandler:{type:"function",group:"Misc",defaultValue:null},afterPressHandler:{type:"any",group:"Misc",defaultValue:null},title:{type:"string",group:"Misc",defaultValue:null},subtitle:{type:"string",group:"Misc",defaultValue:null},info:{type:"string",group:"Misc",defaultValue:null},tileIcon:{type:"string",group:"Apperance",defaultValue:null},numberUnit:{type:"string",group:"Appearance",defaultValue:null},keywords:{type:"string",group:"Misc",defaultValue:null},customUrl:{type:"any",group:"Misc",defaultValue:null},serviceUrl:{type:"any",group:"Misc",defaultValue:null},serviceRefreshInterval:{type:"string",group:"Misc",defaultValue:null},showGroupSelection:{type:"boolean",group:"Misc",defaultValue:true},showPageSelection:{type:"boolean",group:"Misc",defaultValue:true},appData:{type:"object",group:"Misc",defaultValue:null}}}});A.prototype.init=function(){if(B.prototype.init){B.prototype.init.apply(this,arguments);}this.setIcon("sap-icon://add-favorite");this.setText(r.i18n.getText("addToHomePageBtn"));this.setEnabled();this.bSpaceEnabled=C.last("/core/spaces/enabled");this.oModel=new J({showGroupSelection:true,showPageSelection:true,title:"",subtitle:"",numberValue:"",info:"",icon:"",numberUnit:"",keywords:""});this.attachPress(function(){var g=this.getBeforePressHandler();if(g){g();}this.showAddBookmarkDialog();}.bind(this));};A.prototype.exit=function(){if(this.oDialog){this.oDialog.destroy();}if(this.oModel){this.oModel.destroy();}if(B.prototype.exit){B.prototype.exit.apply(this,arguments);}};A.prototype.setBookmarkTileView=function(v){this.bookmarkTileView=v;};A.prototype.getBookmarkTileView=function(){return this.bookmarkTileView;};A.prototype.showAddBookmarkDialog=function(){var o=this.getAppData()||{},I=i(o),v={appData:o,serviceUrl:I?this.getServiceUrl():o.serviceUrl,customUrl:I?this.getCustomUrl():o.customUrl,numberUnit:I?this.getNumberUnit():o.numberUnit,serviceRefreshInterval:I?this.getServiceRefreshInterval():o.serviceRefreshInterval,keywords:I?this.getKeywords():o.keywords},s;if(this.bSpaceEnabled){s=sap.ui.view({type:f.XML,viewName:"sap.ushell.ui.bookmark.SaveOnPage",viewData:v});s.getController().byId("bookmarkTitleInput").attachLiveChange(function(){this.setValueState(d.NONE);});}else{s=sap.ui.view({type:f.JS,viewName:"sap.ushell.ui.footerbar.SaveAsTile",viewData:v});s.getTitleInput().attachLiveChange(function(){this.setValueState(d.NONE);});}if(I){s.setModel(this.oModel);}if(v.serviceUrl){var g=s.getModel();g.setProperty("/serviceUrl",v.serviceUrl);g.setProperty("/numberValue",0);}this.setBookmarkTileView(s);this.oSimpleForm=new S({id:"bookmarkFormId",layout:e.ResponsiveGridLayout,content:[s],editable:true}).addStyleClass("sapUshellAddBookmarkForm");this._openDialog(this.oSimpleForm);};A.prototype._openDialog=function(o){this.oDialog=new D({id:"bookmarkDialog",title:r.i18n.getText("addToHomePageBtn"),contentWidth:"25rem",content:o,beginButton:new B("bookmarkOkBtn",{text:r.i18n.getText("okBtn"),type:b.Emphasized,press:[this._handleOKButtonPress,this]}),endButton:new B("bookmarkCancelBtn",{text:r.i18n.getText("cancelBtn"),press:[this._handleCancelButtonPress,this]}),stretch:a.system.phone,horizontalScrolling:false,afterClose:function(){var g=this.getAfterPressHandler();if(g){g();}this._restoreDialogEditableValuesToDefault();this.oDialog.destroy();delete this.oDialog;}.bind(this)}).addStyleClass("sapContrastPlus");this.oDialog.open();return this.oDialog;};A.prototype._handleOKButtonPress=function(){if(this.bSpaceEnabled){this._handleOKButtonPressSpacesMode();}else{this._handleOKButtonPressClassicMode();}};A.prototype._handleCancelButtonPress=function(){if(this.bSpaceEnabled){this._handleCancelButtonPressSpacesMode();}else{this._handleCancelButtonPressClassicMode();}};A.prototype.setTitle=function(t){this.setProperty("title",t,true);this.oModel.setProperty("/title",t);};A.prototype.setSubtitle=function(s){this.setProperty("subtitle",s,true);this.oModel.setProperty("/subtitle",s);};A.prototype.setInfo=function(I){this.setProperty("info",I,true);this.oModel.setProperty("/info",I);};A.prototype.setTileIcon=function(I){this.setProperty("tileIcon",I,true);this.oModel.setProperty("/icon",I);};A.prototype.setShowGroupSelection=function(s){this.setProperty("showGroupSelection",s,true);this.oModel.setProperty("/showGroupSelection",s);};A.prototype.setNumberUnit=function(n){this.setProperty("numberUnit",n,true);this.oModel.setProperty("/numberUnit",n);};A.prototype.setKeywords=function(k){this.setProperty("keywords",k,true);this.oModel.setProperty("/keywords",k);};A.prototype._restoreDialogEditableValuesToDefault=function(){if(this.oModel){this.oModel.setProperty("/title",this.getTitle());this.oModel.setProperty("/subtitle",this.getSubtitle());this.oModel.setProperty("/info",this.getInfo());}};A.prototype._handleCancelButtonPressSpacesMode=function(){var o=this.getBookmarkTileView().getController(),g=o.getBookmarkTileData();if(g.title||g.subtitle||g.info||g.pages.length){var s=r.i18n.getText("SaveAsTileDialog.MessageBox.Action.Discard"),h=r.i18n.getText("SaveAsTileDialog.MessageBox.Message.Discard"),t=r.i18n.getText("SaveAsTileDialog.MessageBox.Title.Discard");M.show(h,{title:t,actions:[s,M.Action.CANCEL],emphasizedAction:s,onClose:function(R){if(R===s){this.oDialog.close();}}.bind(this)});}else{this.oDialog.close();}};A.prototype._handleOKButtonPressSpacesMode=function(){var o=this.getBookmarkTileView().getController(),g=o.getBookmarkTileData(),v=true;if(g.pages.length===0){var p=o.byId("pageSelect");if(p){p.setValueState(d.Error);p.setValueStateText(r.i18n.getText("bookmarkPageSelectError"));v=false;}}if(!g.title||g.title.length<1){var t=o.byId("bookmarkTitleInput");if(t){t.setValueState(d.Error);t.setValueStateText(r.i18n.getText("bookmarkTitleInputError"));v=false;}}if(!v){return;}this.oDialog.setBusy(true);var h=g.pages;delete g.pages;var j=h.map(function(P){return sap.ushell.Container.getService("Bookmark").addBookmarkToPage(g,P).then(function(){return{pageId:P,status:"resolved"};}).catch(function(s){L.error("Failed to add one a bookmark: ",s,"sap.ushell.ui.footerbar.AddBookmarkButton");return Promise.resolve({pageId:P,error:s,status:"failed"});});});Promise.all(j).then(function(R){var k=sap.ushell.Container.getService("Message"),s=R.filter(function(n){return n.status==="resolved";}).length,F=R.filter(function(n){return n.status==="failed";});if(s===1){k.info(r.i18n.getText("SaveAsTileDialog.MessageToast.TileCreatedInPage"));}else if(s>1){k.info(r.i18n.getText("SaveAsTileDialog.MessageToast.TileCreatedInPages"));}if(F.length){this._showErrorDialog(F,s,g.title);}this.oDialog.setBusy(false);this.oDialog.close();}.bind(this));};A.prototype._showErrorDialog=function(g,n,h){var E,s;if(g.length===1){if(n===0){E=r.i18n.getText("SaveAsTileDialog.MessageBox.SinglePageError");}else{E=r.i18n.getText("SaveAsTileDialog.MessageBox.OnePageError");}s=r.i18n.getText("SaveAsTileDialog.MessageBox.PageErrorDetail",[h,g[0].pageId]);}else if(g.length>1){if(n===0){E=r.i18n.getText("SaveAsTileDialog.MessageBox.AllPagesError");}else{E=r.i18n.getText("SaveAsTileDialog.MessageBox.SomePagesError");}var p=g.map(function(F){return F.pageId;}).join("\n");s=r.i18n.getText("SaveAsTileDialog.MessageBox.PagesErrorDetail",[h,p]);}var o=new V({items:[new T({text:s}).addStyleClass("sapUiSmallMarginBottom"),new T({text:g.map(function(F){return F.error;}).join("\n")}).addStyleClass("sapUiSmallMarginBottom"),new T({text:r.i18n.getText("SaveAsTileDialog.MessageBox.PageErrorSolution")})]});sap.ushell.Container.getService("Message").errorWithDetails(E,o);};A.prototype._handleCancelButtonPressClassicMode=function(){this.oDialog.close();};A.prototype._handleOKButtonPressClassicMode=function(){var g=this.getBookmarkTileView(),o=g.getBookmarkTileData();if(!o.title||o.title.length<1){var t=g.getTitleInput();if(t){t.setValueState(d.Error);t.setValueStateText(r.i18n.getText("bookmarkTitleInputError"));return;}}this.oDialog.setBusy(true);var h=o.group?o.group.object:"";delete o.group;sap.ushell.Container.getService("Bookmark").addBookmark(o,h).done(function(){sap.ushell.Container.getService("Message").info(r.i18n.getText("tile_created_msg"));}).fail(function(s){L.error("Failed to add bookmark",s,"sap.ushell.ui.footerbar.AddBookmarkButton");sap.ushell.Container.getService("Message").error(r.i18n.getText("fail_to_add_tile_msg"));}).always(function(){this.oDialog.setBusy(false);this.oDialog.close();}.bind(this));};A.prototype.setEnabled=function(E){var s="",p=true,o;if(sap.ushell.renderers&&sap.ushell.renderers.fiori2){o=sap.ushell.renderers.fiori2.RendererExtensions.getConfiguration();if(o.appState){s=o.appState;}if(o.enablePersonalization!==undefined){p=o.enablePersonalization;}}if(s==="headerless"||s==="standalone"||s==="embedded"||s==="merged"||!p){E=false;}if(!sap.ushell.Container){if(this.getEnabled()){L.warning("Disabling 'Save as Tile' button: unified shell container not initialized",null,"sap.ushell.ui.footerbar.AddBookmarkButton");}E=false;}B.prototype.setEnabled.call(this,E);if(!E){this.addStyleClass("sapUshellAddBookmarkButton");}};return A;});
