//Copyright (c) 2009-2020 SAP SE, All Rights Reserved
sap.ui.define(["sap/base/util/deepClone","sap/f/GridContainerItemLayoutData","sap/m/library","sap/ui/base/ManagedObjectMetadata","sap/ui/core/InvisibleMessage","sap/ui/core/library","sap/ui/core/XMLComposite","sap/ushell/resources"],function(d,G,m,M,I,c,X,r){"use strict";var T=m.TileSizeBehavior;var a=c.InvisibleMessageMode;var S=X.extend("sap.ushell.ui.launchpad.Section",{metadata:{library:"sap.ushell",properties:{editable:{type:"boolean",group:"Misc",defaultValue:false},default:{type:"boolean",group:"Misc",defaultValue:false},enableAddButton:{type:"boolean",group:"Behavior",defaultValue:true},enableDeleteButton:{type:"boolean",group:"Behavior",defaultValue:true},enableGridBreakpoints:{type:"boolean",group:"Appearance",defaultValue:false},enableGridContainerQuery:{type:"boolean",group:"Appearance",defaultValue:false},enableResetButton:{type:"boolean",group:"Behavior",defaultValue:true},enableShowHideButton:{type:"boolean",group:"Behavior",defaultValue:true},enableVisualizationReordering:{type:"boolean",group:"Behavior",defaultValue:false},noVisualizationsText:{type:"string",group:"Appearance",defaultValue:r.i18n.getText("Section.NoVisualizationsText")},title:{type:"string",group:"Appearance",defaultValue:""},showNoVisualizationsText:{type:"boolean",group:"Behavior",defaultValue:false},showSection:{type:"boolean",group:"Misc",defaultValue:true},sizeBehavior:{type:"sap.m.TileSizeBehavior",group:"Misc",defaultValue:T.Responsive}},defaultAggregation:"visualizations",aggregations:{visualizations:{type:"sap.ui.core.Control",multiple:true,forwarding:{idSuffix:"--innerGrid",aggregation:"items"},dnd:true}},events:{add:{},delete:{},reset:{},titleChange:{},visualizationDrop:{parameters:{draggedControl:{type:"sap.ui.core.Control"},droppedControl:{type:"sap.ui.core.Control"},dropPosition:{type:"string"}}},sectionVisibilityChange:{parameters:{visible:{type:"boolean"}}},borderReached:{parameters:{event:{type:"jQuery.Event"}}}}},resourceModel:r.i18nModel});S.prototype.init=function(){this.oVBox=this.byId("content");var A=function(){this.oVBox.getDomRef().setAttribute("aria-label",this.getTitle());}.bind(this);this.oVBox.addEventDelegate({onBeforeRendering:function(){this.byId("title-edit").detachChange(A);}.bind(this),onAfterRendering:function(){var v=this.oVBox.getDomRef();if(this.getEditable()){v.setAttribute("tabindex","0");}v.setAttribute("aria-label",this.getTitle());v.setAttribute("role","group");this.byId("title-edit").attachChange(A);}.bind(this)});this.byId("innerGrid").addEventDelegate({onAfterRendering:function(){this.oVBox.toggleStyleClass("sapUshellSectionNoVisualizations",!this.getVisualizations().length);}.bind(this)});this.byId("innerGrid").attachBorderReached(function(e){this.fireBorderReached({event:e,section:this,direction:e.getParameter("event").type==="sapnext"?"down":"up"});}.bind(this));this.bUseExtendedChangeDetection=true;this._oInvisibleMessageInstance=I.getInstance();};S.prototype.destroy=function(){X.prototype.destroy.apply(this,arguments);if(this._oInvisibleMessageInstance){this._oInvisibleMessageInstance.destroy();}};S.prototype.updateVisualizations=function(){var b=this.getBinding("visualizations");var B=this.getBindingInfo("visualizations");var l=b.aLastContextData||[];l=l.map(function(o){return JSON.parse(o)[B.key];});var C=b.getContexts();var e=C.map(function(o){return o.getProperty(B.key);});var s=l.length;var D=C.diff;var f=[];var g=false;var R={};f[0]=this.oVizMovePromise||Promise.resolve();if(D){D.forEach(function(o,i){f[i+1]=f[i].then(function(p){return p;});if(g){return;}if(o.type==="delete"){var h=this._calcDeleteIndex(D,s,i);var j=this.getVisualizations()[h];this.removeVisualization(j);var k=l.splice(h,1);R[k]=j;o.done=true;}else if(o.type==="insert"){if(this.oVizMovePromise){o.done=false;f[i+1]=f[i].then(function(p){if(!this._insertVizFromPromise(p,e,o.index)){this._insertVizFromScratch(C[o.index],B,o.index);}o.done=true;return p;}.bind(this));}else{this._insertVizFromScratch(C[o.index],B,o.index);o.done=true;}}else{g=true;}}.bind(this));}else if(this.oVizMovePromise){C.forEach(function(o,i){f[i+1]=f[i].then(function(p){if(!this._insertVizFromPromise(p,e,i,true)){this._insertVizFromScratch(o,B,i,true);}return p;}.bind(this));}.bind(this));}else{g=true;}if(g){this._buildVisualizationsFromScratch(C,B);}this._resolveVizMovePromise(R);return this._cleanupAfterUpdateVisualizations(f,C,e);};S.prototype._buildVisualizationsFromScratch=function(C,b){this.destroyVisualizations();C.forEach(function(o,i){this._insertVizFromScratch(o,b,i,true);}.bind(this));};S.prototype._cleanupAfterUpdateVisualizations=function(p,C,v){return Promise.all(p).then(function(R){var i=R.pop();if(i){Object.keys(i).forEach(function(s){if(v.indexOf(s)===-1){i[s].destroy();}});}this.oVizMovePromise=null;this.fnVizMoveResolve=null;this._updateBindingContexts(C);if(C.length===0){this.invalidate();}}.bind(this));};S.prototype._calcDeleteIndex=function(D,s,b){var A=[];var e=[];for(var i=0;i<s;i++){A.push(i);e.push(i);}D.forEach(function(o,g){if(o.done===true||o.done===false){A=this._applyDiff(A,o,g+s);}if(o.done===true){e=this._applyDiff(e,o,g+s);}}.bind(this));var f=A[D[b].index];return e.indexOf(f);};S.prototype._applyDiff=function(A,D,i){var C=d(A);if(D.type==="delete"){C.splice(D.index,1);}else if(D.type==="insert"){i++;C.splice(D.index,0,i);}return C;};S.prototype._resolveVizMovePromise=function(i){if(this.fnVizMoveResolve){this.fnVizMoveResolve(i);this.fnVizMoveResolve=null;}else{Object.keys(i).forEach(function(s){i[s].destroy();});}};S.prototype._insertVizFromPromise=function(p,v,i,A){var P=v[i];var o=p[P];if(o){if(A){this.addVisualization(o);}else{this.insertVisualization(o,i);}return true;}return false;};S.prototype._insertVizFromScratch=function(C,b,i,A){var o=this._createViz(C,b);if(A){this.addVisualization(o);}else{this.insertVisualization(o,i);}};S.prototype._createViz=function(C,b){return b.factory(M.uid("clone"),C);};S.prototype._updateBindingContexts=function(C){if(!C.length){return;}var b=this.getVisualizations();var o;for(var i=0;i<b.length;i++){o=b[i];o.setBindingContext(C[i]);}};S.prototype.setVizMovePromise=function(p){this.oVizMovePromise=p;};S.prototype.setVizMoveResolve=function(R){this.fnVizMoveResolve=R;};S.prototype.setEditable=function(v){this.setProperty("editable",!!v);this.oVBox.toggleStyleClass("sapUshellSectionEdit",!!v);};S.prototype.setShowSection=function(v,e){this.setProperty("showSection",!!v);this.oVBox.toggleStyleClass("sapUshellSectionHidden",!v);this.fireSectionVisibilityChange({visible:!!v});var i=r.i18n.getText(v?"Section.nowBeingShown":"Section.nowBeingHidden");this._oInvisibleMessageInstance.announce(i,a.Polite);};S.prototype._reorderVisualizations=function(i){this.fireVisualizationDrop(i.getParameters());};S.prototype._onDragEnter=function(e){var D=e.getParameter("dragSession");var t=D.getDropControl&&D.getDropControl();var s=D.getDragControl().getParent();if(t&&t.data("default")&&!s.data("default")){e.preventDefault();}};S.prototype.addAggregation=function(A,o){if(A==="visualizations"){this._addVisualizationLayoutData(o);}X.prototype.addAggregation.apply(this,arguments);return this;};S.prototype.insertAggregation=function(A,o){if(A==="visualizations"){this._addVisualizationLayoutData(o);}X.prototype.insertAggregation.apply(this,arguments);return this;};S.prototype._getVisualizationLayoutData=function(v){if(v.getLayout){return v.getLayout();}return{rows:2,columns:2};};S.prototype._addVisualizationLayoutData=function(v){if(!v.getLayoutData()){var l=this._getVisualizationLayoutData(v);v.setLayoutData(new G(l));}};S.prototype._focusItem=function(i){var g=this.byId("innerGrid");window.setTimeout(function(){var n=g.getItems().length;if(isNaN(i)||i<0){i=0;}else if(i>=n){i=n-1;}if(g.getDomRef()&&n){g.focusItem(i);}},0);};return S;});
