// Copyright (c) 2009-2020 SAP SE, All Rights Reserved
sap.ui.define(["sap/ushell/appRuntime/ui5/AppRuntimePostMessageAPI","sap/ushell/appRuntime/ui5/AppRuntimeService","sap/ui/thirdparty/URI","sap/base/Log","sap/ui/thirdparty/jquery"],function(A,a,U,L,q){"use strict";function S(){this.init=function(){var t=this;A.registerCommunicationHandler("sap.ushell.sessionHandler",{oServiceCalls:{logout:{executeServiceCallFn:function(m){return t.handleLogoutEvent(m);}},extendSessionEvent:{executeServiceCallFn:function(m){return t.handleExtendSessionEvent(m);}}}});this.attachUserEvents();this.userActivityHandler();};this.handleLogoutEvent=function(){var d=new q.Deferred(),t=this;this.detachUserEvents();function b(){sap.ushell.Container.logout().then(function(){d.resolve();},function(e){L.error("logout from iframe "+document.URL+" failed",e,"sap.ushell.appRuntime.ui5.SessionHandlerAgent");d.resolve();});}sap.ushell.Container.getFLPUrl(true).then(function(f){if(t.isSameDomain(f,document.URL)===false){b();}else{d.resolve();}},function(e){L.error("sap.ushell.Container.getFLPUrl call failed",e,"sap.ushell.appRuntime.ui5.SessionHandlerAgent");b();});return d.promise();};this.isSameDomain=function(u,b){var o,c,d=false;try{o=new U(u);c=new U(b);if(o.origin()===c.origin()){d=true;}}catch(e){L.error("Check for same domain of iframe and FLP failed: "+u+" "+b,e,"sap.ushell.appRuntime.ui5.SessionHandlerAgent");}return d;};this.handleExtendSessionEvent=function(){sap.ushell.Container.sessionKeepAlive();return new q.Deferred().resolve().promise();};this.attachUserEvents=function(){q(document).on("mousedown.sessionTimeout mousemove.sessionTimeout",this.userActivityHandler.bind(this));q(document).on("keyup.sessionTimeout",this.userActivityHandler.bind(this));q(document).on("touchstart.sessionTimeout",this.userActivityHandler.bind(this));};this.detachUserEvents=function(){q(document).off("mousedown.sessionTimeout mousemove.sessionTimeout");q(document).off("keydown.sessionTimeout");q(document).off("touchstart.sessionTimeout");};this.userActivityHandler=function(e){if(this.oUserActivityTimer!==undefined){return;}var t=this;this.oUserActivityTimer=setTimeout(function(){a.sendMessageToOuterShell("sap.ushell.sessionHandler.notifyUserActive",{});t.oUserActivityTimer=undefined;},1000);};}var s=new S();return s;});
