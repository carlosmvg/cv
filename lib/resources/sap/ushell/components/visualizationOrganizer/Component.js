// Copyright (c) 2009-2020 SAP SE, All Rights Reserved
sap.ui.define(["sap/m/library","sap/ui/core/UIComponent","sap/ui/model/Filter","sap/ui/model/FilterOperator","sap/ui/model/json/JSONModel","sap/base/Log","sap/ushell/resources","sap/m/MessageBox"],function(m,U,F,c,J,L,r,M){"use strict";var B=m.ButtonType;return U.extend("sap.ushell.components.visualizationOrganizer.Component",{metadata:{version:"1.82.2",library:"sap.ushell",dependencies:{libs:["sap.m"]}},init:function(){U.prototype.init.apply(this,arguments);this.mVizIdInPages=new Map();this.stVizIdInSection=new Set();},requestData:function(){return sap.ushell.Container.getServiceAsync("CommonDataModel").then(function(C){return C.getAllPages();}).then(function(a){this._fillVizIdMaps(a);}.bind(this));},_fillVizIdMaps:function(p){this.mVizIdInPages=new Map();p.forEach(function(P){Object.keys(P.payload.sections).forEach(function(i){Object.keys(P.payload.sections[i].viz).forEach(function(I){var v=P.payload.sections[i].viz[I].vizId;if(this.mVizIdInPages.has(v)){this.mVizIdInPages.get(v).add(P.identification.id);}else{this.mVizIdInPages.set(v,new Set([P.identification.id]));}}.bind(this));}.bind(this));}.bind(this));},isVizIdPresent:function(v,s){if(s){return this.stVizIdInSection.has(v);}var a=this.mVizIdInPages.get(v);return!!(a&&a.size);},formatPinButtonIcon:function(v,s){return(this.isVizIdPresent(decodeURIComponent(v),s)?"sap-icon://accept":"sap-icon://add");},formatPinButtonType:function(v,s){return(this.isVizIdPresent(decodeURIComponent(v),s)?B.Emphasized:B.Default);},formatPinButtonTooltip:function(v,s){var i=this.isVizIdPresent(decodeURIComponent(v),!!s),t,S;if(s){S=s.sectionTitle;if(i){t="VisualizationOrganizer.Button.Tooltip.RemoveFromSection";}else{t="VisualizationOrganizer.Button.Tooltip.AddToSection";}}else if(i){t="EasyAccessMenu_PinButton_Toggled_Tooltip";}else{t="EasyAccessMenu_PinButton_UnToggled_Tooltip";}return r.i18n.getText(t,S);},onTilePinButtonClick:function(e,s){var S=e.getSource(),t=S.getBindingContext().getProperty();if(s){return this._applyOrganizationChangeToSection(S,t,s);}return this.toggle(S,t);},open:function(o,v){var p=sap.ui.getCore().byId("sapUshellVisualizationOrganizerPopover");if(!p){p=sap.ui.xmlfragment("sap.ushell.components.visualizationOrganizer.VisualizationOrganizerPopover",this);p.setModel(new J({pages:[],searchTerm:""}));p.setModel(r.i18nModel,"i18n");}this.oOpenBy=o;this.sVisualizationId=decodeURIComponent(v.id);this.sVisualizationTitle=v.title;this.fnResetPopup=this._resetPopup.bind(this);p.attachAfterClose(this.fnResetPopup);return Promise.all([sap.ushell.Container.getServiceAsync("Menu"),sap.ushell.Container.getServiceAsync("CommonDataModel")]).then(function(R){return Promise.all([R[0].getSpacesPagesHierarchy(),R[1].getAllPages()]);}).then(function(R){var P=this.mVizIdInPages.get(this.sVisualizationId),s=R[0].spaces,a=R[1],b={};a.forEach(function(f){b[f.identification.id]=f.identification.title;});var d=[];s.forEach(function(f){f.pages.forEach(function(g){var h=b[g.id];if(!h){return;}d.push({id:g.id,title:b[g.id],space:f.title,selected:P&&P.has(g.id)});});});var e=p.getModel();e.setProperty("/pages",d);e.setProperty("/pinnedPages",P);p.openBy(o);}.bind(this));},cancel:function(){var p=sap.ui.getCore().byId("sapUshellVisualizationOrganizerPopover"),C=this._retrieveChangedPageIds();if(p&&C.deleteFromPageIds.length===0&&C.addToPageIds.length===0){p.close();}else{M.show(r.i18n.getText("VisualizationOrganizer.MessageBox.Description"),{id:"sapUshellVisualizationOrganizerDiscardDialog",title:r.i18n.getText("VisualizationOrganizer.MessageBox.Title"),actions:[r.i18n.getText("VisualizationOrganizer.MessageBox.ActionDiscard"),M.Action.CANCEL],emphasizedAction:r.i18n.getText("VisualizationOrganizer.MessageBox.ActionDiscard"),onClose:function(a){if(a===r.i18n.getText("VisualizationOrganizer.MessageBox.ActionDiscard")){p.close();}}});}},toggle:function(o,v){var p=sap.ui.getCore().byId("sapUshellVisualizationOrganizerPopover");if(p&&p.isOpen()&&p._oOpenBy&&p._oOpenBy.getId()===o.getId()){this.cancel();return Promise.resolve();}return this.open(o,v);},_applyOrganizationChangeToSection:function(o,v,s){var V=decodeURIComponent(v.id),d=v.title,p=s.pageID,S=s.sectionID,P=sap.ushell.Container.getService("Pages"),e,f;if(this.stVizIdInSection.has(V)){f=r.i18n.getText("VisualizationOrganizer.MessageToastSectionContextRemove",[d||V,s.sectionTitle,s.pageTitle]);e=P.findVisualization(p,S,V).then(function(g){if(g.length===0){return Promise.resolve();}var h=g[0],i=P.getPageIndex(p),j=h.sectionIndex,k;var l=h.vizIndexes.sort(function(a,b){return b-a;});l.forEach(function(a){if(!k){k=P.deleteVisualization(i,j,a);}else{k=k.then(function(){return P.deleteVisualization(i,j,a);});}});return k;}).then(function(){this.stVizIdInSection.delete(V);}.bind(this));}else{f=r.i18n.getText("VisualizationOrganizer.MessageToastSectionContextAdd",[d||V,s.sectionTitle,s.pageTitle]);e=P.addVisualization(p,S,V).then(function(){this.stVizIdInSection.add(V);}.bind(this));}return e.then(function(){o.getBinding("icon").refresh(true);o.getBinding("type").refresh(true);o.getBinding("tooltip").refresh(true);sap.ui.require(["sap/m/MessageToast"],function(a){a.show(f,{offset:"0 -50"});});});},_organizeVisualizations:function(){var C=this._retrieveChangedPageIds();return this._applyOrganizationChange(C);},_applyOrganizationChange:function(v){var C=(v.addToPageIds.length+v.deleteFromPageIds.length);if(!C){return Promise.resolve();}var V=this.sVisualizationId;var s=new Set();var p;var o=sap.ushell.Container.getServiceAsync("Pages").then(function(P){p=P;});v.deleteFromPageIds.forEach(function(P){if(!s.has(P)){s.add(P);o=o.then(function(){return p.findVisualization(P,null,V).then(function(a){var b=[],i,d,e;for(var n=a.length-1;n>=0;n--){d=a[n];i=p.getPageIndex(d);for(var N=d.vizIndexes.length-1;N>=0;N--){e=d.vizIndexes[N];b.push(p.deleteVisualization(i,d.sectionIndex,e));}}return Promise.all(b);});});}this.mVizIdInPages.get(V).delete(P);}.bind(this));v.addToPageIds.forEach(function(P){o=o.then(function(){return p.addVisualization(P,null,V);});if(this.mVizIdInPages.has(V)){this.mVizIdInPages.get(V).add(P);}else{this.mVizIdInPages.set(V,new Set([P]));}}.bind(this));return o.then(function(){if(this.oOpenBy){this.oOpenBy.getBinding("icon").refresh(true);this.oOpenBy.getBinding("type").refresh(true);this.oOpenBy.getBinding("tooltip").refresh(true);}sap.ui.require(["sap/m/MessageToast"],function(a){a.show(r.i18n.getText("VisualizationOrganizer.MessageToast",[C]));});}.bind(this));},_resetPopup:function(e){var p=sap.ui.getCore().byId("sapUshellVisualizationOrganizerPopover"),P=sap.ui.getCore().byId("sapUshellVisualizationOrganizerSpacesList"),s=sap.ui.getCore().byId("sapUshellVisualizationOrganizerSearch"),t=sap.ui.getCore().byId("sapUshellVisualizationOrganizerSelectedPages");p.detachAfterClose(this.fnResetPopup);s.setValue("");t.setType(B.Default);P.getBinding("items").filter(null);P.removeSelections();delete this.fnResetPopup;delete this.sVisualizationId;delete this.sVisualizationTitle;},pagePressed:function(e){this._changeSelectionForAllPagesWithTheSamePageId(e.getSource());},onSelectionChange:function(e){var s=e.getParameter("listItem"),S=e.getParameter("selected");this._changeSelectionForAllPagesWithTheSamePageId(s,S);},_changeSelectionForAllPagesWithTheSamePageId:function(i,s){var o=i.getModel(),C=i.getBindingContext(),I=C.getProperty("id"),S=(s!==undefined)?s:!C.getProperty("selected");var p=o.getProperty("/pages");for(var a=0;a<p.length;a++){var P=p[a];if(P.id===I){P.selected=S;}}o.setProperty("/pages",p);},_onSearch:function(e){var p=sap.ui.getCore().byId("sapUshellVisualizationOrganizerSpacesList"),s=sap.ui.getCore().byId("sapUshellVisualizationOrganizerSearch"),t=sap.ui.getCore().byId("sapUshellVisualizationOrganizerSelectedPages"),b=p.getBinding("items"),S=s.getValue(),T=t.getPressed();if(T){b.filter(new F({filters:[new F({filters:[new F({path:"title",operator:c.Contains,value1:S}),new F({path:"selected",operator:c.EQ,value1:true})],and:true}),new F({filters:[new F({path:"space",operator:c.Contains,value1:S}),new F({path:"selected",operator:c.EQ,value1:true})],and:true})],and:false}));}else{b.filter(new F({filters:[new F({path:"title",operator:c.Contains,value1:S}),new F({path:"space",operator:c.Contains,value1:S})],and:false}));}if(b.getLength()===0){p.setNoDataText(r.i18n.getText(S?"VisualizationOrganizer.PagesList.NoResultsText":"VisualizationOrganizer.PagesList.NoDataText"));}},loadSectionContext:function(C){this.stVizIdInSection.clear();if(!C||!C.pageID||!C.sectionID){return Promise.resolve(null);}return sap.ushell.Container.getServiceAsync("Pages").then(function(p){var P=decodeURIComponent(C.pageID),s=decodeURIComponent(C.sectionID);return p.loadPage(P).then(function(a){var o=p.getModel().getProperty(a),S,b;for(var i=0;i<o.sections.length;i++){if(o.sections[i].id===s){S=o.sections[i];break;}}if(!S){return Promise.resolve(null);}S.visualizations.forEach(function(v){this.stVizIdInSection.add(v.vizId);}.bind(this));b={pageID:P,sectionID:s,pageTitle:o.title,sectionTitle:S.title};return Promise.resolve(b);}.bind(this)).catch(function(){L.warning(P+" cannot be loaded. Please, check the id of the page.");return Promise.resolve(null);});}.bind(this));},_retrieveChangedPageIds:function(){var p=sap.ui.getCore().byId("sapUshellVisualizationOrganizerSpacesList"),s=sap.ui.getCore().byId("sapUshellVisualizationOrganizerSearch"),P=p.getModel(),a=P.getProperty("/pinnedPages")||new Set();p.getBinding("items").filter(null);var i=p.getItems().filter(function(I){return I.isA("sap.m.StandardListItem");});s.fireSearch();var A={},b=[],d=[];i.forEach(function(I){var e=I.getBindingContext().getProperty("id");if(!A[e]){A[e]=true;if(I.getSelected()&&!a.has(e)){b.push(e);}else if(!I.getSelected()&&a.has(e)){d.push(e);}}});return{addToPageIds:b,deleteFromPageIds:d};},okay:function(){this._organizeVisualizations().then(function(){var p=sap.ui.getCore().byId("sapUshellVisualizationOrganizerPopover");p.close();}).catch(function(){L.error("Could not save the selected pages on the VisualizationOrganizerPopover");});},exit:function(){var p=sap.ui.getCore().byId("sapUshellVisualizationOrganizerPopover");if(p){p.destroy();}}});});
