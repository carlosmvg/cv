// Copyright (c) 2009-2020 SAP SE, All Rights Reserved
sap.ui.define(["sap/base/Log","sap/m/Button","sap/m/FlexBox","sap/m/FlexItemData","sap/m/Input","sap/m/library","sap/m/Select","sap/m/Text","sap/m/Token","sap/ui/comp/library","sap/ui/core/ListItem","sap/ui/core/mvc/Controller","sap/ui/comp/smartfield/SmartField","sap/ui/comp/smartform/SmartForm","sap/ui/comp/smartfield/SmartLabel","sap/ui/comp/smartform/Group","sap/ui/comp/smartform/GroupElement","sap/ui/comp/valuehelpdialog/ValueHelpDialog","sap/ui/Device","sap/ui/layout/GridData","sap/ui/model/json/JSONModel","sap/ui/model/odata/ODataModel","sap/ui/thirdparty/jquery","sap/ushell/resources","sap/m/MessageBox"],function(L,B,F,a,I,m,S,T,b,c,d,C,e,f,g,G,h,V,D,j,J,O,q,r,M){"use strict";var k=c.valuehelpdialog.ValueHelpRangeOperation;var l=m.ButtonType;return C.extend("sap.ushell.components.shell.Settings.userDefaults.UserDefaultsSetting",{onInit:function(){this.oModelRecords={};this.oChangedParameters={};this.oBlockedParameters={};this.aDisplayedUserDefaults=[];this.DefaultParametersService=sap.ushell.Container.getService("UserDefaultParameters");this.bIsDirty=false;},_overrideOdataModelValue:function(E){var u=E.getParameter("url").replace(/\?.*/,""),o=E.getSource();this.aDisplayedUserDefaults.forEach(function(R){if(R.editorMetadata&&R.editorMetadata.editorInfo){var s=R.editorMetadata.editorInfo.odataURL+R.editorMetadata.editorInfo.bindingPath;if(s===u){var i=R.editorMetadata.editorInfo.bindingPath+"/"+R.editorMetadata.editorInfo.propertyName;if(o.getProperty(i)!==R.valueObject.value){o.setProperty(i,R.valueObject.value);}this.oBlockedParameters[R.parameterName]=false;}}}.bind(this));},_getOrCreateModelForODataService:function(u){if(!this.oModelRecords[u]){var o=new O(u,{metadataUrlParams:{"sap-documentation":"heading,quickinfo","sap-value-list":"none"},json:true});o.setDefaultCountMode("None");o.setDefaultBindingMode("TwoWay");o.attachRequestCompleted(this._overrideOdataModelValue.bind(this));var i=new Promise(function(n,p){o.attachMetadataLoaded(n);o.attachMetadataFailed(p);});this.oModelRecords[u]={model:o,metadata:i};}return this.oModelRecords[u];},_constructControlSet:function(p){var u=[];for(var P in p){p[P].parameterName=P;u.push(p[P]);}this.sortParametersByGroupIdParameterIndex(u);this.aDisplayedUserDefaults=u;},_createPlainModel:function(o,R){R.modelBind.model=this.oModel;R.modelBind.extendedModel=this.oModel;o.setModel(R.modelBind.model);var i="/sUserDef_"+R.nr+"_";R.modelBind.sFullPropertyPath=i;R.modelBind.sPropertyName="{"+i+"}";R.modelBind.model.setProperty(R.modelBind.sFullPropertyPath,R.valueObject.value);},_revertToPlainModelControls:function(o,R){L.error("Metadata loading for parameter "+R.parameterName+" failed"+JSON.stringify(R.editorMetadata));R.modelBind.isOdata=false;this._createPlainModel(o,R);this._createAppropriateControl(o,R);},_constructForm:function(){this.oSmartForm=new f({editable:true}).addStyleClass("sapUshellShellDefaultValuesForm");this.getView().addContent(this.oSmartForm);},_getContentProviderIds:function(){return sap.ushell.Container.getServiceAsync("CommonDataModel").then(function(o){return o.getContentProviderIds();}).catch(function(){return[""];});},getContent:function(){var s=new J({systemContexts:[],selectedKey:""});this.getView().setModel(s,"systemContexts");var o=this._getContentProviderIds();var i=sap.ushell.Container.getServiceAsync("ClientSideTargetResolution");this._constructForm();return Promise.all([o,i]).then(function(R){var n=R[0];var p=R[1];if(n.length===0){n.push("");}return Promise.all(n.map(function(t){return p.getSystemContext(t).then(function(u){var v=s.getProperty("/systemContexts");v.push(u);s.refresh();});})).then(function(){var t=this.getView().getModel("systemContexts").getProperty("/systemContexts");if(t.length>0){this.getView().getModel("systemContexts").setProperty("/selectedKey",t[0].id);}if(n.length>1){this._createSystemContextSelectGroup();}return this._fillGroups();}.bind(this));}.bind(this));},_handleSystemContextChanged:function(){if(this.bIsDirty){var u=r.i18n.getText("userDefaultsSave");var U=r.i18n.getText("userDefaultsDiscard");M.show(r.i18n.getText("userDefaultsUnsavedChangesMessage"),{title:r.i18n.getText("userDefaultsUnsavedChangesTitle"),actions:[u,U,M.Action.CANCEL],emphasizedAction:u,icon:M.Icon.QUESTION,onClose:function(A){if(A===U){this._fillGroups();this.bIsDirty=false;}else if(A===u){this.onSave();this._fillGroups();this.bIsDirty=false;}else{this.getView().getModel("systemContexts").setProperty("/selectedKey",this.sLastSelectedKey);}}.bind(this)});}else{this._fillGroups();}},_setDirtyState:function(){this.bIsDirty=true;this.sLastSelectedKey=this.getView().getModel("systemContexts").getProperty("/selectedKey");},_createSystemContextSelectGroup:function(){var s=new S("systemContextSelect",{items:{path:"systemContexts>/systemContexts",template:new d({text:"{systemContexts>label}",key:"{systemContexts>id}"})},selectedKey:{path:"systemContexts>/selectedKey"},change:[this._handleSystemContextChanged,this]});var o=new g({width:D.system.phone?"auto":"12rem",textAlign:D.system.phone?"Left":"Right",text:r.i18n.getText("userDefaultsSystemTitle"),labelFor:"systemContextSelect"});var i=new h({});var n=new h({});i.addElement(new F({alignItems:D.system.phone?"Start":"Center",direction:D.system.phone?"Column":"Row",items:[o,s]}));var p=new T({text:r.i18n.getText("userDefaultsSystemContextInfo")}).addStyleClass("sapUshellFlpSettingsWideDescription");n.addElement(p);var t=new G({});t.addGroupElement(i);t.addGroupElement(n);this.oSmartForm.addGroup(t);},_removeDefaultValueGroups:function(){var n=this.oSmartForm.getGroups().length;for(var i=n-1;i>0;i--){this.oSmartForm.removeGroup(i);}},_fillGroups:function(){this._removeDefaultValueGroups();var K=this.getView().getModel("systemContexts").getProperty("/selectedKey");var s=this.getView().getModel("systemContexts").getProperty("/systemContexts").find(function(s){return s.id===K;});return new Promise(function(n,o){this.DefaultParametersService.editorGetParameters(s).done(function(p){this.oModel=new J(p);this.oModel.setDefaultBindingMode("TwoWay");this.getView().setModel(this.oModel,"MdlParameter");this.oOriginalParameters=q.extend(true,{},p);this.oCurrentParameters=q.extend(true,{},p);this._constructControlSet(p);var t="nevermore";var u;this.oBindingContexts={};this.setPropValue=function(R){R.modelBind.model.setProperty(R.modelBind.sFullPropertyPath,R.valueObject.value);this.oBlockedParameters[R.parameterName]=false;};this.oModel.setProperty("/sUser");for(var i=0;i<this.aDisplayedUserDefaults.length;++i){var R=this.aDisplayedUserDefaults[i];var v;R.nr=i;R.editorMetadata=R.editorMetadata||{};R.valueObject=R.valueObject||{value:""};var w=new h({});if(t!==R.editorMetadata.groupId){var x=R.editorMetadata.groupTitle||undefined;u=new G({label:x,editable:true,layoutData:new j({linebreak:false})});t=R.editorMetadata.groupId;this.oSmartForm.addGroup(u);}u.addGroupElement(w);R.modelBind={model:undefined,sModelPath:undefined,sPropertyName:undefined,sFullPropertyPath:undefined};R.valueObject.value=R.valueObject.value||"";if(R.editorMetadata.editorInfo&&R.editorMetadata.editorInfo.propertyName){R.modelBind.isOdata=true;var U=R.editorMetadata.editorInfo.odataURL;v=this._getOrCreateModelForODataService(U);R.modelBind.model=v.model;w.setModel(R.modelBind.model);if(!this.oBindingContexts[U]){w.bindElement(R.editorMetadata.editorInfo.bindingPath);this.oBindingContexts[U]=R.modelBind.model.getContext(R.editorMetadata.editorInfo.bindingPath);}else{w.setBindingContext(this.oBindingContexts[U]);}R.modelBind.sPropertyName="{"+R.editorMetadata.editorInfo.propertyName+"}";R.modelBind.sFullPropertyPath=R.editorMetadata.editorInfo.bindingPath+"/"+R.editorMetadata.editorInfo.propertyName;R.modelBind.extendedModel=this.oModel;}else{this._createPlainModel(w,R);}R.valueObject.value=R.valueObject.value||"";R.modelBind.model.setProperty(R.modelBind.sFullPropertyPath,R.valueObject.value);if(R.modelBind.isOdata){this.oBlockedParameters[R.parameterName]=true;v.metadata.then(this._createAppropriateControl.bind(this,w,R)).catch(this._revertToPlainModelControls.bind(this,w,R));}else{this._createAppropriateControl(w,R);}R.modelBind.model.bindTree(R.modelBind.sFullPropertyPath).attachChange(this.storeChangedData.bind(this));}this.oModel.bindTree("/").attachChange(this.storeChangedData.bind(this));n(this.getView());}.bind(this));}.bind(this));},_createAppropriateControl:function(o,R){var i,n,E;if(R.editorMetadata.extendedUsage){E=new B({text:r.i18n.getText("userDefaultsExtendedParametersTitle"),tooltip:r.i18n.getText("userDefaultsExtendedParametersTooltip"),type:{parts:["MdlParameter>/"+R.parameterName+"/valueObject/extendedValue/Ranges"],formatter:function(u){return u&&u.length?l.Emphasized:l.Transparent;}},press:function(u){this._openExtendedValueDialog(u,R);}.bind(this)}).addStyleClass("sapUshellExtendedDefaultParamsButton");}L.debug("Creating controls for parameter"+R.parameterName+" type "+R.modelBind.isOdata);var p=o.getElements().slice();p.forEach(function(u){o.removeElement(u);});var s=o.getFields().slice();s.forEach(function(u){o.removeField(u);});n=new g({width:D.system.phone?"auto":"12rem",textAlign:D.system.phone?"Left":"Right"});if(R.modelBind.isOdata&&R.editorMetadata.editorInfo){i=new e({value:R.modelBind.sPropertyName,name:R.parameterName});n.setLabelFor(i);}else{i=new I({name:R.parameterName,value:R.modelBind.sPropertyName,type:"Text"});i.addAriaLabelledBy(n);this.setPropValue(R);n.setText((R.editorMetadata.displayText||R.parameterName)+":");n.setTooltip(R.editorMetadata.description||R.parameterName);}i.attachChange(this.storeChangedData.bind(this));i.attachChange(this._setDirtyState,this);i.addStyleClass("sapUshellDefaultValuesSmartField");i.setLayoutData(new a({shrinkFactor:0}));var t=new F({width:D.system.phone?"100%":"auto",direction:(D.system.phone&&!E)?"Column":"Row",items:[i,E]});n.setLayoutData(new a({shrinkFactor:0}));o.addElement(new F({alignItems:D.system.phone?"Start":"Center",direction:D.system.phone?"Column":"Row",items:[n,t]}));},_openExtendedValueDialog:function(E,o){var p="/"+o.parameterName+"/valueObject/extendedValue/Ranges",i=o.modelBind.extendedModel,R=i.getProperty(p)||[],s,n;if(o.modelBind.isOdata){n=this._getMetadataNameSpace(o.editorMetadata.editorInfo.odataURL);var t=o.modelBind.model.getMetaModel().getODataEntityType(n+"."+o.editorMetadata.editorInfo.entityName);if(t){s=o.modelBind.model.getMetaModel().getODataProperty(t,o.editorMetadata.editorInfo.propertyName)["sap:label"];}}var v=new V({basicSearchText:o.editorMetadata.displayText||s||o.parameterName,title:o.editorMetadata.displayText||s||o.parameterName,supportRanges:true,supportRangesOnly:true,key:o.modelBind.sPropertyName,displayFormat:"UpperCase",descriptionKey:o.editorMetadata.displayText||s||o.parameterName,filterMode:true,stretch:D.system.phone,ok:function(u){this._saveExtendedValue(u,o,i,v);}.bind(this),cancel:function(){v.close();},afterClose:function(){v.destroy();}});v.setIncludeRangeOperations(this.getListOfSupportedRangeOperations());this.addTokensToValueHelpDialog(v,R,o.parameterName);var K=[];K.push({label:v.getTitle(),key:o.parameterName});v.setRangeKeyFields(K);v.open();},_saveExtendedValue:function(o,i,n,v){this.aTokens=o.getParameters().tokens;var t=[],p="/"+i.parameterName+"/valueObject/extendedValue/Ranges",s,u={extendedValue:{Ranges:[]}};q.extend(this.oCurrentParameters[i.parameterName].valueObject,u);for(var w in this.aTokens){if(this.aTokens.hasOwnProperty(w)){t.push(this.aTokens[w].data("range"));}}s=t.map(function(x){return{Sign:x.exclude?"E":"I",Option:x.operation!=="Contains"?x.operation:"CP",Low:x.value1,High:x.value2||null};});if(!n.getProperty("/"+i.parameterName+"/valueObject/extendedValue")){n.setProperty("/"+i.parameterName+"/valueObject/extendedValue",{});}n.setProperty(p,s);this.oChangedParameters[i.parameterName]=true;if(o.getParameter("_tokensHaveChanged")){this._setDirtyState();}v.close();},getListOfSupportedRangeOperations:function(){var s=Object.keys(k);return s.filter(function(o){return o!=="StartsWith"&&o!=="EndsWith"&&o!=="Initial";});},_getMetadataNameSpace:function(s){var i=s.split("/"),n;n=i[i.length-1];return n;},addTokensToValueHelpDialog:function(o,R,p){var t=[],i;R.forEach(function(n){if(n){i={};i.exclude=n.Sign==="E";i.keyField=p;i.operation=n.Option!=="CP"?n.Option:"Contains";i.value1=n.Low;i.value2=n.High;t.push(new b({}).data("range",i));}});o.setTokens(t);},sortParametersByGroupIdParameterIndex:function(u){function i(o,p){if(!(p.editorMetadata&&p.editorMetadata.groupId)){return-1;}if(!(o.editorMetadata&&o.editorMetadata.groupId)){return 1;}if(o.editorMetadata.groupId<p.editorMetadata.groupId){return-1;}if(o.editorMetadata.groupId>p.editorMetadata.groupId){return 1;}return 0;}function n(o,p){if(!(p.editorMetadata&&p.editorMetadata.parameterIndex)){return-1;}if(!(o.editorMetadata&&o.editorMetadata.parameterIndex)){return 1;}return o.editorMetadata.parameterIndex-p.editorMetadata.parameterIndex;}u.sort(function(o,p){var s=i(o,p);if(s===0){return n(o,p);}return s;});},storeChangedData:function(){var n=this.aDisplayedUserDefaults;for(var i=0;i<n.length;++i){var p=n[i].parameterName;if(!this.oBlockedParameters[p]){var o={value:this.oCurrentParameters[p].valueObject&&this.oCurrentParameters[p].valueObject.value,extendedValue:this.oCurrentParameters[p].valueObject&&this.oCurrentParameters[p].valueObject.extendedValue&&this.oCurrentParameters[p].valueObject.extendedValue};if(n[i].modelBind&&n[i].modelBind.model){var s=n[i].modelBind.model;var t=n[i].modelBind.extendedModel;var P=n[i].modelBind.sFullPropertyPath;var A=s.getProperty(P);var N={value:s.getProperty(P),extendedValue:t.getProperty("/"+p+"/valueObject/extendedValue")};if(this.isValueDifferent(N,o)){this.oCurrentParameters[p].valueObject.value=A;if(N.extendedValue){q.extend(this.oCurrentParameters[p].valueObject.extendedValue,N.extendedValue);}this.oChangedParameters[p]=true;}}}}},onCancel:function(){this.bIsDirty=false;var s=sap.ui.getCore().byId("saveButton");if(s){s.setEnabled(true);}var n=Object.keys(this.oChangedParameters),o=this.aDisplayedUserDefaults,p,t,u;if(n.length>0){for(var i=0;i<o.length&&n.length>0;i++){p=o[i].parameterName;if(n.indexOf(p)>-1){u=this.oOriginalParameters[p];t=o[i].modelBind;t.model.setProperty(t.sFullPropertyPath,u.valueObject.value||"");if(u.editorMetadata&&u.editorMetadata.extendedUsage){t.extendedModel.setProperty("/"+p+"/valueObject/extendedValue",u.valueObject.extendedValue||{});}}}this.oCurrentParameters=q.extend(true,{},this.oOriginalParameters);this.oChangedParameters={};}},isValueDifferent:function(v,o){var i=false,s=v?JSON.stringify(v):v,n=o?JSON.stringify(o):o,E,p;if(s===n){return false;}if(v===undefined){return false;}if(o===undefined){return false;}E=v.extendedValue?JSON.stringify(v.extendedValue):v.extendedValue;p=o.extendedValue?JSON.stringify(o.extendedValue):o.extendedValue;if((v.value===""&&o.value===undefined)||(o.value===""&&v.value===undefined)){i=true;}if(i&&(E===p)){return false;}return(!i&&(v.value!==o.value))||(E!==p);},onSave:function(){this.bIsDirty=false;var o=new q.Deferred();var i=Object.keys(this.oChangedParameters||{}).sort();if(i.length===0){o.resolve();}sap.ushell.Container.getServiceAsync("ClientSideTargetResolution").then(function(n){return n.getSystemContext(this.sLastSelectedKey);}.bind(this)).then(function(s){this.oChangedParameters={};return this._saveParameterValues(i,s);}.bind(this)).then(o.resolve).catch(o.reject);return o.promise();},_saveParameterValues:function(n,s){var p=[];var P;var o;var v;var t;for(var i=0;i<n.length;i++){P=n[i];v=this.oCurrentParameters[P].valueObject;t=this.oOriginalParameters[P].valueObject;if(this.isValueDifferent(t,v)){if(v&&v.value===null||v&&v.value===""){v.value=undefined;}if(v&&v.extendedValue&&Array.isArray(v.extendedValue.Ranges)&&v.extendedValue.Ranges.length===0){v.extendedValue=undefined;}o=this._saveParameterValue(P,v,t,s);p.push(o);}}return Promise.all(p);},_saveParameterValue:function(n,v,o,s){return sap.ushell.Container.getServiceAsync("UserDefaultParameters").then(function(u){return new Promise(function(i,p){u.editorSetValue(n,v,s).done(function(){o.value=v.value;i();}).fail(p);});});}});});
