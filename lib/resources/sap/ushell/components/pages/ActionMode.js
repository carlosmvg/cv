//Copyright (c) 2009-2020 SAP SE, All Rights Reserved
sap.ui.define(["sap/ui/core/library","sap/m/MessageBox","sap/m/MessageToast","sap/ushell/resources","sap/ushell/EventHub","sap/base/Log"],function(c,M,a,r,E,L){"use strict";var A={};A.start=function(C){this.oController=C;C.getView().getModel("viewSettings").setProperty("/actionModeActive",true);E.emit("enableMenuBarNavigation",false);var o=sap.ui.getCore().byId("ActionModeBtn");var s=r.i18n.getText("PageRuntime.EditMode.Exit");o.setTooltip(s);o.setText(s);};A.cancel=function(){this._cleanup();};A.save=function(){L.info("store actions in pages service");this._cleanup();};A._cleanup=function(){this.oController.getView().getModel("viewSettings").setProperty("/actionModeActive",false);E.emit("enableMenuBarNavigation",true);var o=sap.ui.getCore().byId("ActionModeBtn");var s=r.i18n.getText("PageRuntime.EditMode.Activate");o.setTooltip(s);o.setText(s);};A.addVisualization=function(e,s,p){var m=s.getBindingContext().getModel(),P=s.getBindingContext().getPath(),b=P.split("/"),i=parseInt(b[2],10);var d=m.getProperty("/pages/"+i+"/id"),S=m.getProperty(P+"/id");sap.ushell.Container.getServiceAsync("CrossApplicationNavigation").then(function(C){var f="Shell-appfinder?&/catalog/"+JSON.stringify({pageID:encodeURIComponent(d),sectionID:encodeURIComponent(S)});C.toExternal({target:{shellHash:f}});});};A.addSection=function(e,s,p){var S=p.index;var P=s.getBindingContext().getPath();var b=P.split("/");var i=parseInt(b[2],10);return this.oController.getOwnerComponent().getPagesService().then(function(o){o.addSection(i,S);var d={onAfterRendering:function(){setTimeout(function(){s.getSections()[S].byId("title-edit").focus();},0);s.removeEventDelegate(d);}};s.addEventDelegate(d);});};A.deleteSection=function(e,s,p){return sap.ushell.Container.getServiceAsync("Message").then(function(m){var t=s.getTitle(),b=t?r.i18n.getText("PageRuntime.Message.Section.Delete",t):r.i18n.getText("PageRuntime.Message.Section.DeleteNoTitle"),d=r.i18n.getText("PageRuntime.Dialog.Title.Delete");function C(o){if(o===M.Action.DELETE){this.oController.getOwnerComponent().getPagesService().then(function(P){var f=s.getBindingContext().getPath(),g=s.getParent(),h=f.split("/"),i=parseInt(h[2],10),S=parseInt(h[4],10);P.deleteSection(i,S);a.show(r.i18n.getText("PageRuntime.MessageToast.SectionDeleted"));var j=g.getSections();if(j.length){var k=j[S!==0?S-1:S];k.focus();var l={onAfterRendering:function(){k.focus();k.removeEventDelegate(l);}};k.addEventDelegate(l);}else{var n={onAfterRendering:function(){g.focus();g.removeEventDelegate(n);}};g.addEventDelegate(n);}});}}m.confirm(b,C.bind(this),d,[M.Action.DELETE,M.Action.CANCEL]);}.bind(this));};A.resetSection=function(e,s,p){var S=s;var P=S.getBindingContext().getPath();var b=P.split("/");var i=parseInt(b[2],10);var d=parseInt(b[4],10);return this.oController.getOwnerComponent().getPagesService().then(function(o){o.resetSection(i,d);a.show(r.i18n.getText("PageRuntime.MessageToast.SectionReset"));});};A.changeSectionTitle=function(e,s,p){var P=s.getBindingContext().getPath();var n=s.getProperty("title");var b=P.split("/");var i=parseInt(b[2],10);var S=parseInt(b[4],10);return this.oController.getOwnerComponent().getPagesService().then(function(o){o.renameSection(i,S,n);});};A.moveSection=function(e,s,p){var S=p.draggedControl.getBindingContext().getPath();var t=p.droppedControl.getBindingContext().getPath();var d=p.dropPosition;var T=t.split("/");var b=S.split("/");var P=parseInt(b[2],10);var f=parseInt(b[4],10);var g=parseInt(T[4],10);if(f===g-1&&d==="Before"||f===g+1&&d==="After"){return Promise.resolve();}if(d==="After"){g=g+1;}var o=this.oController._getAncestorPage(p.droppedControl);var h=o.getSections();var i;if(f<g){for(i=f+1;i<g;i++){this.oController._setPromiseInSection(h[i],h[i-1]);}this.oController._setPromiseInSection(h[f],h[g-1]);}else{for(i=g;i<f;i++){this.oController._setPromiseInSection(h[i],h[i+1]);}this.oController._setPromiseInSection(h[f],h[g]);}var C=this.oController.getOwnerComponent();return C.getPagesService().then(function(j){return j.moveSection(P,f,g);}).then(function(){var j=r.i18n.getText("PageRuntime.Message.SectionMoved");C.getInvisibleMessageInstance().announce(j,c.InvisibleMessageMode.Polite);});};A.changeSectionVisibility=function(e,s,p){if(this.oController===undefined||p.visible===undefined){return Promise.resolve();}var P=s.getBindingContext().getPath();var v=p.visible;var b=P.split("/");var i=parseInt(b[2],10);var S=parseInt(b[4],10);return this.oController.getOwnerComponent().getPagesService().then(function(o){o.setSectionVisibility(i,S,v);});};return A;});
