// Copyright (c) 2009-2020 SAP SE, All Rights Reserved
sap.ui.define(["sap/ushell/library","sap/ui/model/json/JSONModel","sap/ushell/Config","sap/ushell/utils/clone","sap/ui/core/MessageType","sap/m/GenericTileScope"],function(u,J,C,c,M,G){"use strict";var V=u.VisualizationLoadState;var p,P,r={},v=new J({sizeBehavior:C.last("/core/home/sizeBehavior")}),_=C.on("/core/home/sizeBehavior").do(function(s){v.setProperty("/sizeBehavior",s);});function a(s){if(!s){throw new Error("Could not find the Section of the given control");}if(s.isA("sap.ushell.ui.launchpad.Section")){return s;}return a(s.getParent());}function b(o){var s=a(o);return{visualizationIndex:s.getVisualizations().indexOf(o),sectionIndex:P.getSections().indexOf(s)};}function d(o){var g=o.getBindingContext();var t=g.getProperty(g.getPath())&&g.getProperty(g.getPath()).targetMappingId;var T=o.getTarget&&o.getTarget();return t||!T||T[0]!=="#";}function e(t){var T=c(t);if(T.subTitle){T.subtitle=T.subTitle;delete T.subTitle;}if(T.iconUrl){T.icon=T.iconUrl;delete T.iconUrl;}if(T.tileType!=="STATIC"&&T.tileType!=="DYNAMIC"&&!T.info){T.info="["+r.i18n.getText("Title.CustomTile")+"]";}return T;}function f(o){var R=p.getModel("roles");var s=R.getProperty("/selected")||[];var A=R.getProperty("/allVisualizations");var g=R.getProperty("/availableVisualizations");var h=!!s.length;var i;if(h&&(A.indexOf(o.getVisualizationId())===-1)){i=V.InsufficientRoles;}else if(h&&(g.indexOf(o.getVisualizationId())===-1)){i=V.OutOfRoleContext;}else if(!d(o)){i=V.NoNavTarget;}return(i||V.Loaded);}return{init:function(o){p=o;P=p.getView().byId("page");P.setModel(p.getModel());P.setModel(v,"viewSettings");r.i18n=p.getResourceBundle();},exit:function(){_.off();},_tileStateFormatter:f,visualizationFactory:function(i,B,F){if(!p.oVisualizationLoadingService){throw new Error("Visualization Service was not loaded yet!");}var t=B.getProperty();var o=p.oVisualizationLoadingService.instantiateVisualization({vizId:t.catalogTileId,previewMode:true,localLoad:true,tileType:(t.tileType==="DYNAMIC"?"sap.ushell.ui.tile.DynamicTile":"sap.ushell.ui.tile.StaticTile"),properties:e(t)});o.setBindingContext(B);o.bindProperty("state","",f.bind(this,o));o._getInnerControlPromise().then(function(){var I=o.getInnerControl().getContent?o.getInnerControl().getContent()[0]:o.getInnerControl();I.attachPress(function(E){switch(E.getParameter("action")){case"Remove":var m=b(o);p.removeVisualizationInSection(m.visualizationIndex,m.sectionIndex);break;case"Press":default:o.fireEvent("press");break;}});I.bindProperty("sizeBehavior","viewSettings>/sizeBehavior");I.bindProperty("scope","/editMode",function(E){return((E&&!F)?G.Actions:G.Display);});});o.attachPress(function(E){var g=E.getSource();p._openTileInfoPopover(g,g.getBindingContext());});return o;},previewVisualizationFactory:function(i,B){return this.visualizationFactory(i,B,true);},collectMessages:function(){var E=[],w=[],i=[],R=p.getModel("roles"),s=R.getProperty("/selected")||[],A=R.getProperty("/allVisualizations"),g=R.getProperty("/availableVisualizations"),h=!!s.length;P.getSections().forEach(function(S,j){var o=S.byId("title-edit");if(S.getTitle()===""){o.setValueState("Warning");o.setValueStateText(r.i18n.getText("Message.InvalidSectionTitle"));w.push({type:M.Warning,title:r.i18n.getText("Title.NoSectionTitle",j+1),description:r.i18n.getText("Message.NoSectionTitle",j+1)});}else{o.setValueState("None");}S.getVisualizations().forEach(function(k,l){var B=k.getBindingContext().getProperty("");var n=B&&B.tileType&&!B.deviceDesktop&&!B.devicePhone&&!B.deviceTablet;if(n){w.push({type:M.Warning,title:r.i18n.getText("Title.NoFormFactor"),description:r.i18n.getText("Message.NoFormFactor",k.getTitle()||k.getCatalogTile()&&k.getCatalogTile().getTitle()||k.getVisualizationId())});}if(h&&(A.indexOf(k.getVisualizationId())===-1)){i.push({type:M.Information,title:r.i18n.getText("Title.InsufficientRoles"),subtitle:r.i18n.getText("Title.VisualizationIsNotVisible"),description:r.i18n.getText("Message.LoadTileError",[(l+1)+".",S.getTitle()])});}else if(h&&(g.indexOf(k.getVisualizationId())===-1)){i.push({type:M.Information,title:r.i18n.getText("Message.VisualizationNotAvailableInContext"),subtitle:r.i18n.getText("Message.VisualizationNotAvailableInContext"),description:r.i18n.getText("Message.VisualizationOutOfContextError",k.getTitle()||k.getCatalogTile()&&k.getCatalogTile().getTitle()||k.getVisualizationId())});}else if(!d(k)){w.push({type:M.Warning,title:r.i18n.getText("Message.NavigationTargetError"),subtitle:r.i18n.getText("Title.VisualizationNotNavigable"),description:r.i18n.getText("Message.NavTargetResolutionError",k.getTitle()||k.getCatalogTile()&&k.getCatalogTile().getTitle()||k.getVisualizationId())});}});});return{errors:E,warnings:w,infos:i};},addSection:function(E){var s=E?E.getParameter("index"):0;p.addSectionAt(s);},deleteSection:function(E){var s=E.getSource(),t=s.getTitle(),m=t?r.i18n.getText("Message.Section.Delete",t):r.i18n.getText("Message.Section.DeleteNoTitle");sap.ui.require(["sap/m/MessageBox"],function(g){g.confirm(m,{icon:g.Icon.WARNING,title:r.i18n.getText("Button.Delete"),actions:[g.Action.DELETE,g.Action.CANCEL],emphasizedAction:g.Action.DELETE,initialFocus:g.Action.CANCEL,onClose:function(A){if(A===g.Action.DELETE){p.deleteSection(P.indexOfSection(s));}}});});},moveSection:function(i){var D=i.getParameter("draggedControl"),o=i.getParameter("droppedControl"),I=i.getParameter("dropPosition"),g=P.indexOfSection(D),h=P.indexOfSection(o);if(I==="After"){if(h<g){h++;}}else if(h>g){h--;}p.moveSection(g,h);},moveVisualization:function(D){var o=D.getParameter("draggedControl"),g=D.getParameter("droppedControl"),i=D.getParameter("dropPosition");if(g.isA("sap.ushell.ui.launchpad.Section")){var m=b(o),s=P.indexOfSection(g),B=o.getBindingContext();p.addVisualizationInSection(B.getModel().getProperty(B.getPath()),[s],0);p.removeVisualizationInSection(m.visualizationIndex,m.sectionIndex);return;}var h=b(g),j=h.visualizationIndex,k=h.sectionIndex;if(o.isA("sap.m.ListItemBase")){var l=D.getParameter("dragSession").getComplexData("callback");if(i==="After"){j++;}l(j,k);return;}var n=b(o),q=n.visualizationIndex,t=n.sectionIndex;if(t===k){if(i==="After"){if(j<q){j++;}}else if(j>q){j--;}}else if(i==="After"){j++;}if(p.moveVisualizationInSection(q,j,t,k)){window.setTimeout(function(){P.getSections()[k]._focusItem(j);},0);}},addVisualization:function(D){var o=D.getParameter("draggedControl"),g=D.getParameter("droppedControl"),i=g.getVisualizations().length,h=P.indexOfSection(g);if(o.isA("sap.m.ListItemBase")){D.getParameter("dragSession").getComplexData("callback")(i,h);return;}var j=b(o),k=j.visualizationIndex,l=j.sectionIndex;p.moveVisualizationInSection(k,i,l,h);}};});
