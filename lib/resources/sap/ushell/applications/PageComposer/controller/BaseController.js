// Copyright (c) 2009-2020 SAP SE, All Rights Reserved
sap.ui.define(["../util/Transport","sap/base/Log","sap/m/MessageBox","sap/ui/core/Fragment","sap/ui/core/mvc/Controller","sap/ui/core/routing/History","sap/ui/core/UIComponent","sap/ui/model/json/JSONModel"],function(T,L,M,F,C,H,U,J){"use strict";return C.extend("sap.ushell.applications.PageComposer.controller.BaseController",{getPageRepository:function(){return this.getOwnerComponent().getPageRepository();},getRouter:function(){return U.getRouterFor(this);},getModel:function(n){return this.getView().getModel(n);},setModel:function(m,n){return this.getView().setModel(m,n);},getRootView:function(){return this.getOwnerComponent().getRootControl();},getResourceBundle:function(){return this.getOwnerComponent().getModel("i18n").getResourceBundle();},getTransportHelper:function(){if(!this.oTransportHelper){this.oTransportHelper=new T();}return this.oTransportHelper;},_createEditDialog:function(o,a){return new Promise(function(r){sap.ui.require(["sap/ushell/applications/PageComposer/controller/EditDialog.controller"],function(E){if(!this.oEditPageDialogController){this.oEditPageDialogController=new E(this.getRootView(),this.getResourceBundle());}else{this.oEditPageDialogController._resetModel();}this.oEditPageDialogController.attachCancel(a);this.oEditPageDialogController.attachConfirm(o);this.oEditPageDialogController.load().then(function(){r(this.oEditPageDialogController);}.bind(this));}.bind(this));}.bind(this));},showCreateDialog:function(o,a){return new Promise(function(r,b){sap.ui.require(["sap/ushell/applications/PageComposer/controller/CreatePageDialog.controller"],function(c){if(!this.oCreatePageDialogController){this.oCreatePageDialogController=new c(this.getRootView(),this.getResourceBundle());}else{this.oCreatePageDialogController._resetModel();}this.oCreatePageDialogController.attachConfirm(o);this.oCreatePageDialogController.attachCancel(a);this.oCreatePageDialogController.load().then(function(){if(this.getOwnerComponent().isTransportSupported()){return this.getOwnerComponent().createTransportComponent().then(function(t){return this.getTransportHelper().enhanceDialogWithTransport(this.oCreatePageDialogController,t,o);}.bind(this));}return this.oCreatePageDialogController;}.bind(this)).then(function(e){if(e){e.open();}r();}).catch(function(e){this.oCreatePageDialogController.destroy();this.handleBackendError(e);b();}.bind(this));}.bind(this));}.bind(this));},_createDeleteDialog:function(o,a){return new Promise(function(r){sap.ui.require(["sap/ushell/applications/PageComposer/controller/DeleteDialog.controller"],function(D){if(!this.oDeletePageDialogController){this.oDeletePageDialogController=new D(this.getRootView(),this.getResourceBundle());}else{this.oDeletePageDialogController._resetModel();}this.oDeletePageDialogController.attachCancel(a);this.oDeletePageDialogController.attachConfirm(o);this.oDeletePageDialogController.load().then(function(){r(this.oDeletePageDialogController);}.bind(this));}.bind(this));}.bind(this));},checkShowEditDialog:function(p,o,a){var e=this.handleBackendError.bind(this);if(!this.getOwnerComponent().isTransportSupported()){return Promise.resolve();}return this.getOwnerComponent().createTransportComponent(p.devclass).then(function(t){return Promise.all([t.showTransport(p,"Page"),t.showLockedMessage(p)]).then(function(r){var s=r[0],l=r[1];if(l){this.showMessageBoxError(this.getResourceBundle().getText("Dialog.LockedText",[p.transportId,l.foreignOwner]),true);}else if(s){this._createEditDialog(o,a).then(function(d){d.getModel().setProperty("/message",this.getResourceBundle().getText("EditDialog.TransportRequired"));var E=this.getTransportHelper().enhanceDialogWithTransport(d,t,o,p);E.open();}.bind(this)).catch(e);}}.bind(this)).catch(e);}.bind(this)).catch(e);},checkShowDeleteDialog:function(p,o,a){var r=this.getResourceBundle(),e=this.handleBackendError.bind(this);if(!this.getOwnerComponent().isTransportSupported()){return this._createDeleteDialog(o,a).then(function(d){d.getModel().setProperty("/message",r.getText("DeleteDialog.Text"));d.open();});}return this.getOwnerComponent().createTransportComponent(p.devclass).then(function(t){return Promise.all([t.showTransport(p,"Page"),t.showLockedMessage(p)]).then(function(R){var s=R[0],l=R[1];if(l){this.showMessageBoxError(r.getText("Dialog.LockedText",[p.transportId,l.foreignOwner]),true);}else{this._createDeleteDialog(o,a).then(function(d){d.getModel().setProperty("/message",r.getText("DeleteDialog.Text"));if(s){d.getModel().setProperty("/message",r.getText("DeleteDialog.TransportRequired"));d=this.getTransportHelper().enhanceDialogWithTransport(d,t,o,p);}d.open();}.bind(this)).catch(e);}}.bind(this)).catch(e);}.bind(this)).catch(e);},showCopyDialog:function(p,o,a){return new Promise(function(r,b){sap.ui.require(["sap/ushell/applications/PageComposer/controller/CopyPageDialog.controller"],function(c){if(!this.oCopyPageDialogController){this.oCopyPageDialogController=new c(this.getRootView(),this.getResourceBundle());}else{this.oCopyPageDialogController._resetModel();}this.oCopyPageDialogController.attachConfirm(o);this.oCopyPageDialogController.attachCancel(a);return this.oCopyPageDialogController.load().then(function(){if(this.getOwnerComponent().isTransportSupported()){return this.getOwnerComponent().createTransportComponent().then(function(t){return this.getTransportHelper().enhanceDialogWithTransport(this.oCopyPageDialogController,t,o,p);}.bind(this));}return this.oCopyPageDialogController;}.bind(this)).then(function(e){if(e){e.getModel().setProperty("/sourceId",p.id);e.getModel().setProperty("/sourceTitle",p.title);e.getModel().setProperty("/sourceDescription",p.description);e.getModel().setProperty("/title",p.title);e.getModel().setProperty("/description",p.description);e.open();}r();}).catch(function(e){this.oCopyPageDialogController.destroy();this.handleBackendError(e);b(e);}.bind(this));}.bind(this));}.bind(this));},_openTileInfoPopover:function(o,b){var r=this.getRootView();if(!r.oTileInfoPopover){F.load({id:r.getId(),name:"sap.ushell.applications.PageComposer.view.TileInfoPopover",controller:this}).then(function(t){r.oTileInfoPopover=t;r.addDependent(r.oTileInfoPopover);this._openTileInfoPopover(o,b);}.bind(this));}else{var v=new J({});if(o.isA("sap.ushell.ui.launchpad.VizInstance")){v.setProperty("/state",o.getState());v.setProperty("/innerControlScope",o.getInnerControl().getScope());}r.oTileInfoPopover.setModel(v,"vizInstance");r.oTileInfoPopover.setModel(b.getModel());r.oTileInfoPopover.bindObject(b.getPath());r.oTileInfoPopover.openBy(o);}},showMessageBoxError:function(e,n){if(n){M.error(e,{onClose:this.navigateBack.bind(this)});}else{M.error(e);}},showMessageBoxWarning:function(w,W,n){if(n){M.warning(w,{onClose:this.navigateBack.bind(this),details:W});}else{M.warning(w,{details:W});}},navigateBack:function(){var h=H.getInstance();this.getPageRepository().abortPendingBackendRequests();if(h.getPreviousHash()!==undefined){window.history.go(-1);}else{this.getRouter().navTo("overview",{},true);}},navigateToErrorPage:function(p){this.getRouter().navTo("error",{pageId:encodeURIComponent(p)},null,true);},navigateToUnsupportedPage:function(p){this.getRouter().navTo("unsupported",{pageId:encodeURIComponent(p)},null,true);},navigateToEdit:function(p){var s=this.getOwnerComponent().getModel("settings");s.setProperty("/editMode",true);s.setProperty("/deepLink",false);this.getRouter().navTo("view",{pageId:encodeURIComponent(p)});},preview:function(){var p=this.getView();if(this.oPagePreviewDialogController){this.oPagePreviewDialogController.open(p);return;}sap.ui.require(["sap/ushell/applications/PageComposer/controller/PagePreviewDialog.controller"],function(P){this.oPagePreviewDialogController=P;this.oPagePreviewDialogController.open(p);}.bind(this));},onExit:function(){if(this.oPagePreviewDialogController){this.oPagePreviewDialogController.close();this.oPagePreviewDialogController.onAfterClose();delete this.oPagePreviewDialogController;}},checkMasterLanguageMismatch:function(p){var c=this.getOwnerComponent().getMetadata().getConfig().checkLanguageMismatch,u=sap.ui.getCore().getConfiguration().getSAPLogonLanguage().toUpperCase(),P=p.masterLanguage.toUpperCase();if(c&&u!==P){this.showMessageBoxError(this.getResourceBundle().getText("EditDialog.LanguageMismatch",[P,u]),true);return true;}return false;},handleBackendError:function(e){if(e.responseText){this.getOwnerComponent().showErrorDialog(e);}else{L.error(e);}},_resetRolesModel:function(s){var r=this.getModel("roles");if(!r){r=new J();this.setModel(r,"roles");}if(typeof s==="undefined"){r.setProperty("/available",[]);r.setProperty("/selected",[]);r.setProperty("/allSelected",true);r.setProperty("/selectedCountText",this.getResourceBundle().getText("Message.AllRolesSelected"));r.setProperty("/allVisualizations",[]);r.setProperty("/availableVisualizations",[]);}else if(s.available){r.setProperty("/available",s.available);r.setProperty("/selected",s.available);r.setProperty("/allVisualizations",this.getPageRepository().getVizIds(s.available));r.setProperty("/availableVisualizations",this.getPageRepository().getVizIds(s.available));}else{var c=s.selected.length.toString();if(!s.selected.length){c=this.getResourceBundle().getText("Message.NoRolesSelected");}else if(s.allSelected){c=this.getResourceBundle().getText("Message.AllRolesSelected");}r.setProperty("/selected",s.selected);r.setProperty("/allSelected",s.allSelected);r.setProperty("/selectedCountText",c);r.setProperty("/availableVisualizations",this.getPageRepository().getVizIds(s.selected));}},formatAssignmentDetailsMessage:function(c){var m=this.getPageRepository().getMissingAssignment(c);if(m==="space"){return this.getResourceBundle().getText("Message.NotAssignedToSpaceInformationDetails");}else if(m==="role"){return this.getResourceBundle().getText("Message.NotAssignedToRoleInformationDetails");}return"";},_formatTileType:function(v){var i=this.getResourceBundle();switch(v){case"STATIC":return i.getText("Title.StaticTile");case"DYNAMIC":return i.getText("Title.DynamicTile");case"CUSTOM":default:return i.getText("Title.CustomTile");}},setTitle:function(t){this.getOwnerComponent().getService("ShellUIService").then(function(s){s.setTitle(t);},function(e){L.error("Cannot get ShellUIService",e,"sap.ushell.applications.PageComposer");});}});});
