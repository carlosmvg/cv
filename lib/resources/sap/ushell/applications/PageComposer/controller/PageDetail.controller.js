// Copyright (c) 2009-2020 SAP SE, All Rights Reserved
sap.ui.define(["./BaseController","./ConfirmChangesDialog.controller","./Page","./TileSelector","sap/ui/model/json/JSONModel","sap/m/MessageBox","sap/m/MessageToast","sap/m/MessagePopover","sap/m/MessageItem","sap/ui/core/Fragment","sap/base/Log","sap/ui/core/library","sap/ui/core/MessageType","sap/ushell/utils","sap/ui/core/BusyIndicator","sap/m/ButtonType","sap/ui/model/Filter","sap/ui/model/FilterOperator","sap/ushell/resources","sap/ushell/services/Container"],function(B,C,P,T,J,M,a,b,c,F,L,d,e,u,f,g,h,i,j){"use strict";return B.extend("sap.ushell.applications.PageComposer.controller.PageDetail",{Page:P,TileSelector:new T(),onInit:function(){u.setPerformanceMark("FLPPage-manage.startDetailInitialization",{bUseUniqueMark:true});this.setModel(new J());this._oAssignedSpacesTable=this.byId("spaceAssignmentTable");this.getRouter().getRoute("view").attachPatternMatched(this._onPageMatched,this);this.getView().setBusyIndicatorDelay(0);this.Page.init(this);},onBreakpointChanged:function(k){var l;if(typeof k!=="undefined"){l=(k.getParameters().currentBreakpoint==="S");this.getModel().setProperty("/currentBreakpointIsS",l);}else{l=this.getModel().getProperty("/currentBreakpointIsS");}this.TileSelector.setEnableDnD(!l);this.TileSelector.showSwitchViewButton(l);},onTabChange:function(E){var s=E.getParameter("selectedKey");if(s==="iconTabBarSpaceAssignment"){this._initSpaceAssignment(this.getModel().getProperty("/page/id"));}},_setDirtyFlag:function(v){sap.ushell.Container.setDirtyFlag(v);},onExit:function(){B.prototype.onExit.apply(this,arguments);if(this.oMessagePopover){this.oMessagePopover.destroy();delete this.oMessagePopover;}this.Page.exit();},handleMessagePopoverPress:function(E){if(!this.oMessagePopover){this.oMessagePopover=new b("messagePopover",{items:{path:"/messages",template:new c({type:"{type}",title:"{title}",activeTitle:"{active}",description:"{description}",subtitle:"{subTitle}",counter:"{counter}"})}}).setModel(this.getModel());}this.oMessagePopover.toggle(E.getSource());},onToggleCatalogsButtonPress:function(){var m=this.getModel();if(m.getProperty("/currentBreakpointIsS")){this.switchDynamicSideContentView();}else{this.onUpdateSideContentVisibility();}},onUpdateSideContentVisibility:function(){this.getModel().setProperty("/catalogsExpanded",!this.getModel().getProperty("/catalogsExpanded"));},switchDynamicSideContentView:function(){this.getView().byId("pageContent").toggle();},_handlePageSaveError:function(s,m){if(s.statusCode==="412"||s.statusCode==="400"){this._showConfirmChangesDialog(s,m);}else{this.showMessageBoxError(s.message,false);}this._setDirtyFlag(true);},_resetModelData:function(){this.getModel().setProperty("/",{page:{},editMode:!!this.oSettingsModel.getProperty("/editMode"),errors:[],warnings:[],messages:[],pageInfoErrors:[],catalogsExpanded:true,currentBreakpointIsS:this.getView().byId("pageContent").getCurrentBreakpoint()==="S"});},_onPageMatched:function(k){var A=k.getParameter("arguments");this.sPageID=decodeURIComponent(A.pageId);this.oSettingsModel=this.getOwnerComponent().getModel("settings");this.setTitle(this.getResourceBundle().getText("PageDetails.Title"));this.getView().byId("iconTabBar").setSelectedKey("iconTabBarPageContent");this._resetModelData();this._resetRolesModel();this._deeplinkAccess=this.oSettingsModel.getProperty("/deepLink");this.oSettingsModel.setProperty("/deepLink",true);this.oTransportComponentPromise=this.getOwnerComponent().createTransportComponent();this._enhanceTabBarWithTransports();this._loadPage(this.navigateBack.bind(this));},_loadPage:function(o){u.setPerformanceMark("FLPPage-manage.startLoadPageDetail");var p=this.getPageRepository();this.getView().setBusy(true);this._setDirtyFlag(false);return Promise.all([sap.ushell.Container.getServiceAsync("VisualizationLoading"),this.oTransportComponentPromise,p.getPage(this.sPageID),p.getRoles(this.sPageID)]).then(function(k){this.oVisualizationLoadingService=k[0];var t=k[1];var l=k[2];var m=k[3];this._resetRolesModel({available:m.map(function(n){return n.id;})});this._setSupportedOperationModel(l);if(!this._pageDisplayAllowed(l)){this.navigateToUnsupportedPage(l.id);return Promise.resolve();}if(!this.getModel().getProperty("/editMode")){this.getModel().setProperty("/page",l);if(t.setShowAssignButton){t.setShowAssignButton(false);}return Promise.resolve(l);}return this._tryEnablingEditMode(l,t,o);}.bind(this)).finally(function(){var k=this.getView().byId("page");var O={onAfterRendering:function(){u.setPerformanceMark("FLPPage-manage.PageDetailCompletelyLoaded");k.removeEventDelegate(O);}};k.addEventDelegate(O);this.getView().setBusy(false);u.setPerformanceMark("FLPPage-manage.endLoadPageDetail");}.bind(this)).catch(function(E){L.error(E);this.navigateToErrorPage(this.sPageID);}.bind(this));},_tryEnablingEditMode:function(p,t,o){return this._pageEditAllowed(p).then(function(E){this.getModel().setProperty("/page",p);if(!E){this.getModel().setProperty("/editMode",false);if(t.setShowAssignButton){t.setShowAssignButton(false);}}else{this.checkShowEditDialog(p,this._updatePageWithMetadata.bind(this),o);this._loadTileSelector();if(t.setShowAssignButton){t.setShowAssignButton(true);}if(!this.getModel().getProperty("/page/sections").length){this.Page.addSection();}else{this._collectMessages();}}return Promise.resolve(p);}.bind(this));},_loadTileSelector:function(){u.setPerformanceMark("FLPPage-manage.startLoadTileSelector");this.TileSelector.init(this);this.onBreakpointChanged();return this.TileSelector.initTiles().then(function(){this.TileSelector.setAddTileHandler(this.addVisualizationInSection.bind(this));u.setPerformanceMark("FLPPage-manage.endLoadTileSelector");}.bind(this));},_enhanceTabBarWithTransports:function(){this.oTransportComponentPromise.then(function(t){if(t.setIconTabBar){t.setIconTabBar(this.getView().byId("iconTabBar"),this.sPageID,"Page");}if(t.attachAssign&&!t.hasListeners("assign")){t.attachAssign(this.onAssignTransport,this);}}.bind(this));},onAssignTransport:function(k){var t=k.getParameter("transportId");this._enhanceModelWithTransportId(t);},_enhanceModelWithTransportId:function(t){var r=this.getResourceBundle();var p=this.getModel().getProperty("/page");p.transportId=t;this.savePageAndUpdateModel(p).then(function(){a.show(r.getText("Message.SavedChanges"),{closeOnBrowserNavigation:false});this._setDirtyFlag(false);}.bind(this)).catch(function(s){this.getPageRepository().getPageWithoutStoringETag(this.sPageID).then(function(R){this._handlePageSaveError(s,R.modifiedByFullname||R.modifiedBy);}.bind(this)).catch(function(){this._handlePageSaveError(s);}.bind(this));}.bind(this)).finally(function(){this.getView().setBusy(false);}.bind(this));},onOpenTileInfo:function(E){var o=E.getSource();this._openTileInfoPopover(o,o.getBindingContext());},_updatePageWithMetadata:function(k){if(k.transportId){this.getModel().setProperty("/page/transportId",k.transportId);this._setDirtyFlag(true);}var D=k.getSource().getParent();D.close();},_deletePage:function(E){var D=E.getSource().getParent(),t=E.transportId||"",s=this.getResourceBundle().getText("Message.SuccessDeletePage");f.show(0);return this.getPageRepository().deletePage(this.sPageID,t).then(function(){this.navigateBack();a.show(s,{closeOnBrowserNavigation:false});D.close();}.bind(this)).catch(this.handleBackendError.bind(this)).finally(function(){f.hide();});},onEdit:function(){this.getModel().setProperty("/editMode",true);this._loadPage(this.discardChangesAndCancel.bind(this));},onSave:function(){var p=this.getModel().getProperty("/page");var r=this.getResourceBundle();var s=function(k){if(k===M.Action.OK){this.getView().setBusy(true);this.getModel().setProperty("/editMode",false);this.savePageAndUpdateModel(p).then(function(){a.show(r.getText("Message.SavedChanges"),{closeOnBrowserNavigation:false});this._setDirtyFlag(false);}.bind(this)).catch(function(S){this.getPageRepository().getPageWithoutStoringETag(p.id).then(function(l){this._handlePageSaveError(S,l.modifiedByFullname||l.modifiedBy);}.bind(this)).catch(function(){this._handlePageSaveError(S);}.bind(this));}.bind(this)).finally(function(){this.getView().setBusy(false);}.bind(this));}}.bind(this);if(!p.title){this.showMessageBoxError(r.getText("Message.EmptyTitle"));return;}if(!window.navigator.onLine){this.showMessageBoxError(r.getText("Message.NoInternetConnection"));return;}if(this.getModel().getProperty("/errors").length>0){sap.ushell.Container.getServiceAsync("Message").then(function(m){var k=r.getText("Message.PageHasErrors"),t=r.getText("Title.PageHasErrors");m.error(k,t);});return;}if(this.getModel().getProperty("/warnings").length>0){M.confirm(r.getText("Message.PageHasWarnings"),{icon:M.Icon.WARNING,title:r.getText("Title.PageHasWarnings"),actions:[M.Action.YES,M.Action.NO],emphasizedAction:M.Action.YES,initialFocus:M.Action.NO,onClose:function(A){if(A===M.Action.YES){s(M.Action.OK);}}});return;}s(M.Action.OK);},onCancel:function(k){if(!sap.ushell.Container.getDirtyFlag()){this.discardChangesAndCancel();return;}var o=k.getSource();if(!this._oPopover){F.load({id:this.createId("discardChangesFragment"),name:"sap.ushell.applications.PageComposer.view.DiscardChangesPopover",type:"XML",controller:this}).then(function(p){this._oPopover=p;this.getView().addDependent(this._oPopover);this._oPopover.openBy(o);}.bind(this));}else{this._oPopover.openBy(o);}},discardChangesAndCancel:function(){this._reloadPageInfoValueStates();this.getModel().setProperty("/editMode",false);this._loadPage();},_reloadPageInfoValueStates:function(){this._getPageDescriptionError();this._getPageTitleError();},onDelete:function(){var p=this.getModel().getProperty("/page");this.checkShowDeleteDialog(p,this._deletePage.bind(this));},onCopy:function(){var p=this.getModel().getProperty("/page");this.showCopyDialog(p,function(E){var D=E.getSource().getParent();var o=D.getModel().getProperty("/");if(E.transportId){o.transportId=E.transportId;}if(E.devclass){o.devclass=E.devclass;}f.show(0);sap.ushell.Container.getServiceAsync("PageReferencing").then(function(k){return k.createReferencePage(o);}).then(function(r){return this.getPageRepository().copyPage(r);}.bind(this)).then(function(){this.navigateToEdit(o.targetId);a.show(this.getResourceBundle().getText("Message.PageCreated"),{closeOnBrowserNavigation:false});D.close();}.bind(this)).catch(this.handleBackendError.bind(this)).finally(function(){f.hide();});}.bind(this));},onErrorMessageClicked:function(){var p=this.getModel().getProperty("/page");var E=this.formatAssignmentDetailsMessage(p.code);this.showMessageBoxWarning(p.message,E,false);},_showConfirmChangesDialog:function(s,m){if(!this.byId("confirmChangesDialog")){F.load({name:"sap.ushell.applications.PageComposer.view.ConfirmChangesDialog",controller:new C(this.getView(),this.getResourceBundle())}).then(function(D){if(s.statusCode==="412"){var o=sap.ui.getCore().byId("confirmChangesModifiedByText");o.setVisible(true);}var k=m||this.getModel().getProperty("/page/modifiedByFullname");this.getModel().setProperty("/simpleError",{message:s.message,statusCode:s.statusCode,modifiedBy:k});this.getView().addDependent(D);D.open();}.bind(this));}else{this.byId("confirmChangesDialog").open();}},_formatLength:function(o){return(o?o.length:undefined);},_pageEditAllowed:function(p){var E=!this.checkMasterLanguageMismatch(p);return Promise.resolve(E);},_pageDisplayAllowed:function(p){return!p.isTemplate||!this._deeplinkAccess;},savePageAndUpdateModel:function(p){return this.getPageRepository().updatePage(p).then(function(r){this.sPageID=r.id;this.getModel().setProperty("/page",r);}.bind(this));},_collectMessages:function(){var p=this._validatePageInfoAndGetErrors();this.getModel().setProperty("/pageInfoErrors",p);var m=this.Page.collectMessages(),E=m.errors.concat(this._getPageInfoErrors()),w=m.warnings,I=m.infos.concat(this._getPageAssignmentMessages()),k=E.concat(w,I);this.getModel().setProperty("/errors",E);this.getModel().setProperty("/warnings",w);this.getModel().setProperty("/infos",I);this.getModel().setProperty("/messages",k);var o=this.getView().byId("buttonValidation");if(E.length){o.setType(g.Negative);}else if(w.length){o.setType(g.Critical);}else{o.setType(g.Neutral);}},_getPageAssignmentMessages:function(){var p=this.getModel().getProperty("/page"),m=this.getPageRepository().getMissingAssignment(p.code),I=[],r=this.getResourceBundle();if(m==="role"){I.push({type:e.Information,title:r.getText("Message.NotAssignedToRoleInformation"),description:r.getText("Message.NotAssignedToRoleInformationDetails")});}else if(m==="space"){I.push({type:e.Information,title:r.getText("Message.NotAssignedToSpaceInformation"),description:r.getText("Message.NotAssignedToSpaceInformationDetails")});}return I;},_checkPageHasErrors:function(p){if(p.code!==""){var E=this.formatAssignmentDetailsMessage(p.code);this.showMessageBoxWarning(p.message,E,true);return true;}return false;},onSectionTitleChange:function(){this._collectMessages();this._setDirtyFlag(true);},showContextSelector:function(o){sap.ui.require(["sap/ushell/applications/PageComposer/controller/ContextSelector.controller"],function(k){if(!this.oContextSelectorController){this.oContextSelectorController=new k(this.getRootView(),this.getResourceBundle());}var s=this.getModel("roles").getProperty("/selected");this.oContextSelectorController.openSelector(this.sPageID,s,o).catch(function(l){this.oContextSelectorController.destroy();this.handleBackendError(l);}.bind(this));}.bind(this));},onOpenContextSelector:function(){this.showContextSelector(function(s){this._resetRolesModel(s);this._collectMessages();this.TileSelector.refreshRoleContext();}.bind(this));},_delegateFocus:function(o){var k={onAfterRendering:function(){setTimeout(function(){o.focus();o.removeEventDelegate(k);},0);}};o.focus();o.addEventDelegate(k);},addSectionAt:function(s){var S=this.getModel().getProperty("/page/sections");if(!S){L.warning("The Model is not ready yet.");return;}if((!s&&s!==0)||s>S.length){s=S.length;}S.splice(s,0,{title:"",viz:[]});this.getModel().setProperty("/page/sections",S);var p=this.getView().byId("page");this._delegateFocus(p.getSections()[s].byId("title-edit"));this._collectMessages();this._setDirtyFlag(true);},deleteSection:function(s){if((!s&&s!==0)||s<0){return;}var S=this.getModel().getProperty("/page/sections");if(s<S.length){S.splice(s,1);this.getModel().setProperty("/page/sections",S);a.show(this.getResourceBundle().getText("Message.SectionDeleted"));var p=this.getView().byId("page"),k=p.getSections();if(k.length){if(s>(k.length-1)){k[k.length-1].focus();}else{k[s].focus();}}else{this._delegateFocus(p);}this._collectMessages();this._setDirtyFlag(true);}},moveSection:function(o,n){if(!o&&o!==0||!n&&n!==0){return;}var s=this.getModel().getProperty("/page/sections"),S=s.splice(o,1)[0];s.splice(n,0,S);this.getModel().setProperty("/page/sections",s);var k=j.i18n.getText("PageRuntime.Message.SectionMoved");this.getOwnerComponent().getInvisibleMessageInstance().announce(k,d.InvisibleMessageMode.Polite);this._collectMessages();this._setDirtyFlag(true);},addVisualizationInSection:function(v,s,k){if(!v||!s.length){return;}s.forEach(function(S){var V=this.getModel().getProperty("/page/sections/"+S+"/viz");if(!V){L.warning("The Model is not ready yet.");return;}if(typeof k==="undefined"){k=V.length;}V.splice(k,0,v);this.getModel().setProperty("/page/sections/"+S+"/viz",V);this._collectMessages();this._setDirtyFlag(true);}.bind(this));},removeVisualizationInSection:function(v,s){var p="/page/sections/"+s+"/viz",V=this.getModel().getProperty(p);V.splice(v,1);this.getModel().setProperty(p,V);a.show(this.getResourceBundle().getText("Message.VisualizationRemoved"));var o=this.getView().byId("page");var S=o.getSections();var k=S[s];var l=k.getVisualizations();if(l.length){if(v>(l.length-1)){l[l.length-1].focus();}else{l[v].focus();}}else{k.focus();}this._collectMessages();this._setDirtyFlag(true);},moveVisualizationInSection:function(o,n,k,l){if(!o&&o!==0||!n&&n!==0||!k&&k!==0||!l&&l!==0){return false;}var O="/page/sections/"+k+"/viz",N="/page/sections/"+l+"/viz",m=this.getModel().getProperty(O),p=this.getModel().getProperty(N),q=m.splice(o,1);p.splice(n,0,q[0]);this.getModel().setProperty(O,m);this.getModel().setProperty(N,p);var v=j.i18n.getText("PageRuntime.Message.TileMoved");this.getOwnerComponent().getInvisibleMessageInstance().announce(v,d.InvisibleMessageMode.Polite);this._collectMessages();this._setDirtyFlag(true);return true;},_validatePageInfoAndGetErrors:function(){var p=[],t=this._getPageTitleError(),D=this._getPageDescriptionError();if(t){p.push(t);}if(D){p.push(D);}return p;},onPageInfoChange:function(){this._collectMessages();this._setDirtyFlag(true);},_getPageTitleError:function(){var I=this.getView().byId("titleInput"),k=!!I.getValue().trim(),E;if(!k){E={type:e.Error,title:this.getResourceBundle().getText("Message.InvalidPageTitle"),description:this.getResourceBundle().getText("Message.InvalidPageTitleDetails")};I.setValueState(d.ValueState.Error);}else{I.setValueState(d.ValueState.None);}return E;},_getPageDescriptionError:function(){var I=this.getView().byId("descriptionInput"),k=!!I.getValue().trim(),E;if(!k){E={type:e.Error,title:this.getResourceBundle().getText("Message.InvalidPageDescription"),description:this.getResourceBundle().getText("Message.InvalidPageDescriptionDetails")};I.setValueState(d.ValueState.Error);}else{I.setValueState(d.ValueState.None);}return E;},_getPageInfoErrors:function(){return this.getModel().getProperty("/pageInfoErrors")||[];},_setSupportedOperationModel:function(p){if(p.isTemplate){this.getOwnerComponent().setMetaModelDataSapDelivered();}else{this.getOwnerComponent().setMetaModelData();}},_initSpaceAssignment:function(p){this._oCANService=sap.ushell.Container.getService("CrossApplicationNavigation");this._checkNavigationSupported();this.getView().bindElement({path:"PageRepository>/pageSet('"+encodeURIComponent(p)+"')",parameters:{expand:"spaces"}});},_checkNavigationSupported:function(){var I=[{target:{semanticObject:"FLPSpace",action:"manage"}}];var n;this._oCANService.isNavigationSupported(I,this.getOwnerComponent()).done(function(r){n=r[0].supported;}).fail(function(){n=false;}).always(function(){this.getModel().setProperty("/spaceAssignmentNavigationSupported",n);}.bind(this));},onManageLaunchpadSpaces:function(){this._oCANService.toExternal({target:{semanticObject:"FLPSpace",action:"manage"}});},onSpaceItemPress:function(k){var s=k.getParameter("listItem").getBindingContext("PageRepository").getProperty("id");this._oCANService.toExternal({target:{semanticObject:"FLPSpace",action:"manage"},appSpecificRoute:"&/view/"+encodeURIComponent(s)});},onSearchSpaces:function(k){var s=k.getSource().getValue()||"",t=this.byId("spaceAssignmentTable"),o=t.getBinding("items");o.filter(new h([new h("id",i.Contains,s),new h("description",i.Contains,s),new h("title",i.Contains,s)],false));if(o.getLength()===0){if(s){t.setNoDataText(this.getResourceBundle().getText("Message.NoSpacesFound"));}else{t.setNoDataText(this.getResourceBundle().getText("Message.NoSpaces"));}}},showViewSettingsSpaceAssignmentDialog:function(){if(this._oViewSettingsSpaceAssignmentDialog){this._oViewSettingsSpaceAssignmentDialog.open();return;}sap.ui.require(["sap/ui/Device","sap/ushell/applications/PageComposer/controller/ViewSettingsSpaceAssignmentDialog.controller"],function(D,V){F.load({name:"sap.ushell.applications.PageComposer.view.ViewSettingsSpaceAssignmentDialog",type:"XML",controller:new V(this)}).then(function(o){this._oViewSettingsSpaceAssignmentDialog=o;if(D.system.desktop){o.addStyleClass("sapUiSizeCompact");}this.getView().addDependent(o);o.open();}.bind(this));}.bind(this));}});});
