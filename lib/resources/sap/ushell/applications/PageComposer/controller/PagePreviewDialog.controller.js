// Copyright (c) 2009-2020 SAP SE, All Rights Reserved
sap.ui.define(["sap/ui/core/mvc/Controller","sap/ui/core/Fragment","sap/ui/model/json/JSONModel","sap/ui/model/Filter","sap/ushell/Config"],function(C,F,J,a,b){"use strict";var _;var c;var d;var e="";var f;function g(){var A,o,r,p=c&&c.getContent()[0];if(p){r=c.getModel("roleContext").getProperty("/selectedRoles")||[];if(r.length){A=_.getController().getPageRepository().getVizIds(r);o=new a({path:"catalogTileId",caseSensitive:true,test:function(s){return!A||A.indexOf(s)>=0;}});}p.getSections().forEach(function(s){s.getBinding("visualizations").filter(o);});}}function h(r,s){if(c){var m=c.getModel("roleContext");s=s||m.getProperty("/selectedRoles")||[];r=r||m.getProperty("/allRoles")||[];var i=s.length+"";if(!s.length){i=f;}else if(s.length===r.length){i=e;}m.setData({allRoles:r,selectedRoles:s,selectedCountText:i});if(r.length){g();}}}var P=C.extend("sap.ushell.applications.PageComposer.controller.PagePreviewDialog.controller",{load:function(p){return c?Promise.resolve(c):F.load({id:p,name:"sap.ushell.applications.PageComposer.view.PagePreviewDialog",controller:this});},open:function(p){_=p;d=p.getModel().getProperty("/page/id");e=p.getController().getResourceBundle().getText("Message.AllRolesSelected");f=p.getController().getResourceBundle().getText("Message.NoRolesSelected");this.load(p.getId()).then(function(D){c=D;c._oParentView=_;p.addDependent(D);D.setBusy(true);D.setModel(new J({sizeBehavior:b.last("/core/home/sizeBehavior")}),"viewSettings");var o=p.getModel("roles"),i=o&&o.getData()||{},s=i.selectedCountText||e,S=i.selected||[],r=new J({allRoles:[],selectedRoles:S,selectedCountText:s});D.setModel(r,"roleContext");D.open();p.getController().getPageRepository().getRoles(d).then(function(R){h(R,null);c.setBusy(false);});}).catch(function(){if(c){c.setBusy(false);}});},close:function(){if(c){c.close();}},onAfterClose:function(){if(c){c.destroy();c=null;}if(this.oContextSelectorController){this.oContextSelectorController.destroy();this.oContextSelectorController=null;}},onRolesSelected:function(s){h(null,s.selected);},onOpenContextSelector:function(){sap.ui.require(["sap/ushell/applications/PageComposer/controller/ContextSelector.controller"],function(i){if(!this.oContextSelectorController){var p=_.getController();this.oContextSelectorController=new i(p.getRootView(),p.getResourceBundle());}var m=c.getModel("roleContext");var s=m.getProperty("/selectedRoles");this.oContextSelectorController.openSelector(d,s,this.onRolesSelected);}.bind(this));}});return new P();});
