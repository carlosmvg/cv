// Copyright (c) 2009-2020 SAP SE, All Rights Reserved
sap.ui.define(["./BaseController","sap/m/MessageToast","sap/m/ColumnListItem","sap/m/ObjectIdentifier","sap/m/Text","sap/m/ListType","sap/ui/model/json/JSONModel","sap/ui/model/Sorter","./../util/FilterFactory","sap/ushell/utils","sap/ui/core/BusyIndicator"],function(B,M,C,O,T,L,J,S,F,u,a){"use strict";return B.extend("sap.ushell.applications.PageComposer.controller.Main",{aPropertiesToFilterCustomerCreated:["id","title","description"],aPropertiesToFilterSapDelivered:["id","title","description"],oDialogFactory:null,sCurrentTableId:"customerCreatedTable",aPropertiesToFilter:[],mSearchFilter:[],mViewSettingsFilters:[],mFilterFactory:{},formatters:{assignmentStatusText:function(n,N){var i;if(!N){i="Label.NotAssignedToSpace";}else if(!n){i="Label.NotAssignedToRole";}else{i="Label.StatusAssigned";}return this.getResourceBundle().getText(i);},assignmentStatusActive:function(n,N){return!(n&&N);},assignmentStatusState:function(n,N){return n&&N?"Success":"Warning";}},onInit:function(){this._bPageMasterSetLoaded=false;this.setModel(this._createInitialButtonStateModel(),"buttonStates");this.aPropertiesToFilter=this.aPropertiesToFilterCustomerCreated;this.mFilterFactory[this.sCurrentTableId]=new F(this.aPropertiesToFilter);},onItemPress:function(e){var p=this.getPageInTable(e.getParameter("listItem"));this._navigateToDetail(p.id);},_navigateToDetail:function(p){var s=this.getOwnerComponent().getModel("settings");s.setProperty("/editMode",false);s.setProperty("/deepLink",false);this.getRouter().navTo("view",{pageId:encodeURIComponent(p)});},_itemFactory:function(c,i,o){return new C({id:i,type:c,detailPress:this.onEdit.bind(this),cells:[new O({title:o.getObject().id,text:o.getObject().description}),new T({text:o.getObject().title})]});},_loadPageMasterSet:function(){if(!this._bPageMasterSetLoaded){var s=this.getOwnerComponent().getModel("SupportedOperationModel");var c=s.getData().updateSupported?L.DetailAndActive:L.Inactive;this.byId("sapDeliveredTable").bindItems({factory:this._itemFactory.bind(this,c),path:"PageRepository>/pagesMasterSet",key:"id",sorter:new S({path:"id"})});this._bPageMasterSetLoaded=true;}},onSelectionChange:function(e){this._setDeleteAndCopyButtonEnabled(true);},onTabChange:function(e){var s=this.byId("iconTabBar").getProperty("selectedKey");if(s==="iconTabBarSapDelivered"){this.getOwnerComponent().setMetaModelDataSapDelivered();this.sCurrentTableId="sapDeliveredTable";this._loadPageMasterSet();this.aPropertiesToFilter=this.aPropertiesToFilterSapDelivered;if(!this.mFilterFactory[this.sCurrentTableId]){this.mFilterFactory[this.sCurrentTableId]=new F(this.aPropertiesToFilter);}}else{this.getOwnerComponent().setMetaModelData();this.sCurrentTableId="customerCreatedTable";this.aPropertiesToFilter=this.aPropertiesToFilterCustomerCreated;}},onEdit:function(e){u.setPerformanceMark("FLPPage-manage.navigateToEditView");var p=this.getPageInTable(e.getSource());this.navigateToEdit(p.id);},onAdd:function(){var r=this.getResourceBundle();this.showCreateDialog(function(e){var d=e.getSource().getParent();var p=d.getModel().getProperty("/");if(e.transportId){p.transportId=e.transportId;}if(e.devclass){p.devclass=e.devclass;}a.show(0);sap.ushell.Container.getServiceAsync("PageReferencing").then(function(P){return P.createReferencePage(p);}).then(function(R){return this.getPageRepository().createPage(R);}.bind(this)).then(function(){this._navigateToDetail(p.id);M.show(r.getText("Message.PageCreated"),{closeOnBrowserNavigation:false});d.close();}.bind(this)).catch(this.handleBackendError.bind(this)).finally(function(){a.hide();});}.bind(this));},_deletePage:function(e){var r=this.getResourceBundle(),d=e.getSource().getParent(),t=e.transportId||"",o=this.byId(this.sCurrentTableId),i=this.getPageInTable(o.getSelectedItem()),s=r.getText("Message.SuccessDeletePage"),p=this.sCurrentTableId==="customerCreatedTable"?this.getPageRepository().deletePage(i.id,t,i.modifiedOn):this.getPageRepository().deleteMasterPage(i.id,t);a.show(0);return p.then(function(){o.removeSelections();this._setDeleteAndCopyButtonEnabled(false);o.fireSelectionChange();M.show(s,{closeOnBrowserNavigation:false});d.close();}.bind(this)).catch(this.handleBackendError.bind(this)).finally(function(){a.hide();});},onDelete:function(){var t=this.byId(this.sCurrentTableId),s=t.getSelectedItem();if(!s){return;}this.checkShowDeleteDialog(this.getPageInTable(s),this._deletePage.bind(this));},getPageInTable:function(s){return s.getBindingContext("PageRepository").getObject();},onCopy:function(){var t=this.byId(this.sCurrentTableId),s=t.getSelectedItem(),r=this.getResourceBundle();if(!s){return;}var p=this.getPageInTable(s);this.showCopyDialog(p,function(e){var d=e.getSource().getParent();var P=d.getModel().getProperty("/");if(e.transportId){P.transportId=e.transportId;}if(e.devclass){P.devclass=e.devclass;}a.show(0);sap.ushell.Container.getServiceAsync("PageReferencing").then(function(b){return b.createReferencePage(P);}).then(function(R){return this.getPageRepository().copyPage(R);}.bind(this)).then(function(){this._navigateToDetail(P.targetId);M.show(r.getText("Message.PageCreated"),{closeOnBrowserNavigation:false});d.close();}.bind(this)).catch(this.handleBackendError.bind(this)).finally(function(){a.hide();});}.bind(this));},onSearch:function(e){var t=this.byId(this.sCurrentTableId),b=t.getBinding("items"),r=this.getResourceBundle(),s=e.getSource().getValue(),o=this.mFilterFactory[this.sCurrentTableId].createOrFilter(s);this.mSearchFilter[this.sCurrentTableId]=o;this._applyCombinedFilters(this.mViewSettingsFilters[this.sCurrentTableId],o);if(b.getLength()===0){if(s){t.setNoDataText(r.getText("Message.NoPagesFound"));}else{t.setNoDataText(r.getText("Message.NoPages"));}}},onTableUpdate:function(){u.setPerformanceMark("FLPPage-manage.tableOverviewUpdated");var t=this.byId(this.sCurrentTableId);if(t.getSelectedItems().length===0){t.removeSelections(true);this._setDeleteAndCopyButtonEnabled(false);}},_createInitialButtonStateModel:function(){return new J({isDeleteAndCopyEnabledCustomerCreated:false,isDeleteAndCopyEnabledSapDelivered:false});},_setDeleteAndCopyButtonEnabled:function(e){this.getView().getModel("buttonStates").setProperty(this.sCurrentTableId==="customerCreatedTable"?"/isDeleteAndCopyEnabledCustomerCreated":"/isDeleteAndCopyEnabledSapDelivered",e);},onErrorMessageClicked:function(e){var s=e.getSource().getBindingContext("PageRepository").getObject();var m=this.getOwnerComponent().getModel("message");var p="/pageSet('"+s.id+"')";var E;m.getData().some(function(o){if(o.target.toLowerCase().indexOf(p.toLowerCase())!==-1){E=o;}return!!E;});if(E){this.showMessageBoxWarning(E.message,this.formatAssignmentDetailsMessage(E.code),false);}},showViewSettingsCustomerCreatedDialog:function(t){if(this._oViewSettingsCustomerCreatedDialog){this._oViewSettingsCustomerCreatedDialog.open(t);return;}sap.ui.require(["sap/ui/core/Fragment","sap/ui/Device","sap/ushell/applications/PageComposer/controller/ViewSettingsCustomerCreatedDialog.controller"],function(b,D,V){b.load({name:"sap.ushell.applications.PageComposer.view.ViewSettingsCustomerCreatedDialog",type:"XML",controller:new V(this)}).then(function(f){this._oViewSettingsCustomerCreatedDialog=f;if(D.system.desktop){f.addStyleClass("sapUiSizeCompact");}this.getView().addDependent(f);f.open(t);}.bind(this));}.bind(this));},showViewSettingsSapDeliveredDialog:function(t){if(this._oViewSettingsSapDeliveredDialog){this._oViewSettingsSapDeliveredDialog.open(t);return;}sap.ui.require(["sap/ui/core/Fragment","sap/ui/Device","sap/ushell/applications/PageComposer/controller/ViewSettingsSapDeliveredDialog.controller"],function(b,D,V){b.load({name:"sap.ushell.applications.PageComposer.view.ViewSettingsSapDeliveredDialog",type:"XML",controller:new V(this)}).then(function(f){this._oViewSettingsSapDeliveredDialog=f;this.getView().addDependent(f);f.open(t);}.bind(this));}.bind(this));},_applyCombinedFilters:function(f,c){var b=this.byId(this.sCurrentTableId).getBinding("items");var s=this.mFilterFactory[this.sCurrentTableId].createFilters(f,c);b.filter(s);}});});
