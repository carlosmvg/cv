// Copyright (c) 2009-2020 SAP SE, All Rights Reserved
sap.ui.define(["sap/m/Button","sap/m/library","sap/m/List","sap/m/ResponsivePopover","sap/m/StandardListItem","sap/ui/core/Fragment","sap/ui/model/Filter","sap/ui/model/FilterOperator","sap/ui/model/json/JSONModel","sap/ui/model/Sorter","sap/ushell/utils/clone","sap/ushell/services/Container"],function(B,m,L,R,S,F,a,b,J,c,C){"use strict";var d=m.ButtonType;var P=m.PlacementType;var e=m.ListMode;var f=m.ListSeparators;return function(){var p,o,t,i,r,g,A,M,h,j={},s,k,l,n,q,v;function _(){return i.getSelectedKey()==="roles"?r:g;}function u(){z();G(M.getProperty("/catalogsDescending"),M.getProperty("/vizDescending"));}function w(){A.setEnabled(!!H().length);}this.init=function(Q){p=Q.getView();o=p.byId("tileSelector");t=p.byId("tileSelectorToolbar");i=p.byId("contextSwitch");r=p.byId("rolesTilesList");g=p.byId("catalogsTilesList");A=p.byId("tileSelectorAddButton");j.i18n=Q.getResourceBundle();M=new J({catalogsDescending:false,vizDescending:false,vizReferenceHierarchySet:undefined,showSwitchViewButton:false});M.setSizeLimit(Infinity);o.setModel(M);h=p.getModel("roles");s=new L({mode:e.MultiSelect,showSeparators:f.None,includeItemInSelection:true,selectionChange:function(){k.getBeginButton().setEnabled(!!s.getSelectedItem());},items:{path:"/page/sections",template:new S({title:"{title}"})},noDataText:j.i18n.getText("Message.NoSections")}).setModel(p.getModel());A.setEnabled(false);if(v){v.fireReset();}i.attachSelect(u);r.attachSelectionChange(w);g.attachSelectionChange(w);};function x(){var Q={};Q.parameters={expand:"vizReferences"};Q.path="/vizReferenceHierarchySet";Q.factory=function(T,U){switch(U.getProperty("type")){default:case"catalog":return p.byId("tileSelectorGroupHeader").clone();case"visualization":return p.byId("tileSelectorCustomListItem").clone().bindObject(U.getPath()+"/vizReferences");}};return Q;}function y(Q){if(Q&&Q.length){var T=x();var U=(Q||[]).map(function(V){return new a("catalogId",b.EQ,V);});T.filters=U;g.setModel(p.getModel("PageRepository"));g.bindItems(T);}else{g.unbindItems();}i.setSelectedKey("catalogs");u();g.removeSelections(true);w();}this.initTiles=function(V){i.setSelectedKey("roles");A.setEnabled(false);var Q=x();if(typeof V!=="undefined"){M.setProperty("/vizReferenceHierarchySet",V);r.setModel(undefined);delete Q.parameters;}else{M.setProperty("/vizReferenceHierarchySet",undefined);r.setModel(p.getModel("PageRepository"));}if(h.getProperty("/available").length){r.bindItems(Q);u();return new Promise(function(T){r.attachUpdateFinished(T);});}r.unbindItems();return Promise.resolve();};this.refreshRoleContext=function(){z();};this.onSearchTiles=function(Q){q=Q.getParameter("query");z();};function z(){var Q=_().getBinding("items");var T=D();if(Q&&(JSON.stringify(Q.aLastFiltersArray)!==JSON.stringify(T))){Q.aLastFiltersArray=T;Q.filter(T);}}this.onAddTiles=function(Q){var T=s.getItems();var U=Q.getParameter("item");n=(U?U.getKey():"default");var V=Q.getSource().getBindingContext();if(V){var W=V.getPath();Q.oAddSingleTileItem=_().getItems().filter(function(X){return(X.getBindingContextPath()===W);})[0];}else{delete Q.oAddSingleTileItem;}if(T.length===1){T[0].setSelected(true);O(Q.oAddSingleTileItem);}else{I(Q);}};this.onAddCatalogs=function(){sap.ui.require(["sap/ushell/applications/PageComposer/controller/CatalogSelector.controller"],function(Q){Q.selectCatalogs(p,y);});};this.showViewSettingsDialog=function(){if(v){v.getModel().setProperty("/catalogsDescending",M.getProperty("/catalogsDescending"));v.getModel().setProperty("/vizDescending",M.getProperty("/vizDescending"));v.open();return;}sap.ui.require(["sap/ushell/applications/PageComposer/controller/ViewSettingsTileSelector.controller"],function(V){F.load({id:p.createId("tileSelectorViewSettings"),name:"sap.ushell.applications.PageComposer.view.ViewSettingsTileSelector",type:"XML",controller:new V(p)}).then(function(Q){v=Q;Q.setModel(new J({catalogsDescending:false,vizDescending:false}));Q.setModel(p.getModel("i18n"),"i18n");Q.open();Q.attachConfirm(function(T){var U=T.getSource().getModel();G(U.getProperty("/catalogsDescending"),U.getProperty("/vizDescending"));});p.addDependent(Q);});});};this.setAddTileHandler=function(Q){l=function(T,U,V){delete T.id;Q(T,U,V);};};this.onDragStart=function(Q){if(typeof l!=="function"){throw new Error("Impossible to add Tile as no \"fnAddTileHandler\" was set via \"setAddTileHandler\"");}var T=Q.getParameter("target").getBindingContext().getProperty();if(T.type==="catalog"){Q.preventDefault();return;}Q.getParameter("dragSession").setComplexData("callback",function(U,V){var W=C(T);W.displayFormatHint="default";l(W,[V],U);});};this.setEnableDnD=function(Q){if(r&&r.getDragDropConfig().length===1){r.getDragDropConfig()[0].setEnabled(Q);}if(g&&g.getDragDropConfig().length===1){g.getDragDropConfig()[0].setEnabled(Q);}};this.showSwitchViewButton=function(Q){if(M){M.setProperty("/showSwitchViewButton",Q);}};function D(){var Q=[];if((_()===r)&&!M.getProperty("/vizReferenceHierarchySet")){var T=h.getProperty("/selected");if(!T.length){T=h.getProperty("/available");}T.forEach(function(U){Q.push(new a("roleId",b.EQ,U));});}if(q){Q.push(new a([new a("vizReferences/id",b.Contains,q),new a("vizReferences/title",b.Contains,q),new a("vizReferences/subTitle",b.Contains,q)],false));}return Q;}function E(Q,T){return[new c("title",Q),new c("vizReferences/title",T)];}function G(Q,T){var U=E(Q,T);var V=_().getBinding("items");if(V&&(JSON.stringify(V.aLastSorterArray)!==JSON.stringify(U))){V.aLastSorterArray=U;V.sort(U);}M.setProperty("/catalogsDescending",Q);M.setProperty("/vizDescending",T);}function H(){var Q=_();var T=Q.getModel();return Q.getSelectedContextPaths().map(function(U){return T.getContext(U).getProperty();});}function I(Q){if(!k||k.bIsDestroyed){N();}s.removeSelections(true);k.getBeginButton().setEnabled(false).oEvent=Q;k.getEndButton().setEnabled(true);var T;if(!Q.oAddSingleTileItem&&K(A)){T=t.getAggregation("_overflowButton");}else{T=Q.getSource();if(T.isA("sap.m.Menu")){T=T.getParent();}}k.openBy(T);}function K(Q){return(Q.hasStyleClass("sapMOTAPButtonNoIcon")||Q.hasStyleClass("sapMOTAPButtonWithIcon"));}function N(){k=new R({id:"sectionSelectionPopover",placement:P.Auto,title:j.i18n.getText("Tooltip.AddToSections"),beginButton:new B({type:d.Emphasized,text:j.i18n.getText("Button.Add"),press:function(){this.setEnabled(false);k.close();O(this.oEvent.oAddSingleTileItem);}}),endButton:new B({text:j.i18n.getText("Button.Cancel"),press:function(){this.setEnabled(false);k.close();}}),content:s,initialFocus:s});o.addDependent(k);}function O(Q){if(typeof l!=="function"){throw new Error("Impossible to add Tile as no \"fnAddTileHandler\" was set via \"setAddTileHandler\"");}var T=s.getSelectedItems().map(function(V){return s.indexOfItem(V);});var U;if(Q){U=[Q.getBindingContext().getProperty()];Q.setSelected(false);}else{U=H();_().removeSelections(true);}w();U.forEach(function(V){var W=C(V);W.displayFormatHint=n;l(W,T);});if(M&&M.getProperty("/showSwitchViewButton")){p.getController().switchDynamicSideContentView();}}};});
