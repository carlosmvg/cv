//Copyright (c) 2009-2020 SAP SE, All Rights Reserved
sap.ui.define(["sap/ui/core/UIComponent","sap/ui/model/json/JSONModel","sap/base/Log","sap/ui/core/library","sap/ui/model/Filter","sap/ui/model/FilterOperator","sap/ui/core/mvc/XMLView","sap/m/IconTabFilter"],function(U,J,L,c,F,a,X,I){"use strict";var V=c.ValueState;var M={off:"OFF",manual:"MANUAL",auto:"AUTOMATIC"};return U.extend("sap.ushell_abap.transport.Component",{metadata:{manifest:"json",associations:{iconTabBar:{type:" sap.m.IconTabBar",multiple:false}},properties:{showAssignButton:{name:"showAssignButton",type:"Boolean",defaultValue:false}},aggregations:{dependents:{name:"dependents",type:"sap.ui.core.Element",multiple:true}},events:{change:{parameters:{valid:{type:"Boolean"},required:{type:"Boolean"}}},assign:{parameters:{transportId:{type:"string"}}}}},init:function(){U.prototype.init.apply(this,arguments);var t=this.getModel("Transport");this._initModels();this.fnOriginAttachChange=this.attachChange;this.attachChange=function(){this.fnOriginAttachChange.apply(this,arguments);this.fireChange({valid:!this.getModel("TransportInformation").getProperty("/required"),empty:true,required:!!this.getModel("TransportInformation").getProperty("/required")});};this._oMetadataPromise=new Promise(function(r,b){if(t.isMetadataLoadingFailed()){b("Metadata failed to load.");}t.attachMetadataFailed(b);t.metadataLoaded().then(r);});},_initModels:function(){this.setModel(new J({showAssignButton:this.getShowAssignButton()}),"ViewSettings");this.setModel(new J({mode:null}),"Mode");this.setModel(new J({transportId:null,required:true,valueState:V.None,value:"",transports:[]}),"TransportInformation");},_saveMode:function(){var p;if(this.getModel("Mode").getProperty("/mode")!==null){p=Promise.resolve(this.getModel("Mode").getProperty("/mode"));}else{p=this._getMode().then(function(r){return r&&r.mode?r.mode.transportMode:M.off;}).catch(function(){return M.off;});}return p.then(this._setMode.bind(this));},_setMode:function(m){this.getModel("Mode").setProperty("/mode",m);if(m===M.auto){this.getModel("TransportInformation").setProperty("/required",true);}else{this.getModel("TransportInformation").setProperty("/required",false);}},_getMode:function(){if(this.oModePromise){return this.oModePromise;}this.oModePromise=new Promise(function(r,b){this.getModel("Transport").callFunction("/mode",{method:"POST",success:r,error:b});}.bind(this));return this.oModePromise;},_getTransports:function(o){return new Promise(function(r,b){this.getModel("Transport").read("/transportSet",{success:r,error:b,filters:[new F("objectId",a.EQ,o.toUpperCase())]});}.bind(this));},_setTransportData:function(r,s){function b(d,e){for(var i=0;i<d.length;i++){if(d[i].getCode()==="/UI2/PAGE/055"){e.setProperty("/required",false);}else{e.setProperty("/required",true);}}}var m=this.getModel("Transport").getMessages({sDeepPath:"/transportSet"});this.getModel("TransportInformation").setProperty("/transports",r.results);if(!s){return;}else{if(m.length!==0&&this.getModel("Mode").getProperty("/mode")===M.auto){b(m,this.getModel("TransportInformation"));}else if(m.length===0&&this.getModel("Mode").getProperty("/mode")===M.auto){this.getModel("TransportInformation").setProperty("/required",true);}else if(m.length===0&&this.getModel("Mode").getProperty("/mode")===M.manual){this.getModel("TransportInformation").setProperty("/required",true);}else if(m.length!==0&&this.getModel("Mode").getProperty("/mode")===M.manual){b(m,this.getModel("TransportInformation"));}this.getRootControl().getController().validate();}},_decorateTabBarWithTransportTable:function(o,b){var s=this.getAssociation("iconTabBar");var d=sap.ui.getCore().byId(s);for(var i=0;i<d.getItems().length;i++){if(d.getItems()[i].getKey()==="iconTabBarTransports"){d.getItems()[i].getContent()[0].getController().bindItems(o,b,d.getItems()[i]);return;}}X.create({id:this.createId("assignedTransport"),viewName:"sap.ushell_abap.transport.view.TransportTable"}).then(function(v){this.addDependent(v);v.setModel(this.getModel("Transport"),"Transport");v.setModel(this.getModel("i18n"),"i18n");v.setModel(this.getModel("ViewSettings"),"ViewSettings");var e=new I({content:v,key:"iconTabBarTransports"});d.addItem(e);v.getController().connect(this);v.getController().bindItems(o,b,e);}.bind(this));},setIconTabBar:function(i,o,b){this.setAssociation("iconTabBar",i,true);this._saveMode().then(function(){if(this.getModel("Mode").getProperty("/mode")===M.off){return;}this._decorateTabBarWithTransportTable(o,b);}.bind(this));return this;},reset:function(){this.getModel("TransportInformation").setProperty("/transportId",null);this.getModel("TransportInformation").setProperty("/value","");this.getModel("TransportInformation").setProperty("/required",true);this.getModel("TransportInformation").setProperty("/valueState",V.None);return Promise.resolve();},decorateResultWithTransportInformation:function(s){var t=this.getModel("TransportInformation").getProperty("/transportId");if(!s){s={};}if(t){s.transportId=t;}return s;},_getAssignedTransports:function(o,b){if(!o){return new Promise(function(r,d){r({results:[]});});}var f=[];f.push(new F("objectId",a.EQ,o.toUpperCase()));f.push(new F("objectType",a.EQ,b));return new Promise(function(r,d){this.getModel("Transport").read("/assignedTransportSet",{success:r,error:d,filters:f});}.bind(this));},showTransport:function(s,o){if(typeof o!=="string"){return new Promise(function(r,b){b("No parameter 'objectType' provided");});}this.getRootControl().setBusy(true);this.fireChange({valid:false,empty:true,required:true});return new Promise(function(r,b){Promise.all([this._getAssignedTransports(s?s.id:"",o),this._oMetadataPromise,this._saveMode()]).then(function(d){if(d[0].results.length){this.fireChange({valid:true,empty:true,required:false});r(false);}else{var S=this.getModel("Mode").getProperty("/mode")!==M.off;if(!S){r(S);}this._getTransports(s?s.id:"").then(function(d){this._setTransportData(d,s);this.fireChange({valid:!this.getModel("TransportInformation").getProperty("/required"),empty:true,required:!!this.getModel("TransportInformation").getProperty("/required")});r(S);}.bind(this));}}.bind(this)).catch(function(e){L.error(e);r(false);}).finally(function(){this.getRootControl().setBusy(false);}.bind(this));}.bind(this));},showLockedMessage:function(){return Promise.resolve(false);},setShowAssignButton:function(s){this.getModel("ViewSettings").setProperty("/showAssignButton",!!s);this.setProperty("showAssignButton",s,true);}});});
