sap.ui.define(["sap/ui/core/mvc/Controller","sap/ovp/cards/ActionUtils","sap/ui/generic/app/navigation/service/SelectionVariant","sap/ui/generic/app/navigation/service/PresentationVariant","sap/ovp/cards/CommonUtils","sap/ovp/cards/OVPCardAsAPIUtils","sap/ui/core/ResizeHandler","sap/ui/core/format/NumberFormat","sap/ovp/cards/AnnotationHelper","sap/ui/model/odata/AnnotationHelper","sap/m/MessageBox","sap/ui/generic/app/navigation/service/NavError","sap/ui/core/CustomData","sap/ui/model/FilterOperator","sap/ui/model/json/JSONModel","sap/m/Dialog","sap/m/Button","sap/m/MessageToast","sap/ui/core/TextDirection","sap/ui/generic/app/library","sap/ui/thirdparty/jquery","sap/ovp/app/resources","sap/ovp/app/OVPUtils","sap/ui/events/KeyCodes","sap/base/util/isPlainObject","sap/base/util/merge","sap/ovp/cards/ovpLogger","sap/ovp/cards/jUtils","sap/base/util/isEmptyObject"],function(C,A,S,P,a,O,R,N,b,c,M,d,e,F,J,D,B,f,T,G,q,g,h,K,k,m,o,u,l){"use strict";var L=new o("OVP.generic.Card");return C.extend("sap.ovp.cards.generic.Card",{initKeyboardNavigation:function(){var j=function(i){this.init(i);};j.prototype.layoutItemFocusHandler=function(){var n=q(document.activeElement);if(n){var p=n.find("[aria-label]");var i,s="";if(n.find('.valueStateText').length==1){var t=n.find('.valueStateText').find('.sapMObjectNumberText').text();var v=n.find('.valueStateText').find('.sapUiInvisibleText').text();n.find('.valueStateText').attr('aria-label',t+" "+v);n.find('.valueStateText').attr('aria-labelledby',"");}n.find("[role='listitem']").attr('aria-label',"");if(n.hasClass('sapOvpCardHeader')&&!n.hasClass('sapOvpStackCardContent')){var r="";var w=n.find('.cardHeaderType');if(w.length===0){var x=g.getText("CardHeaderType");r="cardHeaderType_"+new Date().getTime();var y='<div id="'+r+'" class="cardHeaderType" aria-label="'+x+'" hidden></div>';n.append(y);}else{r=w[0].id;}s+=r+" ";}for(i=0;i<p.length;i++){if(p[i].getAttribute("role")==="heading"){s+=p[i].id+" ";}}if(n.hasClass('sapOvpCardHeader')){var z=n.find('.cardHeaderText');if(z.length!==0){for(var i=0;i<z.length;i++){if(s.indexOf(z[i].id)===-1){s+=z[i].id+" ";}}}}if(s.length){n.attr("aria-labelledby",s);}if(n.prop('nodeName')==="LI"&&n.find('.linkListHasPopover').length!==0){if(n.find('#hasDetails').length===0){n.append("<div id='hasDetails' hidden>"+g.getText("HAS_DETAILS")+"</div>");n.attr('aria-describedby',"hasDetails");}}var E=n.attr("id");if((E&&E.indexOf("ovpTable")!=-1)&&n.find("[role='Link']")&&!n.hasClass('sapUiCompSmartLink')){var H=n.closest("td").attr("data-sap-ui-column"),I=n.closest("tbody").siblings().children().filter("tr").children();for(var i=0;i<I.length;i++){if(I[i].getAttribute("data-sap-ui")==H&&I[i].hasChildNodes("span")){var Q=I[i].firstElementChild.getAttribute("id");n.attr("aria-labelledby",Q);}}}}};j.prototype.init=function(i){this.cardLayout=i;this.keyCodes=K;this.jqElement=q(i.getView().$());this.jqElement=this.jqElement.parent().parent().parent();this.jqElement.on("focus.keyboardNavigation",this.layoutItemFocusHandler.bind(this));};this.keyboardNavigation=new j(this);},onInit:function(){this.oCardComponent=this.getOwnerComponent();this.oCardComponentData=this.oCardComponent&&this.oCardComponent.getComponentData();this.oMainComponent=this.oCardComponentData&&this.oCardComponentData.mainComponent;this.sCardId=this.oCardComponentData.cardId;var s=this.getView().mPreprocessors.xml[0].ovpCardProperties.oData.state;if(s!=="Error"){var H=this.getView().byId("ovpCardHeader");if(!!H){H.attachBrowserEvent("click",this.onHeaderClick.bind(this));H.addEventDelegate({onkeydown:function(E){if(!E.shiftKey&&E.keyCode==13){E.preventDefault();this.onHeaderClick(E);}else if(!E.shiftKey&&E.keyCode==32){E.preventDefault();}}.bind(this)});H.addEventDelegate({onkeyup:function(E){if(!E.shiftKey&&E.keyCode==32){E.preventDefault();this.onHeaderClick(E);}}.bind(this)});}}var n=this.getView().byId("kpiNumberValue");if(n){n.addEventDelegate({onAfterRendering:function(){var $=n.$();var i=$.find(".sapMNCValueScr");var j=$.find(".sapMNCScale");i.attr("aria-label",i.text());j.attr("aria-label",j.text());var p=this.getView().byId("ovpCardHeader").getDomRef();var r=this.getOwnerComponent().getComponentData();if(!!r&&!!r.appComponent){var t=r.appComponent;if(!!t.getModel("ui")){var U=t.getModel("ui");if(!!U.getProperty("/containerLayout")&&U.getProperty("/containerLayout")==="resizable"){var v=r.appComponent.getDashboardLayoutUtil();if(!!v){v.setKpiNumericContentWidth(p);}}}}}.bind(this)});}},exit:function(){if(this.resizeHandlerId){R.deregister(this.resizeHandlerId);}},onAfterRendering:function(){var i=this.getCardPropertiesModel();this.enableClick=true;var s=i.getProperty("/contentFragment");var j=this.getOwnerComponent().getComponentData();this._handleCountHeader();this._handleKPIHeader();var n=i.getProperty("/selectedKey");if(n&&i.getProperty("/state")!=='Loading'){var p=this.getView().byId("ovp_card_dropdown");if(p){p.setSelectedKey(n);}}try{var j=this.getOwnerComponent().getComponentData();if(j&&j.appComponent){var r=j.appComponent;if(r.getModel('ui')){var U=r.getModel('ui');if(U.getProperty('/containerLayout')==='resizable'){var t=r.getDashboardLayoutUtil();if(t){this.oDashboardLayoutUtil=t;this.cardId=j.cardId;if(t.isCardAutoSpan(j.cardId)){this.resizeHandlerId=R.register(this.getView(),function(_){L.info('DashboardLayout autoSize:'+_.target.id+' -> '+_.size.height);t.setAutoCardSpanHeight(_);});}}}}}}catch(v){L.error("DashboardLayout autoSpan check failed.");}if(this.oDashboardLayoutUtil&&this.oDashboardLayoutUtil.isCardAutoSpan(this.cardId)){var $=q("#"+this.oDashboardLayoutUtil.getCardDomId(this.cardId));if(this.oView.$().outerHeight()>$.innerHeight()){this.oDashboardLayoutUtil.setAutoCardSpanHeight(null,this.cardId,this.oView.$().height());}}var I=0;if(j&&j.mainComponent){var w=j.mainComponent;if(w.bGlobalFilterLoaded){I=this.checkNavigation();}}else if(O.checkIfAPIIsUsed(this)){I=this.checkAPINavigation();}var x=this.getCardPropertiesModel();var y=x.getProperty("/state");if(y!=="Loading"&&y!=="Error"){var z=x.getProperty("/template");if(z==="sap.ovp.cards.stack"){if(!I){var E=this.getView().byId('ViewAll');if(E){E=E.getDomRef();E.parentNode.removeChild(E);}}}}if(I){if(s?s!=="sap.ovp.cards.quickview.Quickview":true){if(s==="sap.ovp.cards.stack.Stack"){var H=this.getView().getDomRef();var Q=H.querySelectorAll('.sapOvpCardContentRightHeader');if(Q.length!==0){u.addClassToAllElements(Q,'sapOvpCardNavigable');}}else{this.getView().addStyleClass("sapOvpCardNavigable");}}if(s&&s==="sap.ovp.cards.quickview.Quickview"){var V=this.byId("ovpCardHeader");if(V){V.addStyleClass("sapOvpCardNavigable");}}}else{if(s){this.getView().addStyleClass("ovpNonNavigableItem");var V=this.byId("ovpCardHeader");if(V){V.$().removeAttr('role');V.addStyleClass('ovpNonNavigableItem');}var W=this.checkLineItemNavigation();if(!W){switch(s){case"sap.ovp.cards.list.List":var X=this.getView().byId("listItem");if(X){X.setType("Inactive");}break;case"sap.ovp.cards.table.Table":var X=this.getView().byId("tableItem");if(X){X.setType("Inactive");}break;case"sap.ovp.cards.linklist.LinkList":if(!this.checkNavigationForLinkedList()){var X=this.getView().byId("ovpCLI");if(X){X.setType("Inactive");}}break;}}}}var Y=this.getView().byId("ovp_card_dropdown");var Z=this.getView().byId("ovp_card_dropdown_label");if(Y){Y.addAriaLabelledBy(Z.getId());}if(O.checkIfAPIIsUsed(this)){this.initKeyboardNavigation();}},checkNavigation:function(){var i=this.getCardPropertiesModel();if(this.checkHeaderNavForChart()){return 0;}var E=this.getEntityType();if(E){if(i){var I=i.getProperty("/identificationAnnotationPath");var s=I;var j=i.getProperty("/contentFragment");if(j&&(j==="sap.ovp.cards.stack.Stack"||j==="sap.ovp.cards.quickview.Quickview")){var n=(I)?I.split(","):[];if(n&&n.length>1){if(j==="sap.ovp.cards.stack.Stack"){s=n[0];}else{s=n[1];}}}var r=E[s];if(this.isNavigationInAnnotation(r)){return 1;}if(i&&i.getProperty("/template")==="sap.ovp.cards.charts.analytical"){var p=i.getProperty("/kpiAnnotationPath");if(E&&p){var t=E[p];if(t&&t.Detail){var v=t.Detail.SemanticObject&&t.Detail.SemanticObject.String;var w=t.Detail.Action&&t.Detail.Action.String;if(v&&w){return 1;}}}}}}else if(i&&i.getProperty("/template")==="sap.ovp.cards.linklist"&&i.getProperty("/staticContent")&&i.getProperty("/targetUri")){return 1;}return 0;},checkNavigationForLinkedList:function(){if(this.getEntityType()){var E=this.getEntityType();var i=E['com.sap.vocabularies.UI.v1.LineItem'];if(i&&(i[0].RecordType==="com.sap.vocabularies.UI.v1.DataFieldForAction"||i[0].RecordType==="com.sap.vocabularies.UI.v1.DataFieldWithUrl")){return true;}}return false;},checkLineItemNavigation:function(){if(this.getEntityType()){var E=this.getEntityType();var i=this.getCardPropertiesModel();if(i){var s=i.getProperty("/annotationPath");var r=E[s];return this.isNavigationInAnnotation(r);}}},isNavigationInAnnotation:function(r){if(r&&r.length){for(var i=0;i<r.length;i++){var I=r[i];if(I.RecordType==="com.sap.vocabularies.UI.v1.DataFieldForIntentBasedNavigation"||I.RecordType==="com.sap.vocabularies.UI.v1.DataFieldForAction"||I.RecordType==="com.sap.vocabularies.UI.v1.DataFieldWithUrl"){return 1;}}}return 0;},checkAPINavigation:function(){var i=this.getOwnerComponent().getComponentData(),j=i.fnCheckNavigation&&typeof i.fnCheckNavigation==="function",n=j?i.fnCheckNavigation:null;if(n){if(n()){return true;}}else{if(this.checkNavigation()){return true;}}return false;},onHeaderClick:function(E){var n=E.ctrlKey||E.metaKey?h.constants.explace:h.constants.inplace;if(O.checkIfAPIIsUsed(this)){if(this.checkAPINavigation()){a.onHeaderClicked();}}else{var i=this.getCardPropertiesModel();var t=i.getProperty("/template");var s=i.getProperty("/targetUri");if(t=="sap.ovp.cards.linklist"&&i.getProperty("/staticContent")!==undefined&&s){window.location.href=s;}else if(i.getProperty("/staticContent")!==undefined&&s===""){return;}else if(this.checkHeaderNavForChart()){return;}else{this.doNavigation(this.getView().getBindingContext(),null,n);}}},checkHeaderNavForChart:function(){var i=this.getCardPropertiesModel();var t=i.getProperty("/template");var n=i.getProperty("/navigation");if(n=="noHeaderNav"&&(t=="sap.ovp.cards.charts.analytical"||"sap.ovp.cards.charts.smart.chart")){return true;}else{return false;}},resizeCard:function(i){L.info(i);if(this.resizeHandlerId){R.deregister(this.resizeHandlerId);this.resizeHandlerId=null;}},_handleCountHeader:function(){var i=this.getView().byId("ovpCountHeader");if(i){var I=this.getCardItemsBinding();if(I){if(I.getLength()>0){this.setHeaderCounter(I,i);}I.attachDataReceived(function(){this.setHeaderCounter(I,i);}.bind(this));I.attachChange(function(){this.setHeaderCounter(I,i);}.bind(this));}}},setHeaderCounter:function(i,j){var t=i.getLength();var n=i.getCurrentContexts().length;var p,r="";var s=N.getIntegerInstance({minFractionDigits:0,maxFractionDigits:1,decimalSeparator:".",style:"short"});n=parseFloat(n,10);var v=this.getOwnerComponent().getComponentData();if(v&&v.appComponent){var w=v.appComponent;if(w.getModel('ui')){var U=w.getModel('ui');if(U.getProperty('/containerLayout')!=='resizable'){if(t!==0){t=s.format(Number(t));}if(n!==0){n=s.format(Number(n));}}else{p=w.getDashboardLayoutUtil().dashboardLayoutModel.getCardById(v.cardId);}}}if(n===0){r="";}else if(p&&p.dashboardLayout.showOnlyHeader){r=g.getText("Count_Header_Total",[t]);}else if(t!=n){r=g.getText("Count_Header",[n,t]);}j.setText(r);var x=j.$();x.attr("aria-label",r);},_handleKPIHeader:function(){var i,s;if(this.getView()&&this.getView().getDomRef()){i=this.getView().getDomRef().getElementsByClassName("numericContentHbox");s=this.getView().getDomRef().getElementsByClassName("noDataSubtitle");}else{return;}if(i||s){var j=this.getKPIBinding();if(j){j.attachDataReceived(function(E){var U=E.getParameter("data")&&E.getParameter("data").results&&E.getParameter("data").results[0];var t=j.getLength();if(i[0]){i[0].style.visibility=null;if(t===0){i[0].style.visibility='hidden';}else{this._setSubTitleWithUnitOfMeasure(U);i[0].style.visibility='visible';}}if(s.length!==0){s[0].style.display="none";if(t===0){s[0].style.display="flex";}}}.bind(this));}}},getKPIBinding:function(){var n=this.byId("kpiHBoxNumeric"),i=n&&n.getBindingInfo("items")&&n.getBindingInfo("items").binding;return i;},_setSubTitleWithUnitOfMeasure:function(U){var i=this.getCardPropertiesModel();if(!!i){var j=i.getData();var s=this.getView().byId("SubTitle-Text");if(!!s){s.setText(j.subTitle);if(!!j&&!!j.entityType&&!!j.dataPointAnnotationPath){var E=i.getData().entityType;var n=j.dataPointAnnotationPath.split("/");var p=n.length===1?E[j.dataPointAnnotationPath]:E[n[0]][n[1]];var r;if(p&&p.Value&&p.Value.Path){r=p.Value.Path;}else if(p&&p.Description&&p.Description.Value&&p.Description.Value.Path){r=p.Description.Value.Path;}if(!!r){var t=a.getUnitColumn(r,E);var v;if(!!t&&!!U){v=U[t];}else{v=a.getUnitColumn(r,E,true);}var w=g.getText("SubTitle_IN");if(!!j.subTitle&&!!w&&!!v){s.setText(j.subTitle+" "+w+" "+v);var x=s.getAggregation("customData");if(x){var y;for(y in x){var z=x[y];if(z.getKey()==="aria-label"){z.setValue(j.subTitle+" "+w+" "+v);break;}}}}}}}}},getCardItemsBinding:function(){},onActionPress:function(E){var s=E.getSource(),i=this._getActionObject(s),j=s.getBindingContext();if(i.type.indexOf("DataFieldForAction")!==-1){this.doAction(j,i);}else{this.doNavigation(j,i);}},_getActionObject:function(s){var j=s.getCustomData();var n={};for(var i=0;i<j.length;i++){n[j[i].getKey()]=j[i].getValue();}return n;},doNavigation:function(i,n,s){if(!s){s=h.constants.inplace;}if(!this.enableClick){return;}this.enableClick=false;setTimeout(function(){this.enableClick=true;}.bind(this),1000);if(!this.oMainComponent){return;}if(!n){n=this.getEntityNavigationEntries(i)[0];}var j=m({},i);var p=m({},n);var r=this.oMainComponent.doCustomNavigation&&this.oMainComponent.doCustomNavigation(this.sCardId,j,p);var E=this.oMainComponent.templateBaseExtension&&this.oMainComponent.templateBaseExtension.provideExtensionNavigation&&this.oMainComponent.templateBaseExtension.provideExtensionNavigation(this.sCardId,j,p);var t;if(r){t=r;}if(E){t=E;}if(t){var v=t.type;if(v&&typeof v==="string"&&v.length>0){v=v.split(".").pop().split("/").pop().toLowerCase();switch(v){case"datafieldwithurl":t.type="com.sap.vocabularies.UI.v1.DataFieldWithUrl";break;case"datafieldforintentbasednavigation":t.type="com.sap.vocabularies.UI.v1.DataFieldForIntentBasedNavigation";break;}n=t;}}function w(s){if(!s){s=h.constants.inplace;}if(n){switch(n.type){case"com.sap.vocabularies.UI.v1.DataFieldWithUrl":this.doNavigationWithUrl(i,n,s);break;case"com.sap.vocabularies.UI.v1.DataFieldForIntentBasedNavigation":this.doIntentBasedNavigation(i,n,false,s);break;case"com.sap.vocabularies.UI.v1.KPIDetailType":this.doIntentBasedNavigation(i,n,false,s);break;}}}if(!this.oMainComponent.oAppStatePromise){w.call(this,s);}else{this.oMainComponent.oAppStatePromise.then(w.bind(this,s));}},doNavigationWithUrl:function(i,n,s){if(!s){s=h.constants.inplace;}if(!sap.ushell.Container){return;}var p=sap.ushell.Container.getService("URLParsing");if(!(p.isIntentUrl(n.url))){window.open(n.url);}else{var j=p.parseShellHash(n.url);var w=j.appSpecificRoute?true:false;this.doIntentBasedNavigation(i,j,w,s);}},fnHandleError:function(E){if(E instanceof d){if(E.getErrorCode()==="NavigationHandler.isIntentSupported.notSupported"){M.show(g.getText("OVP_NAV_ERROR_NOT_AUTHORIZED_DESC"),{title:g.getText("OVP_GENERIC_ERROR_TITLE")});}else{M.show(E.getErrorCode(),{title:g.getText("OVP_GENERIC_ERROR_TITLE")});}}},doCrossApplicationNavigation:function(I,n){var s="#"+I.semanticObject+'-'+I.action;if(I.params){var p=this.oCardComponent&&this.oCardComponent.getComponentData();var r=p&&p.appComponent;if(r){var t=r._formParamString(I.params);s=s+t;}}var v=this;if(!sap.ushell.Container){return;}sap.ushell.Container.getService("CrossApplicationNavigation").isIntentSupported([s]).done(function(w){if(w[s].supported===true){if(!!n.params){if(typeof n.params=='string'){try{n.params=JSON.parse(n.params);}catch(x){L.error("Could not parse the Navigation parameters");return;}}}var p=v.getOwnerComponent().getComponentData();var y=p?p.globalFilter:undefined;var U=y&&y.getUiState({allFilters:false});var z=U?JSON.stringify(U.getSelectionVariant()):"{}";y=JSON.parse(z);var E=v._getFilterPreference();y=v._removeFilterFromGlobalFilters(E,y);if(!n.params){n.params={};}if(!!y&&!!y.SelectOptions){for(var i=0;i<y.SelectOptions.length;i++){var H=y.SelectOptions[i].Ranges;if(!!H){var Q=[];for(var j=0;j<H.length;j++){if(H[j].Sign==="I"&&H[j].Option==="EQ"){Q.push(H[j].Low);}}n.params[y.SelectOptions[i].PropertyName]=Q;}}}sap.ushell.Container.getService("CrossApplicationNavigation").toExternal(n);}else{var V=new d("NavigationHandler.isIntentSupported.notSupported");v.fnHandleError(V);}}).then(function(){L.error("Could not get authorization from isIntentSupported");});},doIntentBasedNavigation:function(i,I,U,n){if(!n){n=h.constants.inplace;}if(sap.ushell&&!sap.ushell.Container){return;}var p,j,r,E=i?i.getObject():null;var s=this.getCardPropertiesModel(),t=s.getProperty("/customParams");if(i&&typeof i.getAllData==="function"&&t){r=i.getAllData();}else if(s.getProperty("/staticContent")){r={iStaticLinkListIndex:I.iStaticLinkListIndex,bStaticLinkListIndex:true};}if(E&&E.__metadata){delete E.__metadata;}var v=a.getNavigationHandler();if(v){if(I){p=this._getEntityNavigationParameters(E,r,i);j={target:{semanticObject:I.semanticObject,action:I.action},appSpecificRoute:I.appSpecificRoute,params:p.sNavSelectionVariant};var w={};if(p.sNavPresentationVariant){w.presentationVariant=p.sNavPresentationVariant;}if(U){if(I&&I.semanticObject&&I.action){var x=this.getCardPropertiesModel().getProperty("/staticParameters");j.params=(!!x)?x:{};this.doCrossApplicationNavigation(I,j);}}else{v.navigate(j.target.semanticObject,j.target.action,j.params,null,this.fnHandleError,w,n);}}}},doAction:function(i,j){this.actionData=A.getActionInfo(i,j,this.getEntityType());if(this.actionData.allParameters.length>0){this._loadParametersForm();}else{this._callFunction();}},getEntityNavigationEntries:function(j,s){var n=[];var E=this.getEntityType();var p=this.getCardPropertiesModel();var r=p.getProperty("/template");if(!E){return n;}if(!s&&!j){if(!this.oCardComponentData.settings.identificationAnnotationPath){var t=p.getProperty("/kpiAnnotationPath");if(t&&r==="sap.ovp.cards.charts.analytical"){s=t;var v=E[s];var w=v&&v.Detail;var x=w.SemanticObject&&w.SemanticObject.String;var y=w.Action&&w.Action.String;if(w.RecordType==="com.sap.vocabularies.UI.v1.KPIDetailType"){if(x&&y){n.push({type:w.RecordType,semanticObject:x,action:y,label:""});}else{L.error("Invalid Semantic object and action configured for annotation "+w.RecordType);}}}}}if(!s){var I=p.getProperty("/identificationAnnotationPath");var z=(I)?I.split(","):[];if(z&&z.length>1){s=z[0];}else{s=I;}}var H=E[s];if(Array.isArray(H)){H=b.sortCollectionByImportance(H);for(var i=0;i<H.length;i++){if(H[i].RecordType==="com.sap.vocabularies.UI.v1.DataFieldForIntentBasedNavigation"){n.push({type:H[i].RecordType,semanticObject:H[i].SemanticObject.String,action:H[i].Action.String,label:H[i].Label?H[i].Label.String:null});}if(H[i].RecordType==="com.sap.vocabularies.UI.v1.DataFieldWithUrl"&&!H[i].Url.UrlRef){var Q=this.getView().getModel();var U=Q.oMetaModel;var V=U.createBindingContext(E.$path);var W=c.format(V,H[i].Url);var X=new e({key:"url",value:W});if(j&&r==="sap.ovp.cards.charts.analytical"){Q=j.getModel();}X.setModel(Q);X.setBindingContext(j);var Y=X.getValue();n.push({type:H[i].RecordType,url:Y,value:H[i].Value.String,label:H[i].Label?H[i].Label.String:null});}}}return n;},getModel:function(){return this.getView().getModel();},getMetaModel:function(){if(this.getModel()){return this.getModel().getMetaModel();}},getCardPropertiesModel:function(){if(!this.oCardPropertiesModel||l(this.oCardPropertiesModel)){this.oCardPropertiesModel=this.getView().getModel("ovpCardProperties");}return this.oCardPropertiesModel;},getEntitySet:function(){if(!this.entitySet){var E=this.getCardPropertiesModel().getProperty("/entitySet");this.entitySet=this.getMetaModel().getODataEntitySet(E);}return this.entitySet;},getEntityType:function(){if(!this.entityType){if(this.getMetaModel()&&this.getEntitySet()){this.entityType=this.getMetaModel().getODataEntityType(this.getEntitySet().entityType);}}return this.entityType;},getCardContentContainer:function(){if(!this.cardContentContainer){this.cardContentContainer=this.getView().byId("ovpCardContentContainer");}return this.cardContentContainer;},_processCustomParameters:function(j,s,n){var p=this.getCardPropertiesModel();if(!this.oMainComponent||!p){return;}var r;if(j&&j.bStaticLinkListIndex){var t=p.getProperty("/staticContent");r=t[j.iStaticLinkListIndex]["customParams"];j=null;}else{r=p.getProperty("/customParams");}if(!r||!this.oMainComponent.templateBaseExtension.provideCustomParameter||!this.oMainComponent.onCustomParams){return;}var v=this.oMainComponent.templateBaseExtension.provideCustomParameter(r)?this.oMainComponent.templateBaseExtension.provideCustomParameter(r):this.oMainComponent.onCustomParams(r);if(!v||!u.checkIfFunction(v)){return;}var w=m({},j);var x=m({},s);var y=v(w,x);if(!y||(!Array.isArray(y)&&!k(y))){return;}var I=k(y);if(I&&l(y)){return;}var z=I&&(y.bIgnoreEmptyString||y.ignoreEmptyString);var E=I?(y.aSelectionVariant||y.selectionVariant):y;if(!Array.isArray(E)){return;}var i,H,Q,U,V,W;H=E.length;for(i=0;i<H;i++){Q=E[i];if(!Q){continue;}U=Q.path;V=Q.value1;W=Q.value2;if(!U||typeof U!=="string"||U===""){L.error("Custom Variant property path '"+U+"' should be valid string");continue;}if(!(V||V===0||(V===""&&z))){continue;}V=V.toString();W=W&&W.toString();if(V===""&&z){s.removeSelectOption(U);}if(j){delete j[U];}if(n){delete n[U];}s.addSelectOption(U,Q.sign,Q.operator,V,W);}if(z){this._removeEmptyStringsFromSelectionVariant(s);}return z;},_getEntityNavigationParameters:function(E,j,n){var p={};var s,r,t;var v=this.getOwnerComponent().getComponentData();var w=v?v.globalFilter:undefined;var x=this.getCardPropertiesModel();var y=x&&x.getProperty("/staticContent");if(!y){var z=b.getCardSelections(this.getCardPropertiesModel());var H=z.filters;var I=z.parameters;var Q=this.getEntityType();H&&H.forEach(function(i1){i1.path=i1.path.replace("/",".");switch(i1.operator){case F.NE:i1.operator=F.EQ;i1.sign="E";break;case F.Contains:i1.operator="CP";var j1=i1.value1;i1.value1="*"+j1+"*";break;case F.EndsWith:i1.operator="CP";var j1=i1.value1;i1.value1="*"+j1;break;case F.StartsWith:i1.operator="CP";var j1=i1.value1;i1.value1=j1+"*";}});z.filters=H;if(n&&E&&E.hasOwnProperty("$isOthers")){var U=n.getOtherNavigationDimensions();for(var V in U){var W=U[V];for(var i=0;i<W.length;i++){z.filters.push({path:V,operator:"EQ",value1:W[i],sign:"E"});}}}I&&I.forEach(function(i1){i1.path=i1.path.replace("/",".");});z.parameters=I;var X=b.getCardSorters(this.getCardPropertiesModel());if(E){var V;for(var i=0;Q.property&&i<Q.property.length;i++){V=Q.property[i].name;var Y=E[V];if(E.hasOwnProperty(V)){if(Array.isArray(E[V])&&E[V].length===1){p[V]=E[V][0];}else if(q.type(Y)!=="object"){p[V]=Y;}}}}var Z=x&&x.getProperty("/kpiAnnotationPath");var $=x&&x.getProperty("/template");if(Z&&$==="sap.ovp.cards.charts.analytical"){var _=Q[Z];var a1=_&&_.Detail;if(a1&&a1.RecordType==="com.sap.vocabularies.UI.v1.KPIDetailType"){p["kpiID"]=_.ID.String;}}r=X&&new P(X);s=this._buildSelectionVariant(w,z);t=x&&x.getProperty("/staticParameters");}else{var b1=w&&w.getUiState({allFilters:false});var c1=b1?JSON.stringify(b1.getSelectionVariant()):"{}";s=new S(c1);var d1=this._getFilterPreference();s=this._removeFilterFromGlobalFilters(d1,s);if(y[j.iStaticLinkListIndex].params){t=y[j.iStaticLinkListIndex].params;}else if(y[j.iStaticLinkListIndex].staticParameters){t=y[j.iStaticLinkListIndex].staticParameters;}}var e1;if(j&&!j.bStaticLinkListIndex){e1=this._processCustomParameters(j,s,p);}else if(j&&j.bStaticLinkListIndex){e1=this._processCustomParameters(j,s);}else{e1=this._processCustomParameters(p,s);}var f1=e1?G.navigation.service.SuppressionBehavior.ignoreEmptyString:undefined;if(t){for(var V in t){if(!p.hasOwnProperty(V)){p[V]=t[V];}}}var g1=a.getNavigationHandler();var h1=g1&&g1.mixAttributesAndSelectionVariant(p,s.toJSONString(),f1);if(!y){this._removeSensitiveAttributesFromNavSelectionVariant(Q,h1);}return{sNavSelectionVariant:h1?h1.toJSONString():null,sNavPresentationVariant:r?r.toJSONString():null};},_removeSensitiveAttributesFromNavSelectionVariant:function(E,n){for(var i=0;i<E.property.length;i++){if(E.property[i]["com.sap.vocabularies.PersonalData.v1.IsPotentiallySensitive"]&&E.property[i]["com.sap.vocabularies.PersonalData.v1.IsPotentiallySensitive"].Bool){delete n._mSelectOptions[E.property[i].name];}}},_removeEmptyStringsFromSelectionVariant:function(s){var p=s.getParameterNames();for(var i=0;i<p.length;i++){if(s.getParameter(p[i])===""){s.removeParameter(p[i]);}}var n=s.getSelectOptionsPropertyNames();for(i=0;i<n.length;i++){var r=s.getSelectOption(n[i]);for(var j=0;j<r.length;j++){if(r[j].Low===""&&!r[j].High){r.splice(j,1);j--;}}if(r.length===0){s.removeSelectOption(n[i]);}}return s;},_checkIfCardFiltersAreValid:function(i,p){var j=true;if(i&&i.filterAll==="global"){j=false;}else if(i&&i.globalFilter){if(i.globalFilter.indexOf(p)>=0){j=false;}}return j;},_getFilterPreference:function(){var i=this.getOwnerComponent()?this.getOwnerComponent().getComponentData():null;var j;if(i&&i.mainComponent){j=i.mainComponent._getFilterPreference(i.cardId);}return j;},_removeFilterFromGlobalFilters:function(i,s){var j=[];if(i&&i.filterAll==="card"){j=s.getSelectOptionsPropertyNames();}else if(i&&i.cardFilter){j=i.cardFilter;}j.forEach(function(p){if(p!=="$.basicSearch"){s.removeSelectOption(p);}});return s;},_buildSelectionVariant:function(n,p){var U=n&&n.getUiState({allFilters:false});var s=U?JSON.stringify(U.getSelectionVariant()):"{}";var r=new S(s);var t,v,V,w;var x=this._getFilterPreference();r=this._removeFilterFromGlobalFilters(x,r);var y=p.filters;var z=p.parameters;for(var i=0;i<y.length;i++){t=y[i];if(t.path&&t.operator&&typeof t.value1!=="undefined"){v=t.value1.toString();V=(typeof t.value2!=="undefined")?t.value2.toString():undefined;if(this._checkIfCardFiltersAreValid(x,t.path)){r.addSelectOption(t.path,t.sign,t.operator,v,V);}}}var E,H,I;for(var j=0;j<z.length;j++){w=z[j];if(!w.path||!w.value){continue;}E=w.path.split("/").pop();E=E.split(".").pop();if(E.indexOf("P_")===0){H=E;I=E.substr(2);}else{H="P_"+E;I=E;}if(r.getParameter(H)){continue;}if(r.getParameter(I)){continue;}r.addParameter(E,w.value);}return r;},_loadParametersForm:function(){var p=new J();p.setData(this.actionData.parameterData);var t=this;var i=new D('ovpCardActionDialog',{title:this.actionData.sFunctionLabel,afterClose:function(){i.destroy();}}).addStyleClass("sapUiNoContentPadding");var j=new B({text:this.actionData.sFunctionLabel,press:function(E){var v=A.getParameters(E.getSource().getModel(),t.actionData.oFunctionImport);i.close();t._callFunction(v,t.actionData.sFunctionLabel);}});var n=new B({text:"Cancel",press:function(){i.close();}});i.setBeginButton(j);i.setEndButton(n);var r=function(E){var v=A.mandatoryParamsMissing(E.getSource().getModel(),t.actionData.oFunctionImport);j.setEnabled(!v);};var s=A.buildParametersForm(this.actionData,r);i.addContent(s);i.setModel(p);i.open();},_callFunction:function(U,i){var p={batchGroupId:"Changes",changeSetId:"Changes",urlParameters:U,forceSubmit:true,context:this.actionData.oContext,functionImport:this.actionData.oFunctionImport};var t=this;var j=new Promise(function(r,n){var s=t.actionData.oContext.getModel();var v;v="/"+p.functionImport.name;s.callFunction(v,{method:p.functionImport.httpMethod,urlParameters:p.urlParameters,batchGroupId:p.batchGroupId,changeSetId:p.changeSetId,headers:p.headers,success:function(w,x){r(x);},error:function(w){w.actionText=i;n(w);}});});j.then(function(r){return f.show(g.getText("Toast_Action_Success"),{duration:1000});},function(E){var n=a.showODataErrorMessages(E);if(n===""&&E.actionText){n=g.getText("Toast_Action_Error")+' "'+E.actionText+'"'+".";}return M.error(n,{title:g.getText("OVP_GENERIC_ERROR_TITLE"),onClose:null,styleClass:"",initialFocus:null,textDirection:T.Inherit});});},setErrorState:function(){var i=this.getOwnerComponent();if(!i||!i.oContainer){return;}var j=i.oContainer;var n=this.getCardPropertiesModel();var p={name:"sap.ovp.cards.loading",componentData:{model:this.getView().getModel(),settings:{category:n.getProperty("/category"),title:n.getProperty("/title"),description:n.getProperty("/description"),entitySet:n.getProperty("/entitySet"),state:h.loadingState.ERROR,template:n.getProperty("/template")}}};var r=sap.ui.component(p);j.setComponent(r);setTimeout(function(){i.destroy();},0);},changeSelection:function(s,i,j){if(!i){var n=this.getView().byId("ovp_card_dropdown");s=parseInt(n.getSelectedKey(),10);}var t={};if(!i){t=this.getCardPropertiesModel().getProperty("/tabs")[s-1];}else{t=j.tabs[s-1];}var U={cardId:this.getOwnerComponent().getComponentData().cardId,selectedKey:s};for(var p in t){U[p]=t[p];}if(O.checkIfAPIIsUsed(this)){O.recreateCard(U,this.getOwnerComponent().getComponentData());}else{this.getOwnerComponent().getComponentData().mainComponent.recreateCard(U);this.getOwnerComponent().getComponentData().mainComponent.setOrderedCardsSelectedKey(this.getOwnerComponent().getComponentData().cardId,s);}},getItemHeight:function(i,s,j){if(!!i){var n=i.getView().byId(s);var H=0;if(!!n){if(j){if(n.getItems()[0]&&n.getItems()[0].getDomRef()){H=u.getOuterHeight(n.getItems()[0].getDomRef());}}else{if(n.getDomRef()){H=u.getOuterHeight(n.getDomRef());}}}return H;}},getHeaderHeight:function(){var H=this.getItemHeight(this,'ovpCardHeader'),i=this.getOwnerComponent()?this.getOwnerComponent().getComponentData():null;if(i&&i.appComponent){var j=i.appComponent.getDashboardLayoutUtil(),n=j.getDashboardLayoutModel().getCardById(i.cardId);if(H!==0){n.dashboardLayout.headerHeight=H;}}return H;}});});
