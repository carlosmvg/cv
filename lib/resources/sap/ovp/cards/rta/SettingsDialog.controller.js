sap.ui.define(["sap/ui/core/mvc/Controller","sap/ui/model/json/JSONModel","sap/ovp/cards/OVPCardAsAPIUtils","sap/ovp/cards/SettingsUtils","sap/ovp/cards/PayLoadUtils","sap/ovp/cards/rta/SettingsDialogConstants","sap/m/MessageBox","sap/ui/model/Filter","sap/ui/model/FilterOperator","sap/ui/model/ChangeReason","sap/ovp/cards/linklist/AnnotationHelper","sap/ovp/cards/AnnotationHelper","sap/ui/core/IconPool","sap/ui/core/mvc/ViewType","sap/m/Dialog","sap/m/Button","sap/ovp/cards/CommonUtils","sap/ui/Device","sap/ovp/app/resources","sap/ovp/app/OVPUtils","sap/base/util/deepEqual","sap/base/util/merge","sap/ovp/cards/ovpLogger"],function(C,J,O,s,P,S,M,F,a,b,L,c,I,V,D,B,d,e,f,g,h,m,o){"use strict";var k=new o("OVP.rta.SettingDialog");return C.extend("sap.ovp.cards.rta.SettingsDialog",{_oCardManifestSettings:{},_aRefreshNotRequired:S._aRefreshNotRequired,_aRefreshRequired:S._aRefreshRequired,_updateManifestProperties:S._updateManifestProperties,aVariantNames:S.aVariantNames,oOvpResourceBundle:f,oMandatoryPropertiesKey:S.oMandatoryPropertiesKey,onInit:function(){s.oSaveButton.attachPress(this.onSaveButtonPress,this);s.oResetButton.attachPress(this.onResetButton,this);s.oMessagePopOverButton.attachPress(this.handleMessagePopoverPress,this);},onAfterRendering:function(){s.dialogBox.addStyleClass("sapOvpSettingsDialogBox");this.setEnablePropertyForResetAndSaveButton(false);this._oCardManifestSettings=this.getView().getModel().getData();this._oOriginalCardManifestSettings=m({},this._oCardManifestSettings);var v=this.getView(),i=v.getModel();if(!this._oCardManifestSettings.addNewCard){var j=v.byId("dialogCard");if(!j.getVisible()){j=v.byId("dialogCardNoPreview");}j.getDomRef().style.minHeight=this._oCardManifestSettings.dialogBoxHeight+"px";v.byId("dialogCardOverlay").getDomRef().style.minHeight=this._oCardManifestSettings.dialogBoxHeight+"px";s.settingFormWidth(v,"calc(100% - "+(this._oCardManifestSettings.dialogBoxWidth+1)+"rem)");setTimeout(function(){var j=this.getView().byId("dialogCard");if(j.getVisible()){j.setBusy(false);}}.bind(this),2000);}if(this._oCardManifestSettings.staticContent){this.handleErrorHandling(i,"title","/staticContent");this.handleErrorHandling(i,"targetUri","/staticContent");}if(s.bNewKPICardFlag){var l=v.getModel();var n=v.byId("sapOvpKPITable").getBinding("items").getLength();l.setProperty("/NoOfKPIItem",n);l.setProperty("/NoKPI",n);}},validateInputField:function(E){var i=E.getSource();var l=i.getValue().trim().length;if(!l){i.setValue(i.getValue().trim());}if(!this._oCardManifestSettings.addNewCard){this.updateCard(E);}else{this.setEnablePropertyForResetAndSaveButton(true);}},addView:function(E){this._oCardManifestSettings.showViewSwitchButton=true;this.setEnablePropertyForResetAndSaveButton(true);var i,j=this._oCardManifestSettings,l=this.getView().getModel();if(!j.addNewCard){if(j.dataPointAnnotationPath&&j.dataPoint&&j.dataPoint.length){i=j.dataPoint[0].value;}}if(j.tabs&&j.tabs.length){j.newViewCounter++;if(!j.addNewCard){if(j.template==="sap.ovp.cards.charts.analytical"||j.template==="sap.ovp.cards.charts.smart.chart"){j.tabs.push({chartAnnotationPath:j.chart[0].value,dataPointAnnotationPath:i,value:this.oOvpResourceBundle&&(this.oOvpResourceBundle.getText("OVP_KEYUSER_LABEL_VIEW_NAME")+" "+j.newViewCounter)});}else{j.tabs.push({annotationPath:j.lineItem[0].value,dataPointAnnotationPath:i,value:this.oOvpResourceBundle&&(this.oOvpResourceBundle.getText("OVP_KEYUSER_LABEL_VIEW_NAME")+" "+j.newViewCounter)});}}else{j.tabs.push({entitySet:"",value:this.oOvpResourceBundle&&(this.oOvpResourceBundle.getText("OVP_KEYUSER_LABEL_VIEW_NAME")+" "+j.newViewCounter)});}var n=j.tabs.length;j.aViews.push({text:this.oOvpResourceBundle&&(this.oOvpResourceBundle.getText("OVP_KEYUSER_LABEL_VIEW_NAME")+" "+j.newViewCounter),key:n,isLaterAddedView:true,isViewResetEnabled:false});if(!j.addNewCard){var p=j.defaultViewSelected;if(j.tabs[p-1].entitySet){j.tabs[n-1].entitySet=j.allEntitySet[0].value;}}this.selectViewSwitch(E,n);}else{j.tabs=[{}];S.tabFields.forEach(function(t){if(!j.addNewCard){if(t!=='entitySet'){j.tabs[0][t]=j[t];}}else{j.tabs[0][t]=j[t];}});j.tabs[0].value=this.oOvpResourceBundle&&(this.oOvpResourceBundle.getText("OVP_KEYUSER_LABEL_VIEW_NAME")+" 1");if(!j.addNewCard){if(j.template==="sap.ovp.cards.charts.analytical"||j.template==="sap.ovp.cards.charts.smart.chart"){j.tabs.push({chartAnnotationPath:j.chart[0].value,dataPointAnnotationPath:i,value:this.oOvpResourceBundle&&(this.oOvpResourceBundle.getText("OVP_KEYUSER_LABEL_VIEW_NAME")+" 2")});}else{j.tabs.push({annotationPath:j.lineItem[0].value,dataPointAnnotationPath:i,value:this.oOvpResourceBundle&&(this.oOvpResourceBundle.getText("OVP_KEYUSER_LABEL_VIEW_NAME")+" 2")});}}else{j.tabs.push({entitySet:"",value:this.oOvpResourceBundle&&(this.oOvpResourceBundle.getText("OVP_KEYUSER_LABEL_VIEW_NAME")+" 2")});}j.selectedKey=1;j.defaultViewSelected=1;j.aViews=[{text:this.oOvpResourceBundle&&this.oOvpResourceBundle.getText("OVP_KEYUSER_LABEL_MAIN_VIEW"),key:0,isLaterAddedView:false,isViewResetEnabled:false},{text:this.oOvpResourceBundle&&(this.oOvpResourceBundle.getText("OVP_KEYUSER_LABEL_VIEW_NAME")+" 1 ("+this.oOvpResourceBundle.getText("OVP_KEYUSER_LABEL_DEFAULT_VIEW")+")"),key:1,initialSelectedKey:1,isLaterAddedView:false,isViewResetEnabled:false},{text:this.oOvpResourceBundle&&(this.oOvpResourceBundle.getText("OVP_KEYUSER_LABEL_VIEW_NAME")+" 2"),key:2,isLaterAddedView:true,isViewResetEnabled:false}];j.newViewCounter=2;this.selectViewSwitch(E,1);}this.handleErrorHandling(l,"value","/tabs");},deleteView:function(E){this.setEnablePropertyForResetAndSaveButton(true);var i=this._oCardManifestSettings,j=parseInt(i.selectedKey,10),l=this.getView().getModel();i.tabs.splice(j-1,1);i.aViews.splice(j,1);if(j===i.defaultViewSelected){i.defaultViewSelected=1;i.aViews[j].text=i.aViews[j].text+" ("+this.oOvpResourceBundle.getText("OVP_KEYUSER_LABEL_DEFAULT_VIEW")+")";}i.aViews.forEach(function(v,n){if(n>=j){v.key--;}});this.handleErrorHandling(l,"value","/tabs");if(i.tabs.length==1){S.tabFields.forEach(function(t){var v=i.tabs[0][t];if(t!=='entitySet'||(t==='entitySet'&&v)){i[t]=v;}});delete i.selectedKey;delete i.defaultViewSelected;delete i.tabs;delete i.aViews;i.aViews=[{text:this.oOvpResourceBundle.getText("OVP_KEYUSER_SHOWS_DIFFERENT_VIEWS"),key:0,initialSelectedKey:0,isLaterAddedView:false,isViewResetEnabled:false}];s.addManifestSettings(i);s.setVisibilityForFormElements(i);this.getView().getModel("visibility").refresh();this.getView().getModel().refresh();if(!i.addNewCard){this._fCardWithRefresh();}}else{i.selectedKey=1;this.selectViewSwitch(E,i.selectedKey);}},resetView:function(){var i=this._oCardManifestSettings,j=this.getView().getModel(),l=parseInt(i.selectedKey,10),n=i.aViews[l],p=i.defaultViewSelected;if(!n.isLaterAddedView){var q=i.dataPointAnnotationPath?true:false,r=this._oOriginalCardManifestSettings.dataPointAnnotationPath?true:false;if(l){var t=i.aViews[l].initialSelectedKey;S.tabFields.forEach(function(v){if(v!=="dataPointAnnotationPath"||q){if(this._oOriginalCardManifestSettings.tabs&&this._oOriginalCardManifestSettings.tabs.length){var w=this._oOriginalCardManifestSettings.tabs[t-1][v];if(v!=='entitySet'||(v==='entitySet'&&w)){i[v]=w;i.tabs[l-1][v]=i[v];}}else{if(v!=='entitySet'){i[v]=this._oOriginalCardManifestSettings[v];i.tabs[l-1][v]=i[v];}}}}.bind(this));if(!this._oOriginalCardManifestSettings.tabs||!this._oOriginalCardManifestSettings.tabs.length){i.newViewCounter++;i.tabs[l-1].value=this.oOvpResourceBundle&&(this.oOvpResourceBundle.getText("OVP_KEYUSER_LABEL_VIEW_NAME")+" "+i.newViewCounter);}if(l===i.defaultViewSelected){i.aViews[l].text=i.tabs[l-1].value+" ("+this.oOvpResourceBundle.getText("OVP_KEYUSER_LABEL_DEFAULT_VIEW")+")";}else{i.aViews[l].text=i.tabs[l-1].value;}}else{S.mainFields.forEach(function(v){i[v]=this._oOriginalCardManifestSettings[v];}.bind(this));if(q!==r){if(r){i.tabs.forEach(function(v){if(v.prevDataPointAnnotationPath){v.dataPointAnnotationPath=v.prevDataPointAnnotationPath;}else{v.dataPointAnnotationPath=i.dataPoint[0].value;}});i.dataPointAnnotationPath=i.tabs[p].dataPointAnnotationPath;}else{i.tabs.forEach(function(v){v.prevDataPointAnnotationPath=v.dataPointAnnotationPath;v.dataPointAnnotationPath=undefined;});}}}}else{var u;if(i.dataPointAnnotationPath){u=i.dataPoint[0].value;}i.newViewCounter++;if(i.template==="sap.ovp.cards.charts.analytical"||i.template==="sap.ovp.cards.charts.smart.chart"){i.tabs[l-1]={chartAnnotationPath:i.chart[0].value,dataPointAnnotationPath:u,value:this.oOvpResourceBundle&&(this.oOvpResourceBundle.getText("OVP_KEYUSER_LABEL_VIEW_NAME")+" "+i.newViewCounter)};}else{i.tabs[l-1]={annotationPath:i.lineItem[0].value,dataPointAnnotationPath:u,value:this.oOvpResourceBundle&&(this.oOvpResourceBundle.getText("OVP_KEYUSER_LABEL_VIEW_NAME")+" "+i.newViewCounter)};}if(l===i.defaultViewSelected){i.aViews[l].text=this.oOvpResourceBundle&&(this.oOvpResourceBundle.getText("OVP_KEYUSER_LABEL_VIEW_NAME")+" "+i.newViewCounter+" ("+this.oOvpResourceBundle.getText("OVP_KEYUSER_LABEL_DEFAULT_VIEW")+")");}else{i.aViews[l].text=this.oOvpResourceBundle&&(this.oOvpResourceBundle.getText("OVP_KEYUSER_LABEL_VIEW_NAME")+" "+i.newViewCounter);}S.tabFields.forEach(function(v){var w=i.tabs[l-1][v];if(v!=='entitySet'||(v==='entitySet'&&w)){i[v]=w;}});}this.handleErrorHandling(j,"value","/tabs");i.isViewResetEnabled=false;i.aViews[l].isViewResetEnabled=false;s.addManifestSettings(i);s.setVisibilityForFormElements(i);this.getView().getModel("visibility").refresh();this.getView().getModel().refresh();if(!i.addNewCard){this._fCardWithRefresh();}},selectViewSwitch:function(E,i){var j=this._oCardManifestSettings,l=this.getView().getModel();if(!i){i=E.getSource().getSelectedIndex();}if(this.defaultViewSwitch){this.defaultViewSwitch.setEnabled(true);}this.setEnablePropertyForResetAndSaveButton(true);var n=j.metaModel,p,q=j.defaultViewSelected;if(!i){j.selectedKey=i;j.mainViewSelected=true;j.isViewResetEnabled=j.aViews[i].isViewResetEnabled;S.tabFields.forEach(function(u){var v=j.tabs[q-1][u];if(u!=='entitySet'||(u==='entitySet'&&v)){j[u]=v;}});this.handleErrorHandling(l,"value","/tabs");if(j.tabs[q-1].entitySet){p=n.getODataEntitySet(j.tabs[q-1].entitySet);j.entityType=n.getODataEntityType(p.entityType);this.resetSupportingObjectsOnEntitySetChange(j,q);}s.addManifestSettings(j);s.setVisibilityForFormElements(j);this.getView().getModel("visibility").refresh();this.getView().getModel().refresh();if(!j.addNewCard){this._fCardWithRefresh();}}else{j.mainViewSelected=false;j.isViewResetEnabled=j.aViews[i].isViewResetEnabled;if(!j.addNewCard){var r=this.getView().byId("dialogCard");if(r.getVisible()){var R=r.getComponentInstance().getRootControl();var t=R.getController();t.changeSelection(i,true,j);this.handleErrorHandling(l,"value","/tabs");if(j.tabs[i-1].entitySet){p=n.getODataEntitySet(j.tabs[i-1].entitySet);j.entityType=n.getODataEntityType(p.entityType);this.resetSupportingObjectsOnEntitySetChange(j,q);}s.addManifestSettings(j);s.setVisibilityForFormElements(j);S.tabFields.forEach(function(u){var v=j.tabs[i-1][u];if(u!=='entitySet'||(u==='entitySet'&&v)){j[u]=v;}});if(!!j.kpiAnnotationPath){this.setAnnotationPathInModel(j,"sapOvpSettingsKPIAnnotation",j.kpiAnnotationPath);}if(!!j.selectionPresentationAnnotationPath){this.setAnnotationPathInModel(j,"sapOvpSettingsFilterAndPresentedBy",j.selectionPresentationAnnotationPath);}this.getView().getModel("visibility").refresh();this.getView().getModel().refresh();}}else{if(!!j.tabs[i-1].entitySet){p=n.getODataEntitySet(j.tabs[i-1].entitySet);j.entityType=n.getODataEntityType(p.entityType);s.addManifestSettings(j);}this.aVariantNames.forEach(function(v){if(this._oCardManifestSettings[v.sPath]){this._oCardManifestSettings[v.sPath]=[];}}.bind(this));this.resetSupportingObjectsOnEntitySetChange(j,q);j.selectedKey=i;S.tabFields.forEach(function(u){var v=j.tabs[i-1][u];j[u]=v;});s.setVisibilityForFormElements(j);this.getView().byId("sapOVPEntitySetList").setValue(j.tabs[i-1].entitySet);this.getView().getModel().refresh();this.getView().getModel("visibility").refresh();}}},resetSupportingObjectsOnEntitySetChange:function(i,j){i=s.addSupportingObjects(i);var l=i.defaultViewSelected;if(l){i.aViews[l].text=i.tabs[l-1].value;}i.aViews[j].text+=" ("+this.oOvpResourceBundle.getText("OVP_KEYUSER_LABEL_DEFAULT_VIEW")+")";i.defaultViewSelected=j;},setAnnotationPathInModel:function(i,j,l){if(i.entityType[l]){this.setVariant(i,l);}if(j==="sapOvpSettingsKPIAnnotation"){s.addKPINavApplicationName(i);}},setCurrentActivePageForCarouselCard:function(i){var j=this.getView().byId("dialogCard");if(j.getVisible()){var l=j.getComponentInstance(),r=l.getRootControl(),n=r.byId("pictureCarousel");if(n){var p=n.getPages(),q=p[i];n.setActivePage(q);}}},onSelectionChange:function(E){var j=E.getSource(),l=j.getModel(),n=l.getData().staticContent,p=j.getSelectedItem(),q=p.getBindingContext().getObject(),v=j.getModel("visibility");for(var i=0;i<n.length;i++){if(n[i].id===q.id){v.setProperty("/moveToTheTop",!(n.length===1||i===0));v.setProperty("/moveUp",!(n.length===1||i===0));v.setProperty("/moveDown",!(n.length===1||i===(n.length-1)));v.setProperty("/moveToTheBottom",!(n.length===1||i===(n.length-1)));v.setProperty("/delete",true);l.setProperty("/selectedItemIndex",i);v.refresh(true);if(E.getParameter("listItem")){this.setCurrentActivePageForCarouselCard(i);}break;}}},handleErrorForProperty:function(i,p,j){i.firePropertyChange({context:i.getContext(j?j:"/"),path:p,value:i.getProperty(j?(j+"/"+p):p),reason:b.Change});},handleErrorHandling:function(j,p,l){var n=j.getProperty(l);j.firePropertyChange({context:j.getContext(l),path:l+","+p,value:j.getProperty(l),reason:b.Change});for(var i=0;i<n.length;i++){var q=l+"/"+i;j.firePropertyChange({context:j.getContext(q),path:p,value:j.getProperty(q+"/"+p),reason:b.Change});}},setEnablePropertyForResetAndSaveButton:function(E){s.enableResetButton(E);s.enableSaveButton(E);},getValueInRemString:function(v){return v+"rem";},_getSelectedItemIndex:function(i){return i.getProperty("/selectedItemIndex");},_getLastItemIndex:function(i){return this._getStaticContentArray(i).length-1;},_getStaticContentArray:function(i){return i.getProperty("/staticContent");},_setStaticContentArray:function(i,j){i.setProperty("/staticContent",j);},_setSelectedItemAndScrollToElement:function(i,H){var v=this.getView(),l=v.byId("sapOvpStaticLinkListLineItem"),j=v.byId("scrollContainer"),n=v.getModel();this.handleErrorHandling(n,"title","/staticContent");this.handleErrorHandling(n,"targetUri","/staticContent");var p=l.getItems()[i];if(H){this._oList=l;this._oItem=p;this._oScrollContainer=j;var q={onAfterRendering:function(E){this._oList.removeEventDelegate(this._oDelegateOnAfter);this._oScrollContainer.scrollToElement(this._oItem);delete this._oDelegateOnAfter;delete this._oList;delete this._oScrollContainer;delete this._oItem;}};this._oDelegateOnAfter=q;l.addEventDelegate(q,this);}else{j.scrollToElement(p);}l.setSelectedItem(p);l.fireSelectionChange();},_arrangeStaticContent:function(i,j,t){var l=this._getStaticContentArray(i);l.splice(t,0,l.splice(j,1)[0]);this._setStaticContentArray(i,l);this._setSelectedItemAndScrollToElement(t);},getIndexFromIdForStaticLinkList:function(i){var j=i.split("-");return j[j.length-1];},_getImageData:function(){var i=[];i.push({"Name":"AW.png","Image":L.formUrl(this.getView().getModel().getProperty("/baseUrl"),"img/AW.png")});return i;},_getIconData:function(j){var l=I.getIconNames(),n=[];if(j){var N=j.split("://")[1],p=l.indexOf(N);l.splice(p,1);n.push({"Name":N,"Icon":I.getIconURI(N)});}for(var i=0;i<l.length;i++){n.push({"Name":l[i],"Icon":I.getIconURI(l[i])});}return n;},_getLinkListItemId:function(i,j){return i.getProperty("/staticContent/"+j+"/index");},_makeLinkListItemId:function(i){return"linkListItem--"+i;},_makeLinkListItemIndex:function(i){return"Index--"+i;},getIconAndImageDataModel:function(i){var j=this._getIconData(i),l=this._getImageData();return new J({"Icons":j,"Images":l,"NoOfIcons":j.length,"NoOfImages":l.length});},destroyTemplatesAndObjects:function(){var v=this.getView();var t=v.byId("tableFilterImage");if(t){t.destroy();}var T=v.byId("tableFilter");if(T){T.destroy();}var i=v.byId("tableFilterLinks");if(i){i.destroy();}delete this._oEvent;delete this._iCurrentRow;delete this._oModel;delete this._oVisibilityModel;delete this._oIconsDialogContentView;delete this._oLinksDialogContentView;delete this._oLineItemDialogContentView;delete this._oKPIItemDialogContentView;},onExternalUrlChange:function(E){this.setEnablePropertyForResetAndSaveButton(true);},onLinkSourceChange:function(E){var i=E.getSource(),j=i.getModel(),v=i.getModel("visibility"),l=this.getIndexFromIdForStaticLinkList(i.getId()),n=E.getParameter("selectedIndex"),p=v.getProperty("/staticLink"),q=v.getProperty("/links"),r=this._getLinkListItemId(j,parseInt(l,10));if(n===0){p[r]=false;q[r]=true;j.setProperty("/staticContent/"+l+"/targetUri",undefined);}else{p[r]=true;q[r]=false;j.setProperty("/staticContent/"+l+"/semanticObject",undefined);j.setProperty("/staticContent/"+l+"/action",undefined);j.setProperty("/staticContent/"+l+"/targetUri","");}v.setProperty("/staticLink",p);v.setProperty("/links",q);v.refresh(true);j.refresh(true);this.handleErrorForProperty(j,"targetUri","/staticContent/"+l);this.setEnablePropertyForResetAndSaveButton(true);},onRemoveVisualPress:function(E){var i=E.getSource(),j=i.getModel(),v=i.getModel("visibility"),l=this.getIndexFromIdForStaticLinkList(i.getId()),n=this._getLinkListItemId(j,parseInt(l,10)),r=v.getProperty("/removeVisual");r[n]=false;v.setProperty("/removeVisual",r);v.refresh(true);j.setProperty("/staticContent/"+l+"/imageUri",undefined);j.refresh(true);this.updateCard(E,"sapOvpSettingsStaticLinkListRemoveVisual");},createValueHelpDialogForInternalUrl:function(E){var i=E.getSource(),j=i.getModel(),l=i.getModel("staticCardProperties"),v=i.getModel("visibility"),n=this.getIndexFromIdForStaticLinkList(i.getId());this.attachBrowserHeightChangeHandler();this._oEvent=Object.assign({},E);this._iCurrentRow=n;this._oModel=j;this._oVisibilityModel=v;var p=new B("linksCancelBtn",{text:this.oOvpResourceBundle&&this.oOvpResourceBundle.getText("cancelBtn")});this.linksDialog=new D({title:this.oOvpResourceBundle&&this.oOvpResourceBundle.getText("OVP_KEYUSER_SELECT_APPLICATION_DIALOG"),buttons:[p]}).addStyleClass("sapOvpSettingsDialogBox");l.setProperty("/densityStyle",this.getDensityStyle());l.setProperty("/NoOfLinks",l.getProperty("/links").length);var q=new sap.ui.core.mvc.XMLView("linksDialogContent",{viewName:"sap.ovp.cards.rta.SelectLinks",type:V.XML,preprocessors:{xml:{bindingContexts:{tableRows:l.createBindingContext("/")},models:{tableRows:l}}}});q.setModel(l);q.setModel(this.getView().getModel("ovpResourceModel"),"ovpResourceModel");this.linksDialog.addContent(q);q.loaded().then(function(r){this._oLinksDialogContentView=r;r.getController().updateLinkPath=function(t){var u=t.slice(1).split("-"),w=u[0],A=u[1];this._oModel.setProperty("/staticContent/"+this._iCurrentRow+"/semanticObject",w);this._oModel.setProperty("/staticContent/"+this._iCurrentRow+"/action",A);this._oModel.refresh(true);this.setEnablePropertyForResetAndSaveButton(true);this.cleanAndCloseDialog(p);}.bind(this);p.attachPress(function(){this.cleanAndCloseDialog(p);}.bind(this));this.linksDialog.open();setTimeout(function(){this.browserHeightChange();}.bind(this),0);}.bind(this));},onChangeVisualPress:function(E){var i=E.getSource(),j=i.getModel(),v=i.getModel("visibility"),l=this.getIndexFromIdForStaticLinkList(i.getId()),n=j.getProperty("/staticContent/"+l+"/imageUri"),N=L.isImageUrlStaticData(n);this.attachBrowserHeightChangeHandler();this._oEvent=Object.assign({},E);this._iCurrentRow=l;this._oModel=j;this._oVisibilityModel=v;var p=new B("iconsCancelBtn",{text:this.oOvpResourceBundle&&this.oOvpResourceBundle.getText("cancelBtn")});this.iconsDialog=new D({title:this.oOvpResourceBundle&&this.oOvpResourceBundle.getText("OVP_KEYUSER_SELECT_VISUAL_DIALOG"),buttons:[p]}).addStyleClass("sapOvpSettingsDialogBox");var r=(N)?this.getIconAndImageDataModel():this.getIconAndImageDataModel(n);r.setProperty("/densityStyle",this.getDensityStyle());var q=new sap.ui.core.mvc.XMLView("iconsDialogContent",{viewName:"sap.ovp.cards.rta.SelectIcons",type:V.XML,preprocessors:{xml:{bindingContexts:{tableRows:r.createBindingContext("/")},models:{tableRows:r}}}});r.setProperty("/tableName","IconTable");q.setModel(r);q.setModel(this.getView().getModel("ovpResourceModel"),"ovpResourceModel");this.iconsDialog.addContent(q);q.loaded().then(function(t){this._oIconsDialogContentView=t;t.getController().updateIconPath=function(u){var w=this._getLinkListItemId(this._oModel,parseInt(this._iCurrentRow,10)),R=this._oVisibilityModel.getProperty("/removeVisual");R[w]=true;this._oVisibilityModel.setProperty("/removeVisual",R);this._oVisibilityModel.refresh(true);this._oModel.setProperty("/staticContent/"+this._iCurrentRow+"/imageUri",u);this._oModel.refresh(true);this.updateCard(this._oEvent,"sapOvpSettingsStaticLinkListChangeVisual");this.cleanAndCloseDialog(p);}.bind(this);p.attachPress(function(){this.cleanAndCloseDialog(p);}.bind(this));this.iconsDialog.open();setTimeout(function(){this.browserHeightChange();}.bind(this),0);}.bind(this));},getDensityStyle:function(){if(!e.support.touch){return"compact";}else{return"cozy";}},cleanAndCloseDialog:function(i){if(this._oIconsDialogContentView){this._oIconsDialogContentView.destroy();}if(this._oLinksDialogContentView){this._oLinksDialogContentView.destroy();}if(this._oLineItemDialogContentView){this._oLineItemDialogContentView.destroy();}if(this._oKPIItemDialogContentView){this._oKPIItemDialogContentView.destroy();}this.destroyTemplatesAndObjects();if(this.iconsDialog){this.iconsDialog.close();}if(this.linksDialog){this.linksDialog.close();}if(this.lineItemDialog){this.lineItemDialog.close();}if(this.KPIItemDialog){this.KPIItemDialog.close();}i.destroy();this.detachBrowserHeightChangeHandler();},attachBrowserHeightChangeHandler:function(){e.resize.attachHandler(this.browserHeightChange,this);},detachBrowserHeightChangeHandler:function(){e.resize.detachHandler(this.browserHeightChange,this);},browserHeightChange:function(i){var j,l,n;if(this.iconsDialog&&this._oIconsDialogContentView){j=this.iconsDialog;l=this._oIconsDialogContentView;n="iconsScrollContainer";}else if(this.linksDialog&&this._oLinksDialogContentView){j=this.linksDialog;l=this._oLinksDialogContentView;n="linksScrollContainer";}else if(this.lineItemDialog&&this._oLineItemDialogContentView){j=this.lineItemDialog;l=this._oLineItemDialogContentView;n="lineItemScrollContainer";}else if(this.KPIItemDialog&&this._oKPIItemDialogContentView){j=this.KPIItemDialog;l=this._oKPIItemDialogContentView;n="KPIItemScrollContainer";}if(j&&l&&n){var p=j.getDomRef(),q=(i?(i.height*93)/100:s.dialogBox.getDomRef().getBoundingClientRect().height),r=p.getBoundingClientRect().height,H=Math.max(q,r)-(d.getPixelPerRem()*9),t=l.byId(n);t.setHeight(H+"px");}},handleMessagePopoverPress:function(E){s.oMessagePopOver.openBy(E.getSource());},onShowMorePress:function(E){var i=E.getSource(),j=i.getModel(),v=i.getModel("visibility"),l=this.getIndexFromIdForStaticLinkList(i.getId()),n=this._getLinkListItemId(j,parseInt(l,10)),p=v.getProperty("/showMore/"+n);if(p){v.setProperty("/showMore/"+n,false);}else{v.setProperty("/showMore/"+n,true);}v.refresh(true);},onPressDelete:function(E){this._oEvent=Object.assign({},E);M.confirm(this.oOvpResourceBundle.getText("OVP_KEYUSER_MESSAGE_BOX_INFORMATION_MESSAGE_INFO"),{actions:[M.Action.OK,M.Action.CANCEL],icon:M.Icon.INFORMATION,title:this.oOvpResourceBundle.getText("OVP_KEYUSER_MESSAGE_BOX_TITLE_INFO"),initialFocus:M.Action.CANCEL,onClose:function(A){if(A==="OK"){var i=this._oEvent.getSource(),v=i.getModel("visibility"),j=i.getModel(),l=this._getStaticContentArray(j),n=this._getSelectedItemIndex(j),p=this._getLinkListItemId(j,n),q=v.getProperty("/staticLink"),r=v.getProperty("/links"),R=v.getProperty("/removeVisual"),t=v.getProperty("/showMore");delete q[p];delete r[p];delete R[p];delete t[p];v.setProperty("/staticLink",q);v.setProperty("/links",r);v.setProperty("/removeVisual",R);v.setProperty("/showMore",t);l.splice(n,1);this._setStaticContentArray(j,l);j.refresh(true);if(l.length>0){this._setSelectedItemAndScrollToElement(Math.min(parseInt(n,10),l.length-1),true);}if(l.length<=1){v.setProperty("/delete",false);}v.refresh(true);this.updateCard(this._oEvent,"sapOvpSettingsStaticLinkListDelete");}delete this._oEvent;}.bind(this)});},onPressAdd:function(E){var i=E.getSource(),v=i.getModel("visibility"),j=i.getModel(),l=this._getStaticContentArray(j),n=j.getProperty("/lineItemIdCounter"),p=this._makeLinkListItemId(n+1),q=this._makeLinkListItemIndex(n+1),r=v.getProperty("/staticLink"),t=v.getProperty("/links"),R=v.getProperty("/removeVisual"),u=v.getProperty("/showMore");j.setProperty("/lineItemIdCounter",n+1);l.unshift({"id":p,"index":q,"title":"Default Title","subTitle":"Default SubTitle","imageUri":"","imageAltText":"","targetUri":"","openInNewWindow":""});r[q]=true;t[q]=false;R[q]=false;u[q]=false;v.setProperty("/staticLink",r);v.setProperty("/links",t);v.setProperty("/removeVisual",R);v.setProperty("/showMore",u);v.refresh(true);this._setStaticContentArray(j,l);j.refresh(true);this._setSelectedItemAndScrollToElement(0);this.updateCard(E,"sapOvpSettingsStaticLinkListAdd");},onPressMoveToTheTop:function(E){var i=E.getSource().getModel();this._arrangeStaticContent(i,this._getSelectedItemIndex(i),0);this.updateCard(E,"sapOvpSettingsStaticLinkListSort");},onPressMoveUp:function(E){var i=E.getSource().getModel(),j=this._getSelectedItemIndex(i);this._arrangeStaticContent(i,j,j-1);this.updateCard(E,"sapOvpSettingsStaticLinkListSort");},onPressMoveDown:function(E){var i=E.getSource().getModel(),j=this._getSelectedItemIndex(i);this._arrangeStaticContent(i,j,j+1);this.updateCard(E,"sapOvpSettingsStaticLinkListSort");},onPressMoveToTheBottom:function(E){var i=E.getSource().getModel(),j=this._getSelectedItemIndex(i),l=this._getLastItemIndex(i);this._arrangeStaticContent(i,j,l);this.updateCard(E,"sapOvpSettingsStaticLinkListSort");},onResetButton:function(){this._oCardManifestSettings=m({},this._oOriginalCardManifestSettings);var i=this.getView().getModel();i.setProperty("/",this._oCardManifestSettings);s.setVisibilityForFormElements(this._oCardManifestSettings);this.getView().getModel("visibility").refresh();if(this._oCardManifestSettings.layoutDetail==="resizable"){if(this._oCardManifestSettings.stopResizing){this.getView().byId("sapOvpSettingsStopResize").setState(false);}else if(!this._oCardManifestSettings.stopResizing){this.getView().byId("sapOvpSettingsStopResize").setState(true);}}s.resetErrorHandling();this.setEnablePropertyForResetAndSaveButton(false);if(!this._oCardManifestSettings.addNewCard){this._fCardWithRefresh();}},handleValueStateofComboBox:function(E,p,j,l){var n=s.oMessagePopOver.getModel(),q=n.getProperty("/Messages"),r=n.getProperty("/Counter/All"),t=n.getProperty("/Counter/Error");this.bError=true;var u=true;if(l){for(var i=0;i<q.length;i++){if(q[i].fieldName===p){u=false;}}if(u){q.push({"type":"Error","title":E,"fieldName":p,"counter":t+1});r++;t++;this.getView().byId(j).setValueState("Error");}}else{this.bError=false;for(var i=0;i<q.length;i++){if(q[i].fieldName===p){q.splice(i,1);r--;t--;i--;}}this.getView().byId(j).setValueState("None");}if(!q.length){this.setEnablePropertyForResetAndSaveButton(true);}n.setProperty("/Messages",q);n.setProperty("/Counter/All",r);n.setProperty("/Counter/Error",t);n.refresh(true);},validateComboBox:function(i,p,K){var E;if((p==="KPICheckBox"&&K&&i.entitySet)||(p==="entitySet"&&i.addKPIHeaderCheckBox)){if(i.title===""){E=f.getText("OVP_KEYUSER_INPUT_ERROR");this.handleValueStateofComboBox(E,g.Annotations.title,"sapOvpCardTitle",true);}else{this.handleValueStateofComboBox("",g.Annotations.title,"sapOvpCardTitle",false);}if(i.subTitle===""){E=f.getText("OVP_KEYUSER_INPUT_ERROR_VALUE_STATE_SUBTITLE");this.handleValueStateofComboBox(E,g.Annotations.subTitle,"sapOvpCardSubTitle",true);}else{this.handleValueStateofComboBox("",g.Annotations.subTitle,"sapOvpCardSubTitle",false);}if(i.valueSelectionInfo===""){E=f.getText("OVP_KEYUSER_INPUT_ERROR_VALUE_STATE_SELECTIONVALUEINFO");this.handleValueStateofComboBox(E,g.Annotations.valueSelectionInfo,"sapOvpValueSelectionInfo",true);}else{this.handleValueStateofComboBox("",g.Annotations.valueSelectionInfo,"sapOvpValueSelectionInfo",false);}if(i.dataPointAnnotationPath===""){E=f.getText("OVP_KEYUSER_INPUT_ERROR_VALUE_STATE_DATAPOINT");this.handleValueStateofComboBox(E,g.Annotations.dataPoint,"sapOvpDataPoint",true);}else{this.handleValueStateofComboBox("",g.Annotations.dataPoint,"sapOvpDataPoint",false);}}else if(p==="entitySet"){E=f.getText("OVP_KEYUSER_INPUT_ERROR");this.handleValueStateofComboBox(E,g.Annotations.title,"sapOvpCardTitle",true);if(i.template==="sap.ovp.cards.linklist"){E=f.getText("OVP_KEYUSER_LISTFLAVOR_ERROR");this.handleValueStateofComboBox(E,g.Annotations.listFlavor,"sapOVPLinkListFlavor",true);}}else if(p==="KPICheckBox"&&!K&&i.entitySet){this.handleValueStateofComboBox("",g.Annotations.subTitle,"sapOvpCardSubTitle",false);this.handleValueStateofComboBox("",g.Annotations.valueSelectionInfo,"sapOvpValueSelectionInfo",false);this.handleValueStateofComboBox("",g.Annotations.dataPoint,"sapOvpDataPoint",false);}else{if(p==="title"){this.onComboBoxSelection(i,p,"OVP_KEYUSER_INPUT_ERROR",g.Annotations.title,"sapOvpCardTitle");}if(p==="subTitle"){this.onComboBoxSelection(i,p,"OVP_KEYUSER_INPUT_ERROR_VALUE_STATE_SUBTITLE",g.Annotations.subTitle,"sapOvpCardSubTitle");}if(p==="valueSelectionInfo"){this.onComboBoxSelection(i,p,"OVP_KEYUSER_INPUT_ERROR_VALUE_STATE_SELECTIONVALUEINFO",g.Annotations.valueSelectionInfo,"sapOvpValueSelectionInfo");}if(p==="dataPointAnnotationPath"){this.onComboBoxSelection(i,p,"OVP_KEYUSER_INPUT_ERROR_VALUE_STATE_DATAPOINT",g.Annotations.dataPoint,"sapOvpDataPoint");}if(p==="listFlavor"){this.onComboBoxSelection(i,p,"OVP_KEYUSER_LISTFLAVOR_ERROR",g.Annotations.listFlavor,"sapOVPLinkListFlavor");}}},onComboBoxSelection:function(i,p,t,j,l){var E;if(i[p]===""){E=f.getText(t);this.handleValueStateofComboBox(E,j,l,true);}else{this.handleValueStateofComboBox(E,j,l,false);}},onSaveButtonPress:function(){if(!this._oCardManifestSettings.addNewCard){if(s.bError||this.bError){s.oMessagePopOverButton.firePress();}else{this.createAndSubmitChange.bind(this)();}}else{this.createAndSubmitChange.bind(this)();}},onResizingChange:function(E){var i=E.getParameter("state");this._oCardManifestSettings.stopResizing=!i;this.updateCard(E);},onNumberOfRowsChanged:function(E){var r=+this._oCardManifestSettings.defaultSpan.rows;this._oCardManifestSettings.defaultSpan.rows=r;this._oCardManifestSettings.defaultSpan.showOnlyHeader=(r===0);this._oCardManifestSettings.cardLayout.showOnlyHeader=(r===0);var i=["sap.ovp.cards.list","sap.ovp.cards.table"];if(i.indexOf(this._oCardManifestSettings.template)!==-1){this._oCardManifestSettings.cardLayout.noOfItems=r;}else{this._oCardManifestSettings.cardLayout.rowSpan=r;}this.updateCard(E);},onNumberOfColumnsChanged:function(E){this._oCardManifestSettings.defaultSpan.cols=+this._oCardManifestSettings.defaultSpan.cols;this.updateCard(E);},setBusy:function(i){if(i){this.getView().addStyleClass("dialogContainerOverlay");var j=this.getView().byId("dialogCard");if(j.getVisible()&&j.getComponentInstance()){j.getComponentInstance().getRootControl().setBusy(i);}}else{this.getView().removeStyleClass("dialogContainerOverlay");setTimeout(function(){var j=this.getView().byId("dialogCard");if(j.getVisible()&&j.getComponentInstance()){j.getComponentInstance().getRootControl().setBusy(i);}}.bind(this),2000);}},_fCardWithoutRefresh:function(E,u){var v=this.getView(),i=this._oCardManifestSettings,j=v.byId("dialogCard").getComponentInstance(),r=j.getRootControl(),l=r.getController(),n=l.getCardPropertiesModel(),p,q,t=false,w;if(i.tabs&&i.tabs.length){t=true;w=parseInt(i.selectedKey,10);}if(u.formElementId==="sapOvpSettingsLineItemTitle"||u.formElementId==="sapOvpSettingsLineItemSubTitle"){p=r.byId(u.cardElementId+"--"+v.getModel().getProperty("/lineItemId"));}else{p=r.byId(u.cardElementId);if(!p){this._fCardWithRefresh(E,u.cardElementId);}}switch(u.formElementId){case"sapOvpSettingsLineItemTitle":case"sapOvpSettingsLineItemSubTitle":case"sapOvpSettingsTitle":case"sapOvpSettingsValueSelectionInfo":if(p){p.setText(E.getSource().getValue());}break;case"sapOvpSettingsSubTitle":n.setProperty("/subTitle",E.getSource().getValue());l._setSubTitleWithUnitOfMeasure();break;case"sapOvpSettingsViewName":var x=i.viewName;q=v.getModel();p.getItems()[w-1].setText(x);i.tabs[w-1].value=x;if(i.defaultViewSelected===w){x=x+" ("+this.oOvpResourceBundle.getText("OVP_KEYUSER_LABEL_DEFAULT_VIEW")+")";}i.aViews[w].text=x;q.refresh();break;case"sapOvpDefaultViewSwitch":if(E.getSource().getState()){var y=i.defaultViewSelected;q=v.getModel();i.defaultViewSelected=w;i.aViews[y].text=i.tabs[y-1].value;i.aViews[w].text+=" ("+this.oOvpResourceBundle.getText("OVP_KEYUSER_LABEL_DEFAULT_VIEW")+")";q.refresh();this.defaultViewSwitch=E.getSource();this.defaultViewSwitch.setEnabled(false);}break;case"sapOvpSettingsIdentification":if(t){i.tabs[w-1][u.updateProperty]=i[u.updateProperty];}break;case"sapOvpSettingsKPIHeaderSwitch":var z=v.getModel("visibility"),A=z.getData();A.dataPoint=false;A.valueSelectionInfo=false;if(t){i.tabs.forEach(function(H){H.prevDataPointAnnotationPath=H.dataPointAnnotationPath;H.dataPointAnnotationPath=undefined;});}else{var G=i.dataPointAnnotationPath;if(G){i.prevDataPointAnnotationPath=G;}i.dataPointAnnotationPath=undefined;}z.refresh(true);p.destroy();break;default:break;}},_fCardWithRefresh:function(E,u){var p,i,v,j,l,n=this._oCardManifestSettings,q=this.getView(),r=q.byId("dialogCard"),t=(!r.getComponentInstance())?undefined:r.getComponentInstance().getComponentData(),w=(!t)?"Dialog":t.cardId,x=(!t)?undefined:t.manifest.cards[w].model,y={cards:{}},z=false,A;if(n.tabs&&n.tabs.length){z=true;A=parseInt(n.selectedKey,10);}switch(u){case"subTitleSwitch":v=this.getView();j=v.getModel("visibility");if(E.getSource().getState()){if(z){i=n.defaultViewSelected;n.tabs.forEach(function(U){p=U.prevDynamicSubtitleAnnotationPath;if(p){U.dynamicSubtitleAnnotationPath=p;}else{U.dynamicSubtitleAnnotationPath=n.dynamicSubTitle[0].value;}});n.dynamicSubtitleAnnotationPath=n.tabs[i-1].dynamicSubtitleAnnotationPath;}else{p=n.prevDynamicSubtitleAnnotationPath;if(p){n.dynamicSubtitleAnnotationPath=p;}else{n.dynamicSubtitleAnnotationPath=n.dynamicSubTitle[0].value;}}q.byId("sapOvpSettingsDynamicSubTitle").setSelectedKey(n.dynamicSubtitleAnnotationPath);}else{if(z){n.tabs.forEach(function(U){U.prevDynamicSubtitleAnnotationPath=U.dynamicSubtitleAnnotationPath;U.dynamicSubtitleAnnotationPath=undefined;});n.dynamicSubtitleAnnotationPath=undefined;}else{var G=n.dynamicSubtitleAnnotationPath;if(G){n.prevDynamicSubtitleAnnotationPath=G;}n.dynamicSubtitleAnnotationPath=undefined;}}j.setProperty("/subTitle",s.getVisibilityOfElement(n,"subTitle",z));j.setProperty("/dynamicSubTitle",s.getVisibilityOfElement(n,"dynamicSubTitle",z)&&!!n["dynamicSubTitle"]&&!!n["dynamicSubTitle"].length);j.refresh(true);break;case"kpiHeader":v=this.getView();j=v.getModel("visibility");l=j.getData();l.valueSelectionInfo=true;l.dataPoint=true;if(n.tabs&&n.tabs.length){l.dataPoint=s.getVisibilityOfElement(n,"dataPoint",true);}if(!n.valueSelectionInfo){n.valueSelectionInfo=" ";}if(z){i=n.defaultViewSelected;n.tabs.forEach(function(U){p=U.prevDataPointAnnotationPath;if(p){U.dataPointAnnotationPath=p;}else{U.dataPointAnnotationPath=n.dataPoint[0].value;}});n.dataPointAnnotationPath=n.tabs[i-1].dataPointAnnotationPath;}else{p=n.prevDataPointAnnotationPath;if(p){n.dataPointAnnotationPath=p;}else{n.dataPointAnnotationPath=n.dataPoint[0].value;}}j.refresh(true);break;case"listType":n[u]=(E.getSource().getState())?"extended":"condensed";break;case"listFlavor":n[u]=(E.getSource().getState())?"bar":"";break;case"entitySet":if(z){n.tabs[A-1][u]=n[u];S.resetTabFields.forEach(function(U){delete n.tabs[A-1][U];delete n[U];});var H=n.metaModel,K=H.getODataEntitySet(n.tabs[A-1].entitySet),N=n.defaultViewSelected;n.entityType=H.getODataEntityType(K.entityType);this.resetSupportingObjectsOnEntitySetChange(n,N);}break;case"kpiAnnotationPath":if(z){n.tabs[A-1][u]=n[u];}var Q=q.byId("sapOvpSettingsKPIAnnotation").getSelectedKey();if(n.entityType[Q]){this.setVariant(n,Q);}s.addKPINavApplicationName(n);this.getView().getModel().refresh(true);break;case"selectionPresentationAnnotationPath":if(z){n.tabs[A-1][u]=n[u];}var Q=q.byId("sapOvpSettingsFilterAndPresentedBy").getSelectedKey();if(n.entityType[Q]){this.setVariant(n,Q);}this.getView().getModel().refresh(true);break;case"listFlavorForLinkList":case"annotationPath":case"chartAnnotationPath":case"presentationAnnotationPath":case"selectionAnnotationPath":case"dynamicSubtitleAnnotationPath":case"dataPointAnnotationPath":if(z){n.tabs[A-1][u]=n[u];}break;case"noOfRows":case"ovpHeaderTitle":case"add":case"removeVisual":case"changeVisual":case"sort":case"delete":break;default:break;}y.cards[w]={settings:n};if(s.bNewKPICardFlag){y.cards[w].template=n.template;}else{y.cards[w].template=t.template;}if(s.bNewKPICardFlag){if(x&&q.getModel(x)){q.getModel(x).destroy();q.setModel(null,x);}var R=this._oCardManifestSettings.selectedKPI,T=new sap.ui.model.odata.v2.ODataModel(R.ODataURI,{'annotationURI':R.ModelURI,'defaultCountMode':sap.ui.model.odata.CountMode.None});x=d._getLayerNamespace()+".kpi_card_model_"+s.getTrimmedDataURIName(R.ODataURI);q.setModel(T,x);}if(!!x){y.cards[w].model=x;}if(s.bNewKPICardFlag){T.getMetaModel().loaded().then(function(){var U=O.createCardComponent(q,y,"dialogCard");U.then(function(){q.setBusy(false);this.setBusy(false);}.bind(this)).catch(function(){s.setErrorMessage(y.cards[w].settings,"OVP_KEYUSER_ANNOTATION_FAILURE");s.createErrorCard(q,y,w);});}.bind(this),function(U){k.error(U);this.setBusy(false);q.setBusy(false);}.bind(this));T.attachMetadataFailed(function(){s.setErrorMessage(y.cards[w].settings,"OVP_KEYUSER_METADATA_FAILURE");s.createErrorCard(q,y,w);});}else{this.createCard(q,y);}},setVariant:function(i,j){var l=i.entityType[j];var n=l.SelectionVariant&&l.SelectionVariant.Path;if(/^@/.test(n)){n=n.slice(1);}i.selectionAnnotationPath=n;var p;if(j.indexOf(".KPI")!==-1){p=l.Detail&&l.Detail.DefaultPresentationVariant&&l.Detail.DefaultPresentationVariant.Path;}else if(j.indexOf(".SelectionPresentationVariant")!==-1){p=l.PresentationVariant&&l.PresentationVariant.Path;}if(/^@/.test(p)){p=p.slice(1);}i.presentationAnnotationPath=p;var v=i.entityType[i.presentationAnnotationPath]&&i.entityType[i.presentationAnnotationPath].Visualizations;for(var q=0;q<v.length;q++){var r=v[q].AnnotationPath;if(r){if(/^@/.test(r)){r=r.slice(1);}if(/.Chart/.test(r)){i.chartAnnotationPath=r;break;}}}},createCard:function(i,j){this.setBusy(true);var p=O.createCardComponent(i,j,"dialogCard");p.then(function(){this.setBusy(false);var l=this.getView().byId("sapOvpStaticLinkListLineItem");if(l){var n=l.getSelectedItem();if(n){var q=n.getId(),r=this.getIndexFromIdForStaticLinkList(q);this.setCurrentActivePageForCarouselCard(r);}}}.bind(this));p.catch(function(){this.setBusy(false);}.bind(this));},updateCard:function(E,l){var n=this._oCardManifestSettings,p=this.getView().byId("dialogCard");this.setEnablePropertyForResetAndSaveButton(true);if(p.getVisible()){if(n.tabs&&n.tabs.length){var q=parseInt(n.selectedKey,10);n.isViewResetEnabled=true;n.aViews[q].isViewResetEnabled=true;}var r=E.getSource(),t=(l)?l:r.getId(),u=false;if(t.indexOf("sapOvpStaticLinkListLineItem")!==-1){var v=r.getModel(),w=v.getData().staticContent,x=this.getIndexFromIdForStaticLinkList(t);this.setCurrentActivePageForCarouselCard(x);v.setProperty("/lineItemId",w[x].id);if(t.indexOf("sapOvpSettingsLineItemTitle")!==-1){t="sapOvpSettingsLineItemTitle";}else if(t.indexOf("sapOvpSettingsLineItemSubTitle")!==-1){t="sapOvpSettingsLineItemSubTitle";}}for(var i=0;i<this._aRefreshNotRequired.length;i++){if(t.indexOf(this._aRefreshNotRequired[i].formElementId)>-1){if(this._aRefreshNotRequired[i].isKpiSwitch&&E.getSource().getState()){break;}this._fCardWithoutRefresh(E,this._aRefreshNotRequired[i]);u=true;break;}}if(!u){for(var j=0;j<this._aRefreshRequired.length;j++){if(t.indexOf(this._aRefreshRequired[j].formElementId)>-1){this.setBusy(true);this._fCardWithRefresh(E,this._aRefreshRequired[j].updateProperty);break;}}}var y=d._getLayer();if(y===g.Layers.vendor){for(var z in this.oMandatoryPropertiesKey){if(t.indexOf(this.oMandatoryPropertiesKey[z])>-1){var R=false,T=z+"Key",A=z+"Property";n[z]=E.getParameter("value");n[A]=E.getParameter("value");for(var z in n.ai18nProperties){if(n.ai18nProperties[z].value===E.getParameter("value")){n[T]=n.ai18nProperties[z].key;R=true;break;}}if(!R){n[T]="";}break;}}}}},onExit:function(){s.oSaveButton.detachPress(this.onSaveButtonPress,this);s.oResetButton.detachPress(this.onResetButton,this);s.oMessagePopOverButton.detachPress(this.handleMessagePopoverPress,this);},getListItems:function(){var i=[],j=this._oCardManifestSettings,l=this.getView(),n=l.byId("dialogCard"),p=n.getComponentInstance().getComponentData(),q=j.entityType.$path+"/"+j.annotationPath,r=p.model.getMetaModel(),t=r.getContext(r.resolve(q,this.oView.getBindingContext()));var u=2,v=1,w=0;if(j.listFlavor==="bar"){u=1;v=2;}if(j.listType&&j.listType.toLowerCase()==="extended"){u=6;v=3;w=3;if(j.listFlavor==="bar"){u=5;}}else if(j.contentFragment==="sap.ovp.cards.table.Table"){u=3;v=1;w=1;}j.lineItem.forEach(function(x){var y=c.getSortedDataPoints(t,x.fields),z=c.getSortedDataFields(t,x.fields),A=[],E=[],G=s.getQualifier(x.value);y.forEach(function(Q){if(Q.Title){E.push(s.checkForEmptyString(Q.Title.String,""));}else{E.push(f.getText("OVP_KEYUSER_LABEL_DEFAULT_LABEL_WITH_QUALIFIER",[G]));}});z.forEach(function(Q){if(Q.Label){A.push(Q.Label.String);}else{A.push(f.getText("OVP_KEYUSER_LABEL_DEFAULT_LABEL_WITH_QUALIFIER",[G]));}});var H=Math.min(E.length,v),K=Math.min(w,H),N=A.slice(0,u-K).concat(E.slice(0,H));N.map(function(Q){return Q.charAt(0).toUpperCase()+Q.substr(1);});i.push({Value:x.value,Label:x.name,VisibleFields:N.toString()});});return i;},onSearch:function(E){var v=this.getView(),i=v.getModel(),l;this._filterTable(E,["GroupTitle","KPITitle","GroupID","KPIID","KPIQualifier"],"sapOvpKPITable");l=v.byId("sapOvpKPITable").getBinding("items").getLength();i.setProperty("/NoOfKPIItem",l);i.refresh(true);},_filterTable:function(E,j,l){var q=E.getParameter("query"),G=null,n=[];for(var i=0;i<j.length;i++){n.push(new F(j[i],a.Contains,q));}if(q){G=new F(n,false);}this.getView().byId(l).getBinding("items").filter(G,"Application");},onItemPress:function(E){this.getView().setBusy(true);this.getView().setBusyIndicatorDelay(0);var i=E.getSource(),j=i.getBindingContext(),K=j.getObject();this.getView().byId("sapOvpSettingsTitle").setValue(K.GroupTitle);this.getView().byId("sapOvpSettingsSubTitle").setValue(K.KPITitle);this.onKPIUpdate(K);this.updateCard(E,"sapOvpSettingsNewKPICard");},onKPIUpdate:function(K){this._oCardManifestSettings.entitySet=K.ODataEntityset;this._oCardManifestSettings.kpiAnnotationPath="com.sap.vocabularies.UI.v1.KPI#"+K.KPIQualifier;this._oCardManifestSettings.title=K.GroupTitle;this._oCardManifestSettings.subTitle=K.KPITitle;this._oCardManifestSettings.template="sap.ovp.cards.charts.analytical";this._oCardManifestSettings.selectedKPI=K;},onSeePress:function(){this.attachBrowserHeightChangeHandler();var i=new B("KPIItemCancelBtn",{text:this.oOvpResourceBundle&&this.oOvpResourceBundle.getText("cancelBtn")});this.KPIItemDialog=new D({title:this.oOvpResourceBundle&&this.oOvpResourceBundle.getText("OVP_KEYUSER_KPI_DIALOG_TITLE"),buttons:[i]}).addStyleClass("sapOvpSettingsDialogBox");var r=new J({"KPIItem":this._oCardManifestSettings.KPIData});r.setProperty("/densityStyle",this.getDensityStyle());r.setProperty("/NoOfKPIItem",r.getProperty("/KPIItem").length);var K=new sap.ui.core.mvc.XMLView("KPIItemDialogContent",{viewName:"sap.ovp.cards.rta.SelectKPI",type:V.XML,preprocessors:{xml:{bindingContexts:{tableRows:r.createBindingContext("/")},models:{tableRows:r}}}});K.setModel(r);K.setModel(this.getView().getModel("ovpResourceModel"),"ovpResourceModel");this.KPIItemDialog.addContent(K);K.loaded().then(function(v){this._oKPIItemDialogContentView=v;v.getController().updateKPIItemPath=function(j,E){this.getView().setBusy(true);this.getView().setBusyIndicatorDelay(0);this.getView().byId("sapOvpSettingsTitle").setValue(j.GroupTitle);this.getView().byId("sapOvpSettingsSubTitle").setValue(j.KPITitle);this.onKPIUpdate(j);this.updateCard(E,"sapOvpSettingsNewKPICard");this.cleanAndCloseDialog(i);}.bind(this);i.attachPress(function(){this.cleanAndCloseDialog(i);}.bind(this));this.KPIItemDialog.open();setTimeout(function(){this.browserHeightChange();}.bind(this),0);}.bind(this));},openLineItemValueHelpDialog:function(E){this.attachBrowserHeightChangeHandler();this._oEvent=Object.assign({},E);var i=new B("lineItemCancelBtn",{text:this.oOvpResourceBundle&&this.oOvpResourceBundle.getText("cancelBtn")});this.lineItemDialog=new D({title:this.oOvpResourceBundle&&this.oOvpResourceBundle.getText("OVP_KEYUSER_LINEITEM_ANNO"),buttons:[i]}).addStyleClass("sapOvpSettingsDialogBox");var r=new J({"lineItem":this.getListItems()});r.setProperty("/densityStyle",this.getDensityStyle());r.setProperty("/NoOfLineItem",r.getProperty("/lineItem").length);var l=new sap.ui.core.mvc.XMLView("lineItemDialogContent",{viewName:"sap.ovp.cards.rta.SelectLineItem",type:V.XML,preprocessors:{xml:{bindingContexts:{tableRows:r.createBindingContext("/")},models:{tableRows:r}}}});l.setModel(r);l.setModel(this.getView().getModel("ovpResourceModel"),"ovpResourceModel");this.lineItemDialog.addContent(l);l.loaded().then(function(v){this._oLineItemDialogContentView=v;v.getController().updateLineItemPath=function(j){var n=j.Value,p=this._oCardManifestSettings,q;if(p.tabs&&p.tabs.length){q=parseInt(p.selectedKey,10);}p.lineItemQualifier=s.getQualifier(n);p.annotationPath=n;if(p.tabs&&p.tabs.length){p.tabs[q-1].annotationPath=p.annotationPath;}this.getView().byId("sapOvpSettingsLineItem").setValue(j.Label);this._fCardWithRefresh(this._oEvent,"annotationPath");this.setEnablePropertyForResetAndSaveButton(true);if(p.tabs&&p.tabs.length){p.isViewResetEnabled=true;p.aViews[q].isViewResetEnabled=true;}this.cleanAndCloseDialog(i);}.bind(this);i.attachPress(function(){this.cleanAndCloseDialog(i);}.bind(this));this.lineItemDialog.open();setTimeout(function(){this.browserHeightChange();}.bind(this),0);}.bind(this));},createAndSubmitChange:function(){var p;if(s.bNewStaticLinkListCardFlag){p=P.getPayLoadForNewStaticLinkListCard.bind(this)(s);}else if(s.bNewKPICardFlag){p=P.getPayLoadForNewKPICard.bind(this)(s);}else if(s.bAddNewCardFlag){p=P.getPayLoadForNewCard.bind(this)(s);}else{p=P.getPayLoadForEditCard.bind(this)(s);}this.settingsResolve(p);s.dialogBox.close();},setMandatoryFieldState:function(v,i){i.setProperty("/dataPoint",v);i.setProperty("/valueSelectionInfo",v);i.setProperty("/requiredSubTitle",v);var j=i.getData(),l=false;for(var n=0;n<s.aVisiblePropertiesForAnnotation.length;n++){if(j[s.aVisiblePropertiesForAnnotation[n].sProperty]){l=true;break;}}i.setProperty("/setAnnotationCardProperties",l);},EnableKPIHeaderFields:function(i){var v=this.getView().getModel("visibility");if(!i){this.setMandatoryFieldState(false,v);}else{this.setMandatoryFieldState(true,v);}},onCardTypeSelected:function(E){var i=E.getParameters().id;this._oCardManifestSettings.template=E.getSource().getSelectedKey();this.getView().byId("sapOVPAddKpiCheckBoxID").setSelected(false);this.getView().byId("sapOVPAddODataSelect").setSelected(false);this._oCardManifestSettings.addKPIHeaderCheckBox=false;this.EnableKPIHeaderFields(this._oCardManifestSettings.addKPIHeaderCheckBox);this.resetPropertiesVisibility(i,this._oCardManifestSettings);},onDatasourceComboboxChanged:function(E){var j=E.getParameters().id;this._oCardManifestSettings.model=E.getParameters().value;this._oCardManifestSettings.allEntitySet="";if(!s.newDataSource){var l=this._oCardManifestSettings.datasources;for(var i=0;i<l.length;i++){if(l[i].Title===this._oCardManifestSettings.model){this._oCardManifestSettings.metaModel=l[i].oMetaModel;}}s.addSupportingObjects(this._oCardManifestSettings);if(this._oCardManifestSettings.allEntitySet.length===0){this._oCardManifestSettings.model="";this.resetPropertiesVisibility(j,this._oCardManifestSettings);var n=f.getText("OVP_KEYUSER_NO_RELEVANT_ANNOTATION");this.handleValueStateofComboBox(n,"datasSourceExisting","sapOVPDataSourceExistingComboBox",true);}else{this.handleValueStateofComboBox("","datasSourceExisting","sapOVPDataSourceExistingComboBox",false);this.resetPropertiesVisibility(j,this._oCardManifestSettings);}}else{var p=this._oCardManifestSettings.datasources.filter(function(q){return q.Title===this._oCardManifestSettings.model;}.bind(this));getMetaModelForNewDataSource(p,s.sApplicationId).then(function(q){if(q){s.newDataSourceModel=q.modelInformation;q.getODataEntityContainer=function(){return q.oEntityContainers;};q.getObject=function(r){return q.oSchema;};q.getODataEntityType=function(r){var t=q.oSchema[0].entityType.filter(function(u){var v=r.substr((q.oEntityContainers.namespace+".").length);return u.name===v;});return t[0];};this._oCardManifestSettings.metaModel=q;s.addSupportingObjects(this._oCardManifestSettings);if(this._oCardManifestSettings.allEntitySet.length===0){this._oCardManifestSettings.model="";this.resetPropertiesVisibility(j,this._oCardManifestSettings);var n=f.getText("OVP_KEYUSER_NO_RELEVANT_ANNOTATION");this.handleValueStateofComboBox(n,"datasSourceNew","sapOVPDataSourceNewInput",true);}else{this.handleValueStateofComboBox("","datasSourceNew","sapOVPDataSourceNewInput",false);this.resetPropertiesVisibility(j,this._oCardManifestSettings);}}else{this._oCardManifestSettings.model="";this.resetPropertiesVisibility(j,this._oCardManifestSettings);var n=f.getText("OVP_KEYUSER_UNAVAILABLE_DATASOURCE");this.handleValueStateofComboBox(n,"datasSourceNew","sapOVPDataSourceNewInput",true);}}.bind(this));}},onEntitySetChanged:function(E,j){var l=this._oCardManifestSettings.metaModel.getObject('/dataServices/schema')[0].entityType;this.aVariantNames.forEach(function(v){if(this._oCardManifestSettings[v.sPath]){this._oCardManifestSettings[v.sPath]=[];}}.bind(this));for(var i in l){if(l[i].name===E){this._oCardManifestSettings.entityType=l[i];break;}}s.addSupportingObjects(this._oCardManifestSettings);this.getView().byId("sapOVPAddODataSelect").setSelected(false);this.resetPropertiesVisibility(j,this._oCardManifestSettings);},addStaticParameterRow:function(){var i=this.getView().getModel();var j=i.getProperty("/aAllStaticParameters");if(j&&j.length){j.push({key:"",value:""});}else{j=[];j.push({key:"",value:""});}i.setProperty("/aAllStaticParameters",j);},addActionRow:function(){var i=this.getView().getModel();var j=i.getProperty("/objectStreamCardsSettings/customActions");if(j&&j.length){j.push({text:"",press:"",position:""});}else{j=[];j.push({text:"",press:"",position:""});}i.setProperty("/objectStreamCardsSettings/customActions",j);},onParameterDelete:function(E){var i=this.getView().getModel();var j=i.getProperty("/aAllStaticParameters");var l=E.getSource().getBindingContext().getObject()&&E.getSource().getBindingContext().getObject()["key"];j=j.filter(function(p){return p["key"]!=l;});i.setProperty("/aAllStaticParameters",j);if(!h(this._oCardManifestSettings.staticParameters,this._oOriginalCardManifestSettings.staticParameters)){this.setEnablePropertyForResetAndSaveButton(true);}this.getView().getModel().refresh();},onActionDelete:function(E){var i=this.getView().getModel();var j=i.getProperty("/objectStreamCardsSettings/customActions");var l=E.getSource().getBindingContext().getObject()&&E.getSource().getBindingContext().getObject()["text"];j=j.filter(function(p){return p["text"]!=l;});i.setProperty("/objectStreamCardsSettings/customActions",j);if(!h(this._oCardManifestSettings.objectStreamCardsSettings,this._oOriginalCardManifestSettings.objectStreamCardsSettings)){this.setEnablePropertyForResetAndSaveButton(true);}},updateProperty:function(E){var j=E.getSource().getId();var l=false,n;if(this._oCardManifestSettings.tabs&&this._oCardManifestSettings.tabs.length){l=true;n=parseInt(this._oCardManifestSettings.selectedKey,10);this._oCardManifestSettings.isViewResetEnabled=true;this._oCardManifestSettings.aViews[n].isViewResetEnabled=true;}for(var i=0;i<this._updateManifestProperties.length;i++){if(j.indexOf(this._updateManifestProperties[i].formElementId)>-1){var p=this._updateManifestProperties[i].formElement;switch(p){case"entitySet":var q=E.getSource().getSelectedKey();if(!l){this._oCardManifestSettings["entitySet"]=E.getParameter("value");}else{this._oCardManifestSettings.tabs[n-1]["entitySet"]=E.getParameter("value");}this.onEntitySetChanged(q,j);if(this._oCardManifestSettings["entitySet"].length!==0){this.validateComboBox(this._oCardManifestSettings,"entitySet");}break;case"identificationAnnotationPath":if(!l){this._oCardManifestSettings["identificationAnnotationPath"]=E.getParameter("value");}else{this._oCardManifestSettings.tabs[n-1]["identificationAnnotationPath"]=E.getParameter("value");}break;case"selectionPresentationAnnotationPath":if(!l){this._oCardManifestSettings["selectionPresentationAnnotationPath"]=E.getParameter("value");}else{this._oCardManifestSettings.tabs[n-1]["selectionPresentationAnnotationPath"]=E.getParameter("value");}break;case"selectionAnnotationPath":if(!l){this._oCardManifestSettings["selectionAnnotationPath"]=E.getParameter("value");}else{this._oCardManifestSettings.tabs[n-1]["selectionAnnotationPath"]=E.getParameter("value");}break;case"presentationAnnotationPath":if(!l){this._oCardManifestSettings["presentationAnnotationPath"]=E.getParameter("value");}else{this._oCardManifestSettings.tabs[n-1]["presentationAnnotationPath"]=E.getParameter("value");}break;case"annotationPath":if(!l){this._oCardManifestSettings["annotationPath"]=E.getParameter("value");}else{this._oCardManifestSettings.tabs[n-1]["annotationPath"]=E.getParameter("value");}break;case"listType":this._oCardManifestSettings.listType=E.getSource().getSelectedKey();break;case"listFlavor":this._oCardManifestSettings.listFlavor=E.getSource().getSelectedKey();if(j.indexOf("sapOVPLinkListFlavor")!==-1){this.validateComboBox(this._oCardManifestSettings,"listFlavor");}break;case"KPICheckBox":this._oCardManifestSettings.addKPIHeaderCheckBox=E.getParameter("selected");this.EnableKPIHeaderFields(this._oCardManifestSettings.addKPIHeaderCheckBox);this.validateComboBox(this._oCardManifestSettings,"KPICheckBox",this._oCardManifestSettings.addKPIHeaderCheckBox);break;case"dataPointAnnotationPath":if(!l){this._oCardManifestSettings["dataPointAnnotationPath"]=E.getParameter("value");}else{this._oCardManifestSettings.tabs[n-1]["dataPointAnnotationPath"]=E.getParameter("value");}this.validateComboBox(this._oCardManifestSettings,"dataPointAnnotationPath");break;case"addODataSelectCheckBox":this._oCardManifestSettings.addODataSelectCheckBox=E.getParameter("selected");break;case"requireAppAuthorization":this._oCardManifestSettings.requireAppAuthorization=E.getParameter("value");break;case"kpiAnnotationPath":if(!l){this._oCardManifestSettings["kpiAnnotationPath"]=E.getParameter("value");}else{this._oCardManifestSettings.tabs[n-1]["kpiAnnotationPath"]=E.getParameter("value");}this._oCardManifestSettings.kpiAnnotationPath=E.getParameter("value");break;case"navigationPath":this._oCardManifestSettings.navigationPath=E.getParameter("value");break;case"title":case"subTitle":case"valueSelectionInfo":var r=false;var t=p+"Key";var u=p+"Property";this._oCardManifestSettings[p]=E.getParameter("value");this._oCardManifestSettings[u]=E.getParameter("value");for(var v in this._oCardManifestSettings.ai18nProperties){if(this._oCardManifestSettings.ai18nProperties[v].value===E.getParameter("value")){this._oCardManifestSettings[t]=this._oCardManifestSettings.ai18nProperties[v].key;r=true;break;}}if(!r){this._oCardManifestSettings[t]="";}this.validateComboBox(this._oCardManifestSettings,p);break;case"existingDatasSource":if(E.mParameters.selected){s.newDataSource=false;this._oCardManifestSettings.newDataSource=false;this.handleValueStateofComboBox("","datasSourceExisting","sapOVPDataSourceExistingComboBox",false);this.resetPropertiesVisibility(j,this._oCardManifestSettings);var w=this.getView().getModel();w.setProperty("/datasources",this._oCardManifestSettings.datasourcesFromManifest);}break;case"newDatasSource":if(E.mParameters.selected){s.newDataSource=true;this._oCardManifestSettings.newDataSource=true;this.handleValueStateofComboBox("","datasSourceNew","sapOVPDataSourceNewInput",false);this.resetPropertiesVisibility(j,this._oCardManifestSettings);this.getView().setBusy(true);getNewDataSources(s.sApplicationId).then(function(x){this.getView().setBusy(false);var y=x.results;var w=this.getView().getModel();w.setSizeLimit(y.length);w.setProperty("/datasources",y);}.bind(this));}break;default:break;}}}},resetPropertiesVisibility:function(E,i){if(E.indexOf("sapOVPExistingDataSource")!==-1||E.indexOf("sapOVPNewDataSource")!==-1){this._updateManifestProperties.forEach(function(p){if(!p.formElementId.includes("sapOVPExistingDataSource")&&!p.formElementId.includes("sapOVPNewDataSource")){if(p.formElementId.includes("sapOVPAddODataSelect")){i[p.formElement]=false;}else{i[p.formElement]="";}}});i.model="";}else if(E.indexOf("sapOVPDataSource")!==-1){this._updateManifestProperties.forEach(function(p){if(!p.formElementId.includes("sapOVPExistingDataSource")&&!p.formElementId.includes("sapOVPNewDataSource")&&!E.includes(p.formElementId)){if(p.formElementId.includes("sapOVPAddODataSelect")){i[p.formElement]=false;}else{i[p.formElement]="";}}});}else if(E.indexOf("sapOVPCardType")!==-1){this._updateManifestProperties.forEach(function(p){if(!(p.formElementId.includes("sapOVPDataSource")||p.formElementId.includes("sapOVPCardType"))){if(p.formElementId.includes("sapOVPAddODataSelect")){i[p.formElement]=false;}else{i[p.formElement]="";}}});}else if(E.indexOf("sapOVPEntitySetList")!==-1){var j=this.getView().getModel("visibility").getData().showViewSwitch;this._updateManifestProperties.forEach(function(p){if(!(p.formElementId.includes("sapOVPDataSource")||p.formElementId.includes("sapOVPCardType")||p.formElementId.includes("sapOVPEntitySetList"))){if(p.formElementId.includes("sapOVPAddODataSelect")){i[p.formElement]=false;}else{if(!j){i[p.formElement]="";}else{S.tabFields.forEach(function(l){if(l!=='entitySet'&&l!=='value'){i[l]="";}});}}}});}s.resetErrorHandling();this.setEnablePropertyForResetAndSaveButton(false);s.setVisibilityForFormElements(i);this.getView().getModel().refresh();this.getView().getModel("visibility").refresh();}});});
