sap.ui.define(["sap/ui/base/Object","sap/ui/core/mvc/ControllerExtension","sap/ui/generic/app/navigation/service/NavError","sap/ui/generic/app/navigation/service/SelectionVariant","sap/ui/comp/state/UIState","sap/suite/ui/generic/template/lib/FeLogger","sap/base/util/deepEqual","sap/base/util/extend","sap/suite/ui/generic/template/lib/FeError"],function(B,C,N,S,U,F,d,e,a){"use strict";var c="ListReport.controller.IappStateHandler";var f=new F(c);var l=f.getLogger();var L=f.Level;var b="sap.suite.ui.generic.template.customData",g="sap.suite.ui.generic.template.extensionData",h="sap.suite.ui.generic.template.genericData";var A="sap-iapp-state";var I=["INIT","DATA_SUITE","CANCEL","RESET","SET_VM_ID"];function n(O){if(O){for(var p in O){O[p]=null;}}}function k(O,p){var K=Object.keys(O);if(K.length!==Object.keys(p).length){return true;}for(var i=0;i<K.length;i++){var s=K[i];var P=O[s];var q=p[s];if(P.length!==q.length){return true;}for(var j=0;j<P.length;j++){if(P[j]!==q[j]){return true;}}}return false;}function m(M,D){if(sap.ui.support){var i=l.getLevel();if(i<L.INFO){l.setLevel(L.INFO);}}var s;if(typeof D==="string"){s=D;}else{s="";var j="";for(var K in D){s=s+j+K+": "+D[K];j="; ";}}l.info(M,s,"sap.suite.ui.generic.template.ListReport.controller.IappStateHandler");}function o(s,j,t){var p=t.oServices.oApplication.getNavigationHandler();var q=j.getOwnerComponent().getSmartVariantManagement();var r={appStateKey:"",urlParams:{},selectionVariant:"",tableVariantId:""};var u=false;var v=null;var w=Promise.resolve();var x=false;var D=false;var y=false;var z;var E;var G=t.oComponentUtils.getSettings();var H=null;var J=null;s.oSmartFilterbar.setSuppressSelection(true);var K=(function(){var i;return function(){i=i||s.oSmartFilterbar.getNonVisibleCustomFilterNames();return i;};})();function M(){return D;}function O(){var v1={};var w1=[];var x1=K();for(var i=0;i<x1.length;i++){var y1=x1[i];if(s.oSmartFilterbar.isVisibleInFilterBarByName(y1)){w1.push(y1);}}var z1={suppressDataSelection:!D,visibleCustomFields:w1};v1[h]=z1;if(t.oComponentUtils.isDraftEnabled()){var A1=t.oComponentUtils.getTemplatePrivateModel();z1.editStateFilter=A1.getProperty("/listReport/vDraftState");var B1=A1.getProperty("/listReport/activeObjectEnabled");z1.activeStateFilter=B1;}var C1=s.oMultipleViewsHandler.getSelectedKeyPropertyName();if(C1){var D1=s.oMultipleViewsHandler.getContentForIappState();if(D1){z1[C1]=D1.state;}}if(s.oWorklistData.bWorkListEnabled){var E1=s.oWorklistData.oSearchField?s.oWorklistData.oSearchField.getValue():"";var F1={"searchString":E1};z1.Worklist=F1;}var G1={};v1[b]=G1;j.getCustomAppStateDataExtension(G1);var H1;var I1=true;var J1=function(K1,L1){if(!(K1 instanceof C)){throw new a(c,"State must always be set with respect to a ControllerExtension");}if(!I1){throw new a(c,"State must always be provided synchronously");}if(L1){H1=H1||Object.create(null);var M1=K1.getMetadata().getNamespace();H1[M1]=L1;}};j.templateBaseExtension.provideExtensionAppStateData(J1);I1=false;if(H1){v1[g]=H1;}return v1;}function P(){var v1=JSON.stringify(s.oSmartFilterbar.getUiState().getSelectionVariant());var w1=new S(v1);var x1=j.getVisibleSelectionsWithDefaults();for(var i=0;i<x1.length;i++){if(!w1.getValue(x1[i])){w1.addSelectOption(x1[i],"I","EQ","");}}if(j.byId('template::PageVariant')&&j.byId('template::PageVariant').currentVariantGetModified()&&w1.getID()){w1.setID("");}if(s.oWorklistData.bWorkListEnabled){var y1=s.oWorklistData.oSearchField?s.oWorklistData.oSearchField.getValue():"";w1.addSelectOption("Worklist.SearchField","I","EQ",y1);}var z1={selectionVariant:w1.toJSONString(),tableVariantId:(!q&&s.oSmartTable.getCurrentVariantId())||"",customData:O()};return z1;}function Q(){m("fnStoreCurrentAppStateAndAdjustURL called",{bAppStateDirty:y,bDataAreShownInTable:D});if(!y){return;}y=false;try{H=p.storeInnerAppStateWithImmediateReturn(P(),true);}catch(i){l.error("ListReport.fnStoreCurrentAppStateAndAdjustURL: "+i);return;}if(H instanceof N){y=true;H=null;return;}H.promise.fail(function(v1){l.error("ListReport.fnStoreCurrentAppStateAndAdjustURL: Error when persisting appState"+v1);});m("Result received from storeInnerAppStateWithImmediateReturn",{appStateKey:H.appStateKey,sAppStateKeyInUrl:J});if(J===H.appStateKey){H=null;}else if(t.oComponentUtils.isComponentActive()){m("Call navigateByExchangingQueryParam",{appStateKey:H.appStateKey});t.oServices.oApplication.navigateByExchangingQueryParam(A,H.appStateKey);}else{r.appStateKey=H.appStateKey;H=null;}}function R(v1,w1){var x1=t.oComponentUtils.getTemplatePrivateModel();if(v1&&t.oComponentUtils.isDraftEnabled()){x1.setProperty("/listReport/vDraftState",v1.editStateFilter||"0");x1.setProperty("/listReport/activeObjectEnabled",!!v1.activeStateFilter);s.oMultipleViewsHandler.restoreActiveButtonState(v1);}var y1=v1&&v1.visibleCustomFields;if(y1&&y1.length>0){var z1=s.oSmartFilterbar.getAllFilterItems();for(var i=0;i<z1.length;i++){var A1=z1[i];var B1=A1.getName();if(y1.indexOf(B1)!==-1){A1.setVisibleInFilterBar(true);}}}D=w1&&!(v1&&v1.suppressDataSelection);if(D&&!s.oWorklistData.bWorkListEnabled){s.oSmartFilterbar.search();o1(D);}var C1=s.oMultipleViewsHandler.getSelectedKeyPropertyName();if(C1&&v1[C1]){s.oMultipleViewsHandler.restoreFromIappState(v1[C1]);}}function T(i,q){if(q){var v1=i['sap-ui-fe-variant-id'];if(v1&&v1[0]){s.oSmartFilterbar.getSmartVariant().setCurrentVariantId(v1[0]);}}else{var w1=i['sap-ui-fe-variant-id'],x1=i['sap-ui-fe-filterbar-variant-id'],y1=i['sap-ui-fe-chart-variant-id'],z1=i['sap-ui-fe-table-variant-id'];V(x1&&x1[0],y1&&y1[0],z1&&z1[0],w1&&w1[0]);}}function V(i,v1,w1,x1){if(i||x1){s.oSmartFilterbar.getSmartVariant().setCurrentVariantId(i||x1);}if(s.oSmartTable&&(w1||x1)){s.oSmartTable.attachAfterVariantInitialise(function(y1){s.oSmartTable.setCurrentVariantId(w1||x1);});s.oSmartTable.setCurrentVariantId(w1||x1);}s.oMultipleViewsHandler.setControlVariant(v1,w1,x1);}function W(i){j.restoreCustomAppStateDataExtension(i||{});}function X(i){if(!i){return;}var v1=true;var w1=function(x1){if(!(x1 instanceof C)){throw new a(c,"State must always be retrieved with respect to a ControllerExtension");}var y1=x1.getMetadata().getNamespace();if(!v1){throw new a(c,"State must always be restored synchronously");}return i[y1];};j.templateBaseExtension.restoreExtensionAppStateData(w1);v1=false;}function Y(i,v1){i=i||{};if(i.hasOwnProperty(b)&&i.hasOwnProperty(h)){X(i[g]);W(i[b]);R(i[h],v1);}else{if(i._editStateFilter!==undefined){R({editStateFilter:i._editStateFilter});delete i._editStateFilter;}W(i);}s.oSmartFilterbar.fireFilterChange();}function Z(){return w.then(function(){var i={};if(r.appStateKey){i[A]=r.appStateKey;}return i;});}function $(i){var v1=t.oComponentUtils.getTemplatePrivateModel();v1.setProperty("/generic/bDataAreShownInTable",i);}function _(i,v1){m("changeIappState called",{bFilterOrSettingsChange:i,bDataAreShown:v1,bDataAreShownInTable:D,bIsTransferringUrlStateToPageState:u,bAppStateDirty:y,bIgnoreFilterChange:x});if(x){return;}$(v1);if(u){return;}if(i||v1!==D){D=v1;if(!y){y=true;if(!s.oSmartFilterbar.isDialogOpen()){if(v){Q();}else{setTimeout(Q,0);}}}}}function a1(i){var v1=s.oSmartFilterbar.determineMandatoryFilterItems(),w1;for(var x1=0;x1<v1.length;x1++){if(v1[x1].getName().indexOf("P_DisplayCurrency")!==-1){if(i.oDefaultedSelectionVariant.getSelectOption("DisplayCurrency")&&i.oDefaultedSelectionVariant.getSelectOption("DisplayCurrency")[0]&&i.oDefaultedSelectionVariant.getSelectOption("DisplayCurrency")[0].Low){w1=i.oDefaultedSelectionVariant.getSelectOption("DisplayCurrency")[0].Low;if(w1){i.oSelectionVariant.addParameter("P_DisplayCurrency",w1);}}break;}}}function b1(){var v1=s.oSmartFilterbar.determineMandatoryFilterItems();var w1=s.oSmartFilterbar.getFiltersWithValues();for(var i=0;i<v1.length;i++){if(w1.indexOf(v1[i])===-1){return true;}}return false;}function c1(i,v1,w1){m("fnAdaptToAppState called",{sNavType:w1,sAppStateKeyInUrl:J,sAppStateKey:i.appStateKey,storingInformationAppStateKey:H&&H.appStateKey});s.oSmartFilterbar.setSuppressSelection(false);s.sNavType=w1;var x1=i.appStateKey||"";if(u){return;}if(J===null){J=x1;}else if(x1!==J){return;}var y1=(!x1&&v1)||{};T(y1,q);u=true;var z1=i.selectionVariant||"";var A1=(!q&&i.tableVariantId)||"";var B1=i.oSelectionVariant||"";var C1={selectionVariant:B1,urlParameters:v1,selectedQuickVariantSelectionKey:""};if(w1!==sap.ui.generic.app.navigation.service.NavType.iAppState&&i.presentationVariant!==undefined){var D1=JSON.parse(i.presentationVariant);var E1=D1&&D1.SortOrder;t.oCommonUtils.setControlSortOrder(s,E1);}var F1=new S(JSON.stringify(s.oSmartFilterbar.getUiState().getSelectionVariant()));var G1=JSON.parse(JSON.stringify(F1));var H1=F1.getSelectOption(b);var I1=F1.getSelectOption(h);if((r.appStateKey!==x1||r.selectionVariant!==z1||r.tableVariantId!==A1||k(r.urlParams,y1))&&w1!==sap.ui.generic.app.navigation.service.NavType.initial){if(!H||H.appStateKey!==x1){var J1=i&&i.bNavSelVarHasDefaultsOnly;if((i.oSelectionVariant.getSelectOptionsPropertyNames().indexOf("DisplayCurrency")===-1)&&(i.oSelectionVariant.getSelectOptionsPropertyNames().indexOf("P_DisplayCurrency")===-1)&&(i.oSelectionVariant.getParameterNames().indexOf("P_DisplayCurrency")===-1)){a1(i);}if(!s.oWorklistData.bWorkListEnabled){if(!J1||s.oSmartFilterbar.isCurrentVariantStandard()){C1.selectionVariant=i.oSelectionVariant;if(w1!==sap.ui.generic.app.navigation.service.NavType.iAppState){j.modifyStartupExtension(C1);}u1(J1?d1(C1.selectionVariant,F1):C1.selectionVariant,r,z1,true);}else{q1(F1,H1,I1,true);C1.selectionVariant=F1;j.modifyStartupExtension(C1);q1(C1.selectionVariant,H1,I1,false);if(!d(JSON.parse(JSON.stringify(C1.selectionVariant)),G1)){u1(C1.selectionVariant,r,z1,true);}}}if(A1!==r.tableVariantId){s.oSmartTable.setCurrentVariantId(A1);}i.customData=i.customData||{};if(s.oWorklistData.bWorkListEnabled){s.oWorklistData.oWorklistSavedData=i.customData[h]&&i.customData[h]["Worklist"]?i.customData[h]["Worklist"]:{};s.oWorklistHandler.restoreWorklistStateFromIappState();}Y(i.customData,true);}r={appStateKey:x1,urlParams:y1,selectionVariant:z1,tableVariantId:A1};}if(w1!==sap.ui.generic.app.navigation.service.NavType.iAppState){if(w1===sap.ui.generic.app.navigation.service.NavType.initial){q1(F1,H1,I1,true);C1.selectionVariant=F1;j.modifyStartupExtension(C1);q1(C1.selectionVariant,H1,I1,false);if(!d(JSON.parse(JSON.stringify(C1.selectionVariant)),G1)){u1(C1.selectionVariant,r,z1,true);}}s.oMultipleViewsHandler.handleStartUpObject(C1);}if(v){v();v=null;}if(s.oWorklistData.bWorkListEnabled){if(w1==="initial"&&s.oSmartFilterbar.isCurrentVariantStandard()){s.oWorklistHandler.restoreWorklistStateFromIappState();}}else if(w1!==sap.ui.generic.app.navigation.service.NavType.iAppState&&!D){var K1=(w1===sap.ui.generic.app.navigation.service.NavType.xAppState||w1===sap.ui.generic.app.navigation.service.NavType.URLParams)&&!i.bNavSelVarHasDefaultsOnly;if(s.oSmartFilterbar.isCurrentVariantStandard()){D=s.oSmartFilterbar.getSmartVariant().bExecuteOnSelectForStandardByUser;}else{D=s.oSmartFilterbar.isCurrentVariantExecuteOnSelectEnabled();}var L1=s.oMultipleViewsHandler.getOriginalEnableAutoBinding();var M1=b1();var N1=G.dataLoadSettings;var O1;if(N1){O1=N1.loadDataOnAppLaunch;}var P1=false;if(D===null||D===undefined||s.oSmartFilterbar.getLiveMode()){P1=K1||s.bLoadListAndFirstEntryOnStartup;if(!P1){if((O1===null||O1===undefined)&&(L1!==null&&L1!==undefined)){D=L1&&!M1?true:false;}else{D=l1(O1,M1);}}else{D=P1;}if(!D&&s.oSmartFilterbar.isCurrentVariantStandard()&&!s.oSmartFilterbar.getSmartVariant().bExecuteOnSelectForStandardByUser&&s.oSmartFilterbar.getSmartVariant().bExecuteOnSelectForStandardViaXML){s.oSmartFilterbar.getSmartVariant().bExecuteOnSelectForStandardViaXML=false;D=false;}}$(D);if(D){s.oSmartFilterbar.search();o1(D);}}H=null;u=false;if(w1!==sap.ui.generic.app.navigation.service.NavType.iAppState){_(true,D);}}function d1(i,v1){if(i.isEmpty()){return v1;}var w1=new S();var x1,y1;[v1,i].forEach(function(z1){x1=z1.getSelectOptionsPropertyNames();x1.forEach(function(A1){w1.removeSelectOption(A1);w1.massAddSelectOption(A1,z1.getSelectOption(A1));});y1=z1.getParameterNames();y1.forEach(function(A1){w1.removeParameter(A1);w1.addParameter(A1,z1.getParameter(A1));});});return w1;}function e1(){if(!v){w=new Promise(function(v1){v=v1;});}var i=new Promise(function(v1){var w1=J;var x1=p.parseNavigation();x1.done(function(y1,z1,A1){c1(y1,z1,A1);v1();});x1.fail(function(y1,z1,A1){l.warning(y1.getErrorCode()+"app state could not be parsed - continuing with empty state");c1({appStateKey:w1},z1,sap.ui.generic.app.navigation.service.NavType.initial);v1();});});return i;}function f1(){x=true;var i=s.oSmartFilterbar.getFilterData();var v1,w1=s.oSmartFilterbar.getBasicSearchControl();if(w1&&w1.getValue){v1=w1.getValue();}var x1=P();i._CUSTOM=x1.customData;s.oSmartFilterbar.setFilterData(i,true);if(v1){w1.setValue(v1);}s.oSmartFilterbar.fireFilterChange();x=false;}function g1(){_(true,D);}function h1(i){var v1=i.getParameter("context");var w1=s.oSmartFilterbar.getFilterData(true);if(w1._CUSTOM!==undefined){if(s.oWorklistData.bWorkListEnabled){var x1=w1._CUSTOM[h]["Worklist"];s.oSmartFilterbar.setSuppressSelection(false);s.oWorklistData.oSearchField.setValue(x1.searchString);s.oWorklistData.oSearchField.fireSearch();}else{Y(w1._CUSTOM);}}else{var y1=O();n(y1[b]);n(y1[h]);Y(y1);}if(I.indexOf(v1)<0){D=i.getParameter("executeOnSelect");o1(D);_(true,D);}}function i1(){if(!q){_(true,D);}}function j1(){if(!q){_(true,D);}}function k1(i){J=i[A]||"";if(H){if(H.appStateKey!==J){l.error("ListReport.fnStoreCurrentAppStateAndAdjustURL: Got AppstateKey "+J+" expected "+H.appStateKey);return false;}e1();return true;}return false;}function l1(i,v1){var w1;var x1=s.oSmartFilterbar.getFiltersWithValues();switch(i){case"always":w1=!v1?true:false;break;case"never":w1=false;break;default:w1=x1.length&&!v1?true:false;}return w1;}function m1(){z=s.oSmartTable.getEnableAutoBinding();s.oSmartFilterbar.attachFiltersDialogClosed(Q);}function n1(){var i;var v1=G.dataLoadSettings;if(v1){i=v1.loadDataOnAppLaunch;}var w1=s.oMultipleViewsHandler.getSelectedKeyPropertyName();var x1=w1==="tableTabData"||w1==="tableViewData"?true:false;E=x1?false:true;var y1=i===null||i===undefined?s.oMultipleViewsHandler.getEnableAutoBinding():true;z=E||y1;if(z){var z1=new sap.ui.core.CustomData({key:"executeStandardVariantOnSelect",value:true});s.oSmartFilterbar.addCustomData(z1);}}function o1(D){var i=j.getOwnerComponent().getModel("_templPriv");var v1=b1();if(D&&v1){i.setProperty("/listReport/isHeaderExpanded",true);}else if(D){i.setProperty("/listReport/isHeaderExpanded",false);}else{i.setProperty("/listReport/isHeaderExpanded",true);}}function p1(i,v1,w1){var x1=new U({selectionVariant:i});s.oSmartFilterbar.setUiState(x1,{replace:v1,strictMode:w1});}function q1(i,v1,w1,x1){if(i&&(v1||w1)){if(x1){i.removeSelectOption(b);i.removeSelectOption(h);}else{i.massAddSelectOption(b,v1);i.massAddSelectOption(h,w1);}}}function r1(v1,r,w1){if(v1&&(r.selectionVariant!==w1||s.sNavType==="initial")){var x1=v1.getParameterNames().concat(v1.getSelectOptionsPropertyNames());for(var i=0;i<x1.length;i++){s.oSmartFilterbar.addFieldToAdvancedArea(x1[i]);}}}function s1(i,v1,w1){if(i.getParameter(v1)&&!i.getParameter(w1)){i.addParameter(w1,i.getParameter(v1));}if(i.getSelectOption(v1)&&!i.getSelectOption(w1)){var x1=i.getSelectOption(v1);x1.forEach(function(y1){i.addSelectOption(w1,y1.Sign,y1.Option,y1.Low,y1.High);});}}function t1(i){var v1=j.getOwnerComponent().getModel().getMetaModel();var w1=j.getOwnerComponent().getEntitySet();var x1=v1.getODataEntityType(v1.getODataEntitySet(w1).entityType);x1.property.forEach(function(y1){if(y1["com.sap.vocabularies.Common.v1.EditableFieldFor"]){var z1=y1["com.sap.vocabularies.Common.v1.EditableFieldFor"].PropertyPath||y1["com.sap.vocabularies.Common.v1.EditableFieldFor"].String;var A1=y1.name;s1(i,z1,A1);s1(i,A1,z1);}});}function u1(i,r,v1,w1){t1(i);if(w1){s.oSmartFilterbar.clearVariantSelection();}r1(i,r,v1);p1(i.toJSONObject(),w1,false);}s.getCurrentAppState=P;return{areDataShownInTable:M,parseUrlAndApplyAppState:e1,getUrlParameterInfo:Z,changeIappState:_,onSmartFilterBarInitialise:m1,onBeforeSFBVariantFetch:f1,onAfterSFBVariantSave:g1,onAfterSFBVariantLoad:h1,onAfterTableVariantSave:i1,onAfterApplyTableVariant:j1,isStateChange:k1,onSFBVariantInitialise:n1};}return B.extend("sap.suite.ui.generic.template.ListReport.controller.IappStateHandler",{constructor:function(s,i,t){e(this,o(s,i,t));}});});
