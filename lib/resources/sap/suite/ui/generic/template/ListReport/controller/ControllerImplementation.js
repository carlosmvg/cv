sap.ui.define(["sap/ui/model/Filter","sap/suite/ui/generic/template/ListReport/extensionAPI/ExtensionAPI","sap/suite/ui/generic/template/listTemplates/listUtils","sap/suite/ui/generic/template/ListReport/controller/IappStateHandler","sap/suite/ui/generic/template/ListReport/controller/MultipleViewsHandler","sap/suite/ui/generic/template/ListReport/controller/WorklistHandler","sap/suite/ui/generic/template/lib/ShareUtils","sap/suite/ui/generic/template/lib/FeLogger","sap/base/util/ObjectPath","sap/suite/ui/generic/template/js/StableIdHelper","sap/base/util/deepExtend","sap/suite/ui/generic/template/lib/CreateWithDialogHandler","sap/suite/ui/generic/template/listTemplates/semanticDateRangeTypeHelper"],function(F,E,l,I,M,W,S,a,O,b,d,C,c){"use strict";var L=new a("ListReport.controller.ControllerImplementation").getLogger();var m={getMethods:function(v,t,o){var s={};s.oWorklistData={bWorkListEnabled:false,bVariantDirty:true};var f;var w=null;function e(){var i=o.getOwnerComponent();var T=t.oComponentUtils.getTemplatePrivateModel();T.setProperty("/listReport/isLeaf",i.getIsLeaf());}function g(i){o.onInitSmartFilterBarExtension(i);o.templateBaseExtension.onInitSmartFilterBar(i);s.oIappStateHandler.onSmartFilterBarInitialise();}var h=true;var j;var k=new Promise(function(R){j=R;});function n(){if(!h){s.oIappStateHandler.changeIappState(true,false);}}function u(i){t.oCommonUtils.setEnabledToolbarButtons(i);if(!t.oCommonUtils.isSmartChart(i)){t.oCommonUtils.setEnabledFooterButtons(i);}}function r(i){var P;P=i.getSource();P.getChartAsync().then(function(Q){Q.attachSelectData(u.bind(null,P));Q.attachDeselectData(u.bind(null,P));});}function p(i){var P=i.getParameters();var Q=i.getSource();t.oCommonEventHandlers.onSemanticObjectLinkNavigationPressed(Q,P);}function q(i){var P,Q;P=i.getParameters();Q=i.getSource();t.oCommonEventHandlers.onSemanticObjectLinkNavigationTargetObtained(Q,P,s,undefined,undefined);}function x(i){var P,T,Q,R,U,V;P=i.getParameters().mainNavigation;U=i.getParameters();V=i.getSource();if(P){T=V.getText&&V.getText();Q=t.oCommonUtils.getCustomData(i);if(Q&&Q["LinkDescr"]){R=Q["LinkDescr"];P.setDescription(R);}}V=V.getParent().getParent().getParent().getParent();t.oCommonEventHandlers.onSemanticObjectLinkNavigationTargetObtained(V,U,s,T,P);}function y(P){var Q=v.getItems();for(var i=0;i<Q.length;i++){if(!P||Q[i].getBindingContextPath()===P){return Q[i];}}}function N(i){t.oCommonEventHandlers.onListNavigate(i,s,undefined,true);}function z(P,i){t.oCommonUtils.processDataLossConfirmationIfNonDraft(function(){t.oCommonEventHandlers.addEntry(i,false,s.oSmartFilterbar,P);},Function.prototype,s);}function A(V){var i=b.getStableId({type:"ListReportAction",subType:"Create",sQuickVariantKey:V});var P=b.getStableId({type:"ListReportAction",subType:"CreateWithDialog"});if(o.getOwnerComponent().getCreateWithParameterDialog()){t.oCommonUtils.executeIfControlReady(s.oCreateWithDialogHandler.createWithDialog.bind(null,o.byId(P)),i);}else{t.oCommonUtils.executeIfControlReady(z.bind(null,undefined),i);}}function B(i){var P=o.getOwnerComponent().getCreateWithFilters();var Q=P.strategy||"extension";var R;switch(Q){case"extension":R=o.getPredefinedValuesForCreateExtension(s.oSmartFilterbar);break;default:L.error(Q+" is not a valid strategy to extract values from the SmartFilterBar");return;}z(R,i.getSource());}function D(i){var T=t.oComponentUtils.getTemplatePrivateModel();var P=T.getProperty("/listReport/deleteEnabled");if(P){t.oCommonEventHandlers.deleteEntries(i);}}function G(i){if(!t.oComponentUtils.isDraftEnabled()){return;}var T=t.oComponentUtils.getTemplatePrivateModel();var P=T.getProperty("/listReport/vDraftState");switch(P){case"1":i.push(new F("IsActiveEntity","EQ",true));i.push(new F("HasDraftEntity","EQ",false));break;case"2":i.push(new F("IsActiveEntity","EQ",false));break;case"3":i.push(new F("IsActiveEntity","EQ",true));i.push(new F("SiblingEntity/IsActiveEntity","EQ",null));i.push(new F("DraftAdministrativeData/InProcessByUser","NE",""));break;case"4":i.push(new F("IsActiveEntity","EQ",true));i.push(new F("SiblingEntity/IsActiveEntity","EQ",null));i.push(new F("DraftAdministrativeData/InProcessByUser","EQ",""));break;default:var Q=T.getProperty("/listReport/activeObjectEnabled");if(Q){i.push(new F("IsActiveEntity","EQ",true));}else{var R=new F({filters:[new F("IsActiveEntity","EQ",false),new F("SiblingEntity/IsActiveEntity","EQ",null)],and:false});if(i[0]&&i[0].aFilters){var U=i[0];i[0]=new F([U,R],true);}else{i.push(R);}}break;}}function H(i){var P={shareEmailPressed:function(){var T=t.oCommonUtils.getText("EMAIL_HEADER",[t.oServices.oApplication.getAppTitle()]);sap.m.URLHelper.triggerEmail(null,T,document.URL);},shareJamPressed:function(){S.openJamShareDialog(t.oServices.oApplication.getAppTitle());},getDownloadUrl:function(){var T=s.oSmartTable.getTable();var U=T.getBinding("rows")||T.getBinding("items");return U&&U.getDownloadUrl()||"";},getServiceUrl:function(){var T="";var U=t.oComponentUtils.getSettings();var V=s.oSmartFilterbar&&s.oSmartFilterbar.getUseDateRangeType();if(!V&&c.isServiceUrlAllowedBySemanticDateRangeFilter(U,s.oSmartFilterbar)){T=P.getDownloadUrl();if(T){T+="&$top=0&$inlinecount=allpages";}}var X={serviceUrl:T};o.onSaveAsTileExtension(X);return X.serviceUrl;},getModelData:function(){var T=O.get("sap.ushell.Container.getUser");var U=o.getOwnerComponent();var V=U.getAppComponent();var X=V.getMetadata();var Y=X.getManifestEntry("sap.ui");var Z=(Y&&Y.icons&&Y.icons.icon)||"";var $=X.getManifestEntry("sap.app");var _=($&&$.title)||"";return{serviceUrl:P.getServiceUrl(),icon:Z,title:_,isShareInJamActive:!!T&&T().isJamActive(),customUrl:S.getCustomUrl()};}};S.openSharePopup(t.oCommonUtils,i,P);var Q=this.getView().byId("template::Share");var R=this.getView().byId("bookmarkButton");R.setBeforePressHandler(function(){Q.focus();});}function J(i){var P=i.getId();var Q=s.oSmartFilterbar;var R="";var T=[];if(i.fetchVariant()&&i.fetchVariant().filter&&i.fetchVariant().filter.filterItems){T=i.fetchVariant().filter.filterItems;}var U={search:!!Q.getBasicSearchValue(),filter:!!(T.length||Q.retrieveFiltersWithValues().length)};if(U.search||U.filter){R=t.oCommonUtils.getContextText("NOITEMS_LR_SMARTTABLE_WITH_FILTER",P);}else{R=t.oCommonUtils.getContextText("NOITEMS_LR_SMARTTABLE",P);}i.setNoData(R);}function K(i){var P=i.getId();var Q=s.oSmartFilterbar;var R=[];if(i.fetchVariant()&&i.fetchVariant().filter&&i.fetchVariant().filter.filterItems){R=i.fetchVariant().filter.filterItems;}var T="";var U={search:!!Q.getBasicSearchValue(),filter:!!(R.length||Q.retrieveFiltersWithValues().length)};if(U.search||U.filter){T=t.oCommonUtils.getContextText("NOITEMS_SMARTCHART_WITH_FILTER",P);}else{T=t.oCommonUtils.getContextText("NOITEMS_SMARTCHART",P);}i.getChartAsync().then(function(V){V.setCustomMessages({NO_DATA:T});});}return{onInit:function(){var i=o.getOwnerComponent().getAppComponent();var P=i.getConfig();s.oWorklistData.bWorkListEnabled=!!P.pages[0].component.settings&&P.pages[0].component.settings.isWorklist;s.oSmartFilterbar=o.byId("listReportFilter");s.oSmartTable=o.byId("listReport");s.updateControlOnSelectionChange=u;f=t.oComponentUtils.getFclProxy();s.bLoadListAndFirstEntryOnStartup=f.isListAndFirstEntryLoadedOnStartup();s.oMultipleViewsHandler=new M(s,o,t);s.oCreateWithDialogHandler=new C(s,o,t);s.oWorklistHandler=new W(s,o,t);s.oIappStateHandler=new I(s,o,t);s.oIappStateHandler.onSFBVariantInitialise();if(s.oWorklistData.bWorkListEnabled){s.oWorklistHandler.fetchAndSaveWorklistSearchField();}var T=t.oComponentUtils.getTemplatePrivateModel();T.setProperty("/generic/bDataAreShownInTable",false);T.setProperty("/listReport/firstSelection",false);T.setProperty("/listReport/isHeaderExpanded",true);T.setProperty("/listReport/deleteEnabled",false);if(t.oComponentUtils.isDraftEnabled()){T.setProperty("/listReport/activeObjectEnabled",false);T.setProperty("/listReport/vDraftState","0");}T.setProperty("/listReport/multipleViews/msgVisibility",false);t.oServices.oApplication.registerStateChanger({isStateChange:s.oIappStateHandler.isStateChange});v.getSmartTable=function(){return s.oSmartTable;};v.getUrlParameterInfo=s.oIappStateHandler.getUrlParameterInfo;v.getItems=function(){var Q=s.oSmartTable.getTable();if(t.oCommonUtils.isUiTable(Q)){return Q.getRows();}return Q.getItems();};v.displayNextObject=function(Q){return new Promise(function(R,U){w={aWaitingObjects:Q,resolve:R,reject:U};});};v.onComponentActivate=function(){k.then(function(){var Q=s.oIappStateHandler.parseUrlAndApplyAppState();Q.then(function(){h=false;});});};v.refreshBinding=function(U,Q){if(s.oIappStateHandler.areDataShownInTable()){if(s.oMultipleViewsHandler.refreshOperation(2,null,!U&&Q)){return;}if(U||Q[s.oSmartTable.getEntitySet()]){t.oCommonUtils.refreshModel(s.oSmartTable);t.oCommonUtils.refreshSmartTable(s.oSmartTable);}}};e();o.byId("template::FilterText").attachBrowserEvent("click",function(){o.byId("page").setHeaderExpanded(true);});},handlers:{addEntry:A,addEntryWithFilters:B,deleteEntries:D,deleteEntry:function(i){t.oCommonEventHandlers.deleteEntry(i);},updateTableTabCounts:function(){s.oMultipleViewsHandler.fnUpdateTableTabCounts();},onCancelCreateWithPopUpDialog:function(){s.oCreateWithDialogHandler.onCancelPopUpDialog();},onSaveCreateWithPopUpDialog:function(i){s.oCreateWithDialogHandler.onSavePopUpDialog(i);},onSelectionChange:function(i){var T=i.getSource();u(T);},onMultiSelectionChange:function(i){t.oCommonEventHandlers.onMultiSelectionChange(i);},onSmartFieldUrlPressed:function(i){t.oCommonEventHandlers.onSmartFieldUrlPressed(i,s);},onContactDetails:function(i){t.oCommonEventHandlers.onContactDetails(i);},onSmartFilterBarInitialise:g,onSmartFilterBarInitialized:j,onBeforeSFBVariantFetch:function(){s.oIappStateHandler.onBeforeSFBVariantFetch();},onAfterSFBVariantSave:function(){s.oIappStateHandler.onAfterSFBVariantSave();},onAfterSFBVariantLoad:function(i){s.oIappStateHandler.onAfterSFBVariantLoad(i);},onDataRequested:function(){s.oMultipleViewsHandler.onDataRequested();},onDataReceived:function(P){t.oCommonEventHandlers.onDataReceived(P);if(w){var Q;var R=false;for(var i=0;i<w.aWaitingObjects.length&&!R;i++){Q=y(w.aWaitingObjects[i]);if(Q){N(Q);w.resolve();R=true;}}if(!R){Q=y();if(Q){N(Q);w.resolve();}else{w.reject();}}w=null;return;}var T=P.getSource().getTable();f.handleDataReceived(T,N);var U=t.oComponentUtils.getTemplatePrivateModel();U.setProperty("/listReport/firstSelection",true);U.setProperty("/generic/bDataAreShownInTable",true);},onSmartChartDataReceived:function(){s.oMultipleViewsHandler.onDataRequested();},onBeforeRebindTable:function(i){var P=i.getSource();J(P);var Q=i.getParameters().bindingParams;s.oMultipleViewsHandler.aTableFilters=d({},Q.filters);var R=Q.filters.slice(0);t.oCommonEventHandlers.onBeforeRebindTable(i,{determineSortOrder:s.oMultipleViewsHandler.determineSortOrder,ensureExtensionFields:o.templateBaseExtension.ensureFieldsForSelect,addTemplateSpecificFilters:G,addExtensionFilters:o.templateBaseExtension.addFilters,resolveParamaterizedEntitySet:s.oMultipleViewsHandler.fnResolveParameterizedEntitySet,isFieldControlRequired:false});o.onBeforeRebindTableExtension(i);s.oMultipleViewsHandler.onRebindContentControl(Q,R);l.handleErrorsOnTableOrChart(t,i);},onListNavigate:function(i){t.oCommonEventHandlers.onListNavigate(i,s);},onCallActionFromToolBar:function(i){t.oCommonEventHandlers.onCallActionFromToolBar(i,s);},onDataFieldForIntentBasedNavigation:function(i){t.oCommonEventHandlers.onDataFieldForIntentBasedNavigation(i,s);},onDataFieldWithIntentBasedNavigation:function(i){t.oCommonEventHandlers.onDataFieldWithIntentBasedNavigation(i,s);},onBeforeSemanticObjectLinkNavigationCallback:function(){return new Promise(function(i){t.oServices.oDataLossHandler.performIfNoDataLoss(function(){i(true);},function(){i(false);});});},onBeforeSemanticObjectLinkPopoverOpens:function(i){var P=i.getParameters();var Q=JSON.stringify(s.oSmartFilterbar.getUiState().getSelectionVariant());t.oCommonUtils.semanticObjectLinkNavigation(P,Q,o);},onSemanticObjectLinkNavigationPressed:p,onSemanticObjectLinkNavigationTargetObtained:q,onSemanticObjectLinkNavigationTargetObtainedSmartLink:x,onDraftLinkPressed:function(i){var P=i.getSource();var Q=P.getBindingContext();t.oCommonUtils.showDraftPopover(Q,P);},onAssignedFiltersChanged:function(i){if(i.getSource()){o.byId("template::FilterText").setText(i.getSource().retrieveFiltersWithValuesAsText());}},onFilterChange:n,onSearchButtonPressed:function(){t.oCommonUtils.refreshModel(s.oSmartTable);s.oIappStateHandler.changeIappState(false,true);},onAfterTableVariantSave:function(){s.oIappStateHandler.onAfterTableVariantSave();},onAfterApplyTableVariant:function(){if(!h){s.oIappStateHandler.onAfterApplyTableVariant();}},onAfterChartVariantSave:function(i){s.oIappStateHandler.onAfterTableVariantSave();},onAfterApplyChartVariant:function(i){if(!h){s.oIappStateHandler.onAfterApplyTableVariant();}},onBeforeRebindChart:function(i){var P=i.getSource();K(P);var Q=i.getParameters().bindingParams;s.oMultipleViewsHandler.aTableFilters=d({},Q.filters);var R=Q.filters.slice(0);var T={setBindingPath:P.setChartBindingPath.bind(P),ensureExtensionFields:Function.prototype,addTemplateSpecificFilters:G,addExtensionFilters:o.templateBaseExtension.addFilters,resolveParamaterizedEntitySet:s.oMultipleViewsHandler.fnResolveParameterizedEntitySet,isFieldControlRequired:false};t.oCommonUtils.onBeforeRebindTableOrChart(i,T,s.oSmartFilterbar);o.onBeforeRebindChartExtension(i);s.oMultipleViewsHandler.onRebindContentControl(Q,R);l.handleErrorsOnTableOrChart(t,i);},onChartInitialized:function(i){r(i);t.oCommonUtils.checkToolbarIntentsSupported(i.getSource());},onSelectionDetailsActionPress:function(i){s.oMultipleViewsHandler.onDetailsActionPress(i);},onShareListReportActionButtonPress:function(i){t.oCommonUtils.executeIfControlReady(H,"template::Share");},onInlineDataFieldForAction:function(i){t.oCommonEventHandlers.onInlineDataFieldForAction(i,s);},onInlineDataFieldForIntentBasedNavigation:function(i){t.oCommonEventHandlers.onInlineDataFieldForIntentBasedNavigation(i.getSource(),s);},onDeterminingDataFieldForAction:function(i){t.oCommonEventHandlers.onDeterminingDataFieldForAction(i,s.oSmartTable);},onDeterminingDataFieldForIntentBasedNavigation:function(i){var P=i.getSource();t.oCommonEventHandlers.onDeterminingDataFieldForIntentBasedNavigation(P,s.oSmartTable.getTable(),s);},onTableInit:function(i){var P=i.getSource();t.oCommonUtils.checkToolbarIntentsSupported(P);},onSearchWorkList:function(i){s.oWorklistHandler.performWorklistSearch(i);},onWorkListTableSettings:function(i){s.oWorklistHandler.openWorklistPersonalisation(i);},onActiveButtonPress:function(i){var P=o.byId("template::PageVariant");var T=t.oComponentUtils.getTemplatePrivateModel();var Q=T.getProperty("/listReport/activeObjectEnabled");T.setProperty("/listReport/activeObjectEnabled",!Q);P.currentVariantSetModified(true);s.oSmartFilterbar.search();s.oIappStateHandler.changeIappState(true,true);}},formatters:{formatDraftType:function(i,P,Q){if(i&&i.DraftUUID){if(!P){return sap.m.ObjectMarkerType.Draft;}else if(Q){return i.InProcessByUser?sap.m.ObjectMarkerType.Locked:sap.m.ObjectMarkerType.Unsaved;}}return sap.m.ObjectMarkerType.Flagged;},formatDraftVisibility:function(i,P){if(i&&i.DraftUUID){if(!P){return sap.m.ObjectMarkerVisibility.TextOnly;}}return sap.m.ObjectMarkerVisibility.IconAndText;},formatDraftLineItemVisible:function(i,P,Q){if(i&&i.DraftUUID){if(Q==="0"&&P){return false;}return true;}return false;},formatDraftOwner:function(i,P){var Q="";if(i&&i.DraftUUID&&P){var U=i.InProcessByUserDescription||i.InProcessByUser||i.LastChangedByUserDescription||i.LastChangedByUser;if(U){Q=t.oCommonUtils.getText("ST_DRAFT_OWNER",[U]);}else{Q=t.oCommonUtils.getText("ST_DRAFT_ANOTHER_USER");}}return Q;},formatItemTextForMultipleView:function(i){return s.oMultipleViewsHandler?s.oMultipleViewsHandler.formatItemTextForMultipleView(i):"";},formatMessageStrip:function(i,P){return s.oMultipleViewsHandler?s.oMultipleViewsHandler.formatMessageStrip(i,P):"";}},extensionAPI:new E(t,o,s)};}};return m;});
