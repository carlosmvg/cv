sap.ui.define(["sap/ui/base/Object","sap/ui/generic/app/navigation/service/SelectionVariant","sap/ui/Device","sap/ui/comp/state/UIState","sap/ui/core/mvc/ControllerExtension","sap/suite/ui/generic/template/lib/FeLogger","sap/base/util/deepEqual","sap/base/util/extend","sap/base/util/deepExtend","sap/suite/ui/generic/template/lib/FeError"],function(B,S,D,U,C,F,d,e,a,b){"use strict";var c="AnalyticalListPage.controller.IappStateHandler";var l=new F(c).getLogger();function g(s,o,t){var n=t.oServices.oApplication.getNavigationHandler();var f="sap.suite.ui.generic.template.customData";var h="sap.suite.ui.generic.template.genericData";var j="sap.suite.ui.generic.template.extensionData";var k="visual";var m="compact";var p;var I=false,q=false,_=null,r;var u=null;var A=null;var R={appStateKey:"",urlParams:{}};var v={};var w="sap-iapp-state";function x(){return p.then(function(){if(R.appStateKey){return{"sap-iapp-state":[R.appStateKey]};}return R.urlParams;});}function y(i){if(i&&i.editStateFilter!==undefined){var j1=o.byId("editStateFilter");if(j1){j1.setSelectedKey((i.editStateFilter===null)?0:i.editStateFilter);}}var k1=s.oController.getOwnerComponent().getModel("_templPriv");if(i.chartVariantId&&s.oSmartChart){s.oSmartChart.setCurrentVariantId(i.chartVariantId);}if(i.filterMode){k1.setProperty('/alp/filterMode',i.filterMode);s.filterBarController.handleFilterSwitch(i.filterMode);}else{H();}if(i.contentView){var l1=k1.getProperty('/alp/enableHybridMode');if(l1===false&&i.contentView==='charttable'){k1.setProperty('/alp/contentView','chart');}else{((D.system.phone||D.system.tablet&&!D.system.desktop)&&i.contentView==="charttable")?k1.setProperty('/alp/contentView',"chart"):k1.setProperty('/alp/contentView',i.contentView);}}if(i.autoHide){k1.setProperty('/alp/autoHide',i.autoHide);}}function z(i){if(!i){return;}var j1=true;var k1=function(l1){if(!(l1 instanceof C)){throw new b(c,"State must always be retrieved with respect to a ControllerExtension");}var m1=l1.getMetadata().getNamespace();if(!j1){throw new b(c,"State must always be restored synchronously");}return i[m1];};o.templateBaseExtension.restoreExtensionAppStateData(k1);j1=false;}function E(i){i=i||{};if(i.hasOwnProperty(f)&&i.hasOwnProperty(h)){y(i[h]);T(i[f]);z(i[j]);}else{if(i._editStateFilter!==undefined){y({editStateFilter:i._editStateFilter});delete i._editStateFilter;}H();T(i);}}function G(i){if(s.oSmartFilterbar.isPending()){var j1=function(k1){var l1=k1.getParameters();if(!l1.pendingValue){s.oSmartFilterbar.detachPendingChange(j1);E(i);}};s.oSmartFilterbar.attachPendingChange(j1);}else{E(i);}}function H(){var i=s.oController.getOwnerComponent().getModel("_templPriv"),j1=s.oSmartFilterbar.isCurrentVariantStandard()?s.oController.getOwnerComponent().getDefaultFilterMode():i.getProperty('/alp/filterMode');if(!(j1===k||j1===m)){l.error("Defaulting to Visual filter due to incorrect value of defaultFilterMode in App descriptor");j1=k;}if(j1===k&&s.hideVisualFilter){l.error("Visual filter is hidden defaulting to compact");j1=m;}s.filterBarController.setDefaultFilter(j1);}function J(i){var j1=s.oController.getOwnerComponent().getProperty('smartVariantManagement');if(j1){var k1=i['sap-ui-fe-variant-id'];if(k1&&k1[0]){s.oSmartFilterbar.getSmartVariant().setCurrentVariantId(k1[0]);}}else{var l1=i['sap-ui-fe-variant-id'],m1=i['sap-ui-fe-filterbar-variant-id'],n1=i['sap-ui-fe-chart-variant-id'],o1=i['sap-ui-fe-table-variant-id'];K(m1&&m1[0],n1&&n1[0],o1&&o1[0],l1&&l1[0]);}}function K(i,j1,k1,l1){if(i||l1){s.oSmartFilterbar.getSmartVariant().setCurrentVariantId(i||l1);}if(s.oSmartChart&&(j1||l1)){s.oSmartChart.attachAfterVariantInitialise(function(m1){s.oSmartChart.setCurrentVariantId(j1||l1);});s.oSmartChart.setCurrentVariantId(j1||l1);}if(s.oSmartTable&&(k1||l1)){s.oSmartTable.attachAfterVariantInitialise(function(m1){s.oSmartTable.setCurrentVariantId(k1||l1);});s.oSmartTable.setCurrentVariantId(k1||l1);}}function L(i,j1,k1){s.oSmartFilterbar.setSuppressSelection(false);var l1=i.appStateKey||"";if(I){return;}A=l1;I=true;s.sNavType=k1;var m1=(!l1&&j1)||{};if(m1){J(m1);}if(k1!==sap.ui.generic.app.navigation.service.NavType.iAppState&&i.presentationVariant!==undefined){var n1=JSON.parse(i.presentationVariant);var o1=n1&&n1.SortOrder;t.oCommonUtils.setControlSortOrder(s,o1);}if(k1!==sap.ui.generic.app.navigation.service.NavType.initial){var p1=i&&i.bNavSelVarHasDefaultsOnly;var q1=new S(i.selectionVariant);v=JSON.parse(i.selectionVariant);if((q1.getSelectOptionsPropertyNames().indexOf("DisplayCurrency")===-1)&&(q1.getSelectOptionsPropertyNames().indexOf("P_DisplayCurrency")===-1)&&(q1.getParameterNames().indexOf("P_DisplayCurrency")===-1)){N(q1,i);}if((!p1||s.oSmartFilterbar.isCurrentVariantStandard())){var r1={selectionVariant:q1};if(k1!==sap.ui.generic.app.navigation.service.NavType.iAppState){s.oController.modifyStartupExtension(r1);}X(r1.selectionVariant);W(r1.selectionVariant);}else{var s1=new S(JSON.stringify(s.oSmartFilterbar.getUiState().getSelectionVariant())),t1=s1.getSelectOption("sap.suite.ui.generic.template.customData"),u1=s1.getSelectOption("sap.suite.ui.generic.template.genericData");M(s1,t1,u1,true);var r1={selectionVariant:s1};s.oController.modifyStartupExtension(r1);M(r1.selectionVariant,t1,u1,false);if(!d(r1.selectionVariant,new S(JSON.stringify(s.oSmartFilterbar.getUiState().getSelectionVariant())))){X(r1.selectionVariant);W(r1.selectionVariant);}}if(i.tableVariantId&&s.oSmartTable){s.oSmartTable.setCurrentVariantId(i.tableVariantId);}var v1=s.oController.getOwnerComponent().getModel("_templPriv");if(k1===sap.ui.generic.app.navigation.service.NavType.xAppState&&v1.getProperty('/alp/filterMode')===k){V();}if(i.customData){G(i.customData);}else{H();}if(!p1){s.oSmartFilterbar.checkSearchAllowed(s);if(s.oController.getView().getModel("_templPriv").getProperty("/alp/searchable")){q=true;s.oSmartFilterbar.search();}}R={appStateKey:l1,urlParams:m1};}else{var q1=new S(JSON.stringify(s.oSmartFilterbar.getUiState().getSelectionVariant())),t1=q1.getSelectOption("sap.suite.ui.generic.template.customData"),u1=q1.getSelectOption("sap.suite.ui.generic.template.genericData");M(q1,t1,u1,true);var r1={selectionVariant:q1};s.oController.modifyStartupExtension(r1);M(r1.selectionVariant,t1,u1,false);if(!d(r1.selectionVariant,new S(JSON.stringify(s.oSmartFilterbar.getUiState().getSelectionVariant())))){X(r1.selectionVariant);W(r1.selectionVariant);}if(s.oSmartFilterbar.isLiveMode()||s.oSmartFilterbar.isCurrentVariantExecuteOnSelectEnabled()){s.oSmartFilterbar.checkSearchAllowed(s);if(s.oController.getView().getModel("_templPriv").getProperty("/alp/searchable")){q=true;}}H();}a1();u=null;if(!s.oSmartFilterbar.isLiveMode()){i1();}if(!q){e1();}else{I=false;}}function M(i,j1,k1,l1){if(l1){if(j1){i.removeSelectOption("sap.suite.ui.generic.template.customData");}if(k1){i.removeSelectOption("sap.suite.ui.generic.template.genericData");}}else{if(j1){i.massAddSelectOption("sap.suite.ui.generic.template.customData",j1);}if(k1){i.massAddSelectOption("sap.suite.ui.generic.template.genericData",k1);}}}function N(i,j1){var k1=s.oSmartFilterbar.determineMandatoryFilterItems(),l1;for(var m1=0;m1<k1.length;m1++){if(k1[m1].getName().indexOf("P_DisplayCurrency")!==-1){if(j1.oDefaultedSelectionVariant.getSelectOption("DisplayCurrency")&&j1.oDefaultedSelectionVariant.getSelectOption("DisplayCurrency")[0].Low){l1=j1.oDefaultedSelectionVariant.getSelectOption("DisplayCurrency")[0].Low;}if(l1){i.addParameter("P_DisplayCurrency",l1);}if(s.alr_visualFilterBar&&l1){s.alr_visualFilterBar.setDisplayCurrency(l1);}break;}}}function O(){var i={};i[f]={};var j1=s.oController.getOwnerComponent().getModel("_templPriv");var k1=s.chartController&&e({},s.chartController._chartInfo);if(k1&&k1.chartSelection){delete k1.chartSelection;}i[h]={chartVariantId:s.oSmartChart&&s.oSmartChart.getCurrentVariantId(),filterMode:j1.getProperty('/alp/filterMode'),contentView:j1.getProperty('/alp/contentView'),autoHide:j1.getProperty('/alp/autoHide'),chartInfo:k1};var l1=o.byId("editStateFilter");if(l1){i[h].editStateFilter=l1.getSelectedKey();}o.getCustomAppStateDataExtension(i[f]);var m1;var n1=true;var o1=function(p1,q1){if(!(p1 instanceof C)){throw new b(c,"State must always be set with respect to a ControllerExtension");}if(!n1){throw new b(c,"State must always be provided synchronously");}if(q1){m1=m1||Object.create(null);var r1=p1.getMetadata().getNamespace();m1[r1]=q1;}};o.templateBaseExtension.provideExtensionAppStateData(o1);n1=false;if(m1){i[j]=m1;}return i;}function P(){return v;}function Q(){var j1=s.oSmartFilterbar.getUiState({allFilters:false}).getSelectionVariant();var k1=o.getVisibleSelectionsWithDefaults();for(var i=0;i<k1.length;i++){if(!j1.getValue(k1[i])){j1.addSelectOption(k1[i],"I","EQ","");}}if(s.oController.byId('template::PageVariant').currentVariantGetModified()&&j1.SelectionVariantID){j1.SelectionVariantID="";}return{selectionVariant:JSON.stringify(j1),tableVariantId:s.oSmartTable&&s.oSmartTable.getCurrentVariantId(),customData:O()};}function T(i){o.restoreCustomAppStateDataExtension(i||{});}function V(){var i=a({},s.oSmartFilterbar.getFilterData(true)),j1=s.oController.getOwnerComponent().getModel("_filter");j1.setData(i);s.filterBarController._updateFilterLink();}function W(i){s.oSmartFilterbar.clearVariantSelection();s.oSmartFilterbar.clear();r=i;b1(i.toJSONObject(),true,false);}function X(j1){var k1=j1.getParameterNames().concat(j1.getSelectOptionsPropertyNames());for(var i=0;i<k1.length;i++){s.oSmartFilterbar.addFieldToAdvancedArea(k1[i]);}if(s.alr_visualFilterBar&&s.bVisualFilterInitialised){s.alr_visualFilterBar.addVisualFiltersToBasicArea(k1);}}function Y(){if(s._bIsStartingUp){return;}if(I){return;}var i=Q();try{u=n.storeInnerAppStateWithImmediateReturn(i,true);}catch(j1){l.error("AnalyticalListPage.fnStoreCurrentAppStateAndAdjustURL: "+j1);}if(u instanceof sap.ui.generic.app.navigation.service.NavError){u=null;return;}if(s.oTemplateUtils.oComponentUtils.isComponentActive()&&u){s.oTemplateUtils.oServices.oApplication.navigateByExchangingQueryParam(w,u.appStateKey);}if(u&&A!==u.appStateKey){R.appStateKey=u.appStateKey;u=null;}}function Z(){var i=s.oController.getOwnerComponent().getModel("_templPriv");if(i.getProperty('/alp/filterMode')===k){if(s.alr_visualFilterBar&&s.alr_visualFilterBar.bIsInitialised&&i.getProperty("/alp/searchable")===false){s.oSmartFilterbar.showFilterDialog();}}}function $(){if(s.oSmartFilterbar.isInitialised()){s.oSmartFilterbar.checkSearchAllowed(s);}}function a1(){var i=s.oController.getOwnerComponent().getModel("_filter");i.setData(a({},s.oSmartFilterbar.getFilterData(true)));s.filterBarController._updateFilterLink();}function b1(i,j1,k1){var l1=new U({selectionVariant:i});s.oSmartFilterbar.setUiState(l1,{replace:j1,strictMode:k1});}function c1(i){p=n.parseNavigation();}function d1(){try{var i=new Promise(function(k1,l1){_=k1;p.done(L);p.fail(l1);});return i;}catch(j1){h1();}}function e1(){I=false;_();}function f1(){return r;}function g1(i){if(!i){var j1=s.oIappStateHandler.fnGetStartUpSelectionVariant();if(j1){var k1=j1.getParameterNames().concat(j1.getSelectOptionsPropertyNames());s.alr_visualFilterBar.addVisualFiltersToBasicArea(k1);}}s.alr_visualFilterBar.updateVisualFilterBindings(true);if(s.oSmartFilterbar.isCurrentVariantStandard()){s.oIappStateHandler.fnCheckMandatory();s.oIappStateHandler.fnCheckToLaunchDialog();}}function h1(){H();a1();if(s.alr_visualFilterBar&&s.alr_visualFilterBar.bIsInitialised){s.oIappStateHandler.fnUpdateVisualFilterBar(true);}}function i1(){var i=false;if(s.oSmartFilterbar.isCurrentVariantStandard()){var j1=s.oSmartFilterbar.getSmartVariant().bExecuteOnSelectForStandardByUser;if(j1!==null){return false;}s.oSmartFilterbar.checkSearchAllowed(s);if(s.oController.getView().getModel("_templPriv").getProperty("/alp/searchable")){var k1=s.oController.getOwnerComponent();var l1=k1.getDataLoadSettings();var m1=l1?l1.loadDataOnAppLaunch:"ifAnyFilterExist";if(m1==="ifAnyFilterExist"){var n1=s.oSmartFilterbar.getFiltersWithValues();i=n1.length?true:false;}else if(m1==="always"){i=true;}else if(m1==="never"){i=false;}if(i){s.oSmartFilterbar.getSmartVariant().bExecuteOnSelectForStandardViaXML=true;}}}return i;}return{getFilterState:O,fnCheckMandatory:$,fnCheckToLaunchDialog:Z,getCurrentAppState:Q,fnUpdateSVFB:a1,fnSetDefaultFilter:H,fnRestoreFilterState:G,getUrlParameterInfo:x,onSmartFilterBarInitialise:c1,onSmartFilterBarInitialized:d1,fnStoreCurrentAppStateAndAdjustURL:Y,fnSetFiltersUsingUIState:b1,fnResolveStartUpPromise:e1,fnGetStartUpSelectionVariant:f1,fnUpdateVisualFilterBar:g1,fnOnError:h1,getInitialNavigationContext:P};}return B.extend("sap.suite.ui.generic.template.AnalyticalListPage.controller.IappStateHandler",{constructor:function(s,o,t){e(this,g(s,o,t));}});});
