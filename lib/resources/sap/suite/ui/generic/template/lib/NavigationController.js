/*
 * ! SAP UI development toolkit for HTML5 (SAPUI5)

		(c) Copyright 2009-2015 SAP SE. All rights reserved
	
 */
sap.ui.define(["sap/ui/base/Object","sap/ui/core/ComponentContainer","sap/ui/core/routing/HashChanger","sap/ui/core/routing/History","sap/ui/core/library","sap/suite/ui/generic/template/lib/CRUDHelper","sap/suite/ui/generic/template/lib/ProcessObserver","sap/suite/ui/generic/template/lib/Queue","sap/suite/ui/generic/template/lib/routingHelper","sap/suite/ui/generic/template/lib/TemplateComponent","sap/suite/ui/generic/template/lib/testableHelper","sap/ui/fl/ControlPersonalizationAPI","sap/suite/ui/generic/template/lib/FeLogger","sap/base/util/merge","sap/base/util/extend","sap/base/util/isEmptyObject","sap/base/util/UriParameters","sap/suite/ui/generic/template/lib/FeError"],function(B,C,H,a,c,b,P,Q,r,T,t,d,F,m,e,f,U,g){"use strict";var s="lib.NavigationController";var l=new F(s).getLogger();var h=c.routing.HistoryDirection;var o=a.getInstance();function k(i){i=i||o.getDirection();return i===h.Backwards;}var n=r.getCrossAppNavService();var A="sap-iapp-state--create";var p="sap-iapp-state--history";function q(R){var i=R.substring(R.length-5,R.length);if(i==="query"){return R.substring(0,R.length-5);}return R;}function N(i){if(i.indexOf("/")===0){return i;}return"/"+i;}function u(j){var E="";var R="";var G=Object.keys(j).sort();G.forEach(function(I){var V=j[I];if(Array.isArray(V)){var J=V.sort();for(var i=0;i<J.length;i++){var K=J[i];R=R+E+I+"="+K;E="&";}}else{R=R+E+I+"="+V;E="&";}});return R;}function v(i,j){i=i||"";var E=(i.charAt(i.length-1)==="/")?"?":"/?";return i+(j?E+j:"");}function w(i,j){var E=u(j);return v(i,E);}function x(i){var j=i.getPath();if(j.lastIndexOf("/")!==0){var M=i.getModel();var E=M.getMetaModel();j=E.oMetadata._calculateCanonicalPath(j);}var G=j.split("(");var I=G.shift().substring(1);var R=G.join("(");var K=R.substring(0,R.length-1);return{entitySet:I,key:K};}function y(E,G){var S=[];var I=n.createEmptyAppState(E.oAppComponent,true);var J=I.getKey();var K;var M;var L;var O;var R,V;var W;var X;var Y;var Z=Promise.resolve();var $=(new Q()).start();function _(i){var j=i.iHashChangeCount+1;V={iHashChangeCount:j,backTarget:i.iHashChangeCount,componentsDisplayed:Object.create(null),LeaveByBack:true,backSteps:1};}function a1(){E.oBusyHelper.setBusyReason("HashChange",true);X={};K=k();if(K){E.oBusyHelper.getUnbusy().then(function(){K=false;});W={mode:-1};if(S.length){var i=S.pop();L=i.isInitialNavigation;M=i.myIntentPromise;O=i.previousHashes;O.push(i.currentHash);_(i.currentHash);return;}}else{L=!n||n.isInitialNavigation();}M=(sap.ushell&&sap.ushell.Container)?new Promise(function(j){sap.ushell.Container.getServiceAsync("AppLifeCycle").then(function(J2){var K2=J2.getCurrentApplication();var L2=function(){K2=K2||J2.getCurrentApplication();var M2=K2.getIntent();Promise.all([M2,sap.ushell.Container.getServiceAsync("URLParsing")]).then(function(N2){var M2=N2[0];var O2=N2[1];M2.appSpecificRoute="&/";var P2=O2.constructShellHash(M2);j("#"+P2);});};if(K2){L2();}else{J2.attachAppLoaded(null,L2);}});}):Promise.resolve("");V={iHashChangeCount:0,backTarget:0,componentsDisplayed:Object.create(null)};O=[];W=null;R=null;Y=null;}a1();var b1=Promise.resolve();var c1=Promise.resolve();var d1=new P();function e1(){var i=k();if(!i){S.push({isInitialNavigation:L,myIntentPromise:M,currentHash:V,previousHashes:O});}M=null;V=null;O=null;R=null;Y=null;X=null;}function f1(){v2(E.mRoutingTree.root);return E.mRouteToTemplateComponentPromise.root;}function g1(){return G.oAppComponent.getManifestEntry("sap.app").title;}function h1(){var i=sap.ushell&&sap.ushell.Container;return i&&i.getServiceAsync("URLParsing");}function i1(i,j,J2){var K2=i&&E.componentRegistry[i];var L2=K2&&K2.methods.getUrlParameterInfo;return L2?K2.viewRegistered.then(function(){var M2=j&&N(j);return L2(M2,V.componentsDisplayed[K2.route]===1).then(function(N2){e(J2,N2);});}):Promise.resolve();}function j1(i){var j=i.treeNode.componentId;var J2=i.treeNode.getPath(2,i.keys);var K2=i.appStates;return i1(j,J2,K2);}function k1(i,j,J2){var K2=E.mRoutingTree[i];return i1(K2.componentId,J2,j);}function l1(i,j){var J2;if(!i&&j instanceof T){var K2=j&&E.componentRegistry[j.getId()];var L2=K2&&K2.methods.getTitle;J2=L2&&L2();}else if(!i&&j&&j.title){J2=j.title;}J2=J2||g1();E.oShellServicePromise.then(function(M2){M2.setTitle(J2);}).catch(function(){l.warning("No ShellService available");});}function m1(i){var j=[E.oPagesDataLoadedObserver.getProcessFinished(true)];var J2=null;var K2=V.iHashChangeCount;delete R.componentsDisplayed;var L2=-1;for(var M2 in E.componentRegistry){var N2=E.componentRegistry[M2];var O2=N2.oControllerUtils&&N2.oControllerUtils.oServices.oTemplateCapabilities.oMessageButtonHelper;var P2=V.componentsDisplayed[N2.route]===1;var Q2=N2.utils.getTemplatePrivateModel();Q2.setProperty("/generic/isActive",P2);if(P2){j.push(N2.oViewRenderedPromise);if(N2.viewLevel>L2){L2=N2.viewLevel;J2=N2.oComponent;}}else{N2.utils.suspendBinding();}if(O2){O2.setEnabled(P2);}}var R2=E.oFlexibleColumnLayoutHandler&&E.oFlexibleColumnLayoutHandler.isAppTitlePrefered();l1(R2,i||J2);Promise.all(j).then(function(){if(K2===V.iHashChangeCount&&f(X)){E.oAppComponent.firePageDataLoaded();}});}var n1=m1.bind(null,null);function o1(i,j){var J2=[];for(var K2=i;K2.level>=j;K2=E.mRoutingTree[K2.parentRoute]){J2.push(K2);}return J2.reverse();}t.testable(function(i){R=i;O.push(V);V={backTarget:0,componentsDisplayed:Object.create(null)};},"setCurrentIdentity");t.testable(function(i){J=i;},"setHistoryKey");function p1(){return R;}function q1(j,J2){if(Array.isArray(j)&&j.length<2){j=j[0];}if(Array.isArray(J2)&&J2.length<2){J2=J2[0];}if(Array.isArray(j)){if(Array.isArray(J2)){if(j.length===J2.length){j=j.sort();J2=J2.sort();return j.every(function(K2,i){return K2===J2[i];});}return false;}return false;}return J2===j;}function r1(i){if(!R||R.treeNode!==i.treeNode){return false;}for(var j=i.treeNode;j.level>0;j=E.mRoutingTree[j.parentRoute]){if(!j.noKey&&i.keys[j.level]!==R.keys[j.level]){return false;}}if(f(R.appStates)){return f(i.appStates);}var J2=e(Object.create(null),i.appStates,R.appStates);for(var K2 in J2){var L2=(K2===p)?J:i.appStates[K2];if(!q1(L2,R.appStates[K2])){return false;}}return true;}function s1(i,j,J2){var K2=Object.create(null);for(var L2=i;L2.level>0;L2=E.mRoutingTree[L2.parentRoute]){if(!L2.noKey){K2["keys"+L2.level]=j[L2.level];}}var M2=!f(J2);var N2=i.sRouteName+(M2?"query":"");if(M2){K2["query"]=J2;}return{route:N2,parameters:K2};}function t1(i){var j=s1(W.identity.treeNode,W.identity.keys,W.identity.appStates);if(!E.ghostapp){G.oRouter.navTo(j.route,j.parameters,i);}}function u1(i){if(!i||!W.identity){return;}var j=function(K2,L2,M2){M2=L2?L2.getId():M2;var N2=E.componentRegistry[M2];(N2.methods.presetDisplayMode||Function.prototype)(i,K2);};for(var J2=W.identity.treeNode;J2;J2=J2.parentRoute&&E.mRoutingTree[J2.parentRoute]){if(J2.componentId){j(V.componentsDisplayed[J2.sRouteName]===1,null,J2.componentId);}else{E.mRouteToTemplateComponentPromise[J2.sRouteName].then(j.bind(null,false));}if(J2.fCLLevel===0||J2.fCLLevel===3){break;}}}function v1(i){var j;if(i){if(i.identity){i.identity.appStates[p]=J;}if(W||(R&&R.preset)){if(i.identity){W={identity:i.identity,followUpNeeded:true,mode:W?W.mode:0};u1(i.displayMode);}return;}if(i.identity&&r1(i.identity)){return;}j=i.mode;W={identity:i.identity,mode:j};u1(i.displayMode);}else{j=1;}W.followUpNeeded=W.identity&&j<0;E.oBusyHelper.setBusyReason("HashChange",!E.ghostapp);$.stop();if(j>=0){t1(j===1);}else if(!E.ghostapp){window.history.go(j);}}function w1(i,j){i.text=((i.headerTitle!==j)&&j)||"";if(Y&&Y.linkInfos.length>i.level){Y.adjustNavigationHierarchy();}}function x1(i,j){var J2=Object.create(null);if(E.oFlexibleColumnLayoutHandler){E.oFlexibleColumnLayoutHandler.adaptBreadCrumbUrlParameters(J2,i);}var K2={treeNode:i};var L2={treeNode:i,keys:R.keys.slice(0,i.level+1),appStates:J2};var M2;var N2=j1(L2).then(function(){var P2=s1(i,R.keys,J2);M2=G.oRouter.getURL(P2.route,P2.parameters);J2[p]=J;P2=s1(i,R.keys,J2);K2.fullLink=G.oRouter.getURL(P2.route,P2.parameters);});j.push(N2);K2.navigate=function(P2,Q2){if(E.oFlexibleColumnLayoutHandler&&!Q2){var R2;for(var S2=O[V.backTarget];S2.backTarget>0&&!R2;S2=O[S2.backTarget]){if(S2.identity.treeNode===i){R2=S2.identity;}}E.oFlexibleColumnLayoutHandler.adaptPreferredLayout(J2,i,R2);}E.oBusyHelper.setBusy(N2.then(function(){return J1(L2,false,P2);}));};var O2=i.getPath(2,L2.keys);K2.adaptBreadCrumbLink=function(P2){N2.then(function(){var U2=H.getInstance();var V2=U2.hrefForAppSpecificHash?U2.hrefForAppSpecificHash(M2):"#/"+M2;P2.setHref(V2);});var Q2=function(){w1(i,P2.getText());};if(!K2.bLinkAttached){K2.bLinkAttached=true;var R2=P2.getBindingInfo("text")||{};R2.events={change:Q2};}var S2=P2.getElementBinding();var T2=S2&&S2.getPath();if(T2===O2){Q2();}else{P2.bindElement({path:O2,canonicalRequest:!E.bCreateRequestsCanonical});}};return K2;}function y1(i,j){var J2={title:j.treeNode.headerTitle||"",icon:j.treeNode.titleIconUrl||"",subtitle:j.treeNode.text,intent:i+j.fullLink};return J2;}function z1(){var j=[];var J2=[M];var K2=E.oFlexibleColumnLayoutHandler&&E.oFlexibleColumnLayoutHandler.hasNavigationMenuSelfLink(R);for(var L2=K2?R.treeNode:E.mRoutingTree[R.treeNode.parentRoute];L2;L2=E.mRoutingTree[L2.parentRoute]){var M2=x1(L2,J2);j[L2.level]=M2;}var N2=Promise.all(J2);var O2=function(){E.oShellServicePromise.then(function(P2){P2.setHierarchy([]);N2.then(function(Q2){var R2=Q2[0];var S2=[];for(var i=j.length-1;i>=0;i--){S2.push(y1(R2,j[i]));}P2.setHierarchy(S2);});}).catch(function(){l.warning("No ShellService available");});};Y={linkInfos:j,adjustNavigationHierarchy:O2};O2();}function A1(){return Y.linkInfos;}function B1(i){var j=R;if(W&&W.identity&&!W.followUpNeeded){R=W.identity;}else{R=Object.create(null);var J2=i.getParameter("config");var K2=q(J2.name);R.treeNode=E.mRoutingTree[K2];var L2=i.getParameter("arguments");R.appStates=L2["?query"]||Object.create(null);R.keys=[""];for(var M2=R.treeNode;M2.level>0;M2=E.mRoutingTree[M2.parentRoute]){R.keys[M2.level]=M2.noKey?"":L2["keys"+M2.level];}}R.previousIdentity=j;R.componentsDisplayed=Object.create(null);R.componentsDisplayed[R.treeNode.sRouteName]=1;z1();}function C1(i,j){var J2=d1.getProcessFinished(true).then(function(){var K2={identity:{treeNode:R.treeNode,keys:R.keys,appStates:e(Object.create(null),R.appStates)},mode:1};if(Array.isArray(j)&&j.length<2){j=j[0];}if(j){K2.identity.appStates[i]=j;}else{delete K2.identity.appStates[i];}v1(K2);});E.oBusyHelper.setBusy(J2);return J2;}var D1;function E1(i,j,J2,K2,L2){if(!i||(Array.isArray(i)&&i.length===0)){return c2(j);}var M2=Array.isArray(i)?i:[i];var N2=0,O2;var P2=new Promise(function(R2,S2){var T2=function(){if(N2==M2.length){R2(O2);}else{var U2=M2[N2];var V2=O1(O2,U2,true,true);V2.then(function(W2){N2++;O2=W2;T2();});}};T2();});var Q2=P2.then(function(R2){R2.appStates=L2||Object.create(null);var S2;if(R2.treeNode.fCLLevel===0||R2.treeNode.fCLLevel===3){S2=j1(R2);}else{S2=E.oFlexibleColumnLayoutHandler.getAppStatesPromiseForNavigation(R,R2);}if(!j&&K2&&K2.bIsCreate&&K2.bIsDraft&&!K2.bIsDraftModified){D1={index:O.length,path:i.getPath(),identity:R2,displayMode:V1()};}return S2.then(function(){return J1(R2,j,J2);});});E.oBusyHelper.setBusy(Q2);return Q2;}function F1(j){if(!D1||D1.path!==j.getPath()){return null;}var J2;var K2=function(Q2,i){return Q2!==J2.identity.keys[i];};for(var i=D1.index+1;i<O.length;i++){J2=O[i];if(!J2.identity.treeNode||J2.identity.treeNode.level<D1.identity.treeNode.level||D1.identity.keys.some(K2)){return null;}}var L2=0;for(var M2=V;M2.iHashChangeCount!==D1.index;M2=O[M2.backTarget]){if(M2.iHashChangeCount<D1.index){return null;}L2--;}var N2=O[D1.index].identity;var O2={treeNode:N2.treeNode,keys:N2.keys,appStates:Object.create(null)};var P2=v1.bind(null,{identity:O2,mode:L2,displayMode:D1.displayMode});if(N2.treeNode.fCLLevel===0||N2.treeNode.fCLLevel===3){e(O2.appStates,N2.appStates);return Promise.resolve(P2);}return E.oFlexibleColumnLayoutHandler.getSpecialDraftCancelPromise(R,N2,O2.appStates).then(function(){return P2;});}function G1(i,J2){var K2=r.determineNavigationPath(i);var L2={keys:["",K2.key],appStates:Object.create(null)};var M2=J1.bind(null,L2,true,J2);if(R.treeNode.level===1){L2.treeNode=R.treeNode;e(L2.appStates,R.appStates);return Promise.resolve(M2);}var N2=o1(R.treeNode,2);var O2=N2.map(function(j){if(j.noKey){return Promise.resolve(true);}if(!j.isDraft){return Promise.resolve(R.keys[j.level]);}var Q2=j.getPath(2,R.keys);var R2=E.oApplicationProxy.getSiblingPromise(Q2);return R2.then(function(i){K2=r.determineNavigationPath(i,j.navigationProperty);return K2.key;},Function.prototype);});var P2=Promise.all(O2);return P2.then(function(Q2){var R2=E.mEntityTree[K2.entitySet];for(var j=0;Q2[j];j++){R2=N2[j];L2.keys.push(R2.noKey?"":Q2[j]);}L2.treeNode=R2;if(R2===R.treeNode){e(L2.appStates,R.appStates);return M2;}var S2=E.oFlexibleColumnLayoutHandler.getAppStatesPromiseForNavigation(R,L2);return S2.then(function(){return M2;});});}function H1(i,j){if((i&&i.treeNode)!==j.treeNode){return Promise.resolve(false);}if(E.oFlexibleColumnLayoutHandler&&!E.oFlexibleColumnLayoutHandler.areIdentitiesLayoutEquivalent(i,j)){return Promise.resolve(false);}var J2=true;var K2=i.treeNode.sRouteName;for(var L2=i.treeNode;L2.level>0;L2=E.mRoutingTree[L2.parentRoute]){var M2=L2.noKey||i.keys[L2.level]===j.keys[L2.level];if(!M2&&L2.noOData){return Promise.resolve(false);}J2=J2&&M2;if(L2.noOData){K2=L2.parentRoute;}}if(J2){return Promise.resolve(true);}var N2=E.mRoutingTree[K2];var O2=i.keys.slice(0,N2.level+1);var P2=j.keys.slice(0,N2.level+1);var Q2=N2.getPath(2,O2);var R2=N2.getPath(2,P2);return E.oApplicationProxy.areTwoKnownPathesIdentical(Q2,R2,N2.level===1);}function I1(i){var j=O[V.backTarget];var J2=-1;if(j&&(i.level===0||(E.oFlexibleColumnLayoutHandler&&i.fCLLevel===0))){for(;j.backTarget>0&&j.identity.treeNode&&j.identity.treeNode.level>i.level;J2--){j=O[j.backTarget];}}return j&&{candidateHash:j,candidateCount:J2};}function J1(i,j,J2){var K2=I1(i.treeNode);var L2=H1(K2&&K2.candidateHash.identity,i);var M2=L2.then(function(N2){var O2=N2?K2.candidateCount:(0+!!j);var P2={identity:i,mode:O2,displayMode:J2};v1(P2);});E.oBusyHelper.setBusy(M2);return M2;}function K1(){if(K){return c2(true);}var i=E.componentRegistry[R.treeNode.componentId];var j=i.utils.getTemplatePrivateModel();var J2=L1();j2({title:J2.dataLoadFailedTitle,text:J2.dataLoadFailedText,description:"",viewLevel:j.getProperty("/generic/viewLevel")});return Promise.resolve();}function L1(){return{dataLoadFailedTitle:E.getText("ST_ERROR"),dataLoadFailedText:E.getText("ST_GENERIC_ERROR_LOAD_DATA_TEXT")};}function M1(i,j,J2,K2){if(!j){return{treeNode:E.mRoutingTree.root,key:""};}var L2=x(j);var M2=(i.level&&i.entitySet===L2.entitySet)?i:i.children.indexOf(L2.entitySet)>=0&&E.mEntityTree[L2.entitySet];if(M2){return{treeNode:M2,key:L2.key};}if(J2){var N2=E.oAppComponent.getModel();var O2=N2.getMetaModel();var P2=O2.getODataEntitySet(L2.entitySet);var Q2=O2.getODataEntityType(P2.entityType);var R2;var S2=i.children.some(function(U2){M2=E.mEntityTree[U2];R2=M2.navigationProperty;if(!R2){return false;}var V2=O2.getODataAssociationEnd(Q2,R2);return!!V2&&V2.multiplicity.endsWith("1");});if(S2){return{treeNode:M2,navigationProperty:R2};}}if(K2&&i.level>0){var T2=E.mRoutingTree[i.parentRoute];return M1(T2,j,J2,true);}}function N1(i,j,J2,K2){if(K2.navigationProperty){return new Promise(function(M2,N2){var O2=J2.getModel();O2.createBindingContext(K2.navigationProperty,J2,null,function(P2){var Q2=P2&&N1(i,j,P2,{treeNode:K2.treeNode,key:r.determineNavigationPath(P2).key});if(Q2){Q2.then(M2,N2);}else{N2();}});});}var L2=j.slice(0,K2.treeNode.level);L2.push(K2.key);return Promise.resolve({treeNode:K2.treeNode,keys:L2});}function O1(i,j,J2,K2){var L2=(i&&i.treeNode)||(R&&R.treeNode)||E.mRoutingTree.root;var M2=(i&&i.keys)||(R&&R.keys)||[""];var N2=M1(L2,j,J2,K2);return N2?N1(L2,M2,j,N2):Promise.reject();}function P1(i,j,J2){var K2={treeNode:i,keys:J2||R.keys.slice(0,i.level+1),appStates:j};if(i.fCLLevel===0||i.fCLLevel===3){return j1(K2);}return E.oFlexibleColumnLayoutHandler.getAppStatesPromiseForNavigation(R,K2);}function Q1(i){var j=O1({treeNode:E.mRoutingTree.root},i,false,true);var J2=j.then(function(K2){K2.appStates=Object.create(null);var L2;if(K2.treeNode===R.treeNode){Object.assign(K2.appStates,R.appStates);L2={identity:K2,mode:1,displayMode:1};v1(L2);return null;}var M2=P1(K2.treeNode,K2.appStates);return M2.then(J1.bind(null,K2,true,1));});E.oBusyHelper.setBusy(J2);return J2;}function R1(i){var j;var J2=0;for(j=V;j.backTarget>0&&(!j.identity||!j.identity.treeNode||j.identity.treeNode.level>i);J2++){j=O[j.backTarget];}if(!L&&(J2===0||!j.identity.treeNode||j.identity.treeNode.level>i)){window.history.go(-J2-1);return;}var K2=-J2||1;var L2=p2(i);var M2={treeNode:L2,keys:R.keys.slice(0,L2.level+1),appStates:Object.create(null)};var N2=P1(M2.treeNode,M2.appStates).then(function(){if(K2<0&&(M2.treeNode.fCLLevel===1||M2.treeNode.fCLLevel===2)&&j.identity.treeNode===M2.treeNode){for(;j.backTarget>0&&!E.oFlexibleColumnLayoutHandler.areIdentitiesLayoutEquivalent(j.identity,M2);K2--){j=O[j.backTarget];if(j.identity.treeNode!==M2.treeNode){break;}}}var O2={identity:M2,mode:K2,displayMode:M2.treeNode.isDraft?6:1};v1(O2);});E.oBusyHelper.setBusy(N2);return N2;}var S1;function T1(i,j,J2,K2){var L2=E.mEntityTree[i];var M2=E.componentRegistry[L2.componentId];var N2;if(j){var O2=n.createEmptyAppState(E.oAppComponent);O2.setData(j);O2.save();N2=O2.getKey();}var P2=R?R.keys.slice(0,L2.level):[""];P2.push("-");K2=K2||Object.create(null);var Q2=P1(L2,K2,P2);var R2=Q2.then(function(){if(N2){K2[A]=N2;}var S2={treeNode:L2,keys:P2,appStates:K2};S1=J2;if(r1(S2)){var T2={componentsDisplayed:V.componentsDisplayed,isNonDraftCreate:true};return q2("-",T2,M2.oComponent);}else{var U2=!R||!!(M2&&M2.nonDraftCreateContext);return J1(S2,U2,4);}});E.oBusyHelper.setBusy(R2);return R2;}function U1(i){var j=O1(null,i,false,false);var J2=j.then(function(K2){K2.appStates=Object.create(null);e(K2.appStates,R.appStates);delete K2.appStates[A];var L2={identity:K2,mode:1};v1(L2);});E.oBusyHelper.setBusy(J2);return J2;}function V1(){var i=E.componentRegistry[R.treeNode.componentId];var j=i.utils.getTemplatePrivateModel();var J2=j.getProperty("/objectPage/displayMode")||0;return J2;}function W1(i,j,J2,K2,L2){var M2=R.keys.slice(0,i.level);M2.push(j?J2:"");var N2=Object.create(null);var O2=P1(i,N2,M2);var P2=O2.then(function(){var Q2={treeNode:i,keys:M2,appStates:N2};return J1(Q2,K2,L2);});E.oBusyHelper.setBusy(P2);return P2;}function X1(J2,K2,L2,M2,N2){var O2;var P2=true;for(var i=0;i<J2.children.length&&!O2;i++){var Q2=J2.children[i];var R2=E.mEntityTree[Q2];if(R2[J2.level?"navigationProperty":"sRouteName"]===K2){O2=R2.sRouteName;P2=!R2.noKey;}}var S2=!O2&&L2&&J2.embeddedComponents[L2];if(S2){for(var j=0;j<S2.pages.length&&!O2;j++){var T2=S2.pages[j];if(T2.navigationProperty===K2){O2=J2.sRouteName+"/"+L2+"/"+K2;P2=!(T2.routingSpec&&T2.routingSpec.noKey);}}}if(O2){var U2=E.mRoutingTree[O2];return W1(U2,P2,M2,N2,V1());}return Promise.reject();}function Y1(i,j,J2,K2){var L2=O1({treeNode:i},j,true,false);var M2=L2.then(function(N2){N2.appStates=Object.create(null);var O2=P1(N2.treeNode,N2.appStates,N2.keys);return O2.then(J1.bind(null,N2,K2,J2));});E.oBusyHelper.setBusy(M2);return M2;}function Z1(){return!!W;}function $1(i){l.info("Navigate back");if(V.backTarget&&N(o.getPreviousHash()||"")!==N(V.hash)){E.oBusyHelper.setBusyReason("HashChange",true);}V.LeaveByBack=!V.forwardingInfo;if(V.LeaveByBack){V.backSteps=i;}window.history.go(-i);}function _1(j,J2,K2,L2){var M2=E.oAppComponent.getObjectPageHeaderType()==="Dynamic"&&E.oAppComponent.getObjectPageVariantManagement()==="VendorLayer";var N2;var O2=new U(window.location.href);if(O2.mParams["sap-ui-layer"]){var P2=O2.mParams["sap-ui-layer"];for(var i=0;i<P2.length;i++){if(P2[i].toUpperCase()==="VENDOR"){N2=true;break;}}}j=N(j||"");l.info("Navigate to hash: "+j);if(j===V.hash){l.info("Navigation suppressed since hash is the current hash");return;}V.targetHash=j;if(V.backTarget&&N(o.getPreviousHash()||"")===j){G.navigateBack();return;}var Q2=R?R.treeNode.level:0;if(M2&&N2){if(!L2){if(!E.oFlexibleColumnLayoutHandler){d.clearVariantParameterInURL();}else{if(Q2>=K2){if(K2===1){d.clearVariantParameterInURL();}else if(K2===2){var R2;for(var S2 in E.componentRegistry){if(E.componentRegistry[S2].viewLevel===2){R2=E.componentRegistry[S2];break;}}var T2=R2.oController.byId("template::ObjectPage::ObjectPageVariant");d.clearVariantParameterInURL(T2);}}}}}E.oBusyHelper.setBusyReason("HashChange",true);V.LeaveByReplace=J2;if(J2){G.oHashChanger.replaceHash(j);}else{G.oHashChanger.setHash(j);}}function a2(i,j,J2,K2,L2,M2){var N2=j.then(function(O2){i=v(i,O2);if(L2){V.backwardingInfo={count:L2.count,index:L2.index,targetHash:N(i)};$1(L2.count);}else{_1(i,K2,J2,M2);}return i;});E.oBusyHelper.setBusy(N2);return N2;}function b2(i,j,J2){var K2=O[V.backTarget];return K2&&K2.hash&&N(K2.hash.split("?")[0])===N(j)&&{count:1,index:V.backTarget};}function c2(i){if(R.treeNode.level===0){return Promise.resolve();}var j={treeNode:E.mRoutingTree["root"],keys:[""],appStates:Object.create(null)};var J2=j1(j);var K2=J2.then(J1.bind(null,j,i));E.oBusyHelper.setBusy(K2);return K2;}function d2(j,J2){var K2=V.componentsDisplayed;var L2=function(N2){var O2=E.componentRegistry[N2.getId()];(O2.methods.presetDisplayMode||Function.prototype)(J2,K2[O2.route]===1);};for(var i=0;i<j.length;i++){var M2=j[i];M2.then(L2);}}function e2(i,j,J2,K2,L2){var M2={};var N2=E.oFlexibleColumnLayoutHandler&&E.oFlexibleColumnLayoutHandler.getFCLAppStatesPromise(i,M2);var O2=k1(i,M2,j);var P2=(N2?Promise.all([N2,O2]):O2).then(u.bind(null,M2));var Q2=b2(K2,j,J2);var R2=a2(j,P2,J2,K2,Q2,L2);E.oBusyHelper.setBusy(R2);return R2;}function f2(j,J2,K2,L2,M2){if(typeof j==="string"){var N2=j;var O2=N(N2);if(O2==="/"){return c2(K2);}var P2=O2.split("/");var Q2=P2.length-1;var R2=[];var S2;switch(Q2){case 1:S2=P2[1].split("(")[0];break;default:S2="";var T2="";for(var i=0;i<Q2;i++){var U2=P2[i+1];var V2=U2.indexOf("(");if(V2>0){U2=U2.substring(0,V2);}S2=S2+T2+U2;T2="/";}S2=S2.replace("---","/");}d2(R2,L2||0);return e2(S2,N2,Q2,K2,M2);}return E1(j,K2,L2);}function g2(i,j){V.componentsDisplayed[i]=j;var J2=E.mRoutingTree[i];var K2=J2.componentId;if(K2){var L2=E.componentRegistry[K2];var M2=L2.utils.getTemplatePrivateModel();M2.setProperty("/generic/isActive",j===1);}}function h2(i){var j,J2,K2,L2,M2,N2=null,O2,P2;if(i){j=i.entitySet;J2=i.text;N2=i.icon;P2=i.description;}if(j){O2=E.oAppComponent.getModel().getMetaModel();if(O2){K2=O2.getODataEntitySet(j);L2=O2.getODataEntityType(K2.entityType);M2=L2["com.sap.vocabularies.UI.v1.HeaderInfo"];}if(M2&&M2.TypeImageUrl&&M2.TypeImageUrl.String){N2=M2.TypeImageUrl.String;}}E.oTemplatePrivateGlobalModel.setProperty("/generic/messagePage",{text:J2,icon:N2,description:P2});if(E.oFlexibleColumnLayoutHandler){E.oFlexibleColumnLayoutHandler.displayMessagePage(i,V.componentsDisplayed);}else{var Q2=G.oRouter.getTargets();Q2.display("messagePage");for(var R2 in V.componentsDisplayed){g2(R2,5);}}m1(i);}function i2(){if(!f(X)){var j=null;for(var i=0;!j;i++){j=X[i];}X={};h2(j);}}function j2(i){if(G.oTemplateContract.oFlexibleColumnLayoutHandler){i.viewLevel=i.viewLevel||0;X[i.viewLevel]=i;var j=Promise.all([c1,G.oTemplateContract.oPagesDataLoadedObserver.getProcessFinished(true)]);j.then(i2);j.then(E.oBusyHelper.setBusyReason.bind(null,"HashChange",false));return;}h2(i);E.oBusyHelper.setBusyReason("HashChange",false);}function k2(){var i=[];var j=R.componentsDisplayed||V.componentsDisplayed;for(var J2 in E.componentRegistry){var K2=E.componentRegistry[J2];if(j[K2.route]===1){i.push(J2);}}return i;}function l2(){var i=[];for(var j in E.componentRegistry){i.push(j);}return i;}function m2(i){return R.keys.slice(0,i+1);}function n2(j){var J2="";var K2=V.hash;var L2=K2.split("/");var M2="";for(var i=0;i<=j;i++){J2=J2+M2+L2[i];M2="/";}return J2;}function o2(){var i=R.treeNode.componentId;var j=E.componentRegistry[i];var J2=!!j.nonDraftCreateContext;if(J2){var K2=Object.assign({},V);K2.isNonDraftCreate=J2;return K2;}return V;}function p2(i){var j=R.treeNode;for(;j.level>i;){j=E.mRoutingTree[j.parentRoute];}return j;}function q2(i,j,J2){var K2=J2.getId();var L2=E.componentRegistry[K2];var M2=m2(L2.viewLevel);var N2=L2.route;var O2=j.componentsDisplayed[N2];var P2=O2===1;var Q2=function(W2){var X2=J2.onActivate(W2,P2)||Promise.resolve();return Promise.all([X2,L2.viewRegistered]).then(function(){L2.aKeys=M2;});};V.componentsDisplayed[N2]=1;if(j.isNonDraftCreate&&i==="-"){var R2=E.mRoutingTree[N2];var S2=E.mRoutingTree[R2.parentRoute];var T2=S2.getPath(2,M2);var U2=E.oAppComponent.getModel();var V2=T2?new Promise(function(W2){var X2={canonicalRequest:!E.bCreateRequestsCanonical};U2.createBindingContext(T2,null,X2,W2);}):Promise.resolve();return V2.then(function(W2){var X2=W2?R2.navigationProperty:"/"+J2.getEntitySet();var Y2=R.appStates[A];var Z2=Y2?new Promise(function($2){var _2=n.getAppState(E.oAppComponent,Y2);_2.done($2);_2.fail($2.bind(null,null));}):Promise.resolve();return Z2.then(function($2){L2.nonDraftCreateContext=S1||L2.nonDraftCreateContext||b.createNonDraft(W2,X2,U2,$2&&$2.getData(),E.oApplicationProxy.mustRequireRequestsCanonical());S1=null;return Q2(L2.nonDraftCreateContext.getPath());});});}delete L2.nonDraftCreateContext;return Q2(i);}function r2(i,j,J2){return q2(i,j,J2).then(n1);}function s2(i,j,J2){var K2={};if(j||J2){var L2=i.level;for(var M2=0;M2<L2;M2++){K2[M2]=E.oPaginatorInfo[M2];}}E.oPaginatorInfo=K2;}function t2(i){return E.oApplicationProxy.getAlternativeContextPromise(i);}var u2=Object.create(null);function v2(i){if(u2[i.sRouteName]){return;}var j=G.oRouter.getViews();var J2=G.createHostView();u2[i.sRouteName]=J2;j.setView(i.sRouteName,J2);var K2=J2.byId("host");I2(K2,i.sRouteName);if(i.fCLLevel===1||i.fCLLevel===2){v2(E.mRoutingTree[i.parentRoute]);}}function w2(i){d1.startProcess();B1(i);v2(R.treeNode);if(E.oFlexibleColumnLayoutHandler){Z=E.oFlexibleColumnLayoutHandler.handleBeforeRouteMatched(R);}}function x2(){var i={isInitialNavigation:L,historicalEntries:[]};for(var j=V;j.iHashChangeCount>0;j=O[j.backTarget]){var J2=(j===V)?R:j.identity;var K2=J2.treeNode&&{sRouteName:J2.treeNode.sRouteName,keys:J2.keys,appStates:J2.appStates};i.historicalEntries.push(K2);}I.setData(i);I.save();var L2=R.appStates[p];if(L2===J||!(L2||V.backTarget||L)){return false;}v1({identity:{treeNode:R.treeNode,keys:R.keys,appStates:e(Object.create(null),R.appStates)},mode:1});return true;}function y2(){d1.stopProcess();if(W&&W.followUpNeeded&&W.identity&&!r1(W.identity)){v1();return;}E.oBusyHelper.setBusyReason("HashChange",false);var J2=R.treeNode.level;var K2=N(G.oHashChanger.getHash()||"");l.info("Route matched with hash "+K2);var L2;if(V.backwardingInfo){L2=V;L2.identity=R.previousIdentity;delete R.previousIdentity;O.push(L2);var M2=L2.iHashChangeCount+1;V={iHashChangeCount:M2,forwardingInfo:{bIsProgrammatic:true,bIsBack:true,iHashChangeCount:M2,targetHash:L2.backwardingInfo.targetHash,componentsDisplayed:L2.componentsDisplayed},backTarget:O[L2.backwardingInfo.index].backTarget,componentsDisplayed:Object.create(null)};}if(V.forwardingInfo&&V.forwardingInfo.targetHash&&V.forwardingInfo.targetHash!==K2){V.hash=K2;var N2=V.forwardingInfo.targetHash;delete V.forwardingInfo.targetHash;_1(N2,true);return;}var O2=false;for(var i=0;i<E.aStateChangers.length;i++){var P2=E.aStateChangers[i];if(P2.isStateChange(R.appStates)){O2=true;}}if(O2){W=null;V.hash=K2;if(!x2()){$.start();}return;}E.oTemplatePrivateGlobalModel.setProperty("/generic/routeLevel",J2);var Q2=V.forwardingInfo;delete V.forwardingInfo;if(!Q2){Q2={componentsDisplayed:V.componentsDisplayed,isNonDraftCreate:!R.treeNode.isDraft&&R.keys[R.treeNode.level]==="-"};var R2=V.iHashChangeCount;Q2.iHashChangeCount=R2+1;var S2=o.getDirection();if(W){Q2.bIsProgrammatic=!!W.identity;Q2.bIsBack=W.mode<0;if(Q2.bIsBack){V.backSteps=0-W.mode;}Q2.bIsForward=!Q2.bIsBack&&(S2===h.Forwards);V.LeaveByReplace=W.mode===1;}else{Q2.bIsProgrammatic=(K2===V.targetHash);Q2.bIsBack=!!(V.LeaveByBack||(!Q2.bIsProgrammatic&&(S2===h.Backwards)));Q2.bIsForward=!Q2.bIsBack&&(S2===h.Forwards);V.LeaveByReplace=Q2.bIsProgrammatic&&V.LeaveByReplace;if(!Q2.bIsProgrammatic&&R.previousIdentity&&R.previousIdentity.treeNode.level>0&&!R.previousIdentity.treeNode.isDraft){var T2=Q2.isNonDraftCreate||R.treeNode!==R.previousIdentity.treeNode;for(var j=1;!T2&&j<R.keys.length;j++){T2=R.keys[j]!==R.previousIdentity.keys[j];}if(T2){var U2=E.componentRegistry[R.previousIdentity.treeNode.componentId];var V2=U2.oComponent.getModel("ui");if(V2.getProperty("/editable")){U2.utils.cancelEdit();}}}}V.LeaveByBack=Q2.bIsBack;L2=V;L2.identity=R.previousIdentity;delete R.previousIdentity;O.push(L2);V={iHashChangeCount:Q2.iHashChangeCount,componentsDisplayed:Object.create(null)};if(L2.LeaveByReplace){V.backTarget=L2.backTarget;}else if(Q2.bIsBack){var W2=L2.backTarget;for(var X2=L2.backSteps||1;X2>0;X2--){W2=O[W2].backTarget;}V.backTarget=W2;}else{V.backTarget=R2;}}W=null;V.hash=K2;var Y2=function(_2){if(_2){E1(_2.context,true,_2.iDisplayMode);return;}if(x2()){return;}s2(R.treeNode,Q2.bIsProgrammatic,Q2.bIsBack);if(E.oFlexibleColumnLayoutHandler){c1=E.oFlexibleColumnLayoutHandler.handleRouteMatched(Q2);}else{var a3=E.mRouteToTemplateComponentPromise[R.treeNode.sRouteName];c1=a3.then(function(b3){return r2(Q2.isNonDraftCreate?"-":R.treeNode.getPath(2,R.keys),Q2,b3);});}E.oBusyHelper.setBusy(c1);c1.then($.start);};if(Q2.bIsBack){var Z2=p2(1);var $2=Z2&&Z2.getPath(2,R.keys);E.oBusyHelper.setBusy(t2($2).then(Y2));}else{Y2();}}function z2(){var i=Promise.all([Z,b1.then(function(){return E.oStatePreserversAvailablePromise;})]);var j=i.then(y2,E.oBusyHelper.setBusyReason.bind(null,"HashChange",false));E.oBusyHelper.setBusy(j);E2();}function A2(j){O.push(V);var J2;if(j){var K2=j.getData();L=K2.isInitialNavigation;for(var i=K2.historicalEntries.length;i>0;i--){var L2=K2.historicalEntries[i-1];J2={iHashChangeCount:O.length,backTarget:O.length-1};if(L2){J2.identity={treeNode:E.mRoutingTree[L2.sRouteName],keys:L2.keys,appStates:L2.appStates};}O.push(J2);}}else{J2={iHashChangeCount:1,backTarget:0,identity:R};O.push(J2);}_(J2);z2();}var B2=A2.bind(null,null);function C2(i){if(K&&!O.length){var j=R.appStates[p];var J2=j&&n.getAppState(E.oAppComponent,j);if(J2){J2.done(A2);J2.fail(B2);}else{B2();}return;}z2();}function D2(){R={appStates:Object.create(null),keys:[]};j2({title:E.getText("ST_ERROR"),text:E.getText("ST_GENERIC_UNKNOWN_NAVIGATION_TARGET"),description:""});E.oBusyHelper.setBusyReason("HashChange",false);}function E2(){var i;for(var j=R.treeNode;j;j=i){var J2=j.componentId&&E.componentRegistry[j.componentId];if(J2){var K2=J2.utils.getTemplatePrivateModel();K2.setProperty("/generic/currentActiveChildContext",j.selectedPath);}i=E.mRoutingTree[j.parentRoute];if(i){i.selectedPath=j.getPath(3,R.keys);}}}G.oRouter.attachBeforeRouteMatched(w2);G.oRouter.attachRouteMatched(C2);G.oRouter.attachBypassed(D2);var F2=[];function G2(i,j){G[i]=j;F2.push(i);}function H2(){F2.forEach(function(i){G[i]=$.makeQueuable(G[i]);});G.routerInitialized=Function.prototype;}function I2(i,j){b1=Promise.all([b1,E.mRouteToTemplateComponentPromise[j]]);var J2=E.mRoutingTree[j];var K2=J2.page.component.name;var L2=J2.entitySet;var M2=J2.level;var N2=-1;if(E.oFlexibleColumnLayoutHandler){N2=M2<E.oFlexibleColumnLayoutHandler.getMaxColumnCountInFCL()?M2:0;}var O2=N2<0?E.oNavigationObserver:E.aNavigationObservers[N2];var P2=new P();var Q2=N2<0?E.oHeaderLoadingObserver:E.aHeaderLoadingObservers[N2];Q2.addObserver(P2);var R2={};var S2={appComponent:E.oAppComponent,isLeaf:!J2.page.pages||!J2.page.pages.length,entitySet:L2,navigationProperty:J2.navigationProperty,componentData:{registryEntry:{oAppComponent:E.oAppComponent,componentCreateResolve:G.mRouteToComponentResolve[j],route:j,routeConfig:J2.page,viewLevel:J2.level,routingSpec:J2.page.routingSpec,oNavigationObserver:O2,oHeaderLoadingObserver:P2,preprocessorsData:R2}}};if(J2.page.component.settings){e(S2,J2.page.component.settings);}E.oAppComponent.runAsOwner(function(){var T2=sap.ui.core.Component.create({name:K2,settings:S2,handleValidation:true,manifest:true});T2.then(function(U2){J2.componentId=U2.getId();i.setComponent(U2);});});}G.routerInitialized=H2;G.concatPathAndAppStates=w;G.navigate=_1;G2("navigateBack",v1.bind(null,{mode:-1}));G.activateOneComponent=q2;G.afterActivation=n1;G.addUrlParameterInfoForRoute=k1;G.getApplicableStateForIdentityAddedPromise=j1;G.setVisibilityOfRoute=g2;G.getActiveComponents=k2;G.getAllComponents=l2;G.getRootComponentPromise=f1;G.getActivationInfo=o2;G.getCurrentKeys=m2;G.getCurrentHash=n2;G.getAppTitle=g1;G.getParsedShellHashFromFLP=h1;G2("navigateByExchangingQueryParam",C1);G2("navigateToSubContext",E1);G.getSwitchToSiblingPromise=G1;G.getSpecialDraftCancelPromise=F1;G.getCurrentIdentity=p1;G2("navigateToIdentity",J1);G2("navigateAfterActivation",Q1);G2("navigateUpAfterDeletion",R1);G2("navigateForNonDraftCreate",T1);G2("adaptUrlAfterNonDraftCreateSaved",U1);G2("navigateToChild",X1);G2("navigateFromNodeAccordingToContext",Y1);G.isNavigating=Z1;G.getLinksToUpperLayers=A1;G.setTextForTreeNode=w1;G2("navigationContextNotFound",K1);G.suspend=e1;G.restore=a1;t.testable(function(i){G.createHostView=i;},"setCreateHostView");var I2=t.testable(I2,"createTemplateComponent");return{navigateToRoot:$.makeQueuable(c2),navigateToContext:$.makeQueuable(f2),navigateToMessagePage:j2,navigateBack:G.navigateBack};}function z(i,j){var R=j.oAppComponent.getRouter();var E={oAppComponent:j.oAppComponent,oRouter:R,oHashChanger:R.getHashChanger(),oTemplateContract:j,mRouteToComponentResolve:{}};j.oNavigationControllerProxy=E;var G=new Promise(function(I){E.initialize=function(){R.initialize();I();E.routerInitialized();};E.fnInitializationResolve=I;});j.oBusyHelper.setBusy(G);e(i,y(j,E));e(E,i);r.startupRouter(E);}var D=B.extend("sap.suite.ui.generic.template.lib.NavigationController",{metadata:{library:"sap.suite.ui.generic.template"},constructor:function(i){B.apply(this,arguments);t.testableStatic(z,"NavigationController")(this,i);}});D._sChanges="Changes";return D;});
