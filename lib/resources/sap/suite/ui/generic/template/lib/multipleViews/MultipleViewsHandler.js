sap.ui.define(["sap/ui/base/Object","sap/ui/model/Filter","sap/suite/ui/generic/template/lib/multipleViews/MultipleTablesModeHelper","sap/suite/ui/generic/template/lib/multipleViews/SingleTableModeHelper","sap/ui/generic/app/navigation/service/SelectionVariant","sap/suite/ui/generic/template/lib/MetadataAnalyser","sap/suite/ui/generic/template/lib/FeLogger","sap/suite/ui/generic/template/lib/testableHelper","sap/base/util/extend","sap/base/security/encodeURL","sap/ui/comp/util/DateTimeUtil","sap/base/util/isEmptyObject"],function(B,F,M,S,a,b,c,t,e,d,D,f){"use strict";var l=new c("lib.multipleViews.MultipleViewsHandler").getLogger();function g(C,T,o){var s=Object.create(null);var h=T.oComponentUtils.getTemplatePrivateModel();var p=o.pathInTemplatePrivateModel+"/items";var P=o.pathInTemplatePrivateModel+"/selectedKey";h.setProperty(o.pathInTemplatePrivateModel,Object.create(null));h.setProperty(p,Object.create(null));var I=new(o.smartControl?S:M)(C,T,o);h.setProperty(o.pathInTemplatePrivateModel+"/mode",I.getMode());var k=T.oServices.oApplication.getBusyHelper().getBusyDelay();var m=C.getOwnerComponent().getModel();var n;var q;var r;function u(){if(q){var i=o.getSearchValue&&o.getSearchValue();var j=i?{search:i}:{};for(var _ in s){var a1=s[_];var b1=a1.getPath();a1.numberOfUpdates++;a1.updateStartFunction(a1.numberOfUpdates);m.read(b1+"/$count",{urlParameters:j,filters:a1.getFiltersForCount(),groupId:"updateMultipleViewsItemsCounts",success:a1.updateSuccessFunction.bind(null,a1.numberOfUpdates),error:a1.errorFunction.bind(null,a1.numberOfUpdates)});}}}function R(i,j){var _="";var a1=j["parameters"];if(!j||!j.entitySetName||!j.navPropertyName||a1.length<1){_="/"+i.name;return _;}var b1=o.smartFilterBar&&o.smartFilterBar.getAnalyticalParameters();if(b1&&b1.length>0){var c1=o.smartFilterBar&&o.smartFilterBar.getUiState({allFilters:false});var d1=c1?JSON.stringify(c1.getSelectionVariant()):"{}";var e1=new a(d1);var f1=[];a1.forEach(function(g1){b1.forEach(function(h1){if(h1&&(h1.name===g1)){var i1=h1.name;var j1=e1.getParameter(i1);if(h1.type==='Edm.DateTime'){j1=new Date(j1);j1=D.localToUtc(j1);j1=d(h1.control.getModel().formatValue(j1,h1.type));f1.push(i1+'='+j1);}else{f1.push(i1+'='+"'"+j1+"'");}}});});_='/'+j.entitySetName+'('+f1.join(',')+')/'+j.navPropertyName;}else{_="/"+i.name;l.error("SelectionParameters","There are no parameters to resolve");return _;}return _;}function G(i){var j;var _=i.getEntitySet();var a1=C.getOwnerComponent();if(o.smartFilterBar&&o.smartFilterBar.getConsiderAnalyticalParameters&&o.smartFilterBar.getConsiderAnalyticalParameters()){var b1=m.getMetaModel();var c1=b1.getODataEntitySet(_);var d1=a1.getAppComponent();var e1=b.getParametersByEntitySet(d1.getModel(),_);j=R(c1,e1);return j;}var f1=i.getTableBindingPath?i.getTableBindingPath():i.getChartBindingPath();j=f1?f1:"/"+_;var g1=a1.getComponentContainer();var h1=g1.getElementBinding();return h1?h1.getPath()+'/'+j:j;}function v(_,a1){var b1=m.getMetaModel();var c1=_.getEntitySet();var d1=b1.getODataEntitySet(c1);var e1=b1.getODataEntityType(d1.entityType);var f1=[],g1;var h1=a1.variantAnnotationPath;if(h1){var i1=e1[h1];if(!i1){return[];}if(!i1.SelectOptions&&i1.SelectionVariant){i1=i1.SelectionVariant;if(i1.Path){h1=i1.Path.split("@")[1];i1=h1&&e1[h1];}}if(i1.AnnotationPath){g1=i1.AnnotationPath.split("@")[1];i1=e1[g1];}for(var i in i1.SelectOptions){if(i1.SelectOptions[i].PropertyName){var j1=i1.SelectOptions[i].PropertyName.PropertyPath;for(var j in i1.SelectOptions[i].Ranges){var k1=i1.SelectOptions[i].Ranges[j].Sign;var l1=i1.SelectOptions[i].Ranges[j].Option;if(k1){l1.EnumMember=w(k1.EnumMember.replace("com.sap.vocabularies.UI.v1.SelectionRangeSignType/",""),l1.EnumMember.replace("com.sap.vocabularies.UI.v1.SelectionRangeOptionType/",""));}else{l1.EnumMember=l1.EnumMember.replace("com.sap.vocabularies.UI.v1.SelectionRangeOptionType/","");}var m1=i1.SelectOptions[i].Ranges[j].Low;var n1=i1.SelectOptions[i].Ranges[j].High;var o1=Object.keys(m1)[0];if(n1){var p1=Object.keys(n1)[0];f1.push(new F(j1,l1.EnumMember,m1[o1],n1[p1]));}else{f1.push(new F(j1,l1.EnumMember,m1[o1]));}}}}}return f1;}function w(i,j){var _;var a1=new Map([["EQ","NE"],["BT","NB"],["CP","NP"],["LE","GT"],["GE","LT"],["NE","EQ"],["NB","BT"],["NP","CP"],["GT","LE"],["LT","GE"]]);if(i==="I"){_=j;}else if(i==="E"){if(a1.has(j)){_=a1.get(j);}else{_=j;}}return _;}function H(i){for(var j in s){var _=s[j];if(_.smartControl.getEntitySet()===i){return true;}}return false;}function O(i,j){var _=i.filters.slice(0);var a1=y();i.filters=A(i.filters,a1,j,false);if(q){for(var b1 in s){var c1=s[b1];x(_,c1,j);}}}function x(i,j,_){j.getFiltersForCount=function(){return A(i,j,_,true);};}function A(i,j,_,a1){if(I.getFiltersAdaptedFromItem){i=I.getFiltersAdaptedFromItem(i,j,_,a1);}return i.concat(j.selectionVariantFilters);}function y(){return s[r];}function z(i,r){return I.formatMessageStrip(i,r);}function E(){return r;}function J(r){h.setProperty(P,r||n);}function K(){return I.getContentForIappState(r);}function L(i){var j;if(!i){return"";}if(i.state==="error"){return T.oCommonUtils.getText("SEG_BUTTON_ERROR",i.text);}if(i.state===""||i.state==="busy"){var _=sap.ui.core.format.NumberFormat.getIntegerInstance({groupingEnabled:true});j=_.format(i.count);}return T.oCommonUtils.getText("SEG_BUTTON_TEXT",[i.text,i.state==="busyLong"?"...":j]);}function N(i){r=I.getSelectedKeyAndRestoreFromIappState(i);if(s[r]){h.setProperty(P,r);}}function Q(){return s[r].templateSortOrder;}function U(i){var j=y();var _=T.oCommonUtils.isSmartTable(j.smartControl);if(i!==2){j.smartControl[_?"rebindTable":"rebindChart"]();}if(i>1){if(_){if(o.refreshModelOnTableRefresh){T.oCommonUtils.refreshModel(j.smartControl);}T.oCommonUtils.refreshSmartTable(j.smartControl);}else{}}}function V(i,j,_){var a1=Array.isArray(j);var b1=T.oComponentUtils.isComponentActive();if((a1&&j.length===0)||(_&&f(_))){return;}I.refreshOperation(i,j,_,r,a1,b1,U);}function W(){var i=y();return I.setActiveButtonState(i);}function X(){var i=y();return I.restoreActiveButtonState&&I.restoreActiveButtonState(i);}function Y(i,j,_){if(I.setControlVariant){I.setControlVariant(i,j,_);}}function Z(i,j,_,a1){return T.oCommonUtils.getCustomDataText(i).then(function(b1){_.text=b1;a1.text=b1;return{modelEntry:_,pathToTheItem:j};});}function $(i){h.setProperty(i.pathToTheItem,i.modelEntry);}(function(){t.testable(function(){return I;},"getImplementingHelper");t.testable(function(){return q;},"getShowCounts");t.testable(function(){return s[r];},"getCurrentViewMeta");var j=function(c1,i1,j1,k1){if(c1.numberOfUpdates!==j1){return;}var f1=p+"/"+c1.switchingKey;var g1=e({},h.getProperty(f1));if(!g1.state&&i1=="busy"){setTimeout(function(){if(h.getProperty(f1).state==="busy"){g1=e({},h.getProperty(f1));g1.state="busyLong";h.setProperty(f1,g1);}},k);}g1.state=i1;if(!i1){g1.count=k1;}h.setProperty(f1,g1);};var _=o.switchingControl.getItems();for(var i=0;i<_.length;i++){var a1=_[i];var b1=a1.getKey();if(i===0){n=b1;}var c1={smartControl:o.smartControl||o.getSmartControl(b1),switchingKey:b1};var d1=I.getCustomDataHost(c1.smartControl,a1);var e1=T.oCommonUtils.getElementCustomData(d1);var f1=p+"/"+c1.switchingKey;var g1=Object.create(null);g1.text=e1.text;g1.count=0;g1.state="";g1.facetId=o.sectionKey;Z(d1,f1,g1,c1).then($);c1.templateSortOrder=e1.TemplateSortOrder;c1.getPath=G.bind(null,c1.smartControl);c1.selectionVariantFilters=v(c1.smartControl,e1);c1.numberOfUpdates=0;c1.updateStartFunction=j.bind(null,c1,"busy");c1.updateSuccessFunction=j.bind(null,c1,"");c1.errorFunction=j.bind(null,c1,"error");s[b1]=c1;}if(I.init){I.init(s,V,y);}if(o.manifestSettings.showCounts===undefined){q=I.getDefaultShowCounts();}else{q=o.manifestSettings.showCounts;}J();r=h.getProperty(P);var h1=h.bindProperty(P);h1.attachChange(function(i1){var j1=i1.getSource().getValue();if(j1===r){return;}r=j1;if(I.onSelectedKeyChanged){I.onSelectedKeyChanged(j1);}var k1=o.isDataToBeShown();var l1=I.getRefreshMode(r);if(o.adaptRefreshRequestMode){l1=o.adaptRefreshRequestMode(l1);if(k1&&l1>0){U(l1);}else{var m1=y().smartControl;T.oCommonUtils.setEnabledToolbarButtons(m1);}}o.appStateChange();});})();return{updateCounts:u,refreshOperation:V,onRebindContentControl:O,formatMessageStrip:z,getSelectedKey:E,setSelectedKey:J,getContentForIappState:K,restoreFromIappState:N,formatItemTextForMultipleView:L,determineSortOrder:Q,setActiveButtonState:W,restoreActiveButtonState:X,setControlVariant:Y,hasEntitySet:H};}return B.extend("sap.suite.ui.generic.template.lib.multipleViews.MultipleViewsHandler",{constructor:function(C,T,o){e(this,g(C,T,o));}});});
