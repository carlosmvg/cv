/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)
        (c) Copyright 2009-2017 SAP SE. All rights reserved
    
 */
sap.ui.define(["sap/ui/model/Filter","sap/ui/core/format/NumberFormat","sap/fe/core/CommonUtils","sap/fe/macros/filter/FilterUtils","sap/base/Log","sap/fe/macros/DelegateUtil"],function(F,N,C,a,L,D){"use strict";function g(T,s){var E=T.data("targetCollectionName"),M=C.getAppComponent(T).getMetaModel(),S=M.getObject(E+"/@"+s),k=[],u="";if(S&&S.SelectOptions){u=S.Text;for(var i in S.SelectOptions){var v=S.SelectOptions[i];if(v&&v.PropertyName){var P=v.PropertyName.$PropertyPath;for(var j in v.Ranges){var R=v.Ranges[j];k.push(new F(P,R.Option.$EnumMember.split("/").pop(),R.Low,R.High));}}}}return{filters:k,text:u};}function b(T){var i=[],j=T.data("hiddenFilters");if(j&&Array.isArray(j.paths)){j.paths.forEach(function(P){var s=g(T,P.annotationPath);i=i.concat(s.filters);});}return i;}function c(T){var i=[],Q=p(T);if(Q){i=i.concat(g(T,Q).filters);}return i;}function d(T){return c(T).concat(b(T));}function e(T){var s=T.getQuickFilter();if(s){var S=s.getItems();if(S.length>0){var k=S[0].getKey();s.setSelectedKey(k);T.data("quickFilterKey",k);}}}function f(T,E,H){var B=T.getRowsBindingInfo();if(B){if(!B.events){B.events={};}if(!B.events[E]){B.events[E]=H;}else{var O=B.events[E];B.events[E]=function(){H.apply(this,arguments);O.apply(this,arguments);};}}}function h(T,P,i){var B=T.getRowsBindingInfo(),j=T.getModel(),k,s,u=i.batchGroupId||"",v=n(T),x=Array.isArray(i.additionalFilters)?i.additionalFilters:[];x=x.concat(v.filters);s=new F({filters:x,and:true});k=j.bindList((P?P.getPath()+"/":"")+B.path,T.getBindingContext(),null,s,{$count:true,$$groupId:u||"$auto",$search:v.search});return k.requestContexts(0,1).then(function(y){var z=y&&y.length?y[0].getBinding().getLength():0;k.destroy();return z;});}function l(T,P){var s=p(T);if(s){var S=T.getQuickFilter();if(S.data("showCounts")==="true"){var i=S.getItems(),B=[],I=[],A=[];A=A.concat(b(T));for(var k in i){var j=i[k].getKey(),u=g(T,j);I.push(u.text);i[k].setText(I[k]+" (...)");B.push(h(T,P,{batchGroupId:j===p(T)?S.data("batchGroupId"):"$auto",additionalFilters:A.concat(u.filters)}));}Promise.all(B).then(function(v){for(var k in v){i[k].setText(I[k]+" ("+m(v[k])+")");}}).catch(function(E){L.error("Error while retrieving the binding promises",E);});}}}function m(i){var j=N.getIntegerInstance({groupingEnabled:true});return j.format(i);}function n(T){return a.getFilterInfo(T.getFilter());}function o(T){var P=T.getP13nMode();if(P&&P.indexOf("Filter")>-1){var i=D.getCustomData(T,"sap_fe_TableDelegate_propertyInfoMap"),j=a.getFilterInfo(T,i);if(j&&j.filters){return j.filters;}}return[];}function p(T){return T.data("quickFilterKey");}function n(T){return a.getFilterInfo(T.getFilter());}function q(T){var i=n(T);return{filters:i.filters.concat(d(T),o(T)),search:i.search};}function w(T){return _(T).promise;}function r(T){var B=_(T);if(B.resolve){B.resolve(T);T.data("boundPromiseResolve",null);}}function _(T){if(!T.data("boundPromise")){var R;T.data("boundPromise",new Promise(function(i){R=i;}));if(T.isBound()){R(T);}else{T.data("boundPromiseResolve",R);}}return{promise:T.data("boundPromise"),resolve:T.data("boundPromiseResolve")};}var t={addEventToBindingInfo:f,getCountFormatted:m,getFiltersInfoforSV:g,getTableFilters:d,getQuickFilters:c,handleQuickFilterCounts:l,initializeQuickFilterKey:e,getQuickFilterKey:p,getListBindingForCount:h,getFilterInfo:n,getP13nFilters:o,getAllFilterInfo:q,whenBound:w,onTableBound:r};return t;});
