/*
 * ! SAP UI development toolkit for HTML5 (SAPUI5)
        (c) Copyright 2009-2017 SAP SE. All rights reserved
    
 */
sap.ui.define(["sap/ui/mdc/link/Panel","sap/ui/mdc/link/PanelItem","sap/ui/mdc/LinkDelegate","sap/ui/mdc/link/LinkItem","sap/ui/mdc/link/Factory","sap/ui/mdc/link/Log","sap/base/Log","sap/ui/core/util/XMLPreprocessor","sap/ui/core/XMLTemplateProcessor","sap/ui/core/Fragment","sap/fe/macros/field/FieldHelper","sap/base/util/isPlainObject","sap/ui/mdc/link/SemanticObjectMapping","sap/ui/mdc/link/SemanticObjectMappingItem","sap/ui/mdc/link/SemanticObjectUnavailableAction","sap/fe/core/CommonUtils","sap/base/util/merge","sap/fe/navigation/SelectionVariant","sap/fe/core/CommonUtils","sap/ui/model/json/JSONModel"],function(P,a,L,b,F,c,S,X,d,e,f,g,h,j,k,C,m,l,o,J){"use strict";var p=Object.assign({},L);p._getEntityType=function(i,M){if(M){return M.createBindingContext(i.entityType);}};p._getSemanticsModel=function(i,M){if(M){var s=new J(i);return s;}};p._getDataField=function(i,M){return M.createBindingContext(i.dataField);};p._getContact=function(i,M){return M.createBindingContext(i.contact);};p.fnTemplateFragment=function(s){var t=this;var i=d.loadTemplate(s,"fragment");var n=this._getSemanticsModel(this.payLoad,this.oMetaModel);var q={};if(this.payLoad.entityType&&this._getEntityType(this.payLoad,this.oMetaModel)){q.bindingContexts={"entityType":this._getEntityType(this.payLoad,this.oMetaModel),"semantic":n.createBindingContext("/")};q.models={"entityType":this.oMetaModel,"semantic":n};}else if(this.payLoad.dataField&&this._getDataField(this.payLoad,this.oMetaModel)){q.bindingContexts={"dataField":this._getDataField(this.payLoad,this.oMetaModel),"semantic":n.createBindingContext("/")};q.models={"dataField":this.oMetaModel,"semantic":n};}else if(this.payLoad.contact&&this._getContact(this.payLoad,this.oMetaModel)){q.bindingContexts={"contact":this._getContact(this.payLoad,this.oMetaModel)};q.models={"contact":this.oMetaModel};}return Promise.resolve(X.process(i,{name:s},q)).then(function(i){return e.load({definition:i,controller:t});});};p.onPressTitleLink=function(E){if(E.getParameter("target")!=="_blank"){var H=E.getSource().getHref();var u=F.getService("URLParsing");var t=E.getSource();var H=t.getHref();var n=E.getSource().getCustomData()[0].getValue();for(var i=0;i<n.length;i++){if(n[i].key===H.split("#")[1]){t.setHref(n[i].href);break;}}H=t.getHref();var v=sap.ui.fl.Utils.getViewForControl(t);var A=o.getAppComponent(v);var q=v.getController();var r=q&&q.getView(),B=r&&r.getBindingContext();if(!B){B=t.getBindingContext();}E.preventDefault();this.beforeNavigationCallback(E).then(function(N){if(N){return q.editFlow.getProgrammingModel(B).then(function(s){var w=u.parseShellHash(H);A.getNavigationService().navigate(w.semanticObject,w.action,w.params,null,null,null,o.isStickyEditMode(r,s));});}}).catch(function(s){c.error("Error while resolving field value",s);});}};p.fetchAdditionalContent=function(i,B,n){this.oControl=n;this.payLoad=i;if(B){this.oMetaModel=B.getModel().getMetaModel();return this.fnTemplateFragment("sap.fe.macros.field.QuickViewLinkDelegate").then(function(q){return[q];});}return Promise.resolve([]);};p.fetchLinkItems=function(i,B,I){if(B&&p._getSemanticObjects(i)){var n=B.getObject();var q=[];if(I){I.initialize(p._getSemanticObjects(i));q.forEach(function(r){I.addIntent(c.IntentType.API,{text:r.getText(),intent:r.getHref()});});}var s=p._calculateSemanticAttributes(n,i,I);return p._retrieveNavigationTargets("",s,i,I).then(function(r,O){return r;});}else{return Promise.resolve([]);}};p.modifyLinkItems=function(i,B,n){if(n.length!==0){var q=n[0].getParent();var v=sap.ui.fl.Utils.getViewForControl(q);var A=C.getAppComponent(v);var r=q.getBindingContext();var s;var t;return new Promise(function(u){var N=A.getNavigationService();t=A.getShellServices();if(!t.hasUShell()){S.error("QuickViewLinkDelegate: Service 'URLParsing' could not be obtained");return Promise.reject();}if(v.getAggregation("content")[0]&&v.getAggregation("content")[0].getBindingContext()){var w=v.getAggregation("content")[0].getBindingContext().getObject();var M=m({},w,r.getObject());s=N.mixAttributesAndSelectionVariant(M,new l());}else{var x=v.getController();var y=x.filterBarConditions;s=p._getMergedContext(r,y,N);}if(v.getViewData().entitySet&&s){var z=N.constructContextUrl(v.getViewData().entitySet,v.getModel());s.setFilterContextUrl(z);}return N.getAppStateKeyAndUrlParameters(s.toJSONString()).then(function(D,E){var G=E;i.aSemanticLinks=[];var H,I;u(Promise.all(n.map(function(K){return t.expandCompactHash(K.getHref()).then(function(O){H=t.parseShellHash(O);I={target:{semanticObject:H.semanticObject,action:H.action},params:Object.assign(D,H.params),appStateKey:G};delete I.params["sap-xapp-state"];K.setHref("#"+t.constructShellHash(I));i.aSemanticLinks.push(K.getHref());return K;});})));});}).catch(function(E){c.error("Error while getting the navigation service",E);});}else{return Promise.resolve(n);}};p.beforeNavigationCallback=function(i,E){return Promise.resolve(true);};p._getMergedContext=function(i,n,N){var q,s;q=o.addExternalStateFiltersToSelectionVariant(new l(),n);s=N.mixAttributesAndSelectionVariant(i.getObject(),q.toJSONString());return s;};p._calculateSemanticAttributes=function(i,n,I){var s=p._getSemanticObjects(n);var q=p._convertSemanticObjectMapping(p._getSemanticObjectMappings(n));if(!s.length){s.push("");}var r={};s.forEach(function(t){if(I){I.addContextObject(t,i);}r[t]={};for(var A in i){var u=null,T=null;if(I){u=I.getSemanticObjectAttribute(t,A);if(!u){u=I.createAttributeStructure();I.addSemanticObjectAttribute(t,A,u);}}if(i[A]===undefined||i[A]===null){if(u){u.transformations.push({value:undefined,description:"\u2139 Undefined and null values have been removed in SimpleLinkDelegate."});}continue;}if(g(i[A])){if(u){u.transformations.push({value:undefined,description:"\u2139 Plain objects has been removed in SimpleLinkDelegate."});}continue;}var v=q&&q[t]&&q[t][A]?q[t][A]:A;if(u&&A!==v){T={value:undefined,description:"\u2139 The attribute "+A+" has been renamed to "+v+" in SimpleLinkDelegate.",reason:"\ud83d\udd34 A com.sap.vocabularies.Common.v1.SemanticObjectMapping annotation is defined for semantic object "+t+" with source attribute "+A+" and target attribute "+v+". You can modify the annotation if the mapping result is not what you expected."};}if(r[t][v]){S.error("SimpleLinkDelegate: The attribute "+A+" can not be renamed to the attribute "+v+" due to a clash situation. This can lead to wrong navigation later on.");}r[t][v]=i[A];if(u){if(T){u.transformations.push(T);var w=I.createAttributeStructure();w.transformations.push({value:i[A],description:"\u2139 The attribute "+v+" with the value "+i[A]+" has been added due to a mapping rule regarding the attribute "+A+" in SimpleLinkDelegate."});I.addSemanticObjectAttribute(t,v,w);}}}});return r;};p._retrieveNavigationTargets=function(A,s,i,I){if(!i.semanticObjects){return new Promise(function(n){n([]);});}var t=this;var q=i.semanticObjects;var r=i.sourceControl;var N={ownNavigation:undefined,availableActions:[]};return sap.ui.getCore().loadLibrary("sap.ui.fl",{async:true}).then(function(){return new Promise(function(u){sap.ui.require(["sap/ui/fl/Utils"],function(U){var v=U.getAppComponentForControl(t.oControl).getShellServices();if(!v.hasUShell()){S.error("SimpleLinkDelegate: Service 'CrossApplicationNavigation' or 'URLParsing' could not be obtained");return u(N.availableActions,N.ownNavigation);}var w=sap.ui.getCore().byId(r);var x=U.getAppComponentForControl(w);var y=q.map(function(n){return[{semanticObject:n,params:s?s[n]:undefined,appStateKey:A,ui5Component:x,sortResultsBy:"text"}];});return new Promise(function(){return v.getLinks(y).then(function(z){if(!z||!z.length){return u(N.availableActions,N.ownNavigation);}var B=p._getSemanticObjectUnavailableActions(i);var D=p._convertSemanticObjectUnavailableAction(B);var E=v.hrefForExternal();if(E&&E.indexOf("?")!==-1){E=E.split("?")[0];}if(E){E+="?";}var G=function(K,M){return(!!D&&!!D[K]&&D[K].indexOf(M)>-1);};var H=function(K){var M=v.parseShellHash(K.intent);if(G(M.semanticObject,M.action)){return;}var O=v.hrefForExternal({target:{shellHash:K.intent}},x);if(K.intent&&K.intent.indexOf(E)===0){N.ownNavigation=new b({href:O,text:K.text});return;}var Q=new b({key:M.semanticObject&&M.action?M.semanticObject+"-"+M.action:undefined,text:K.text,description:undefined,href:O,icon:undefined,initiallyVisible:K.tags&&K.tags.indexOf("superiorAction")>-1});N.availableActions.push(Q);if(I){I.addSemanticObjectIntent(M.semanticObject,{intent:Q.getHref(),text:Q.getText()});}};for(var n=0;n<q.length;n++){z[n][0].forEach(H);}return u(N.availableActions,N.ownNavigation);},function(){S.error("SimpleLinkDelegate: '_retrieveNavigationTargets' failed executing getLinks method");return u(N.availableActions,N.ownNavigation);});}).catch();});});});};p._getSemanticObjects=function(i){return i.semanticObjects?i.semanticObjects:[];};p._getSemanticObjectUnavailableActions=function(i){var s=[];if(i.semanticObjectUnavailableActions){i.semanticObjectUnavailableActions.forEach(function(n){s.push(new k({semanticObject:n.semanticObject,actions:n.actions}));});}return s;};p._getSemanticObjectMappings=function(i){var s=[];var n=[];if(i.semanticObjectMappings){i.semanticObjectMappings.forEach(function(q){n=[];if(q.items){q.items.forEach(function(r){n.push(new j({key:r.key,value:r.value}));});}s.push(new h({semanticObject:q.semanticObject,items:n}));});}return s;};p._convertSemanticObjectMapping=function(s){if(!s.length){return undefined;}var i={};s.forEach(function(n){if(!n.getSemanticObject()){throw Error("SimpleLinkDelegate: 'semanticObject' property with value '"+n.getSemanticObject()+"' is not valid");}i[n.getSemanticObject()]=n.getItems().reduce(function(M,I){M[I.getKey()]=I.getValue();return M;},{});});return i;};p._convertSemanticObjectUnavailableAction=function(s){if(!s.length){return undefined;}var i={};s.forEach(function(n){if(!n.getSemanticObject()){throw Error("SimpleLinkDelegate: 'semanticObject' property with value '"+n.getSemanticObject()+"' is not valid");}i[n.getSemanticObject()]=n.getActions();});return i;};return p;},true);
