/*
 * ! SAP UI development toolkit for HTML5 (SAPUI5)
        (c) Copyright 2009-2017 SAP SE. All rights reserved
    
 */
sap.ui.define(["sap/ui/mdc/TableDelegate","sap/ui/core/XMLTemplateProcessor","sap/ui/core/util/XMLPreprocessor","sap/ui/core/Fragment","sap/ui/model/json/JSONModel","sap/fe/macros/CommonHelper","sap/fe/core/helpers/StableIdHelper","sap/fe/macros/field/FieldHelper","sap/fe/macros/table/TableHelper","sap/fe/macros/table/Utils","sap/fe/core/CommonUtils","sap/ui/mdc/Table","sap/fe/macros/DelegateUtil","sap/ui/model/Filter","sap/base/Log","sap/ui/mdc/odata/v4/TypeUtil","sap/fe/macros/FilterBarDelegate"],function(T,X,a,F,J,C,S,b,c,d,e,M,D,f,L,g,h){"use strict";var i="sap_fe_TableDelegate_propertyInfoMap";var O=Object.assign({},T);function _(v){return C.parseCustomData(D.getCustomData(v,"columns"));}function j(P){return P&&P.metadataPath.includes("@com.sap.vocabularies.UI.v1.LineItem");}function k(P,v,w){var x=v?P.lastIndexOf("/"):P.indexOf("/");if(x===-1){return P;}return w?P.substring(x+1,P.length):P.substring(0,x);}function l(N,v){var w;if(v){switch(v.$Type){case"com.sap.vocabularies.UI.v1.DataFieldForAction":case"com.sap.vocabularies.UI.v1.DataFieldForIntentBasedNavigation":w=undefined;break;case"com.sap.vocabularies.UI.v1.DataField":case"com.sap.vocabularies.UI.v1.DataFieldWithNavigationPath":case"com.sap.vocabularies.UI.v1.DataFieldWithUrl":w=N.getProperty("Value/$Path/$Type");break;case"com.sap.vocabularies.UI.v1.DataFieldForAnnotation":var A=N.getProperty("Target/$AnnotationPath");if(A.indexOf("com.sap.vocabularies.UI.v1.FieldGroup")>-1){w=undefined;}else if(A.indexOf("com.sap.vocabularies.Communication.v1.Contact")>-1){w=N.getProperty("Target/$AnnotationPath/fn/$Path/$Type");}else if(A.indexOf("com.sap.vocabularies.UI.v1.DataPoint")>-1){w=N.getProperty("Value/$Path/$Type");}break;}}return w;}function m(B,v){var A=v.annotationPath,w=B.getModel(),x=w.getObject(v.annotationPath),N=w.createBindingContext(A),y=x.$kind==="Property"||x.$Type==="com.sap.vocabularies.UI.v1.DataField";if(x&&(x.$Type==="com.sap.vocabularies.UI.v1.DataFieldForAction"||x.$Type==="com.sap.vocabularies.UI.v1.DataFieldForIntentBasedNavigation")){y=false;}var z=C.getLabel(N),E=null,P=C.getIdentifyingName(N),G=k(P,true),I=G!=P,H=I?C.getLabel(B,G):null,K=C.isPropertyFilterable(P,{context:N},x),Q=(N.getProperty("$kind")&&N.getProperty("$Type"))||l(N,x),R=Q&&N.getProperty("@com.sap.vocabularies.UI.v1.Hidden")===true,U=Q&&Q.indexOf("Edm.")!==0,V=D.isTypeFilterable(Q)?g.getTypeConfig(Q):undefined;return{name:v.name,path:P,metadataPath:A,groupLabel:H,group:I?G:null,label:z,description:E||z,maxLength:N.$MaxLength,precision:N.$Precision,scale:N.$Scale,type:Q,typeConfig:V,filterable:K,sortable:y,visible:!R&&!U};}function n(v){return{name:v.name,path:v.name,groupLabel:null,group:null,label:v.header,description:v.header,maxLength:undefined,precision:undefined,scale:undefined,type:"Edm.String",filterable:false,sortable:false,visible:true};}function o(K){return function(P){return P.name===K;};}function p(v,B,w){var x=w.createBindingContext(B);var y=[];return Promise.all([_(v),D.fetchAnnotationsForEntity(B,w)]).then(function(R){if(!R[0]&&!R[1]){return Promise.resolve([]);}var z=R[0],E=R[1],A=E["@Org.OData.Capabilities.V1.SortRestrictions"]||{},N=(A["NonSortableProperties"]||[]).map(function(G){return G["$PropertyPath"];}),P;z.forEach(function(G){switch(G.type){case"Annotation":P=m(x,G);P.sortable=P.sortable&&N.indexOf(P.name)===-1;break;case"Default":P=n(G);P.label=D._catchTranslationModel(P.label,v);break;default:throw new Error("unhandled switch case "+G.type);}y.push(P);});return y;});}function q(v,w){if(v instanceof window.Element){return;}D.setCustomData(v,i,w);}function r(v){if(v instanceof window.Element){return null;}return D.getCustomData(v,i);}function s(v,E,w){var x=r(v);if(x){return Promise.resolve(x);}return p(v,E,w).then(function(x){x=x&&x.filter(function(P){return P.visible;});q(v,x);return x;});}function t(v,B){var N="",w=d.getFilterInfo(v),x=B.path.substr(1),R=v.getModel("sap.fe.i18n");if(w.search||w.filter){N="T_OP_TABLE_NO_DATA_TEXT_WITH_FILTER";}else{N="T_OP_TABLE_NO_DATA_TEXT";}R&&R.getResourceBundle().then(function(y){v.setNoDataText(e.getTranslatedText(N,y,null,x));});return;}O.rebindTable=function(v,B){if(!v.data("tableHidden")){var w=v.getModel("localUI");var x=v.getId().split("--")[1];if(w){w.setProperty("/$contexts/"+x+"/deleteEnabled",false);w.setProperty("/$contexts/"+x+"/numberOfSelectedContexts",0);w.setProperty("/$contexts/"+x+"/selectedContexts",[]);w.setProperty("/$contexts/"+x+"/deletableContexts",[]);}T.rebindTable(v,B);d.onTableBound(v);t(v,B);}};O.fetchProperties=function(v){return D.fetchModel(v).then(function(w){if(!w){return[];}return s(v,D.getCustomData(v,"targetCollectionName"),w.getMetaModel());});};O.updateBindingInfo=function(v,w,B){if(v.getRowBinding()){B.suspended=false;}else if(!v.data("tableHidden")&&d.getQuickFilterKey(v)&&B){var H=function(){d.handleQuickFilterCounts(v,v.getBindingContext());};d.addEventToBindingInfo(v,"dataRequested",H);}var x;var y=d.getAllFilterInfo(v);if(y.filters.length>0){x=new f({filters:y.filters,and:true});}B.filters=x;if(y.search){B.parameters.$search=y.search;}else{delete B.parameters.$search;}};function u(v,H,w){var x=new J(v),P={bindingContexts:{"column":x.createBindingContext("/")},models:{"column":x}};return D.templateControlFragment("sap.fe.macros.table.CustomColumn",P,H,w.targets==="xmlTree").then(function(I){x.destroy();return I;});}O.addItem=function(P,v,w){var x=w.appComponent&&w.appComponent.getModel().getMetaModel(),y=w.modifier,I=y.targets==="xmlTree",z=y.getId(v),A=(!I&&w.view&&w.view.getController())||undefined,B,G,V,E,H,K,N,Q,R=_(v);H=R.find(function(W){return W.name===P;});if(!H){L.error(P+" not found while adding column");return Promise.resolve(null);}if(H.type==="Default"){return u(H,A,y);}function U(W){return W&&W.indexOf(">/")>-1?"{"+W+"}":W;}if(!x){return Promise.resolve(null);}B=D.getCustomData(v,"targetCollectionName");G=D.getCustomData(v,"requestGroupId")||undefined;E=x.createBindingContext(B);return s(v,B,x).then(function(W){N=W.find(o(P));K=x.createBindingContext(N.metadataPath);Q={sPropertyName:P,sBindingPath:B,sValueHelpType:"TableValueHelp",oControl:v,oMetaModel:x,oModifier:y};V=Promise.all([D.isValueHelpRequired(Q),D.doesValueHelpExist(Q)]).then(function($){var a1=$[0],b1=$[1];if(a1&&!b1){return Y("sap.fe.macros.table.ValueHelp");}return Promise.resolve();});function Y($){var a1=new J({id:z,requestGroupId:G}),b1={bindingContexts:{"collection":E,"item":K,"this":a1.createBindingContext("/")},models:{"this":a1,"collection":x,"item":x}};return D.templateControlFragment($,b1,undefined,y.targets==="xmlTree").then(function(V){if(V){y.insertAggregation(v,"dependents",V,0);}}).catch(function(c1){L.error("ValueHelp not loaded : "+c1.message);return Promise.resolve(null);}).finally(function(){a1.destroy();});}function Z(N,$){var a1=j(N)?"sap.fe.macros.table.Column":"sap.fe.macros.table.ColumnProperty",b1=new J({editMode:U(D.getCustomData(v,"editModePropertyBinding")),onCallAction:D.getCustomData(v,"onCallAction"),tableType:D.getCustomData(v,"tableType"),onChange:D.getCustomData(v,"onChange"),parentControl:"Table",onDataFieldForIBN:D.getCustomData(v,"onDataFieldForIBN"),id:z,navigationPropertyPath:P,columnInfo:H}),c1={bindingContexts:{"collection":E,"dataField":K,"this":b1.createBindingContext("/"),"column":b1.createBindingContext("/columnInfo")},models:{"this":b1,"collection":x,"dataField":x,"column":b1}};return D.templateControlFragment(a1,c1,$,y.targets==="xmlTree").finally(function(){b1.destroy();});}return V.then(Z.bind(this,N,A));});};O.getFilterDelegate=function(){return{addFilterItem:function(P,v){return h.addP13nItem(P,v);}};};O.getTypeUtil=function(P){return g;};return O;},false);
