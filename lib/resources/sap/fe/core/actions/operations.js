/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)
        (c) Copyright 2009-2020 SAP SE. All rights reserved
    
 */
sap.ui.define(["sap/m/MessageBox","sap/m/Dialog","sap/ui/model/json/JSONModel","sap/ui/core/XMLTemplateProcessor","sap/ui/core/util/XMLPreprocessor","sap/ui/core/Fragment","sap/fe/core/actions/messageHandling","sap/fe/core/BusyLocker","sap/fe/core/helpers/SideEffectsUtil","sap/fe/core/helpers/StableIdHelper","sap/fe/core/CommonUtils","sap/base/Log","sap/fe/core/library"],function(M,D,J,X,a,F,m,B,S,b,C,L,c){"use strict";var d=c.Constants;function e(A,i,j,P){if(!i||i.length===0){return Promise.reject("Bound actions always requires at least one context");}P=P||{};if(Array.isArray(i)){P.bReturnAsArray=true;}else{i=[i];}var q=j.getMetaModel(),r=q.getMetaPath(i[0].getPath())+"/"+A,t=q.createBindingContext(r+"/@$ui5.overload/0");P.aContexts=i;P.isCriticalAction=l(q,r);return g(A,j,t,P);}function f(A,i,P){if(!i){return Promise.reject("Action expects a model/context for execution");}var j=i.getMetaModel(),q=i.bindContext("/"+A).getPath(),r=j.createBindingContext("/"+j.createBindingContext(q).getObject("$Action")+"/0");P.isCriticalAction=l(j,q+"/@$ui5.overload");return g(A,i,r,P);}function g(A,i,j,P){return new Promise(function(r,q){P=P||{};var t=P.actionParameters||[],u={},v,w,x=P.label,y=P.showActionParameterDialog,z=P.aContexts,I=P.bIsCreateAction,E=P.isCriticalAction;if(!j){q("Action not found");}if(y||t.length>0){t=p(j,t);if(!t||t.length===0){y=false;}}if(y){v=s;}else if(E){v=h;}u={fnOnSubmitted:P.onSubmitted,fnOnResponse:P.onResponse,actionName:A,model:i,aActionParameters:t,ownerComponent:P.ownerComponent,bGetBoundContext:P.bGetBoundContext};if(j.getObject("$IsBound")){u.aContexts=z;u.mBindingParameters=P.mBindingParameters;u.additionalSideEffect=P.additionalSideEffect;u.bGrouped=P.invocationGrouping==="ChangeSet";u.bReturnAsArray=P.bReturnAsArray;u.localUIModel=P.localUIModel;u.prefix=P.prefix;u.operationAvailableMap=P.operationAvailableMap;}if(I){u.bIsCreateAction=I;}if(v){w=v(A,x,u,t,j,P.parentControl,P.entitySetName);}else{w=_(u);}return w.then(function(O){r(O);}).catch(function(O){q(O);});});}function h(A,i,P,j,q,r,t){return new Promise(function(u,v){var w=A?A:null;w=w.indexOf(".")>=0?w.split(".")[w.split(".").length-1]:w;var x=w&&t?t+"|"+w:"";var R=r.getController().oResourceBundle;var y=C.getTranslatedText("C_OPERATIONS_ACTION_CONFIRM_MESSAGE",R,null,x);M.confirm(y,{onClose:function(z){if(z===M.Action.OK){return _(P).then(function(O){u(O);}).catch(function(E){m.showUnboundMessages().then(function(){v(E);}).catch(function(){v(E);});});}else{u();}}});});}function s(A,j,P,q,r,t,u){var v=n(r,A),w=r.getModel().oModel.getMetaModel(),x=w.createBindingContext(v),y=r.getObject("$IsBound")?r.getPath().split("/@$ui5.overload/0")[0]:r.getPath().split("/0")[0],z=w.createBindingContext(y),E=Promise.resolve(),G,H="sap/fe/core/controls/ActionParameterDialog";return new Promise(function(I,K){var N=X.loadTemplate(H,"fragment"),O=new J({$displayMode:{}}),Q=[],R=[],T={handleChange:function(i){m.removeBoundTransitionMessages();Q=[];Q.push(i.getParameter("promise"));if(i.getParameter("valid")===false&&R.indexOf(i.getParameter("id"))<0){R.push(i.getParameter("id"));}else if(R.indexOf(i.getParameter("id"))>-1){delete R[R.indexOf(i.getParameter("id"))];R.length=R.length-1;}if(R.length>0){G.setEnabled(false);return;}else{G.setEnabled(true);}sap.ui.getCore().getMessageManager().getMessageModel().getData().forEach(function(U){U.aTargets.forEach(function(V){if((V.indexOf("APD_::")>-1&&V.indexOf("/value")<0)||(V.indexOf("APD_::")>-1&&V.indexOf("-inner/value")>-1)){G.setEnabled(false);}else{G.setEnabled(true);}});});}};return Promise.resolve(a.process(N,{name:H},{bindingContexts:{action:r,actionName:z,entitySet:x},models:{action:r.getModel(),actionName:z.getModel(),entitySet:x.getModel()}})).then(function(N){return C.setUserDefaults(P.ownerComponent,q,O,true).then(function(){return F.load({definition:N,controller:T}).then(function(U){var V;var W=t.getController().oResourceBundle;var Y=new D({title:j||C.getTranslatedText("C_OPERATIONS_ACTION_PARAMETER_DIALOG_TITLE",W),content:[U],escapeHandler:function(i){Y.close();m.removeUnboundTransitionMessages();K();},beginButton:{text:j||C.getTranslatedText("C_COMMON_DIALOG_OK",W),type:"Emphasized",press:function(a1){var b1=a1.getSource();var c1=sap.ui.getCore().getMessageManager().getMessageModel().getData();b1.setEnabled(false);q.forEach(function(i){var d1=i.$Name;c1.forEach(function(e1){var f1=d1.replace("-inner","");if(e1.controlIds.length>0&&(e1.getControlId().includes("APD_::"+d1)||(e1.getControlId().includes("APD_::"+d1+"inner")&&R.indexOf("APD_::"+f1)<0))){R.push("APD_::"+f1);}});});if(R.length>0){return;}B.lock(Y);return Promise.all(Q).then(function(){return E.then(function(){var d1,i,e1,f1=U.getAggregation("form").getAggregation("formContainers")[0].getAggregation("formElements");var g1=function(l1){var m1={};for(i=0;i<l1.length;i++){var n1=l1[i].getFields()[0];if(n1.getProperty("required")&&n1.mBindingInfos.value.binding){m1[n1.mBindingInfos.value.binding.getPath()]={element:n1};}}return m1;};var h1=g1(f1);var i1;var j1=V&&V.getParameterContext();for(i=0;i<q.length;i++){i1=q[i].$Name;e1=j1.getProperty(i1);if(!e1&&h1[i1]){d1=true;Y.fireValidationError({element:h1[i1].element,property:"value",type:sap.ui.core.MessageType.Error,newValue:e1,message:C.getTranslatedText("C_OPERATIONS_ACTION_PARAMETER_REQUIRED",W)});b1.setEnabled(false);}}if(!d1){m.removeUnboundTransitionMessages();var k1;for(var i in P.aActionParameters){k1=j1.getProperty(P.aActionParameters[i].$Name);P.aActionParameters[i].value=k1;k1=undefined;}return _(P).then(function(l1){Y.close();I(l1);}).catch(function(l1){b1.setEnabled(false);throw l1;});}});}).catch(function(){m.showUnboundMessages();}).finally(function(){B.unlock(Y);b1.setEnabled(true);});}},endButton:{text:C.getTranslatedText("C_COMMON_ACTION_PARAMETER_DIALOG_CANCEL",W),press:function(){Y.close();m.removeUnboundTransitionMessages();K(d.CancelActionDialog);}},afterOpen:function(){var a1=function(c1){var d1=function(f1,h1){var i1;if(h1){if($.length>0&&h1.$Path){i1=V.getParameterContext().getProperty(h1.$Path);if($.length>1){var j1=h1.$Path;if(j1.indexOf(c1+"/")===0){j1=j1.replace(c1+"/","");}for(var i=1;i<$.length;i++){if($[i].getProperty(j1)!==i1){return;}}}}else{i1=h1;}}else{if(O&&O.oData[f1]){i1=O.oData[f1];}}if(i1){V.setParameter(f1,i1);}};var e1=function(f1){var h1=Y.getModel().getMetaModel(),Z=r.sPath&&r.sPath.split("/@")[0],i1=Z+"/"+f1+"@",j1=h1.getObject(i1),k1=j1&&j1["@com.sap.vocabularies.UI.v1.ParameterDefaultValue"];return k1;};var f1,g1;for(var i in P.aActionParameters){f1=P.aActionParameters[i].$Name;g1=e1(f1);d1(f1,g1);}Y.open();};if(r.getObject("$IsBound")&&$.length>0){var b1=r.getObject("$Parameter"),c1=b1[0]&&b1[0].$Name;$[0].requestObject().then(function(i){if(i){V.setParameter(c1,i);}a1(c1);}).catch(function(i){L.error("Error while retrieving the parameter",i);});}else{a1();}},afterClose:function(){m.removeUnboundTransitionMessages();m.removeBoundTransitionMessages();Y.destroy();}});G=Y.getBeginButton();Y.setModel(r.getModel().oModel);Y.setModel(O,"paramsModel");Y.bindElement({path:"/",model:"paramsModel"});var Z=A+"(...)";var $=P.aContexts||[];if(!$.length){Z="/"+Z;}Y.bindElement({path:Z});if(t){t.addDependent(Y);}if($.length>0){Y.setBindingContext($[0]);}V=Y.getObjectBinding();Y.open();});});}).catch(K);});}function p(A,P){var i=k(A);P=P||[];if(P.length>0){}return i;}function k(A){var P=A.getObject("$Parameter")||[];if(P&&P.length){if(A.getObject("$IsBound")){return P.slice(1,P.length)||[];}}return P;}function l(i,P){return!!i.getObject(P+"@com.sap.vocabularies.Common.v1.IsActionCritical");}function _(P){var q=P.aContexts||[],r=P.model,A=P.aActionParameters||[],t=P.actionName,O=P.fnOnSubmitted,u=P.fnOnResponse,I=P.bIsCreateAction,v=false,w;function x(i){return i.then(function(j){return{response:j,status:"resolved"};},function(j){return{response:j,status:"rejected"};});}function y(){if(A&&A.length){v=true;for(var j=0;j<A.length;j++){if(!A[j].value){switch(A[j].$Type){case"Edm.String":A[j].value="";break;case"Edm.Boolean":A[j].value=false;break;case"Edm.Byte":case"Edm.Int16":case"Edm.Int32":case"Edm.Int64":A[j].value=0;break;default:break;}}w.setParameter(A[j].$Name,A[j].value);}}}if(q.length){return new Promise(function(j,E){var G=P.mBindingParameters,H=P.bGrouped,R=P.bReturnAsArray,K=P.bGetBoundContext,N=[],z,i,Q,T=function(w,U,V){y();Q=!H?"actionGroup":w.getUpdateGroupId();z=K?w.execute(Q).then(function(){return w.getBoundContext();}):w.execute(Q);N.push(z);if(!H){r.submitBatch(Q);}if(V&&V.triggerActions&&V.triggerActions.length){V.triggerActions.forEach(function(W){if(W){var Y=V.context.getModel().bindContext(W+"(...)",V.context);Y.execute(Q);}});}if(V&&V.pathExpressions){S.logRequest(V);V.context.requestSideEffects(V.pathExpressions,Q).then(function(){if(P.operationAvailableMap){C.setActionEnablement(P.localUIModel,JSON.parse(P.operationAvailableMap),"/$contexts/"+P.prefix,P.aContexts);}}).catch(function(W){L.error("Error while requesting side effects",W);});}};for(i=0;i<q.length;i++){w=r.bindContext(t+"(...)",q[i],G);T(w,q.length<=1?null:i,{context:q[i],pathExpressions:P.additionalSideEffect&&P.additionalSideEffect.pathExpressions,triggerActions:P.additionalSideEffect&&P.additionalSideEffect.triggerActions});}(O||jQuery.noop)(N);Promise.all(N.map(x)).then(function(U){var V=[],W=[],Y;for(Y=0;Y<U.length;Y++){if(U[Y].status==="rejected"){V.push(U[Y].response);}if(U[Y].status==="resolved"){if(I&&v){U[Y].bConsiderDocumentModified=true;W.push(U[Y]);}else{W.push(U[Y].response);}}}if(!U||(U&&U.length===0)){E(true);}if(V.length===0){if(R){j(W);}else{j(W[0]);}}else{E({resolvedItems:W,rejectedItems:V});}}).catch(E);}).finally(function(){(u||jQuery.noop)();});}else{var z;w=r.bindContext("/"+t+"(...)");y();z=w.execute("actionImport");r.submitBatch("actionImport");(O||jQuery.noop)(z);return z.finally(function(){(u||jQuery.noop)();});}}function n(A,i){var P=A.getPath();P=A.getObject("$IsBound")?P.split("@$ui5.overload")[0]:P.split("/0")[0];return P.split("/"+i)[0];}var o={callBoundAction:e,callActionImport:f};return o;});
