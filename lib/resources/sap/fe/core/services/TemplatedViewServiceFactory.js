sap.ui.define(["sap/ui/core/service/Service","sap/ui/core/service/ServiceFactory","sap/ui/core/service/ServiceFactoryRegistry","sap/ui/model/base/ManagedObjectModel","sap/ui/model/resource/ResourceModel","sap/ui/core/mvc/View","sap/ui/core/Component","sap/ui/model/json/JSONModel","sap/base/Log","sap/fe/core/TemplateModel","sap/fe/core/converters/TemplateConverter","sap/fe/core/helpers/DynamicAnnotationPathHelper","sap/ui/core/cache/CacheManager","sap/base/strings/hash","sap/ui/VersionInfo"],function(S,a,b,M,R,V,C,J,L,T,c,D,d,h,e){"use strict";function f(n,i){this.name=n;this.currentPath=i||"";this.lastPath="";this.set=function(N){while(N.indexOf("../")===0){this.currentPath=this.currentPath.substr(0,this.currentPath.lastIndexOf(this.lastPath)-1);this.lastPath=this.currentPath.substr(this.currentPath.lastIndexOf("/")+1);N=N.substr(3);}if(N){this.lastPath=N;}this.currentPath+=N;L.info(this.name+" is now : "+this.currentPath);};this.get=function(){return this.currentPath;};this.delete=function(){this.currentPath="";L.info(this.name+" has been deleted");};}var g=S.extend("sap.fe.core.services.TemplatedViewService",{initPromise:null,init:function(){var t=this;var s=[];var o=this.getContext();var j=o.scopeObject;var A=C.getOwnerComponentFor(j);var m=A.getMetaModel();var k=A.getMetadata().getComponentName()+"::"+A.getLocalId(j.getId());var E=j.getEnhanceI18n()||[];var l;if(E){l=A.getMetadata().getComponentName();for(var i=0;i<E.length;i++){E[i]=l+"."+E[i].replace(".properties","");}}var n=A.getMetadata().getName()+"_"+k+"_"+sap.ui.getCore().getConfiguration().getLanguageTag();s.push(b.get("sap.fe.core.services.ResourceModelService").createInstance({scopeType:"component",scopeObject:j,settings:{bundles:["sap.fe.core.messagebundle","sap.fe.templates.messagebundle"],enhanceI18n:E,modelName:"sap.fe.i18n"}}).then(function(r){return r.getResourceModel();}));s.push(b.get("sap.fe.core.services.CacheHandlerService").createInstance({settings:{metaModel:m}}).then(function(q){return q.validateCacheKey(n);}));s.push(e.load().then(function(I){var q="";if(!I.libraries){q=sap.ui.buildinfo.buildtime;}else{I.libraries.forEach(function(r){q+=r.buildTimestamp;});}return q;}).catch(function(){return"<NOVALUE>";}));var p="";this.initPromise=Promise.all(s).then(function(q){var r=q[1];var v=q[2];var u=A.getManifest();var w=h(JSON.stringify({sapApp:u["sap.app"],viewData:j.getViewData()}));p=r+"-"+w+"-"+v+"-"+k+"-pageModel";return Promise.all(q.concat([d.get(p)]));}).then(function(q){var r=q[0];var u=q[1];var P=q[3];return t.createView(r,k,u,p,P);}).then(function(q){var r=b.get("sap.fe.core.services.CacheHandlerService").getInstance(m);r.invalidateIfNeeded(q,n);});},createView:function(r,s,i,p,P){var t=this;var o=this.getContext(),m=o.settings,j=m.converterType,k=o.scopeObject,E=k.getProperty("entitySet"),A=C.getOwnerComponentFor(k),l=A.getMetaModel(),n=A.getManifest(),q=new J(sap.ui.Device).setDefaultBindingMode("OneWay"),u=new J(n),v=new J({currentPath:new f(),navigationPath:new f("NavigationPath")}),w=false,x,y,z,B,F;this.oFactory=o.factory;function G(){var B={type:"XML",preprocessors:{xml:{bindingContexts:{entitySet:E?l.createBindingContext("/"+E):null,converterContext:y.createBindingContext("/",null,{noResolve:true}),viewData:F?z.createBindingContext("/"):null},models:{entitySet:l,"sap.fe.i18n":r,"sap.ui.mdc.metaModel":l,"sap.fe.deviceModel":q,manifest:u,converterContext:y,viewData:z,metaPath:v}}},id:s,viewName:m.viewName,viewData:F,cache:{keys:[i]},models:{"sap.fe.i18n":r},height:"100%"};return B;}function H(I){L.error(I.message,I);B.viewName=m.errorViewName||"sap.fe.core.services.view.TemplatingErrorPage";B.preprocessors.xml.models["error"]=new J(I);return k.runAsOwner(function(){return V.create(B).then(function(K){t.oView=K;t.oView.setModel(new M(t.oView),"$view");k.setAggregation("rootControl",t.oView);return i;});});}return A.getService("routingService").then(function(I){var K=I.getTargetInformationFor(k);var O=n["sap.app"]&&n["sap.app"].crossNavigation&&n["sap.app"].crossNavigation.outbounds;var N=k.getNavigation()||{};Object.keys(N).forEach(function(U){var W=N[U];var X;if(W.detail&&W.detail.outbound&&O[W.detail.outbound]){X=O[W.detail.outbound];W.detail.outboundDetail={semanticObject:X.semanticObject,action:X.action,parameters:X.parameters};}if(W.create&&W.create.outbound&&O[W.create.outbound]){X=O[W.create.outbound];W.create.outboundDetail={semanticObject:X.semanticObject,action:X.action,parameters:X.parameters};}});F={navigation:N,viewLevel:K.viewLevel,stableId:s};if(k.getViewData){Object.assign(F,k.getViewData());}z=new J(F);if(F&&F.controlConfiguration){Object.keys(F.controlConfiguration).forEach(function(U){if(U.indexOf("[")!==-1){var W=D.resolveDynamicExpression(U,l);F.controlConfiguration[W]=F.controlConfiguration[U];}});}if(!!P){y=P;}else{try{x=c.convertPage(j,l,F);y=P=new T(x,l);}catch(Q){w=true;y=new J();B=G();return H(Q);}}if(!w){B=G();k.setModel(y,"_pageModel");return k.runAsOwner(function(){return V.create(B).catch(H).then(function(U){t.oView=U;t.oView.setModel(new M(t.oView),"$view");k.setAggregation("rootControl",t.oView);return i;}).catch(L.error);});}}).catch(function(I){L.error(I.message,I);throw new Error("Error while creating view : "+I);});},getView:function(){return this.oView;},exit:function(){this.oFactory.removeGlobalInstance();}});return a.extend("sap.fe.core.services.TemplatedViewServiceFactory",{_oInstanceRegistry:{},createInstance:function(s){var t=new g(Object.assign({factory:this},s));return t.initPromise.then(function(){return t;});},removeGlobalInstance:function(){this._oInstanceRegistry={};}});},true);
