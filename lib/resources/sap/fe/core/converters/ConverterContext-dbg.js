sap.ui.define(["sap/fe/core/converters/ManifestSettings", "sap/ui/model/odata/v4/AnnotationHelper", "sap/fe/core/converters/MetaModelConverter"], function (ManifestSettings, AnnotationHelper, MetaModelConverter) {
  "use strict";

  var _exports = {};
  var convertTypes = MetaModelConverter.convertTypes;
  var createManifestWrapper = ManifestSettings.createManifestWrapper;

  /**
   * Check whether an expression is a PathExpression.
   *
   * @param expression
   * @returns {boolean}
   */
  var isPathExpression = function (expression) {
    return expression.type !== undefined && expression.type === "Path";
  };
  /**
   * Checks whether an object is an annotation term.
   *
   * @param {string|AnnotationTerm<object>} vAnnotationPath
   * @returns {boolean}
   */


  var isAnnotationTerm = function (vAnnotationPath) {
    return typeof vAnnotationPath === "object";
  };
  /**
   * Create a ConverterContext object that will be used within the converters.
   *
   * @param {ConverterOutput} oConvertedTypes the converted annotation and service types
   * @param {Context} oBaseContext the base ODataMetaModel context for this object
   * @param {BaseManifestSettings} oManifestSettings the manifestSettings that applies to this page
   * @param {EntitySet} currentEntitySet the entitySet to template against
   * @param {TemplateConverterType} templateType the type of template we're looking at right now
   *
   * @returns {ConverterContext} a converter context for the converters
   */


  function createConverterContext(oConvertedTypes, oBaseContext, oManifestSettings, currentEntitySet, templateType) {
    var oManifestWrapper = createManifestWrapper(oManifestSettings);

    var getBindingExpression = function (annotationValue, defaultValue) {
      if (!annotationValue) {
        return defaultValue;
      } else if (isPathExpression(annotationValue)) {
        return AnnotationHelper.format({
          $Path: annotationValue.path
        }, {
          context: oBaseContext
        });
      } else {
        return AnnotationHelper.format(annotationValue, {
          context: oBaseContext
        });
      }
    };

    var getInverseBindingExpression = function (annotationValue, defaultValue) {
      if (!annotationValue) {
        return defaultValue;
      } else if (typeof annotationValue === "boolean") {
        return !annotationValue;
      }

      var bindingExpression = getBindingExpression(annotationValue); // for path based values

      return "{= !$".concat(bindingExpression, " }");
    };

    var getEntityTypeFromFullyQualifiedName = function (fullyQualifiedName) {
      var targetEntityType = oConvertedTypes.entityTypes.find(function (entityType) {
        if (fullyQualifiedName.startsWith(entityType.fullyQualifiedName)) {
          var replaceAnnotation = fullyQualifiedName.replace(entityType.fullyQualifiedName, "");
          return replaceAnnotation.startsWith("/") || replaceAnnotation.startsWith("@");
        }

        return false;
      });
      return targetEntityType;
    };

    var getAnnotationEntityType = function (annotation) {
      var annotationPath = annotation.fullyQualifiedName;
      var targetEntityType = getEntityTypeFromFullyQualifiedName(annotationPath);

      if (!targetEntityType) {
        throw new Error("Cannot find Entity Type for " + annotation.fullyQualifiedName);
      }

      return targetEntityType;
    };

    var getManifestControlConfiguration = function (vAnnotationPath) {
      if (isAnnotationTerm(vAnnotationPath)) {
        return oManifestWrapper.getControlConfiguration(getRelativeAnnotationPath(vAnnotationPath.fullyQualifiedName, currentEntitySet.entityType));
      }

      return oManifestWrapper.getControlConfiguration(vAnnotationPath);
    }; //
    // const getPageManifestSettings = function(): BaseManifestSettings {
    // 	return oManifestSettings;
    // };


    var getAbsoluteAnnotationPath = function (sAnnotationPath) {
      if (sAnnotationPath[0] === "/") {
        return sAnnotationPath;
      }

      return oBaseContext.getPath(sAnnotationPath);
    };

    var getEntitySet = function () {
      return currentEntitySet;
    };

    var getEntitySetForEntityType = function (entityType) {
      return oConvertedTypes.entitySets.find(function (entitySet) {
        return entitySet.entityType === entityType;
      });
    };

    var getEntityTypeAnnotation = function (annotationPath) {
      if (annotationPath.indexOf("@") === -1) {
        annotationPath = "@" + annotationPath;
      }

      return currentEntitySet.entityType.resolvePath(annotationPath);
    };

    var getAnnotationPathFromFullyQualifiedName = function (fullyQualifiedName) {
      var targetEntityType = getEntityTypeFromFullyQualifiedName(fullyQualifiedName);

      if (!targetEntityType) {
        return fullyQualifiedName;
      } else {
        var targetEntitySet = getEntitySetForEntityType(targetEntityType);

        if (!targetEntitySet) {
          return fullyQualifiedName;
        }

        return fullyQualifiedName.replace(targetEntityType.fullyQualifiedName, "/" + targetEntitySet.name + "/");
      }
    };

    var getTemplateConverterType = function () {
      return templateType;
    };

    var getRelativeAnnotationPath = function (annotationPath, entityType) {
      return annotationPath.replace(entityType.fullyQualifiedName, "");
    };

    var getEntitySetBasedAnnotationPath = function (annotationPath) {
      var entityTypeFQN = currentEntitySet.entityType.fullyQualifiedName;
      return "/" + annotationPath.replace(entityTypeFQN, currentEntitySet.name + "/");
    };

    var getManifestWrapper = function () {
      return oManifestWrapper;
    };

    return {
      getBindingExpression: getBindingExpression,
      getInverseBindingExpression: getInverseBindingExpression,
      getAnnotationEntityType: getAnnotationEntityType,
      getManifestControlConfiguration: getManifestControlConfiguration,
      getAbsoluteAnnotationPath: getAbsoluteAnnotationPath,
      getAnnotationPathFromFullyQualifiedName: getAnnotationPathFromFullyQualifiedName,
      getEntitySet: getEntitySet,
      getEntitySetForEntityType: getEntitySetForEntityType,
      getEntityTypeAnnotation: getEntityTypeAnnotation,
      getTemplateConverterType: getTemplateConverterType,
      getRelativeAnnotationPath: getRelativeAnnotationPath,
      getEntitySetBasedAnnotationPath: getEntitySetBasedAnnotationPath,
      getManifestWrapper: getManifestWrapper
    };
  }
  /**
   * Create the converter context necessary for a macro based on a metamodel context.
   *
   * @param sEntitySetName
   * @param oMetaModelContext
   * @param sTemplateType
   * @returns {ConverterContext} the current converter context
   */


  _exports.createConverterContext = createConverterContext;

  function createConverterContextForMacro(sEntitySetName, oMetaModelContext, sTemplateType) {
    var oConverterOutput = convertTypes(oMetaModelContext.getModel());
    var targetEntitySet = oConverterOutput.entitySets.find(function (entitySet) {
      return entitySet.name === sEntitySetName;
    });
    return createConverterContext(oConverterOutput, oMetaModelContext, {}, targetEntitySet, sTemplateType);
  }

  _exports.createConverterContextForMacro = createConverterContextForMacro;
  return _exports;
}, false);
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIkNvbnZlcnRlckNvbnRleHQudHMiXSwibmFtZXMiOlsiaXNQYXRoRXhwcmVzc2lvbiIsImV4cHJlc3Npb24iLCJ0eXBlIiwidW5kZWZpbmVkIiwiaXNBbm5vdGF0aW9uVGVybSIsInZBbm5vdGF0aW9uUGF0aCIsImNyZWF0ZUNvbnZlcnRlckNvbnRleHQiLCJvQ29udmVydGVkVHlwZXMiLCJvQmFzZUNvbnRleHQiLCJvTWFuaWZlc3RTZXR0aW5ncyIsImN1cnJlbnRFbnRpdHlTZXQiLCJ0ZW1wbGF0ZVR5cGUiLCJvTWFuaWZlc3RXcmFwcGVyIiwiY3JlYXRlTWFuaWZlc3RXcmFwcGVyIiwiZ2V0QmluZGluZ0V4cHJlc3Npb24iLCJhbm5vdGF0aW9uVmFsdWUiLCJkZWZhdWx0VmFsdWUiLCJBbm5vdGF0aW9uSGVscGVyIiwiZm9ybWF0IiwiJFBhdGgiLCJwYXRoIiwiY29udGV4dCIsImdldEludmVyc2VCaW5kaW5nRXhwcmVzc2lvbiIsImJpbmRpbmdFeHByZXNzaW9uIiwiZ2V0RW50aXR5VHlwZUZyb21GdWxseVF1YWxpZmllZE5hbWUiLCJmdWxseVF1YWxpZmllZE5hbWUiLCJ0YXJnZXRFbnRpdHlUeXBlIiwiZW50aXR5VHlwZXMiLCJmaW5kIiwiZW50aXR5VHlwZSIsInN0YXJ0c1dpdGgiLCJyZXBsYWNlQW5ub3RhdGlvbiIsInJlcGxhY2UiLCJnZXRBbm5vdGF0aW9uRW50aXR5VHlwZSIsImFubm90YXRpb24iLCJhbm5vdGF0aW9uUGF0aCIsIkVycm9yIiwiZ2V0TWFuaWZlc3RDb250cm9sQ29uZmlndXJhdGlvbiIsImdldENvbnRyb2xDb25maWd1cmF0aW9uIiwiZ2V0UmVsYXRpdmVBbm5vdGF0aW9uUGF0aCIsImdldEFic29sdXRlQW5ub3RhdGlvblBhdGgiLCJzQW5ub3RhdGlvblBhdGgiLCJnZXRQYXRoIiwiZ2V0RW50aXR5U2V0IiwiZ2V0RW50aXR5U2V0Rm9yRW50aXR5VHlwZSIsImVudGl0eVNldHMiLCJlbnRpdHlTZXQiLCJnZXRFbnRpdHlUeXBlQW5ub3RhdGlvbiIsImluZGV4T2YiLCJyZXNvbHZlUGF0aCIsImdldEFubm90YXRpb25QYXRoRnJvbUZ1bGx5UXVhbGlmaWVkTmFtZSIsInRhcmdldEVudGl0eVNldCIsIm5hbWUiLCJnZXRUZW1wbGF0ZUNvbnZlcnRlclR5cGUiLCJnZXRFbnRpdHlTZXRCYXNlZEFubm90YXRpb25QYXRoIiwiZW50aXR5VHlwZUZRTiIsImdldE1hbmlmZXN0V3JhcHBlciIsImNyZWF0ZUNvbnZlcnRlckNvbnRleHRGb3JNYWNybyIsInNFbnRpdHlTZXROYW1lIiwib01ldGFNb2RlbENvbnRleHQiLCJzVGVtcGxhdGVUeXBlIiwib0NvbnZlcnRlck91dHB1dCIsImNvbnZlcnRUeXBlcyIsImdldE1vZGVsIl0sIm1hcHBpbmdzIjoiOzs7Ozs7O0FBU0E7Ozs7OztBQU1BLE1BQU1BLGdCQUFnQixHQUFHLFVBQVlDLFVBQVosRUFBd0U7QUFDaEcsV0FBT0EsVUFBVSxDQUFDQyxJQUFYLEtBQW9CQyxTQUFwQixJQUFpQ0YsVUFBVSxDQUFDQyxJQUFYLEtBQW9CLE1BQTVEO0FBQ0EsR0FGRDtBQUlBOzs7Ozs7OztBQU1BLE1BQU1FLGdCQUFnQixHQUFHLFVBQVNDLGVBQVQsRUFBZ0c7QUFDeEgsV0FBTyxPQUFPQSxlQUFQLEtBQTJCLFFBQWxDO0FBQ0EsR0FGRDtBQUlBOzs7Ozs7Ozs7Ozs7O0FBV08sV0FBU0Msc0JBQVQsQ0FDTkMsZUFETSxFQUVOQyxZQUZNLEVBR05DLGlCQUhNLEVBSU5DLGdCQUpNLEVBS05DLFlBTE0sRUFNYTtBQUNuQixRQUFNQyxnQkFBZ0IsR0FBR0MscUJBQXFCLENBQUNKLGlCQUFELENBQTlDOztBQUNBLFFBQU1LLG9CQUFvQixHQUFHLFVBQzVCQyxlQUQ0QixFQUU1QkMsWUFGNEIsRUFHTDtBQUN2QixVQUFJLENBQUNELGVBQUwsRUFBc0I7QUFDckIsZUFBT0MsWUFBUDtBQUNBLE9BRkQsTUFFTyxJQUFJaEIsZ0JBQWdCLENBQUNlLGVBQUQsQ0FBcEIsRUFBdUM7QUFDN0MsZUFBT0UsZ0JB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QXZCO0FBQUEsS0FBMUMsQ0FBeEI7QUFDQSxXQUFPcEQsc0JBQXNCLENBQUN1RCxnQkFBRCxFQUFtQkYsaUJBQW5CLEVBQXNDLEVBQXRDLEVBQWtFUixlQUFsRSxFQUFtRlMsYUFBbkYsQ0FBN0I7QUFDQSIsInNvdXJjZVJvb3QiOiIuIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgQW5ub3RhdGlvblRlcm0sIEFwcGx5QW5ub3RhdGlvbkV4cHJlc3Npb24sIFBhdGhBbm5vdGF0aW9uRXhwcmVzc2lvbiB9IGZyb20gXCJAc2FwLXV4L3ZvY2FidWxhcmllcy10eXBlc1wiO1xuaW1wb3J0IHsgQW55QW5ub3RhdGlvbiwgQ29udmVydGVyT3V0cHV0LCBFbnRpdHlTZXQsIEVudGl0eVR5cGUgfSBmcm9tIFwiQHNhcC11eC9hbm5vdGF0aW9uLWNvbnZlcnRlclwiO1xuaW1wb3J0IHsgQ29udGV4dCB9IGZyb20gXCJzYXAvdWkvbW9kZWxcIjtcbmltcG9ydCB7IEJhc2VNYW5pZmVzdFNldHRpbmdzLCBjcmVhdGVNYW5pZmVzdFdyYXBwZXIsIE1hbmlmZXN0V3JhcHBlciB9IGZyb20gXCJzYXAvZmUvY29yZS9jb252ZXJ0ZXJzL01hbmlmZXN0U2V0dGluZ3NcIjtcbmltcG9ydCB7IENvbnZlcnRlckNvbnRleHQsIFRlbXBsYXRlQ29udmVydGVyVHlwZSB9IGZyb20gXCJzYXAvZmUvY29yZS9jb252ZXJ0ZXJzL3RlbXBsYXRlcy9CYXNlQ29udmVydGVyXCI7XG5pbXBvcnQgeyBBbm5vdGF0aW9uSGVscGVyLCBPRGF0YU1ldGFNb2RlbCB9IGZyb20gXCJzYXAvdWkvbW9kZWwvb2RhdGEvdjRcIjtcbmltcG9ydCB7IGNvbnZlcnRUeXBlcyB9IGZyb20gXCJzYXAvZmUvY29yZS9jb252ZXJ0ZXJzL01ldGFNb2RlbENvbnZlcnRlclwiO1xuaW1wb3J0IHsgQmluZGluZ0V4cHJlc3Npb24gfSBmcm9tIFwic2FwL2ZlL2NvcmUvaGVscGVycy9CaW5kaW5nRXhwcmVzc2lvblwiO1xuXG4vKipcbiAqIENoZWNrIHdoZXRoZXIgYW4gZXhwcmVzc2lvbiBpcyBhIFBhdGhFeHByZXNzaW9uLlxuICpcbiAqIEBwYXJhbSBleHByZXNzaW9uXG4gKiBAcmV0dXJucyB7Ym9vbGVhbn1cbiAqL1xuY29uc3QgaXNQYXRoRXhwcmVzc2lvbiA9IGZ1bmN0aW9uPFQ+KGV4cHJlc3Npb246IGFueSk6IGV4cHJlc3Npb24gaXMgUGF0aEFubm90YXRpb25FeHByZXNzaW9uPFQ+IHtcblx0cmV0dXJuIGV4cHJlc3Npb24udHlwZSAhPT0gdW5kZWZpbmVkICYmIGV4cHJlc3Npb24udHlwZSA9PT0gXCJQYXRoXCI7XG59O1xuXG4vKipcbiAqIENoZWNrcyB3aGV0aGVyIGFuIG9iamVjdCBpcyBhbiBhbm5vdGF0aW9uIHRlcm0uXG4gKlxuICogQHBhcmFtIHtzdHJpbmd8QW5ub3RhdGlvblRlcm08b2JqZWN0Pn0gdkFubm90YXRpb25QYXRoXG4gKiBAcmV0dXJucyB7Ym9vbGVhbn1cbiAqL1xuY29uc3QgaXNBbm5vdGF0aW9uVGVybSA9IGZ1bmN0aW9uKHZBbm5vdGF0aW9uUGF0aDogc3RyaW5nIHwgQW5ub3RhdGlvblRlcm08YW55Pik6IHZBbm5vdGF0aW9uUGF0aCBpcyBBbm5vdGF0aW9uVGVybTxhbnk+IHtcblx0cmV0dXJuIHR5cGVvZiB2QW5ub3RhdGlvblBhdGggPT09IFwib2JqZWN0XCI7XG59O1xuXG4vKipcbiAqIENyZWF0ZSBhIENvbnZlcnRlckNvbnRleHQgb2JqZWN0IHRoYXQgd2lsbCBiZSB1c2VkIHdpdGhpbiB0aGUgY29udmVydGVycy5cbiAqXG4gKiBAcGFyYW0ge0NvbnZlcnRlck91dHB1dH0gb0NvbnZlcnRlZFR5cGVzIHRoZSBjb252ZXJ0ZWQgYW5ub3RhdGlvbiBhbmQgc2VydmljZSB0eXBlc1xuICogQHBhcmFtIHtDb250ZXh0fSBvQmFzZUNvbnRleHQgdGhlIGJhc2UgT0RhdGFNZXRhTW9kZWwgY29udGV4dCBmb3IgdGhpcyBvYmplY3RcbiAqIEBwYXJhbSB7QmFzZU1hbmlmZXN0U2V0dGluZ3N9IG9NYW5pZmVzdFNldHRpbmdzIHRoZSBtYW5pZmVzdFNldHRpbmdzIHRoYXQgYXBwbGllcyB0byB0aGlzIHBhZ2VcbiAqIEBwYXJhbSB7RW50aXR5U2V0fSBjdXJyZW50RW50aXR5U2V0IHRoZSBlbnRpdHlTZXQgdG8gdGVtcGxhdGUgYWdhaW5zdFxuICogQHBhcmFtIHtUZW1wbGF0ZUNvbnZlcnRlclR5cGV9IHRlbXBsYXRlVHlwZSB0aGUgdHlwZSBvZiB0ZW1wbGF0ZSB3ZSdyZSBsb29raW5nIGF0IHJpZ2h0IG5vd1xuICpcbiAqIEByZXR1cm5zIHtDb252ZXJ0ZXJDb250ZXh0fSBhIGNvbnZlcnRlciBjb250ZXh0IGZvciB0aGUgY29udmVydGVyc1xuICovXG5leHBvcnQgZnVuY3Rpb24gY3JlYXRlQ29udmVydGVyQ29udGV4dChcblx0b0NvbnZlcnRlZFR5cGVzOiBDb252ZXJ0ZXJPdXRwdXQsXG5cdG9CYXNlQ29udGV4dDogQ29udGV4dCxcblx0b01hbmlmZXN0U2V0dGluZ3M6IEJhc2VNYW5pZmVzdFNldHRpbmdzLFxuXHRjdXJyZW50RW50aXR5U2V0OiBFbnRpdHlTZXQsXG5cdHRlbXBsYXRlVHlwZTogVGVtcGxhdGVDb252ZXJ0ZXJUeXBlXG4pOiBDb252ZXJ0ZXJDb250ZXh0IHtcblx0Y29uc3Qgb01hbmlmZXN0V3JhcHBlciA9IGNyZWF0ZU1hbmlmZXN0V3JhcHBlcihvTWFuaWZlc3RTZXR0aW5ncyk7XG5cdGNvbnN0IGdldEJpbmRpbmdFeHByZXNzaW9uID0gZnVuY3Rpb248VD4oXG5cdFx0YW5ub3RhdGlvblZhbHVlOiBhbnkgfCBQYXRoQW5ub3RhdGlvbkV4cHJlc3Npb248YW55PiB8IEFwcGx5QW5ub3RhdGlvbkV4cHJlc3Npb248YW55PiB8IHVuZGVmaW5lZCxcblx0XHRkZWZhdWx0VmFsdWU/OiBUXG5cdCk6IEJpbmRpbmdFeHByZXNzaW9uPFQ+IHtcblx0XHRpZiAoIWFubm90YXRpb25WYWx1ZSkge1xuXHRcdFx0cmV0dXJuIGRlZmF1bHRWYWx1ZTtcblx0XHR9IGVsc2UgaWYgKGlzUGF0aEV4cHJlc3Npb24oYW5ub3RhdGlvblZhbHVlKSkge1xuXHRcdFx0cmV0dXJuIEFubm90YXRpb25IZWxwZXIuZm9ybWF0KHsgJFBhdGg6IGFubm90YXRpb25WYWx1ZS5wYXRoIH0sIHsgY29udGV4dDogb0Jhc2VDb250ZXh0IH0pO1xuXHRcdH0gZWxzZSB7XG5cdFx0XHRyZXR1cm4gQW5ub3RhdGlvbkhlbHBlci5mb3JtYXQoYW5ub3RhdGlvblZhbHVlLCB7IGNvbnRleHQ6IG9CYXNlQ29udGV4dCB9KTtcblx0XHR9XG5cdH07XG5cblx0Y29uc3QgZ2V0SW52ZXJzZUJpbmRpbmdFeHByZXNzaW9uID0gZnVuY3Rpb248VD4oXG5cdFx0YW5ub3RhdGlvblZhbHVlOiBUIHwgUGF0aEFubm90YXRpb25FeHByZXNzaW9uPFQ+IHwgQXBwbHlBbm5vdGF0aW9uRXhwcmVzc2lvbjxUPiB8IHVuZGVmaW5lZCxcblx0XHRkZWZhdWx0VmFsdWU/OiBib29sZWFuXG5cdCk6IEJpbmRpbmdFeHByZXNzaW9uPGJvb2xlYW4+IHtcblx0XHRpZiAoIWFubm90YXRpb25WYWx1ZSkge1xuXHRcdFx0cmV0dXJuIGRlZmF1bHRWYWx1ZTtcblx0XHR9IGVsc2UgaWYgKHR5cGVvZiBhbm5vdGF0aW9uVmFsdWUgPT09IFwiYm9vbGVhblwiKSB7XG5cdFx0XHRyZXR1cm4gIWFubm90YXRpb25WYWx1ZTtcblx0XHR9XG5cdFx0Y29uc3QgYmluZGluZ0V4cHJlc3Npb24gPSBnZXRCaW5kaW5nRXhwcmVzc2lvbihhbm5vdGF0aW9uVmFsdWUpO1xuXHRcdC8vIGZvciBwYXRoIGJhc2VkIHZhbHVlc1xuXHRcdHJldHVybiBgez0gISQke2JpbmRpbmdFeHByZXNzaW9ufSB9YDtcblx0fTtcblxuXHRjb25zdCBnZXRFbnRpdHlUeXBlRnJvbUZ1bGx5UXVhbGlmaWVkTmFtZSA9IGZ1bmN0aW9uKGZ1bGx5UXVhbGlmaWVkTmFtZTogc3RyaW5nKTogRW50aXR5VHlwZSB8IHVuZGVmaW5lZCB7XG5cdFx0Y29uc3QgdGFyZ2V0RW50aXR5VHlwZSA9IG9Db252ZXJ0ZWRUeXBlcy5lbnRpdHlUeXBlcy5maW5kKGVudGl0eVR5cGUgPT4ge1xuXHRcdFx0aWYgKGZ1bGx5UXVhbGlmaWVkTmFtZS5zdGFydHNXaXRoKGVudGl0eVR5cGUuZnVsbHlRdWFsaWZpZWROYW1lKSkge1xuXHRcdFx0XHRjb25zdCByZXBsYWNlQW5ub3RhdGlvbiA9IGZ1bGx5UXVhbGlmaWVkTmFtZS5yZXBsYWNlKGVudGl0eVR5cGUuZnVsbHlRdWFsaWZpZWROYW1lLCBcIlwiKTtcblx0XHRcdFx0cmV0dXJuIHJlcGxhY2VBbm5vdGF0aW9uLnN0YXJ0c1dpdGgoXCIvXCIpIHx8IHJlcGxhY2VBbm5vdGF0aW9uLnN0YXJ0c1dpdGgoXCJAXCIpO1xuXHRcdFx0fVxuXHRcdFx0cmV0dXJuIGZhbHNlO1xuXHRcdH0pO1xuXHRcdHJldHVybiB0YXJnZXRFbnRpdHlUeXBlO1xuXHR9O1xuXG5cdGNvbnN0IGdldEFubm90YXRpb25FbnRpdHlUeXBlID0gZnVuY3Rpb24oYW5ub3RhdGlvbjogQW5ub3RhdGlvblRlcm08YW55Pik6IEVudGl0eVR5cGUge1xuXHRcdGNvbnN0IGFubm90YXRpb25QYXRoID0gYW5ub3RhdGlvbi5mdWxseVF1YWxpZmllZE5hbWU7XG5cdFx0Y29uc3QgdGFyZ2V0RW50aXR5VHlwZSA9IGdldEVudGl0eVR5cGVGcm9tRnVsbHlRdWFsaWZpZWROYW1lKGFubm90YXRpb25QYXRoKTtcblx0XHRpZiAoIXRhcmdldEVudGl0eVR5cGUpIHtcblx0XHRcdHRocm93IG5ldyBFcnJvcihcIkNhbm5vdCBmaW5kIEVudGl0eSBUeXBlIGZvciBcIiArIGFubm90YXRpb24uZnVsbHlRdWFsaWZpZWROYW1lKTtcblx0XHR9XG5cdFx0cmV0dXJuIHRhcmdldEVudGl0eVR5cGU7XG5cdH07XG5cblx0Y29uc3QgZ2V0TWFuaWZlc3RDb250cm9sQ29uZmlndXJhdGlvbiA9IGZ1bmN0aW9uKHZBbm5vdGF0aW9uUGF0aDogc3RyaW5nIHwgQW5ub3RhdGlvblRlcm08YW55Pik6IGFueSB7XG5cdFx0aWYgKGlzQW5ub3RhdGlvblRlcm0odkFubm90YXRpb25QYXRoKSkge1xuXHRcdFx0cmV0dXJuIG9NYW5pZmVzdFdyYXBwZXIuZ2V0Q29udHJvbENvbmZpZ3VyYXRpb24oXG5cdFx0XHRcdGdldFJlbGF0aXZlQW5ub3RhdGlvblBhdGgodkFubm90YXRpb25QYXRoLmZ1bGx5UXVhbGlmaWVkTmFtZSwgY3VycmVudEVudGl0eVNldC5lbnRpdHlUeXBlKVxuXHRcdFx0KTtcblx0XHR9XG5cdFx0cmV0dXJuIG9NYW5pZmVzdFdyYXBwZXIuZ2V0Q29udHJvbENvbmZpZ3VyYXRpb24odkFubm90YXRpb25QYXRoKTtcblx0fTtcblxuXHQvL1xuXHQvLyBjb25zdCBnZXRQYWdlTWFuaWZlc3RTZXR0aW5ncyA9IGZ1bmN0aW9uKCk6IEJhc2VNYW5pZmVzdFNldHRpbmdzIHtcblx0Ly8gXHRyZXR1cm4gb01hbmlmZXN0U2V0dGluZ3M7XG5cdC8vIH07XG5cblx0Y29uc3QgZ2V0QWJzb2x1dGVBbm5vdGF0aW9uUGF0aCA9IGZ1bmN0aW9uKHNBbm5vdGF0aW9uUGF0aDogc3RyaW5nKTogc3RyaW5nIHtcblx0XHRpZiAoc0Fubm90YXRpb25QYXRoWzBdID09PSBcIi9cIikge1xuXHRcdFx0cmV0dXJuIHNBbm5vdGF0aW9uUGF0aDtcblx0XHR9XG5cdFx0cmV0dXJuIG9CYXNlQ29udGV4dC5nZXRQYXRoKHNBbm5vdGF0aW9uUGF0aCk7XG5cdH07XG5cblx0Y29uc3QgZ2V0RW50aXR5U2V0ID0gZnVuY3Rpb24oKTogRW50aXR5U2V0IHtcblx0XHRyZXR1cm4gY3VycmVudEVudGl0eVNldDtcblx0fTtcblxuXHRjb25zdCBnZXRFbnRpdHlTZXRGb3JFbnRpdHlUeXBlID0gZnVuY3Rpb24oZW50aXR5VHlwZTogRW50aXR5VHlwZSk6IEVudGl0eVNldCB8IHVuZGVmaW5lZCB7XG5cdFx0cmV0dXJuIG9Db252ZXJ0ZWRUeXBlcy5lbnRpdHlTZXRzLmZpbmQoZW50aXR5U2V0ID0+IGVudGl0eVNldC5lbnRpdHlUeXBlID09PSBlbnRpdHlUeXBlKTtcblx0fTtcblxuXHRjb25zdCBnZXRFbnRpdHlUeXBlQW5ub3RhdGlvbiA9IGZ1bmN0aW9uKGFubm90YXRpb25QYXRoOiBzdHJpbmcpOiBBbnlBbm5vdGF0aW9uIHtcblx0XHRpZiAoYW5ub3RhdGlvblBhdGguaW5kZXhPZihcIkBcIikgPT09IC0xKSB7XG5cdFx0XHRhbm5vdGF0aW9uUGF0aCA9IFwiQFwiICsgYW5ub3RhdGlvblBhdGg7XG5cdFx0fVxuXHRcdHJldHVybiBjdXJyZW50RW50aXR5U2V0LmVudGl0eVR5cGUucmVzb2x2ZVBhdGgoYW5ub3RhdGlvblBhdGgpO1xuXHR9O1xuXG5cdGNvbnN0IGdldEFubm90YXRpb25QYXRoRnJvbUZ1bGx5UXVhbGlmaWVkTmFtZSA9IGZ1bmN0aW9uKGZ1bGx5UXVhbGlmaWVkTmFtZTogc3RyaW5nKTogc3RyaW5nIHtcblx0XHRjb25zdCB0YXJnZXRFbnRpdHlUeXBlID0gZ2V0RW50aXR5VHlwZUZyb21GdWxseVF1YWxpZmllZE5hbWUoZnVsbHlRdWFsaWZpZWROYW1lKTtcblx0XHRpZiAoIXRhcmdldEVudGl0eVR5cGUpIHtcblx0XHRcdHJldHVybiBmdWxseVF1YWxpZmllZE5hbWU7XG5cdFx0fSBlbHNlIHtcblx0XHRcdGNvbnN0IHRhcmdldEVudGl0eVNldCA9IGdldEVudGl0eVNldEZvckVudGl0eVR5cGUodGFyZ2V0RW50aXR5VHlwZSk7XG5cdFx0XHRpZiAoIXRhcmdldEVudGl0eVNldCkge1xuXHRcdFx0XHRyZXR1cm4gZnVsbHlRdWFsaWZpZWROYW1lO1xuXHRcdFx0fVxuXHRcdFx0cmV0dXJuIGZ1bGx5UXVhbGlmaWVkTmFtZS5yZXBsYWNlKHRhcmdldEVudGl0eVR5cGUuZnVsbHlRdWFsaWZpZWROYW1lLCBcIi9cIiArIHRhcmdldEVudGl0eVNldC5uYW1lICsgXCIvXCIpO1xuXHRcdH1cblx0fTtcblxuXHRjb25zdCBnZXRUZW1wbGF0ZUNvbnZlcnRlclR5cGUgPSBmdW5jdGlvbigpOiBUZW1wbGF0ZUNvbnZlcnRlclR5cGUge1xuXHRcdHJldHVybiB0ZW1wbGF0ZVR5cGU7XG5cdH07XG5cblx0Y29uc3QgZ2V0UmVsYXRpdmVBbm5vdGF0aW9uUGF0aCA9IGZ1bmN0aW9uKGFubm90YXRpb25QYXRoOiBzdHJpbmcsIGVudGl0eVR5cGU6IEVudGl0eVR5cGUpOiBzdHJpbmcge1xuXHRcdHJldHVybiBhbm5vdGF0aW9uUGF0aC5yZXBsYWNlKGVudGl0eVR5cGUuZnVsbHlRdWFsaWZpZWROYW1lLCBcIlwiKTtcblx0fTtcblxuXHRjb25zdCBnZXRFbnRpdHlTZXRCYXNlZEFubm90YXRpb25QYXRoID0gZnVuY3Rpb24oYW5ub3RhdGlvblBhdGg6IHN0cmluZyk6IHN0cmluZyB7XG5cdFx0Y29uc3QgZW50aXR5VHlwZUZRTiA9IGN1cnJlbnRFbnRpdHlTZXQuZW50aXR5VHlwZS5mdWxseVF1YWxpZmllZE5hbWU7XG5cdFx0cmV0dXJuIFwiL1wiICsgYW5ub3RhdGlvblBhdGgucmVwbGFjZShlbnRpdHlUeXBlRlFOLCBjdXJyZW50RW50aXR5U2V0Lm5hbWUgKyBcIi9cIik7XG5cdH07XG5cblx0Y29uc3QgZ2V0TWFuaWZlc3RXcmFwcGVyID0gZnVuY3Rpb24oKTogTWFuaWZlc3RXcmFwcGVyIHtcblx0XHRyZXR1cm4gb01hbmlmZXN0V3JhcHBlcjtcblx0fTtcblxuXHRyZXR1cm4ge1xuXHRcdGdldEJpbmRpbmdFeHByZXNzaW9uLFxuXHRcdGdldEludmVyc2VCaW5kaW5nRXhwcmVzc2lvbixcblx0XHRnZXRBbm5vdGF0aW9uRW50aXR5VHlwZSxcblx0XHRnZXRNYW5pZmVzdENvbnRyb2xDb25maWd1cmF0aW9uLFxuXHRcdGdldEFic29sdXRlQW5ub3RhdGlvblBhdGgsXG5cdFx0Z2V0QW5ub3RhdGlvblBhdGhGcm9tRnVsbHlRdWFsaWZpZWROYW1lLFxuXHRcdGdldEVudGl0eVNldCxcblx0XHRnZXRFbnRpdHlTZXRGb3JFbnRpdHlUeXBlLFxuXHRcdGdldEVudGl0eVR5cGVBbm5vdGF0aW9uLFxuXHRcdGdldFRlbXBsYXRlQ29udmVydGVyVHlwZSxcblx0XHRnZXRSZWxhdGl2ZUFubm90YXRpb25QYXRoLFxuXHRcdGdldEVudGl0eVNldEJhc2VkQW5ub3RhdGlvblBhdGgsXG5cdFx0Z2V0TWFuaWZlc3RXcmFwcGVyXG5cdH07XG59XG5cbi8qKlxuICogQ3JlYXRlIHRoZSBjb252ZXJ0ZXIgY29udGV4dCBuZWNlc3NhcnkgZm9yIGEgbWFjcm8gYmFzZWQgb24gYSBtZXRhbW9kZWwgY29udGV4dC5cbiAqXG4gKiBAcGFyYW0gc0VudGl0eVNldE5hbWVcbiAqIEBwYXJhbSBvTWV0YU1vZGVsQ29udGV4dFxuICogQHBhcmFtIHNUZW1wbGF0ZVR5cGVcbiAqIEByZXR1cm5zIHtDb252ZXJ0ZXJDb250ZXh0fSB0aGUgY3VycmVudCBjb252ZXJ0ZXIgY29udGV4dFxuICovXG5leHBvcnQgZnVuY3Rpb24gY3JlYXRlQ29udmVydGVyQ29udGV4dEZvck1hY3JvKFxuXHRzRW50aXR5U2V0TmFtZTogc3RyaW5nLFxuXHRvTWV0YU1vZGVsQ29udGV4dDogQ29udGV4dCxcblx0c1RlbXBsYXRlVHlwZTogVGVtcGxhdGVDb252ZXJ0ZXJUeXBlXG4pOiBDb252ZXJ0ZXJDb250ZXh0IHtcblx0Y29uc3Qgb0NvbnZlcnRlck91dHB1dCA9IGNvbnZlcnRUeXBlcygob01ldGFNb2RlbENvbnRleHQuZ2V0TW9kZWwoKSBhcyB1bmtub3duKSBhcyBPRGF0YU1ldGFNb2RlbCk7XG5cdGNvbnN0IHRhcmdldEVudGl0eVNldCA9IG9Db252ZXJ0ZXJPdXRwdXQuZW50aXR5U2V0cy5maW5kKGVudGl0eVNldCA9PiBlbnRpdHlTZXQubmFtZSA9PT0gc0VudGl0eVNldE5hbWUpIGFzIEVudGl0eVNldDtcblx0cmV0dXJuIGNyZWF0ZUNvbnZlcnRlckNvbnRleHQob0NvbnZlcnRlck91dHB1dCwgb01ldGFNb2RlbENvbnRleHQsIHt9IGFzIEJhc2VNYW5pZmVzdFNldHRpbmdzLCB0YXJnZXRFbnRpdHlTZXQsIHNUZW1wbGF0ZVR5cGUpO1xufVxuIl19