/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)
        (c) Copyright 2009-2020 SAP SE. All rights reserved
    
 */
sap.ui.define(["sap/ui/mdc/p13n/StateUtil","sap/ui/base/Object","sap/fe/core/library","sap/fe/navigation/library","sap/fe/core/CommonUtils","sap/ui/fl/apply/api/ControlVariantApplyAPI","sap/base/Log","sap/base/util/merge"],function(S,B,C,N,a,b,L,m){"use strict";var c=N.NavType,V=C.VariantManagement;return B.extend("sap.fe.core.AppStateHandler",{constructor:function(){this.bIsAppStateReady=false;this.sNavType=null;this.bNoRouteChange=false;this.bIsInitialSearch=false;this.mInnerAppDataForFCL={};this.mInnerAppDataForLR={};this.mInnerAppDataForOP={};this.getAppData=Promise.resolve();L.info("APPSTATE : Appstate handler initialized");return B.apply(this,arguments);},createAppState:function(o,e){var d=o.getOwnerComponent();this.bNoRouteChange=false;if(this._isListBasedComponent(d)&&this._getIsAppStateReady()){this._fnCreateAppStateForLR(o,e);L.info("APPSTATE: AppState for LR created");}else if(d.isA("sap.fe.templates.ObjectPage.Component")&&this._getIsAppStateReady()){this._fnCreateAppStateForOP(o,e);L.info("APPSTATE: AppState for OP created");}},applyAppState:function(o){var t=this;var A=a.getAppComponent(o.getView());t._setIsAppStateReady(false,o);var n=A.getNavigationService();t.getAppData=n.parseNavigation().done(function(d,s,e){L.info("APPSTATE: Parse Navigation is done");t.sNavType=e;if(e){t._applyAppStateToPage(o,d,s,e);}else{t._setIsAppStateReady(true,o);L.info("APPSTATE: Set Appstate ready is done after navtype is null");}}).fail(function(){L.info("APPSTATE: Parse Navigation is failed");t._setIsAppStateReady(true,o);L.info("APPSTATE: Set Appstate ready is done after parsenavigation fails");});},_applyAppStateToPage:function(o,A,s,n){var t=this,d,f,e=a.getAppComponent(o.getView()),M=e.getMetaModel(),v=o.getView().getViewData(),E=v.entitySet,g=o.getOwnerComponent();if(n!==c.iAppState&&this._isListBasedComponent(g)){d={};f=o.getView().byId(o.getView().getContent()[0].data("filterBarId"));if(A.oSelectionVariant){L.info("APPSTATE: selection variant is present");var h=a.getMandatoryFilterFields(M,E);a.addDefaultDisplayCurrency(h,A);a.addSelectionVariantToConditions(A.oSelectionVariant,d,M,E);var i,j;switch(o.getView().getViewData().variantManagement){case V.Page:L.info("APPSTATE: Entered Page level VM for applyappstatetopage");i=o.getView().byId("fe::PageVariantManagement");if(A.bNavSelVarHasDefaultsOnly){j=i.getDefaultVariantKey();}else{j=i.getStandardVariantKey();}if(j===null){j=i.getId();}b.activateVariant({element:e,variantReference:j}).then(function(){L.info("APPSTATE: Activate variant done");if(!(A.bNavSelVarHasDefaultsOnly&&i.getDefaultVariantKey()!==i.getStandardVariantKey())){t._fnClearFilterAndReplaceWithAppState(d,o,f,i);L.info("APPSTATE: _fnClearFilterAndReplaceWithAppState done");}else{t._setIsAppStateReady(true,o);L.info("APPSTATE: _setIsAppStateReady done");}}).catch(function(k){L.error("APPSTATE: Activate variant error",k);});break;case V.Control:L.info("APPSTATE: Entered Control level VM for applyappstatetopage");i=o.getView().byId(o.getView().getContent()[0].data("filterBarVariantId"));if(A.bNavSelVarHasDefaultsOnly){j=i.getDefaultVariantKey();}else{j=i.getStandardVariantKey();}if(j===null){j=i.getId();}b.activateVariant({element:e,variantReference:j}).then(function(){L.info("APPSTATE: Activate variant done");if(!(A.bNavSelVarHasDefaultsOnly&&i.getDefaultVariantKey()!==i.getStandardVariantKey())){t._fnClearFilterAndReplaceWithAppState(d,o,f,i);L.info("APPSTATE: _fnClearFilterAndReplaceWithAppState done");}else{t._setIsAppStateReady(true,o);L.info("APPSTATE: _setIsAppStateReady done");}}).catch(function(){L.info("APPSTATE: Activate variant failed");t._setIsAppStateReady(true,o);L.info("APPSTATE: _setIsAppStateReady done");});break;case V.None:L.info("APPSTATE: Entered None VM for applyappstatetopage");t._fnClearFilterAndReplaceWithAppState(d,o,f);L.info("APPSTATE: _fnClearFilterAndReplaceWithAppState done");break;default:t._fnClearFilterAndReplaceWithAppState(d,o,f);L.error("Variant Management not correctly defined, variable wrongly set to: "+o.getView().getViewData().variantManagement);break;}}else{t._setIsAppStateReady(true,o);L.info("APPSTATE: _setIsAppStateReady for no selection variant is done");}}else if(this._isListBasedComponent(g)){L.info("APPSTATE: Applying appstate to LR");this._fnApplyAppStatetoLR(o,A);}else{L.info("APPSTATE: Applying appstate to OP");this._fnApplyAppStatetoOP(o,A);}},createKeyForAppStateData:function(v,e,s){var k="";k=k+v+"_"+e[0]+"/";if(e.length>1){for(var i=1;i<e.length;i++){k=k+e[i]+"/";}}k=k+s;return k;},_setIsAppStateReady:function(i,o,g){this.bIsAppStateReady=i;if(o&&this._isListBasedComponent(o.getOwnerComponent())&&i){L.info("APPSTATE: LR component for _setIsAppstateReady");var n=this._getNavType();if(n!==null&&n!==c.iAppState){this.createAppState(o);}var f=o.getView().byId(o.getView().getContent()[0].data("filterBarId"));var h=o.getView().getViewData().variantManagement===V.None;var I=h&&o.getView().getViewData().initialLoad;var l=o.getView().getViewData().liveMode;f.setSuspendSelection(false);if(!l&&(g||n===c.xAppState||n===c.URLParams||(n===c.initial&&I)||(n===null&&I))){if(n===c.iAppState){this.bIsInitialSearch=true;}this._triggerSearch(f);L.info("APPSTATE: Search is triggered");}}},_getIsAppStateReady:function(){return this.bIsAppStateReady;},_triggerSearch:function(f){f.triggerSearch();},removeSensitiveDataForIAppState:function(d,M,e){var p;var k="LR_"+e+"/FilterBar";var f=d.appState[k].filter;var K=Object.keys(f);K.map(function(P){if(P!=="$editState"){p=M&&M.getObject("/"+e+"/"+P+"@");if(p){if(p["@com.sap.vocabularies.PersonalData.v1.IsPotentiallySensitive"]||p["@com.sap.vocabularies.UI.v1.ExcludeFromNavigationContext"]||p["@com.sap.vocabularies.Analytics.v1.Measure"]){delete f[P];}}}});d.appState[k].filter=f;L.info("APPSTATE: Returning non sensitive data");return d;},_fnCreateAppStateForLR:function(o,e){var t=this;return new Promise(function(r){var A=a.getAppComponent(o.getView());var v=o.getView().getViewData();var M=o.getView().getModel();var d=M&&M.getMetaModel();var E=v.entitySet;var i=A.getRootViewController().isFclEnabled();var R=A.getRouterProxy();var h=R.getHash();var T="LR";var f=t.createKeyForAppStateData(T,[E],"FilterBar");var I={};if(i){t.mInnerAppDataForFCL=t.mInnerAppDataForFCL||{};I=m({},t.mInnerAppDataForFCL);}if(o._isMultiMode()){var s=t.createKeyForAppStateData(T,[E],"TabBar");var g=o._getMultiModeControl();I[s]={selectedKey:g.getSelectedKey()};}var j,k,l,n,p;var F=o.getView().byId(o.getView().getContent()[0].data("filterBarId"));S.retrieveExternalState(F).then(function(q){L.info("APPSTATE: Retrieve external state done");var u=A.getNavigationService();L.info("APPSTATE: Get navigation service done");I[f]=q;switch(o.getView().getViewData().variantManagement){case V.Page:L.info("APPSTATE: Page level VM for createappstate for LR");l=o.getView().byId("fe::PageVariantManagement");j=t.createKeyForAppStateData(T,[E],"Variant");var w=l.getModified()?l.getStandardVariantKey():l.getCurrentVariantKey();w=t.fnCheckForNullVariantId(l,w);I[j]={"variantId":w};break;case V.Control:L.info("APPSTATE: Control level VM for createappstate for LR");k=t.createKeyForAppStateData(T,[E],"@UI.LineItem");n=o.getView().byId(o.getView().getContent()[0].data("filterBarVariantId"));p=o._getCurrentTable().getVariant();var x=p.getCurrentVariantKey();x=t.fnCheckForNullVariantId(p,x);var y=n.getModified()?n.getStandardVariantKey():n.getCurrentVariantKey();y=t.fnCheckForNullVariantId(n,y);I[f].variantId=y;I[k]={"variantId":x};break;case V.None:L.info("APPSTATE: None level VM for createappstate for LR");break;default:L.error("Variant Management not correctly defined, variable wrongly set to: "+o.getView().getViewData().variantManagement);break;}if(v.liveMode===false){if(e&&(e.getId()==="search"||e.getSource().getMetadata().getName()==="sap.m.IconTabBar")){I[f].GoPressed=true;}else if(e&&e.getSource().getId().indexOf("::LineItem::VM")>-1){if(i){I[f].GoPressed=t.mInnerAppDataForFCL[f].GoPressed;}else{I[f].GoPressed=t.mInnerAppDataForLR[f].GoPressed;}}else if(e){I[f].GoPressed=false;}else{I[f].GoPressed=v.variantManagement===V.None&&v.initialLoad;}}var z={appState:I};z=t.removeSensitiveDataForIAppState(z,d,E,i);var D=u.storeInnerAppStateWithImmediateReturn(z,true,E,true);L.info("APPSTATE: Appstate stored for LR");var G=D.appStateKey;var H=u.replaceInnerAppStateKey(h,G);R.navToHash(H);L.info("APPSTATE: navToHash for LR");if(i){t.mInnerAppDataForFCL=m({},I);}else{t.mInnerAppDataForLR=m({},I);}r({appState:I});}).catch(function(q){L.info("APPSTATE: Retrieve External State failed",q);L.warning("Retrieve External State failed");if(t._getIsAppStateReady()===false){t._setIsAppStateReady(true,o);L.info("APPSTATE: _setIsAppStateReady for Retrieve External State failed is done");}});});},_fnCreateAppStateForOP:function(o,e){var t=this;return new Promise(function(r,d){var A=a.getAppComponent(o.getView());var v=o.getView().getViewData();var E=v.entitySet;var i=A.getRootViewController().isFclEnabled();var R=A.getRouterProxy();var h=R.getHash();var s;var n;var T="OP";var f=t.createKeyForAppStateData(T,[E],"Section");var l=m({},e);var g=A.getNavigationService();var I={};if(i){I=m({},t.mInnerAppDataForFCL);}else{I=m({},t.mInnerAppDataForOP);}if(l&&l.getSource().isA("sap.uxap.ObjectPageLayout")){s=l.getParameter("section").getId();I[f]={"selectedSection":s};L.info("APPSTATE: section store for createappstate for OP done");}if(l&&l.getSource().isA("sap.ui.fl.variants.VariantManagement")){var j=l.getSource().getId().split("::VM")[0];n=o.getView().byId(j).getRowsBindingInfo().path;var q="";if(j.indexOf("LineItem::")>-1){q=j.split("::")[j.split("::").length-1];}var k;if(q){k=t.createKeyForAppStateData(T,[E,n],"@UI.LineItem#"+q);}else{k=t.createKeyForAppStateData(T,[E,n],"@UI.LineItem");}var p=l.getSource().getCurrentVariantKey();p=t.fnCheckForNullVariantId(l.getSource(),p);I[k]={"variantId":p};L.info("APPSTATE: variant store for createappstate for OP done");}var u={appState:I};var w=g.storeInnerAppStateWithImmediateReturn(u,true,E,true);L.info("APPSTATE: appstate store for createappstate for OP done");var x=w.appStateKey;var y=g.replaceInnerAppStateKey(h,x);if(y!==h){R.navToHash(y);L.info("APPSTATE: hash change for createappstate for OP done");t.bNoRouteChange=true;}if(i){t.mInnerAppDataForFCL=m({},I);}else{t.mInnerAppDataForOP=m({},I);}r(u);});},_fnApplyAppStatetoLR:function(o,A){var t=this,T,f,d=a.getAppComponent(o.getView()),v=o.getView().getViewData(),e=v.entitySet,i=d.getRootViewController().isFclEnabled();if(i){L.info("APPSTATE: _fnApplyAppStatetoLR for FCL app ");if(A&&A.appState){t.mInnerAppDataForFCL=m({},A.appState,t.mInnerAppDataForFCL);}}else if(A&&A.appState){L.info("APPSTATE: _fnApplyAppStatetoLR for non-FCL app ");t.mInnerAppDataForLR=m({},A.appState,t.mInnerAppDataForLR);}T="LR";var F=t.createKeyForAppStateData(T,[e],"FilterBar");var s,g;f=o.getView().byId(o.getView().getContent()[0].data("filterBarId"));var h;if(A&&A.appState){if(o._isMultiMode()){var j=t.createKeyForAppStateData(T,[e],"TabBar");var k=o._getMultiModeControl();if(k&&A.appState[j]){k.setSelectedKey(A.appState[j].selectedKey);o._updateTableControl();o._updateMultiTableHiddenStatus();}}L.info("APPSTATE: appstate present");switch(o.getView().getViewData().variantManagement){case V.Page:L.info("APPSTATE: Page level VM for _fnApplyAppStatetoLR");h=o.getView().byId("fe::PageVariantManagement");s=t.createKeyForAppStateData(T,[e],"Variant");if(A.appState[s]&&A.appState[s].variantId){L.info("APPSTATE: variant id is present");b.activateVariant({element:d,variantReference:A.appState[s].variantId}).then(function(){L.info("APPSTATE: Variant applied");t._fnClearFilterAndReplaceWithAppState(A.appState[F].filter,o,f,h,A.appState[F].GoPressed);L.info("APPSTATE: _fnClearFilterAndReplaceWithAppState done");}).catch(function(){L.info("APPSTATE: Variant not applied");t._fnClearFilterAndReplaceWithAppState(A.appState[F].filter,o,f,h,A.appState[F].GoPressed);L.info("APPSTATE: _fnClearFilterAndReplaceWithAppState done");});}else{L.info("APPSTATE: variant id is not present");if(A.appState[F]&&A.appState[F].filter){L.info("APPSTATE: filter is present");t._fnClearFilterAndReplaceWithAppState(A.appState[F].filter,o,f,h,A.appState[F].GoPressed);L.info("APPSTATE: _fnClearFilterAndReplaceWithAppState done");}}break;case V.Control:L.info("APPSTATE: Control level VM for _fnApplyAppStatetoLR");h=o.getView().byId(o.getView().getContent()[0].data("filterBarVariantId"));g=t.createKeyForAppStateData(T,[e],"@UI.LineItem");if(A.appState[F]&&A.appState[F].variantId&&A.appState[g]&&A.appState[g].variantId){L.info("APPSTATE: variant id is present");Promise.all([b.activateVariant({element:d,variantReference:A.appState[F].variantId}),b.activateVariant({element:d,variantReference:A.appState[g].variantId})]).then(function(){L.info("APPSTATE: Variant applied");t._fnClearFilterAndReplaceWithAppState(A.appState[F].filter,o,f,h,A.appState[F].GoPressed);L.info("APPSTATE: _fnClearFilterAndReplaceWithAppState done");}).catch(function(){L.info("APPSTATE: Variant not applied");t._fnClearFilterAndReplaceWithAppState(A.appState[F].filter,o,f,h,A.appState[F].GoPressed);L.info("APPSTATE: _fnClearFilterAndReplaceWithAppState done");});}else{L.info("APPSTATE: variant id is not present");if(A.appState[F]&&A.appState[F].filter){L.info("APPSTATE: filter is present");t._fnClearFilterAndReplaceWithAppState(A.appState[F].filter,o,f,h,A.appState[F].GoPressed);L.info("APPSTATE: _fnClearFilterAndReplaceWithAppState done");}}break;case V.None:L.info("APPSTATE: None VM for _fnApplyAppStatetoLR");if(A.appState[F]&&A.appState[F].filter){L.info("APPSTATE: filter is present");S.applyExternalState(f,{filter:A.appState[F].filter}).then(function(){L.info("APPSTATE: applyExternalState done");t._setIsAppStateReady(true,o,A.appState[F].GoPressed);L.info("APPSTATE: _setIsAppStateReady done");}).catch(function(){L.info("APPSTATE: applyExternalState fail");t._setIsAppStateReady(true,o,A.appState[F].GoPressed);L.info("APPSTATE: _setIsAppStateReady done");});}break;default:t._fnClearFilterAndReplaceWithAppState(A.appState[F].filter,o,f);L.error("Variant Management not correctly defined, variable wrongly set to: "+o.getView().getViewData().variantManagement);break;}}},_fnApplyAppStatetoOP:function(o,A){var t=this,T,d=a.getAppComponent(o.getView()),v=o.getView().getViewData(),e=v.entitySet,I=d.getRootViewController().isFclEnabled();T="OP";if(I){if(A&&A.appState){t.mInnerAppDataForFCL=m({},A.appState,t.mInnerAppDataForFCL);}}else if(A&&A.appState){t.mInnerAppDataForOP=m({},A.appState,t.mInnerAppDataForOP);}var f=o._findTables();var s=t.createKeyForAppStateData(T,[e],"Section");var O=o.getView().byId("fe::ObjectPage");var g=(A&&A.appState&&Object.keys(A.appState))||[];var h=[];var q,k,n;var r=function(){for(var j=0;j<f.length;j++){if(f[j].getRowsBindingInfo().path===n){var u=f[j].getId();if(q){if(u.indexOf("LineItem::")>-1&&u.split("::")[u.split("::").length-1]===q){k=f[j];break;}}else if(f[j].getId().indexOf("LineItem::")===-1){k=f[j];break;}}}};var l=function(){if(A&&A.appState&&A.appState[s]){L.info("APPSTATE: section is present");O.setSelectedSection(A.appState[s].selectedSection);t._setIsAppStateReady(true);L.info("APPSTATE: _setIsAppStateReady done");}else{L.info("APPSTATE: section is not present");t._setIsAppStateReady(true);L.info("APPSTATE: _setIsAppStateReady done");}};for(var i=0;i<g.length;i++){if(g[i].indexOf("OP_"+e)>-1&&g[i].indexOf("@UI.LineItem")>-1){var p=g[i];n=g[i].split("/")[g[i].split("/").length-2];if(p.indexOf("#")>-1){q=p.split("#")[1];r();}else{r();}if(k){h.push(b.activateVariant({element:k,variantReference:A.appState[p].variantId}));}}}if(h.length){L.info("APPSTATE: variant is present");Promise.all(h).then(function(){L.info("APPSTATE: variant is applied");l();L.info("APPSTATE: fnApplySectionAndSetAppStateReady done");}).catch(function(){L.info("APPSTATE: variant is not applied");l();L.info("APPSTATE: fnApplySectionAndSetAppStateReady done");});}else{L.info("APPSTATE: variant is not present");l();L.info("APPSTATE: fnApplySectionAndSetAppStateReady done");}},_fnClearFilterAndReplaceWithAppState:function(o,d,f,v,G){var A=a.getAppComponent(d.getView()),M=A.getMetaModel(),e=d.getView().getViewData(),E=e.entitySet;var g=M.getObject("/"+E+"/");var t=this;var h={};var O;for(var k in g){O=g[k];if(O){if(O.$kind==="Property"){if(t.sNavType===c.iAppState&&!a.isPropertyFilterable(M,"/"+E,k,false)){continue;}h[k]=[];}}}S.applyExternalState(f,{filter:h}).then(function(){L.info("APPSTATE: applyExternalState done for clear conditions");var s={filter:o};s.items=Object.keys(o).reduce(function(i,p){if(!M.getObject("/"+E+"/"+p+"@com.sap.vocabularies.UI.v1.HiddenFilter")){i.push({name:p});}return i;},[]);S.applyExternalState(f,s).then(function(){L.info("APPSTATE: applyExternalState done for actual conditions");if(v&&v.getStandardVariantKey()!==v.getCurrentVariantKey()){L.info("APPSTATE: variant is not standard");v.setModified(false);L.info("APPSTATE: variant is modified as false");}t._setIsAppStateReady(true,d,G);L.info("APPSTATE: _setIsAppStateReady done");}).catch(function(){L.info("APPSTATE: applyExternalState failed for actual conditions");t._setIsAppStateReady(true,d,G);L.info("APPSTATE: _setIsAppStateReady done");});}).catch(function(i){L.info("APPSTATE: applyExternalState failed for clear conditions",i);});},_getNavType:function(){return this.sNavType;},checkIfRouteChangedByIApp:function(){return this.bNoRouteChange;},resetRouteChangedByIApp:function(){if(this.bNoRouteChange){this.bNoRouteChange=false;}},fnCheckForNullVariantId:function(v,s){if(s===null){s=v.getId();}return s;},_isListBasedComponent:function(o){return(o.isA("sap.fe.templates.ListReport.Component")||o.isA("sap.fe.templates.AnalyticalListPage.Component"));}});},true);
