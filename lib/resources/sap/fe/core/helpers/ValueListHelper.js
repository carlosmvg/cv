/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)
        (c) Copyright 2009-2020 SAP SE. All rights reserved
    
 */
sap.ui.define(["sap/ui/thirdparty/jquery","sap/ui/core/XMLTemplateProcessor","sap/ui/model/json/JSONModel","sap/ui/core/util/XMLPreprocessor","sap/ui/core/Fragment","sap/m/MessageToast","sap/ui/mdc/field/InParameter","sap/ui/mdc/field/OutParameter","sap/base/Log","sap/fe/core/CommonUtils"],function(q,X,J,a,F,M,I,O,L,C){"use strict";var w={};function _(v){return v.Parameters.some(function(p){return(p["@com.sap.vocabularies.UI.v1.Importance"]&&p["@com.sap.vocabularies.UI.v1.Importance"].$EnumMember==="com.sap.vocabularies.UI.v1.ImportanceType/High");});}function b(v){var c=v.valueListInfo.$model.getMetaModel().getObject("/"+v.valueListInfo.CollectionPath+"@")||{},s=c["@Org.OData.Capabilities.V1.SearchRestrictions"]&&c["@Org.OData.Capabilities.V1.SearchRestrictions"].Searchable;return s===undefined?true:s;}var V={getColumnVisibility:function(v,o){if(!_(v)){return undefined;}else if(o&&o["@com.sap.vocabularies.UI.v1.Importance"]&&o["@com.sap.vocabularies.UI.v1.Importance"].$EnumMember==="com.sap.vocabularies.UI.v1.ImportanceType/High"){return undefined;}else{return"{_VHUI>/showAllColumns}";}},hasImportance:function(v){return _(v.getObject())?"Importance/High":"None";},getMinScreenWidth:function(v){return _(v)?"{= ${_VHUI>/minScreenWidth}}":"416px";},getTableItemsParameters:function(v,r){var s,p="",m=v.$model.getMetaModel();v.Parameters.find(function(e){if(m.getObject("/"+v.CollectionPath+"/"+e.ValueListProperty+"@com.sap.vocabularies.Common.v1.Text@com.sap.vocabularies.UI.v1.TextArrangement/$EnumMember")==="com.sap.vocabularies.UI.v1.TextArrangementType/TextOnly"){s=m.getObject("/"+v.CollectionPath+"/"+e.ValueListProperty+"@com.sap.vocabularies.Common.v1.Text/$Path");}else{s=e.ValueListProperty;}return!(m.getObject("/"+v.CollectionPath+"/"+e.ValueListProperty+"@com.sap.vocabularies.UI.v1.Hidden")===true);});var S=v.Parameters.some(function(P){return P.$Type==="com.sap.vocabularies.Common.v1.ValueListParameterIn";});if(r){p=", parameters: { $$groupId: '"+r+"' }";}return("{path: '/"+v.CollectionPath+"'"+p+", suspended : "+S+", sorter: {path: '"+s+"', ascending: true}}");},getPropertyPath:function(p){return!p.UnboundAction?"/"+p.EntitySet+"/"+p.Action+"/"+p.Property:"/"+p.Action.substring(p.Action.lastIndexOf(".")+1)+"/"+p.Property;},getWaitForPromise:function(){return w;},getValueListCollectionEntitySet:function(v){var m=v.getObject();return m.$model.getMetaModel().createBindingContext("/"+m.CollectionPath);},getValueListProperty:function(p){var v=p.getModel();var m=v.getObject("/");return m.$model.getMetaModel().createBindingContext("/"+m.CollectionPath+"/"+p.getObject());},getValueListInfo:function(f,m,p,c){var k,d,s="",P=m.getObject(p+"@sapui.name"),e,i=[],o=[],g="";return m.requestValueListInfo(p,true).then(function(v){var h=f.getInParameters().length+f.getOutParameters().length===0;v=v[v[""]?"":Object.keys(v)[0]];v.Parameters.forEach(function(j){e="/"+v.CollectionPath+"/"+j.ValueListProperty;var l=v.$model.getMetaModel().getObject(e)||{},n=v.$model.getMetaModel().getObject(e+"@")||{};if(!k&&j.$Type.indexOf("Out")>48&&j.LocalDataProperty.$PropertyPath===P){g=e;k=j.ValueListProperty;d=n["@com.sap.vocabularies.Common.v1.Text"]&&n["@com.sap.vocabularies.Common.v1.Text"].$Path;}if(!s&&l.$Type==="Edm.String"&&!n["@com.sap.vocabularies.UI.v1.HiddenFilter"]&&!n["@com.sap.vocabularies.UI.v1.Hidden"]){s=s.length>0?s+","+j.ValueListProperty:j.ValueListProperty;}if(h&&j.$Type!=="com.sap.vocabularies.Common.v1.ValueListParameterDisplayOnly"&&j.LocalDataProperty.$PropertyPath!==P){var r="";if(c&&c.length>0){r=c+">/conditions/";}r="{"+r+j.LocalDataProperty.$PropertyPath+"}";if(j.$Type.indexOf("Out")>48){o.push(new O({value:r,helpPath:j.ValueListProperty}));}if(j.$Type.indexOf("In")>48){i.push(new I({value:r,helpPath:j.ValueListProperty}));}}});return{keyValue:k,descriptionValue:d,fieldPropertyPath:g,filters:s,inParameters:i,outParameters:o,valueListInfo:v};}).catch(function(h){var j=h.status&&h.status===404?"Metadata not found ("+h.status+") for value help of property "+p:h.message;L.error(j);M.show(j);});},createValueHelpDialog:function(p,f,t,o,v,s){var c=f.getMetadata().getName(),W=f.getContent&&f.getContent(),d=W.getId(),e=v.filters,i=v.inParameters,g=v.outParameters;if(!t){if(c.indexOf("FieldValueHelp")>-1){f.setTitle(v.valueListInfo.Label);f.setKeyPath(v.keyValue);f.setDescriptionPath(v.descriptionValue);f.setFilterFields(b(v)?"$search":"");}}function h(j){var k=X.loadTemplate(j,"fragment"),m=v.valueListInfo,l=new J(m),n=m.$model.getMetaModel(),S=new J({id:f.getId(),groupId:f.data("requestGroupId")||undefined});return Promise.resolve(a.process(k,{name:j},{bindingContexts:{valueList:l.createBindingContext("/"),entitySet:n.createBindingContext("/"+m.CollectionPath),source:S.createBindingContext("/")},models:{valueList:l,entitySet:n,source:S}})).then(function(k){var r={path:p,fragmentName:j,fragment:k};if(L.getLevel()===L.Level.DEBUG){V.ALLFRAGMENTS=V.ALLFRAGMENTS||[];V.ALLFRAGMENTS.push(r);}if(V.logFragment){setTimeout(function(){V.logFragment(r);},0);}return F.load({definition:k});});}t=t||h("sap.fe.macros.ValueListTable");if(e.length){o=o||(!s&&h("sap.fe.macros.ValueListFilterBar"));}else{o=Promise.resolve();}return Promise.all([t,o]).then(function(j){var t=j[0],o=j[1],k=o?o.getFilterItems():[];if(t){t.setModel(v.valueListInfo.$model);L.info("Value List XML content created ["+p+"]",t.getMetadata().getName(),"MDC Templating");}if(o&&k.length){o.setModel(v.valueListInfo.$model);L.info("Value List XML content created ["+p+"]",o.getMetadata().getName(),"MDC Templating");}if(t!==W.getTable()){W.setTable(t);delete w[d];}var l=s?"416px":"Auto";t.setContextualWidth(l);if(o&&o!==f.getFilterBar()&&k.length){f.setFilterBar(o);}else{f.addDependent(o);}g.forEach(function(m){f.addOutParameter(m);});i.forEach(function(m){f.addInParameter(m);});});},showValueListInfo:function(p,f,s,c){var m=f.getModel(),o=m.getMetaModel(),W=f.getContent&&f.getContent(),d=W.getId(),t=W&&W.getTable&&W.getTable(),e=f&&f.getFilterBar&&f.getFilterBar(),E=t&&e,v;if(!e&&f.getDependents().length>0){var P=f.getDependents()[0];if(P.isA("sap.ui.mdc.FilterBar")){e=P;}}v=f.getModel("_VHUI");if(!v){v=new J({});f.setModel(v,"_VHUI");}v.setProperty("/showAllColumns",!s);v.setProperty("/minScreenWidth",!s?"418px":undefined);if(w[d]||E){return w["promise"+d];}else{if(!t){w[d]=true;}var g=V.getValueListInfo(f,o,p,c).then(function(h){if(f.getParent().getMetadata().getName()==="sap.ui.mdc.Field"){var i,j,k=h.valueListInfo;i=k.$model.getMetaModel().getObject(h.fieldPropertyPath+"@")||{};j=k.$model.getMetaModel().getObject("/"+k.CollectionPath+"/$Type@")||{};var D=C.computeDisplayMode(i,j);f.getParent().setProperty("display",D);}return V.createValueHelpDialog(p,f,t,e,h,s);}).catch(function(h){var i=h.status&&h.status===404?"Metadata not found ("+h.status+") for value help of property "+p:h.message;L.error(i);M.show(i);});w["promise"+d]=g;return g;}},setValueListFilterFields:function(p,f,s,c){var m=f.getModel(),o=m.getMetaModel();return V.getValueListInfo(f,o,p,c).then(function(v){f.setFilterFields(b(v)?"$search":"");});}};return V;},true);
