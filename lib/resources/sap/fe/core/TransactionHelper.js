sap.ui.define(["sap/ui/base/Object","sap/fe/core/AnnotationHelper","sap/fe/core/actions/draft","sap/fe/core/actions/sticky","sap/fe/core/actions/operations","sap/fe/core/model/DraftModel","sap/ui/model/json/JSONModel","sap/fe/core/actions/messageHandling","sap/m/Popover","sap/m/VBox","sap/m/CheckBox","sap/m/Text","sap/m/Button","sap/m/MessageToast","sap/m/Dialog","sap/ui/model/BindingMode","sap/base/Log","sap/ui/core/message/Message","sap/fe/core/CommonUtils","sap/fe/core/BusyLocker","sap/fe/core/helpers/SideEffectsUtil","sap/ui/core/util/XMLPreprocessor","sap/ui/core/XMLTemplateProcessor","sap/ui/core/Fragment","sap/m/MessageBox"],function(B,A,d,s,o,D,J,m,P,V,C,T,a,M,b,c,L,e,f,g,S,X,h,F,j){"use strict";var k={DRAFT:"Draft",STICKY:"Sticky",NON_DRAFT:"NonDraft"};function l(p){if(p&&p.getMetadata&&p.getMetadata().getName()==="sap.ui.base.Event"){p={};}return p||{};}return B.extend("sap.fe.core.TransactionHelper",{_bIsModified:false,_bCreateMode:false,_oAppComponent:null,_oResourceBundle:null,initialize:function(i){this._oAppComponent=i;},destroy:function(){this.getUIStateModel().destroy();B.prototype.destroy.apply(this,arguments);},getProgrammingModel:function(i){var t=this;if(!this.sProgrammingModel){var n=i.getModel();return D.upgradeOnDemand(n).then(function(I){if(I){t.sProgrammingModel=k.DRAFT;}else{t.sProgrammingModel=A.isStickySessionSupported(n.getMetaModel())?k.STICKY:k.NON_DRAFT;}return t.sProgrammingModel;});}else{return Promise.resolve(this.sProgrammingModel);}},getUIStateModel:function(){if(!this.uiModel){this.uiModel=new J({editMode:"Display",busy:false,busyLocal:{},draftStatus:"Clear"});this.uiModel.setDefaultBindingMode(c.OneWay);}return this.uiModel;},setUIStateModel:function(u){this.uiModel=u;},isBusy:function(i,n){var u=this.getUIStateModel();return g.isLocked(u,i==="Global"?undefined:n);},busyHandler:function(i,n,O){var p=O?"lock":"unlock";if(i==="Global"||i==="Local"){g[p](this.getUIStateModel(),i==="Global"?"/busy":"/busyLocal/"+n);}},busyOn:function(i,n){this.busyHandler(i,n,true);},busyOff:function(i,n){this.busyHandler(i,n,false);},createDocument:function(i,p,r){var n,t=this,q,u,v=i.getModel(),w=v.getMetaModel(),x=w.getMetaPath(i.getHeaderContext().getPath()),N=!i.isRelative()&&(w.getObject(x+"@com.sap.vocabularies.Session.v1.StickySessionSupported/NewAction")||w.getObject(x+"@com.sap.vocabularies.Common.v1.DraftRoot/NewAction")),y,z={"$$patchWithoutSideEffects":true},E=w.getObject(x+"/@com.sap.vocabularies.Common.v1.Messages/$Path");if(E){z["$select"]=E;}p=l(p);if(!i){return Promise.reject("Binding required for new document creation");}if(p.busyMode==="Local"){u=i.sId;}q=!p.refreshList;t.busyOn(p.busyMode,u);var R=sap.ui.getCore().getLibraryResourceBundle("sap.fe.core");if(N){y=this.onCallAction(N,{contexts:i.getHeaderContext(),showActionParameterDialog:true,label:R.getText("C_TRANSACTION_HELPER_SAPFE_ACTION_CREATE"),bindingParameters:z,parentControl:p.parentControl,bIsCreateAction:true});}else{var I=p.creationMode!=="CreationRow"&&p.creationMode!=="Inline";var G=I?f.getNonComputedVisibleFields(w,x):[];if(G.length>0){var H=v.bindList(i.getPath(),i.getContext(),[],[],{$$updateGroupId:"submitLater",$$groupId:"submitLater"});H.refreshInternal=function(){};n=H.create(p.data,q);p.keepTransientContextOnFailed=true;y=this._launchDialogWithKeyFields(i,H,n,G,v,p);y.catch(function(){L.trace("transient creation context deleted");});}else{n=i.create(p.data,q,p.createAtEnd);t.onAfterCreateCompletion(i,n,p,R);y=n.created();}}return y.then(function(K){if(!i.isRelative()){t._bCreateMode=true;}n=n||(K&&K.response);if(K&&K.bConsiderDocumentModified){t.handleDocumentModifications();}return m.showUnboundMessages().then(function(){return n;});}).catch(function(K){return m.showUnboundMessages().then(function(){if(K&&K.bDeleteTransientContext&&n.isTransient()){n.delete("$direct");}return Promise.reject(K);});}).finally(function(){t.busyOff(p.busyMode,u);});},findActiveDraftRootContexts:function(i,n){if(!n){return Promise.resolve();}var p=i.reduce(function(r,q){var t=q.getModel().getMetaModel();var u=t.getMetaPath(q.getPath());if(t.getObject(u+"@com.sap.vocabularies.Common.v1.DraftRoot")){var I=q.getObject().IsActiveEntity,H=q.getObject().HasActiveEntity,v;if(!I&&H){v=q.getModel().bindContext(q.getPath()+"/SiblingEntity").getBoundContext();r.push(v);}}return r;},[]);return Promise.all(p.map(function(q){return q.requestCanonicalPath().then(function(){return q;});}));},afterDeleteProcess:function(i,p,n,q,r){if(i.getProperty("/$contexts/"+p.id+"/deleteEnabled")!=undefined){if(n.isCheckBoxVisible===true&&n.isCheckBoxSelected===false){i.setProperty("/$contexts/"+p.id+"/deleteEnabled",true);var t=Object.assign(i.getProperty("/$contexts/"+p.id),{});t.selectedContexts=t.selectedContexts.filter(function(u){return t.deletableContexts.indexOf(u)===-1;});t.deletableContexts=[];t.selectedContexts=[];t.numberOfSelectedContexts=t.selectedContexts.length;i.setProperty("/$contexts/"+p.id,t);}else{i.setProperty("/$contexts/"+p.id+"/deleteEnabled",false);i.setProperty("/$contexts/"+p.id+"/selectedContexts",[]);i.setProperty("/$contexts/"+p.id+"/numberOfSelectedContexts",0);}}if(q.length===1){M.show(f.getTranslatedText("C_TRANSACTION_HELPER_OBJECT_PAGE_DELETE_TOAST_SINGULAR",r,null,p.entitySetName));}else{M.show(f.getTranslatedText("C_TRANSACTION_HELPER_OBJECT_PAGE_DELETE_TOAST_PLURAL",r,null,p.entitySetName));}},deleteDocument:function(v,p,n,r){var u=this.getUIStateModel(),R,q,t=[],w=false,x=false,y=false,z,E=this;var G=sap.ui.getCore().getLibraryResourceBundle("sap.fe.core");var H,I={title:G.getText("C_COMMON_OBJECT_PAGE_DELETE")};g.lock(u);if(!Array.isArray(v)){v=[v];}this.getProgrammingModel(v[0]).then(function(K){if(p){if(!p.numberOfSelectedContexts){if(K==="Draft"){for(var i=0;i<v.length;i++){var N=v[i].getObject();if(N.IsActiveEntity===true&&N.HasDraftEntity===true&&N.DraftAdministrativeData&&N.DraftAdministrativeData.InProcessByUser){j.show(G.getText("C_TRANSACTION_HELPER_OBJECT_PAGE_CONFIRM_DELETE_WITH_SINGLE_OBJECT_LOCKED"),{title:G.getText("OBJECT_PAGE_DELETE"),onClose:R});return;}}}p=l(p);if(p.title){if(p.description){H=[p.title,p.description];I.text=f.getTranslatedText("C_TRANSACTION_HELPER_OBJECT_PAGE_CONFIRM_DELETE_WITH_OBJECTINFO",r,H,p.entitySetName);}else{I.text=f.getTranslatedText("C_TRANSACTION_HELPER_OBJECT_PAGE_CONFIRM_DELETE_WITH_OBJECTTITLE_SINGULAR",r,null,p.entitySetName);}}else{I.text=f.getTranslatedText("C_TRANSACTION_HELPER_OBJECT_PAGE_CONFIRM_GENERIC_DELETE",r);}t=v;}else{I={title:G.getText("OBJECT_PAGE_DELETE")};if(p.numberOfSelectedContexts===1&&p.numberOfSelectedContexts===v.length){t=v;I.text=f.getTranslatedText("C_TRANSACTION_HELPER_OBJECT_PAGE_CONFIRM_DELETE_WITH_OBJECTTITLE_SINGULAR",r,null,p.entitySetName);}else if(p.numberOfSelectedContexts===1&&p.unSavedContexts.length===1){t=p.unSavedContexts;var O=t[0].getObject()["DraftAdministrativeData"]?t[0].getObject()["DraftAdministrativeData"]["LastChangedByUserDescription"]:"";H=[O];I.text=f.getTranslatedText("C_TRANSACTION_HELPER_OBJECT_PAGE_CONFIRM_DELETE_WITH_UNSAVED_CHANGES",r,H);}else if(p.numberOfSelectedContexts===p.unSavedContexts.length){t=p.unSavedContexts;I.text=f.getTranslatedText("C_TRANSACTION_HELPER_OBJECT_PAGE_CONFIRM_DELETE_WITH_UNSAVED_CHANGES_MULTIPLE_OBJECTS",r);}else if(p.numberOfSelectedContexts===v.concat(p.unSavedContexts.concat(p.lockedContexts)).length){t=v.concat(p.unSavedContexts);I.text=t.length===1?f.getTranslatedText("C_TRANSACTION_HELPER_OBJECT_PAGE_CONFIRM_DELETE_WITH_OBJECTTITLE_SINGULAR",r,null,p.entitySetName):f.getTranslatedText("C_TRANSACTION_HELPER_OBJECT_PAGE_CONFIRM_DELETE_WITH_OBJECTTITLE_PLURAL",r,null,p.entitySetName);}else{t=v.concat(p.unSavedContexts);y=true;I.text=t.length===1?f.getTranslatedText("C_TRANSACTION_HELPER_OBJECT_PAGE_CONFIRM_DELETE_WITH_OBJECTTITLE_SINGULAR_NON_DELETABLE",r,null,p.entitySetName):f.getTranslatedText("C_TRANSACTION_HELPER_OBJECT_PAGE_CONFIRM_DELETE_WITH_OBJECTTITLE_PLURAL_NON_DELETABLE",r,null,p.entitySetName);I.nonDeletableText=f.getTranslatedText("C_TRANSACTION_HELPER_OBJECT_PAGE_CONFIRM_DELETE_WITH_OBJECTINFO_AND_FEW_OBJECTS_NON_DELETABLE",r,[p.numberOfSelectedContexts-v.concat(p.unSavedContexts).length,p.numberOfSelectedContexts]);}if(p.lockedContexts.length>0){x=true;I.nonDeletableText=f.getTranslatedText("C_TRANSACTION_HELPER_OBJECT_PAGE_CONFIRM_DELETE_WITH_OBJECTINFO_AND_FEW_OBJECTS_LOCKED",r,[p.lockedContexts.length,p.numberOfSelectedContexts]);}if(p.unSavedContexts.length>0&&p.unSavedContexts.length!==p.numberOfSelectedContexts){if((y||x)&&t.length===p.unSavedContexts.length){w=false;t=p.unSavedContexts;if(p.unSavedContexts.length===1){I.text=f.getTranslatedText("C_TRANSACTION_HELPER_OBJECT_PAGE_CONFIRM_DELETE_WITH_UNSAVED_AND_FEW_OBJECTS_LOCKED_SINGULAR",r);}else{I.text=f.getTranslatedText("C_TRANSACTION_HELPER_OBJECT_PAGE_CONFIRM_DELETE_WITH_UNSAVED_AND_FEW_OBJECTS_LOCKED_PLURAL",r);}}else{if(p.unSavedContexts.length===1){I.checkBoxText=f.getTranslatedText("C_TRANSACTION_HELPER_OBJECT_PAGE_CONFIRM_DELETE_WITH_OBJECTINFO_AND_FEW_OBJECTS_UNSAVED_SINGULAR",r);}else{I.checkBoxText=f.getTranslatedText("C_TRANSACTION_HELPER_OBJECT_PAGE_CONFIRM_DELETE_WITH_OBJECTINFO_AND_FEW_OBJECTS_UNSAVED_PLURAL",r);}w=true;}}if(y&&x){I.nonDeletableText=f.getTranslatedText("C_TRANSACTION_HELPER_OBJECT_PAGE_CONFIRM_DELETE_WITH_OBJECTINFO_AND_FEW_OBJECTS_LOCKED_AND_NON_DELETABLE",r,[p.numberOfSelectedContexts-v.concat(p.unSavedContexts).length-p.lockedContexts.length,p.lockedContexts.length,p.numberOfSelectedContexts]);}}}var Q=new V({items:[new T({text:I.nonDeletableText,visible:x||y}),new T({text:I.text}),new C({text:I.checkBoxText,selected:true,select:function(Y){var Z=Y.getSource().getSelected();if(Z){t=v.concat(p.unSavedContexts);z=true;}else{t=v;z=false;}},visible:w})]});var U=p.numberOfSelectedContexts?f.getTranslatedText("C_TRANSACTION_HELPER_OBJECT_PAGE_DELETE_DIALOG",r,[p.numberOfSelectedContexts]):G.getText("C_COMMON_OBJECT_PAGE_DELETE");var W=new b({title:U,state:"Warning",content:[Q],beginButton:new a({text:G.getText("C_COMMON_OBJECT_PAGE_DELETE"),type:"Emphasized",press:function(){g.lock(u);var Y=t;W.close();return E.findActiveDraftRootContexts(Y,p.bFindActiveContexts).then(function(Z){return Promise.all(Y.map(function($){return d.deleteDraft($).catch(function(_){return m.showUnboundMessages().then(function(){return Promise.reject();});});})).then(function(){var $={"isCheckBoxVisible":w,"isCheckBoxSelected":z};if(Z&&Z.length){return Promise.all(Z.map(function(_){return _.delete();})).then(function(){E.afterDeleteProcess(n,p,$,Y,r);return m.showUnboundMessages().then(q);});}else{E.afterDeleteProcess(n,p,$,Y,r);return m.showUnboundMessages().then(q);}});}).finally(function(){g.unlock(u);});}}),endButton:new a({text:f.getTranslatedText("C_COMMON_OBJECT_PAGE_CANCEL",r),press:function(){W.close();R();}}),afterClose:function(){W.destroy();}});W.addStyleClass("sapUiContentPadding");W.open();}).finally(function(){g.unlock(u);}).catch(function(){L.warning("Couldn't get Programming model");R();});return new Promise(function(i,K){R=K;q=i;});},editDocument:function(i,p,v){this._bIsModified=false;var t=this;var u=this.getUIStateModel();if(!i){return Promise.reject(new Error("Binding context to active document is required"));}g.lock(u);return this.getProgrammingModel(i).then(function(n){switch(n){case k.DRAFT:t.activeContext=i;return d.createDraftFromActiveDocument(i,{bPreserveChanges:true,bPrepareOnEdit:p,oView:v});case k.NON_DRAFT:return i;case k.STICKY:return s.editDocumentInStickySession(i);}}).then(function(n){u.setProperty("/editMode","Editable");u.setProperty("/isEditable",true);t._bCreateMode=false;return m.showUnboundMessages().then(function(){return n;});}).catch(function(n){return m.showUnboundMessages().then(function(){return Promise.reject(n);});}).finally(function(){g.unlock(u);});},updateDocument:function(){return Promise.resolve();},cancelDocument:function(i,p,r){var t=this,u=t.getUIStateModel(),n;if(!i){return Promise.reject("No context exists. Pass a meaningful context");}g.lock(u);p=l(p);var q=i,v=p.cancelButton,w=q.getModel(),x;return this.getProgrammingModel(i).then(function(y){n=y;if(y===k.DRAFT){var z=w.bindContext(q.getPath()+"/DraftAdministrativeData").getBoundContext();if(!t._bIsModified){return z.requestObject().then(function(E){t._bIsModified=!(E.CreationDateTime===E.LastChangeDateTime);});}}else if(y===k.NON_DRAFT){t._bIsModified=q.hasPendingChanges();}}).then(function(){return t._showDiscardPopover(v,t._bIsModified,r);}).then(function(){switch(n){case k.DRAFT:return q.requestObject("HasActiveEntity").then(function(H){var y;if(!H){if(q&&q.hasPendingChanges()){q.getBinding().resetChanges();}y=d.deleteDraft(q);return y;}else{var z=t.activeContext||w.bindContext(q.getPath()+"/SiblingEntity").getBoundContext();return z.requestCanonicalPath().then(function(E){x=E;if(q&&q.hasPendingChanges()){q.getBinding().resetChanges();}y=d.deleteDraft(q);return y;}).then(function(){if(z.getPath()!==x){z=w.bindContext(x).getBoundContext();}z.requestSideEffects([{$PropertyPath:"HasDraftEntity"},{$NavigationPropertyPath:"DraftAdministrativeData"}]);return z;});}});case k.STICKY:return s.discardDocument(i).then(function(i){if(i){if(i.hasPendingChanges()){i.getBinding().resetChanges();}if(!t._bCreateMode){i.refresh();return i;}}return false;});case k.NON_DRAFT:if(q===i&&t._bIsModified){i.getBinding().resetChanges();}break;}}).then(function(y){t._bIsModified=false;t._removeContextsFromPages();u.setProperty("/editMode","Display");u.setProperty("/isEditable",false);m.removeBoundTransitionMessages();return m.showUnboundMessages().then(function(){return y;});}).catch(function(y){return m.showUnboundMessages().then(function(){return Promise.reject(y);});}).finally(function(){g.unlock(u);});},saveDocument:function(i,r,E){var u=this.getUIStateModel(),n,t=this;if(!i){return Promise.reject(new Error("Binding context to draft document is required"));}m.removeBoundTransitionMessages();g.lock(u);return this.getProgrammingModel(i).then(function(p){switch(p){case k.DRAFT:return d.activateDocument(i);case k.STICKY:return s.activateDocument(i);case k.NON_DRAFT:n=i.getModel();n.submitBatch(n.getUpdateGroupId());return i;}}).then(function(p){t._bIsModified=false;t._removeContextsFromPages();u.setProperty("/editMode","Display");u.setProperty("/isEditable",false);M.show(f.getTranslatedText("C_TRANSACTION_HELPER_OBJECT_SAVED",r));return m.showUnboundMessages().then(function(){return p;});}).catch(function(p){var q=Array.isArray(i)?i[0].getBinding():null;if(!f.hasTransientContext(q)&&E){S.requestSideEffects(q.getPath(),i);}return m.showUnboundMessages().then(function(){return Promise.reject(p);});}).finally(function(){g.unlock(u);});},onCallAction:function(n,p){p=l(p);var u=this.getUIStateModel(),t=this,q,r,v,N,w=p.bindingParameters;if(!n){return Promise.reject("Provide name of action to be executed");}N=n.split("/")[1];n=N||n;q=N?undefined:p.contexts;if(q&&((Array.isArray(q)&&q.length)||!Array.isArray(q))){q=Array.isArray(q)?q[0]:q;r=q.getModel();}if(p.model){r=p.model;}if(!r){return Promise.reject("Pass a context for a bound action or pass the model for an unbound action");}var x=t._getBindingParameters(n,q)||{},y=t._getAppComponent();if(q&&r){v=new Promise(function(z,E){var G;var H={onClose:function(){G.close();z();},onContinue:function(){G.close();z(p.applicableContext);}};var O=function(){var W,Y=p.notApplicableContext.length,Z=[];for(var i=0;i<p.notApplicableContext.length;i++){W=p.notApplicableContext[i].getObject();Z.push(W);}var $=new J(Z);var _=new J({total:Y,label:p.label});G.setModel($,"notApplicable");G.setModel(_,"totals");G.open();};if(p.notApplicableContext&&p.notApplicableContext.length>=1){var I="sap.fe.core.controls.ActionPartial";var K=h.loadTemplate(I,"fragment");var Q=r.getMetaModel();var R=p.contexts[0].getCanonicalPath();var U=R.substr(0,R.indexOf("("))+"/";Promise.resolve(X.process(K,{name:I},{bindingContexts:{entityType:Q.createBindingContext(U)},models:{entityType:Q}})).then(function(i){return F.load({definition:i,controller:H});}).then(function(i){G=i;p.parentControl.addDependent(i);O();}).catch(E);}else{z(p.contexts);}}).then(function(i){if(i){return o.callBoundAction(n,i,r,{invocationGrouping:p.invocationGrouping,label:p.label,showActionParameterDialog:true,mBindingParameters:w,entitySetName:p.entitySetName,additionalSideEffect:x,onSubmitted:function(){g.lock(u);},onResponse:function(){g.unlock(u);},parentControl:p.parentControl,ownerComponent:y,localUIModel:p.localUIModel,operationAvailableMap:p.operationAvailableMap,prefix:p.prefix,bIsCreateAction:p.bIsCreateAction,bGetBoundContext:p.bGetBoundContext});}else{return null;}});}else{v=o.callActionImport(n,r,{label:p.label,showActionParameterDialog:true,bindingParameters:w,entitySetName:p.entitySetName,onSubmitted:function(){g.lock(u);},onResponse:function(){g.unlock(u);},parentControl:p.parentControl,localUIModel:p.localUIModel,operationAvailableMap:p.operationAvailableMap,prefix:p.prefix,ownerComponent:y});}return v.then(function(R){return m.showUnboundMessages().then(function(){return R;});}).catch(function(i){return m.showUnboundMessages().then(function(){return Promise.reject(i);});});},_removeContextsFromPages:function(){var p=[];if(this._oAppComponent._isFclEnabled()){p=p.concat(this._oAppComponent.getRootContainer().getMidColumnPages()||[]);p=p.concat(this._oAppComponent.getRootContainer().getEndColumnPages()||[]);}else{p=this._oAppComponent.getRootContainer().getPages()||[];}for(var i=0;i<p.length;i++){if(p[i].getBindingContext()){p[i].setBindingContext(null);}}},_getBindingParameters:function(i,n){var p=n&&n.getModel().getMetaModel(),q=p&&p.getMetaContext(n.getPath()),r=q&&p.getObject(i+"@",q),t=S.getSideEffects(r),u,v=[],w=[],x=[],E,y=[];if(t.length===0){return{};}t.forEach(function(z){w=w.concat(z.TargetProperties);v=v.concat(z.TargetEntities);x=x.concat(z.TriggerAction);});u=p.getObject(i+"/@$ui5.overload/0/$Parameter/0/$Name",q);w=S.removeBindingPaths(w,"$PropertyPath",u,i);v=S.removeBindingPaths(v,"$NavigationPropertyPath",u,i);y=y.concat(w).concat(v);y=S.replaceEmptyNavigationPaths(y);E=p.getMetaPath(n.getPath());y=S.addTextProperties(y,p,E);return{pathExpressions:y,triggerActions:x};},handleValidationError:function(){var i=sap.ui.getCore().getMessageManager(),n=i.getMessageModel().getData().filter(function(p){if(p.validation){return p;}});i.removeMessages(n);},_showDiscardPopover:function(i,I,r){var t=this;t._bContinueDiscard=false;return new Promise(function(n,p){if(!i){p("Cancel button not found");}if(I){var O=function(){i.setEnabled(true);if(t._bContinueDiscard){n();}else{p("Discard operation was rejected. Document has not been discarded");}t._oPopover.detachAfterClose(O);};if(!t._oPopover){var q=new T({text:f.getTranslatedText("C_TRANSACTION_HELPER_DRAFT_DISCARD_MESSAGE",r)}),u=new a({text:f.getTranslatedText("C_TRANSACTION_HELPER_DRAFT_DISCARD_BUTTON",r),width:"100%",press:function(){t.handleValidationError();t._bContinueDiscard=true;t._oPopover.close();},ariaLabelledBy:q});t._oPopover=new P({showHeader:false,placement:"Top",content:[new V({items:[q,u]})],beforeOpen:function(){i.setEnabled(false);t._oPopover.setInitialFocus(u);}});t._oPopover.addStyleClass("sapUiContentPadding");}t._oPopover.attachAfterClose(O);t._oPopover.openBy(i);}else{t.handleValidationError();n();}});},handleDocumentModifications:function(){this._bIsModified=true;},_getAppComponent:function(){return this._oAppComponent;},_getRouting:function(){return this._getAppComponent()._oRouting;},_launchDialogWithKeyFields:function(n,t,p,q,r,u){var v=this;var w,x=u.parentControl;return new Promise(function(y,z){var E="sap/fe/core/controls/NonComputedVisibleKeyFieldsDialog";var G=h.loadTemplate(E,"fragment"),R=x.getController().oResourceBundle,H=r.getMetaModel(),I=[],K=v._getAppComponent(),N=H.createBindingContext(n.getPath()),O=H.getMetaPath(n.getPath());for(var i in q){I.push(H.createBindingContext(O+"/"+q[i]));}var Q=new J(I);Q=Q.createBindingContext("/");return Promise.resolve(X.process(G,{name:E},{bindingContexts:{entitySet:N,fields:Q},models:{entitySet:N.getModel(),fields:Q.getModel()}})).then(function(G){var U=[],W=[],Y,Z=function(U,b1){for(var i in U){if(U[i].id===b1){U.splice(i,1);}}},$=function(b1){b1=b1||[];var c1=true;for(i=0;i<W.length;i++){var d1=W[i].getFields()[0];if(b1.id===d1.getId()){c1=!!b1.hasValue;}else{var e1=d1.getValue();if(d1.getProperty("required")&&!e1){c1=false;}}}Y.setEnabled(c1);},_=function(b1,c1){var d1=typeof c1==="object"?true:c1;$({id:b1.getId(),hasValue:d1});},a1={handleChange:function(b1){var c1=b1.getParameter("id");var d1=b1.getParameter("value");f1=b1.getParameter("promise");var e1=b1.getSource();Z(U,c1);var f1={id:c1,promise:f1};U.push(f1);var g1=d1===undefined?f1:d1;_(e1,g1);},handleLiveChange:function(b1){var c1=b1.getSource();var d1=b1.getParameter("value");_(c1,d1);}};return F.load({definition:G,controller:a1}).then(function(b1){w=new b({title:f.getTranslatedText("C_TRANSACTION_HELPER_SAPFE_ACTION_CREATE",R),content:[b1],escapeHandler:function(){w.close();return z({bDeleteTransientContext:true});},beginButton:{text:f.getTranslatedText("C_TRANSACTION_HELPER_SAPFE_ACTION_CREATE",R),type:"Emphasized",press:function(c1){var Y=c1.getSource();Y.setEnabled(false);g.lock(w);return Promise.all(U.map(function(d1){return d1.promise;})).then(function(){u.dialog=w;v.onAfterCreateCompletion(t,p,u,R);r.submitBatch("submitLater");return p.created();}).then(function(){w.close();return y(p);}).finally(function(){g.unlock(w);Y.setEnabled(true);m.showUnboundMessages();});}},endButton:{text:f.getTranslatedText("C_COMMON_ACTION_PARAMETER_DIALOG_CANCEL",R),press:function(){w.close();return z({bDeleteTransientContext:true});}},afterClose:function(){w.getModel("localUI").setProperty("/bIsCreateDialogOpen",false);w.destroy();}});W=b1.getAggregation("form").getAggregation("formContainers")[0].getAggregation("formElements");if(x&&x.addDependent){x.addDependent(w);}Y=w.getBeginButton();w.setBindingContext(p);return f.setUserDefaults(K,I,p).then(function(){$();w.getModel("localUI").setProperty("/bIsCreateDialogOpen",true);w.open();return Promise.resolve();}).catch(function(c1){return m.showUnboundMessages().then(function(){return Promise.reject(c1);});});});});});},onAfterCreateCompletion:function(n,N,p,r){var q=function(E){var t=E.getParameter("context"),u=sap.ui.getCore().getMessageManager(),v,w,x,y;if(t===N){n.detachCreateCompleted(q,this);if(!E.getParameter("success")){if(p.keepTransientContextOnFailed){var z=p.dialog;v=N.getPath();w=u.getMessageModel().getData();y=false;for(var i=0;i<w.length;i++){if(w[0].target===v){y=true;break;}}if(!y){x=new e({message:f.getTranslatedText("C_TRANSACTION_HELPER_TRANSIENT_CONTEXT_MESSAGE",r),description:f.getTranslatedText("C_TRANSACTION_HELPER_TRANSIENT_CONTEXT_DESCRIPTION",r),target:v,persistent:false,type:"Error"});u.addMessages(x);N.created().then(function(){u.removeMessages(x);},function(){u.removeMessages(x);}).catch(function(H){L.error("Cannot find a created new document context",H);});}var G=function(E){if(E.getParameter("context")===N){m.showUnboundMessages();if(E.getParameter("success")){n.detachCreateCompleted(G,this);}}};n.attachCreateCompleted(G);setTimeout(function(){m.showUnboundMessages();},0);if(z){g.unlock(z);z.getBeginButton().setEnabled(true);}}else{t.created().then(undefined,function(){L.trace("transient creation context deleted");}).catch(function(H){L.trace("transient creation context deletion error",H);});t.delete();var R=this._getRouting();R.navigateBackFromTransientState(this._getAppComponent(),{unLockObject:this.getUIStateModel()});}}}};n.attachCreateCompleted(q,this);}});});
