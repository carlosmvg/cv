/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)
        (c) Copyright 2009-2020 SAP SE. All rights reserved
    
 */
sap.ui.define(["sap/ui/base/Object","sap/fe/core/actions/messageHandling","sap/fe/core/actions/sticky","sap/fe/core/TransactionHelper","sap/base/Log","sap/m/Text","sap/m/Button","sap/m/Dialog","sap/ui/model/json/JSONModel","sap/fe/core/CommonUtils","sap/fe/core/BusyLocker","sap/base/util/merge","sap/fe/core/helpers/SideEffectsUtil","sap/fe/core/library","sap/ui/model/odata/v4/ODataListBinding"],function(B,m,s,T,L,a,b,D,J,C,c,d,S,F,O){"use strict";var f=F.CreationMode,t={},g=F.Constants;var E=B.extend("sap.fe.core.controllerextensions.EditFlow",{configure:function(v,r){this.oView=v;this.oRouting=r;},onExit:function(){this.getUIStateModel().destroy();},syncTask:function(v){var n;if(v instanceof Promise){n=function(){return v;};}else if(typeof v==="function"){n=v;}this._pTasks=this._pTasks||Promise.resolve();if(!!n){this._pTasks=this._pTasks.then(n).catch(function(){return Promise.resolve();});}return this._pTasks;},getProgrammingModel:function(o){return this.getTransactionHelper().getProgrammingModel(o);},createDocument:function(l,p){var e=this,h=this.getTransactionHelper(),o=h.getUIStateModel(),i,j,r=e.oView.getController().oResourceBundle,k=!p||(p.creationMode!==f.Inline&&p.creationMode!==f.CreationRow&&p.creationMode!==f.External);if(p.creationMode===f.External){return this.syncTask().then(function(){var u=e.oView.getController();u.handlers.onChevronPressNavigateOutBound(u,p.outbound,undefined);});}if(p.creationMode===f.CreationRow&&p.creationRow){i=p.creationRow.getParent();if(i.getCreationRow().data("disableAddRowButtonForEmptyData")==="true"){var n=e.oView.getModel("creationRowModel");n.setProperty("/fieldValidity/"+i.data("navigationPath"),{});}}if(p.creationMode===f.Inline&&p.tableId){i=this.oView.byId(p.tableId);}function q(u,v){v.then(function(N){var w=e.oView.getBindingContext();if(!C.hasTransientContext(u)){S.requestSideEffects(u.getPath(),w);}}).catch(function(w){L.error("Error while creating the document",w);});}k&&c.lock(o);return this.syncTask().then(function(){var P,u,M;p=p||{};if(l&&typeof l==="object"){u=l;}else if(typeof l==="string"){u=new O(e.oView.getModel(),l);p.creationMode=f.Sync;p.noHistoryEntry=true;delete p.createAtEnd;}else{throw new Error("Binding object or path expected");}M=u.getModel();j=u.iMaxLength||0;var v=p.creationMode;if((!v||v===f.NewPage)&&e.oView.getViewData()._creationMode==="Inplace"){v=f.Inline;}return h.getProgrammingModel(u).then(function(w){P=w;if(v&&v!==f.NewPage){return v;}else{switch(P){case"Draft":case"Sticky":var x=M.getMetaModel();if(!u.isRelative()){var y=u.getPath(),N=P==="Draft"?x.getObject(y+"@com.sap.vocabularies.Common.v1.DraftRoot/NewAction"):x.getObject(y+"@com.sap.vocabularies.Session.v1.StickySessionSupported/NewAction");if(N){var z=x.getObject("/"+N+"/@$ui5.overload/0/$Parameter")||[];if(z.length>1){return f.Deferred;}}}var A=x.getMetaPath(u.getHeaderContext().getPath());var G=C.getNonComputedVisibleFields(x,A);if(G.length>0){return f.Deferred;}return f.Async;case"NonDraft":return f.Sync;}}}).then(function(v){var w,A,x=p.creationRow,y,V=Promise.resolve(),z,G,H=M.getMetaModel();if(v!==f.Deferred){if(v===f.CreationRow){y=x.getBindingContext();G=H.getMetaPath(y.getPath());z=y.getObject();p.data={};Object.keys(z).forEach(function(K){var Q=H.getObject(G+"/"+K);if(Q&&Q.$kind==="NavigationProperty"){return;}p.data[K]=z[K];});V=e.checkForValidationErrors(y);}if(v===f.CreationRow||v===f.Inline){p.keepTransientContextOnFailed=true;p.busyMode="Local";if(v===f.CreationRow){p.busyMode="None";}if(v===f.Inline){p.keepTransientContextOnFailed=false;}e.handleCreateEvents(u);}w=V.then(function(){if(!p.parentControl){p.parentControl=e.oView;}return h.createDocument(u,p,r);});}var N;switch(v){case f.Deferred:N=e.oRouting.navigateForwardToContext(u,{deferredContext:true,noHistoryEntry:p.noHistoryEntry,editable:true});break;case f.Async:N=e.oRouting.navigateForwardToContext(u,{asyncContext:w,noHistoryEntry:p.noHistoryEntry,editable:true});break;case f.Sync:A={noHistoryEntry:p.noHistoryEntry,editable:true};if(P=="Sticky"){A.transient=true;}N=w.then(function(K){if(!K){var r,Q;r=sap.ui.getCore().getLibraryResourceBundle("sap.fe.core");Q=C.getAppComponent(e.oView).getRootControl();return e.oRouting.navigateToMessagePage(r.getText("SAPFE_DATA_RECEIVED_ERROR"),{title:r.getText("C_COMMON_SAPFE_ERROR"),description:r.getText("C_EDITFLOW_SAPFE_CREATION_FAILED_DESCRIPTION"),navContainer:Q});}else{return e.oRouting.navigateForwardToContext(K,A);}});break;case f.Inline:N=q(u,w);break;case f.CreationRow:N=V.then(function(){var K=y.getBinding(),Q;if(!p.bSkipSideEffects){q(u,w);}Q=K.create();x.setBindingContext(Q);Q.created().catch(function(){L.trace("transient fast creation context deleted");});return y.delete("$direct");}).catch(function(K){L.error("CreationRow navigation error: ",K);});break;default:N=Promise.reject("Unhandled creationMode "+v);break;}var I=e.oView.getModel("localUI");if(P==="Sticky"){I.setProperty("/sessionOn",true);}if(w){return Promise.all([w,N]).then(function(K){e.setEditMode("Editable",true);var Q=K[0];if(Q){e.oRouting.setUIStateCreation();if(P==="Sticky"){e._handleStickyOn(Q);}}});}});}).finally(function(){if(i&&i.isA("sap.ui.mdc.Table")){switch(p.createAtEnd){case true:if(i.data("tableType")==="ResponsiveTable"&&i.getThreshold()){i.scrollToIndex(i.getThreshold());}else{i.scrollToIndex(j+1);}break;case false:i.scrollToIndex(0);break;}}k&&c.unlock(o);});},createMultipleDocuments:function(l,e,h){var i=this,j=this.getTransactionHelper(),o=j.getUIStateModel(),r=i.oView.getController().oResourceBundle;c.lock(o);return this.syncTask().then(function(){var M=l.getModel(),k=M.getMetaModel(),n;if(l.getContext()){n=k.getMetaPath(l.getContext().getPath()+"/"+l.getPath());}else{n=k.getMetaPath(l.getPath());}i.handleCreateEvents(l);var p=e.map(function(P){var q={data:{}};q.keepTransientContextOnFailed=true;q.busyMode="None";q.creationMode="CreationRow";q.parentControl=i.oView;q.createAtEnd=h;for(var u in P){var v=k.getObject(n+"/"+u);if(v&&v.$kind!=="NavigationProperty"){q.data[u]=P[u];}}return j.createDocument(l,q,r);});return Promise.all(p);}).then(function(){var k=i.oView.getBindingContext();if(!C.hasTransientContext(l)){S.requestSideEffects(l.getPath(),k);}}).catch(function(k){L.error("Error while creating multiple documents.");return Promise.reject(k);}).finally(function(){c.unlock(o);});},editDocument:function(o,p){var e=this,h=this.getTransactionHelper();return h.editDocument(o,p,e.oView).then(function(n){return h.getProgrammingModel(o).then(function(P){var N;if(P==="Sticky"){var l=e.oView.getModel("localUI");l.setProperty("/sessionOn",true);N=true;}e.setEditMode("Editable",false);if(n!==o){return e.handleNewContext(n,true,N,true,true,true).then(function(){if(P==="Sticky"){e._handleStickyOn(n);}});}});});},saveDocument:function(o,e){var h=this,i=this.getTransactionHelper(),r=h.oView.getController().oResourceBundle;return(this.syncTask().then(this._submitOpenChanges.bind(this,o)).then(this.checkForValidationErrors.bind(this,o)).then(i.saveDocument.bind(i,o,r,e)).then(function(A){return i.getProgrammingModel(o).then(function(p){var n;if(p==="Sticky"){var l=h.oView.getModel("localUI");l.setProperty("/sessionOn",false);h._handleStickyOff(o);if(o.getPath()===A.getPath()){n=true;}}h.setEditMode("Display",false);if(A!==o){h.handleNewContext(A,true,n,false,true,false);}});}));},cancelDocument:function(o,p){var e=this,h=this.getTransactionHelper(),r=e.oView.getController().oResourceBundle;return this.syncTask().then(h.cancelDocument.bind(h,o,p,r)).then(function(A){return h.getProgrammingModel(o).then(function(P){var n;if(P==="Sticky"){var l=e.oView.getModel("localUI");l.setProperty("/sessionOn",false);e._handleStickyOff(o);n=true;}e.setEditMode("Display",false);if(!A){e.oRouting.setUIStateDirty();e.oRouting.navigateBackFromContext(o);}else{return e.handleNewContext(A,true,n,false,true,true);}});});},deleteSingleDocument:function(o,p){var e=this;if(!p){p={bFindActiveContexts:false};}else{p.bFindActiveContexts=false;}return this._deleteDocumentTransaction(o,p).then(function(){e.oRouting.setUIStateDirty();e.oRouting.navigateBackFromContext(o);});},deleteMultipleDocuments:function(e,p){var h=this;var o=h.oView.byId(p.controlId);if(!o||!o.isA("sap.ui.mdc.Table")){throw new Error("parameter controlId missing or incorrect");}var l=o.getRowBinding();var i=this.getTransactionHelper();p.bFindActiveContexts=true;c.lock(i.getUIStateModel());return this._deleteDocumentTransaction(e,p).then(function(){var r;o.clearSelection();var j=h.oView.getBindingContext();if(l.isRoot()){r=new Promise(function(n){l.attachEventOnce("dataReceived",function(){n();});});l.refresh();}else if(j){if(!C.hasTransientContext(l)){S.requestSideEffects(l.getPath(),j);}}h.oRouting.setUIStateDirty();var A=C.getAppComponent(h.oView);var R=A.getRouterProxy();for(var k=0;k<e.length;k++){if(R.isCurrentStateImpactedBy(e[k].getPath())){h.oRouting.navigateBackFromContext(e[k]);break;}}return r;}).finally(function(){c.unlock(i.getUIStateModel());});},_deleteDocumentTransaction:function(o,p){var e=this,l=this.oView.getModel("localUI"),r=this.oView.getController().oResourceBundle,h=this.getTransactionHelper();p=p||{};return this.syncTask().then(h.deleteDocument.bind(h,o,p,l,r)).then(function(){var l=e.oView.getModel("localUI");l.setProperty("/sessionOn",false);});},applyDocument:function(o){var e=this,u=this.getTransactionHelper().getUIStateModel();c.lock(u);return(this._submitOpenChanges(o).then(this.checkForValidationErrors.bind(this,o)).then(function(){m.showUnboundMessages();e.oRouting.navigateBackFromContext(o);return true;}).finally(function(){c.unlock(u);}));},_submitOpenChanges:function(o){var M=o.getModel();return M.submitBatch("$auto").then(function(){if(M.hasPendingChanges("$auto")){return Promise.reject("submit of open changes failed");}});},_handleStickyOn:function(o){var e=this,A=C.getAppComponent(this.oView);if(!A.getRouterProxy().hasNavigationGuard()){var h=A.getRouterProxy().getHash(),l=this.oView.getModel("localUI");setTimeout(function(){A.getRouterProxy().setNavigationGuard();},0);A.getShellServices().setBackNavigation(e.onBackNavigationInSession.bind(e));this.fnDirtyStateProvider=function(n){var j=n.innerAppRoute,r=A.getRouterProxy(),k,p=l.getProperty("/sessionOn");if(l.getProperty("/IBN_OpenInNewTable")){l.setProperty("/IBN_OpenInNewTable",false);return;}if(!p){return;}if(!r.isNavigationFinalized()){k=false;h=j;}else if(h===j){k=true;}else if(r.checkHashWithGuard(j)||r.isGuardCrossAllowedByUser()){h=j;k=false;}else{k=true;}if(k){setTimeout(function(){A.getShellServices().setDirtyFlag(false);},0);}return k;};A.getShellServices().registerDirtyStateProvider(this.fnDirtyStateProvider);var i=this.oView.getModel("sap.fe.i18n");this.fnHandleSessionTimeout=function(){m.removeBoundTransitionMessages();m.removeUnboundTransitionMessages();var j=new D({title:"{sap.fe.i18n>C_EDITFLOW_OBJECT_PAGE_SESSION_EXPIRED_DIALOG_TITLE}",state:"Warning",content:new a({text:"{sap.fe.i18n>C_EDITFLOW_OBJECT_PAGE_SESSION_EXPIRED_DIALOG_MESSAGE}"}),beginButton:new b({text:"{sap.fe.i18n>C_COMMON_DIALOG_OK}",type:"Emphasized",press:function(){e._handleStickyOff();e.oRouting.navigateBackFromContext(o);}}),afterClose:function(){j.destroy();}});j.addStyleClass("sapUiContentPadding");j.setModel(i,"sap.fe.i18n");e.oView.addDependent(j);j.open();};this.oView.getModel().attachSessionTimeout(this.fnHandleSessionTimeout);this.fnStickyDiscardAfterNavigation=function(){var j=A.getRouterProxy().getHash();if(!j||!A.getRouterProxy().checkHashWithGuard(j)){e.fnStickyDiscard(o);}};this.oRouting.attachOnAfterNavigation(this.fnStickyDiscardAfterNavigation);}},_handleStickyOff:function(){var A=C.getAppComponent(this.oView);if(A.getRouterProxy){A.getRouterProxy().discardNavigationGuard();}if(this.fnDirtyStateProvider){A.getShellServices().deregisterDirtyStateProvider(this.fnDirtyStateProvider);this.fnDirtyStateProvider=null;}if(this.oView.getModel()&&this.fnHandleSessionTimeout){this.oView.getModel().detachSessionTimeout(this.fnHandleSessionTimeout);}this.oRouting.detachOnAfterNavigation(this.fnStickyDiscardAfterNavigation);this.fnStickyDiscardAfterNavigation=null;this.setEditMode("Display",false);if(A){A.getShellServices().setBackNavigation();}},handleNewContext:function(o,n,N,e,p,u){this.oRouting.setUIStateDirty();return this.oRouting.navigateToContext(o,{noHistoryEntry:n,noHashChange:N,editable:e,bPersistOPScroll:p,useHash:u});},createActionPromise:function(A){var e=this,r,R;this.oActionPromise=new Promise(function(h,i){r=h;R=i;}).then(function(o){return e._getActionResponseDataAndKeys(A,o);});return{fResolver:r,fRejector:R};},getCurrentActionPromise:function(){return this.oActionPromise;},deleteCurrentActionPromise:function(){this.oActionPromise=null;},onCallAction:function(A,p){var e=this,o,h=this.getTransactionHelper(),i,j,P,k;var v=this.oView;p.localUIModel=e.oView.getModel("localUI");if(!p.parentControl){p.parentControl=this.oView;}if(p.bStaticAction){o=this.oView.byId(p.prefix);if(A&&A.indexOf("(")>-1){P=A.split("(");A=P[0];k=P[1].slice(0,-1);if(k.indexOf("Collection(")>-1){return Promise.reject(A+" bound to a collection "+k+" is not supported");}i=o;while(i){j=i.getBindingContext();if(j&&j.getModel().getMetaModel().getMetaContext(j.getPath()).getObject("$Type")===k){p.contexts=j;break;}else{i=i.getParent();}}if(!p.contexts){return Promise.reject("Context not found for entity type "+k);}}else{if(o.isTableBound()){p.contexts=o.getRowBinding().getHeaderContext();}else{var l=o.getRowsBindingInfo().path,n=new O(e.oView.getModel(),l);p.contexts=n.getHeaderContext();}}}var q=this.createActionPromise(A);if(p.isNavigable){p.bGetBoundContext=false;}else{p.bGetBoundContext=true;}return this.syncTask().then(h.onCallAction.bind(h,A,p)).then(function(r){return e.refreshListIfRequired(e._getActionResponseDataAndKeys(A,r),p.contexts[0]).then(function(){return r;});}).then(function(r){q.fResolver(r);if(p.contexts){e.oRouting.setUIStateDirty();}if(p.isNavigable){var u=r;if(Array.isArray(u)&&u.length===1){u=u[0];}if(u&&!Array.isArray(u)){var M=v.getModel().getMetaModel();var w=M.getMetaPath(u.getPath());var x=M.createBindingContext(w+"/"+A+"/@$ui5.overload/0");var y=x.getObject()&&x.getObject().$ReturnType?x.getObject().$ReturnType.$Type:null;var z=M.getObject(w+"/$Type");if(z!=undefined&&z===y){e.oRouting.navigateForwardToContext(u,{noHistoryEntry:false});}}}}).catch(function(r){q.fRejector();if(r==g.CancelActionDialog){L.trace("Dialog cancelled.");}else{L.error("Error in EditFlow.onCallAction:"+r);}});},formatDraftOwnerText:function(e,h,i,j,k){var l="";var u=h||e||j||i;if(k){l+=e?C.getTranslatedText("C_EDIT_FLOW_GENERIC_LOCKED_OBJECT_POPOVER_TEXT")+" ":C.getTranslatedText("C_EDIT_FLOW_LAST_CHANGE_USER_TEXT")+" ";}l+=u?C.getTranslatedText("C_EDIT_FLOW_OWNER",null,[u]):C.getTranslatedText("C_EDIT_FLOW_ANOTHER_USER");return l;},formatDraftOwnerTextInline:function(e,h,i,j){return this.formatDraftOwnerText(e,i,h,j,false);},formatDraftOwnerTextInPopover:function(e,h,i,j){return this.formatDraftOwnerText(e,i,h,j,true);},handlePatchSent:function(e){var h=this;if(h.editFlow){h=h.editFlow;}var i=h.getTransactionHelper(),o=i.getUIStateModel(),j=e.getSource();i.handleDocumentModifications();h.oRouting.setUIStateDirty();return i.getProgrammingModel(j).then(function(p){if(p==="Draft"){o.setProperty("/draftStatus","Saving");}});},handlePatchCompleted:function(e){var h=this;if(h.editFlow){h=h.editFlow;}var i=h.getTransactionHelper(),o=i.getUIStateModel(),j=e.getSource(),k=e.getParameter("success");m.showUnboundMessages();return i.getProgrammingModel(j).then(function(p){if(p==="Draft"){o.setProperty("/draftStatus",k?"Saved":"Clear");}});},handleCreateEvents:function(o){var e=this;if(e.editFlow){e=e.editFlow;}var h=e.getTransactionHelper(),i=h.getUIStateModel();i.setProperty("/draftStatus","Clear");o=(o.getBinding&&o.getBinding())||o;o.attachEvent("createSent",function(){h.handleDocumentModifications();h.getProgrammingModel(o).then(function(p){if(p==="Draft"){i.setProperty("/draftStatus","Saving");}}).catch(L.error);});o.attachEvent("createCompleted",function(j){var k=j.getParameter("success");h.getProgrammingModel(o).then(function(p){if(p==="Draft"){i.setProperty("/draftStatus",k?"Saved":"Clear");}}).catch(L.error);m.showUnboundMessages();});},handleErrorOfTable:function(e){if(e.getParameter("error")){setTimeout(m.showUnboundMessages,0);}},getUIStateModel:function(i){if(!this.editFlowStateModel){this.editFlowStateModel=new J({createMode:false});}if(i){this.editFlowStateModel.setData(d(this.editFlowStateModel.getData(),i));}return this.editFlowStateModel;},computeEditMode:function(o){var e=this;return new Promise(function(r,h){var i=e.getUIStateModel();e.getTransactionHelper().getProgrammingModel(o).then(function(p){if(p==="Draft"){o.requestObject("IsActiveEntity").then(function(I){if(I===false){e.setEditMode("Editable");o.requestObject("HasActiveEntity").then(function(H){if(H){i.setProperty("/createMode",false);}else{i.setProperty("/createMode",true);}r();}).catch(function(j){L.error("Error while requesting the HasActiveEntity property",j);});}else{e.setEditMode("Display");r();}}).catch(function(j){L.error("Error while requesting the IsActiveEntity property",j);});}else{r();}}).catch(h);});},setEditMode:function(e,h){var o=this.getUIStateModel(),i=this.getTransactionHelper().getUIStateModel();if(e){i.setProperty("/editMode",e);i.setProperty("/isEditable",e==="Editable");}if(h!==undefined){o.setProperty("/createMode",h);}},checkForValidationErrors:function(o){return this.syncTask().then(function(){var p=o.getPath(),M=sap.ui.getCore().getMessageManager().getMessageModel().getData(),e,h;for(var i=0;i<M.length;i++){h=M[i];if(h.validation){e=sap.ui.getCore().byId(h.getControlId());if(e&&e.getBindingContext()&&e.getBindingContext().getPath().indexOf(p)===0){return Promise.reject("validation errors exist");}}}});},getTransactionHelper:function(){if(!this._oTransactionHelper){var A=C.getAppComponent(this.oView),e=A.getId();if(!t[e]){var h=new T();h.initialize(A);t[e]=h;}this._oTransactionHelper=t[e];}return this._oTransactionHelper;},onBackNavigationInSession:function(){var e=this,v=e.oView,A=C.getAppComponent(v),r=A.getRouterProxy();if(r.checkIfBackIsOutOfGuard()){var o=v&&v.getBindingContext();e.getTransactionHelper().getProgrammingModel(o).then(function(p){C.processDataLossConfirmation(function(){e.fnStickyDiscard(o);history.back();},v,p);}).catch(function(h){L.error("Error while getting the programmingModel",h);});return;}history.back();},fnStickyDiscard:function(o){s.discardDocument(o);this._handleStickyOff();},onTableContextChange:function(e){var o=this.getView().getController();if(o.handlers.onTableContextChange){o.handlers.onTableContextChange.apply(o,[e]);}},_getActionResponseDataAndKeys:function(A,r){if(Array.isArray(r)){if(r.length===1){r=r[0];}else{return null;}}if(!r){return null;}var v=this.oView,M=v.getModel().getMetaModel().getData(),e=M&&M[A]&&M[A][0]&&M[A][0].$ReturnType?M[A][0].$ReturnType.$Type:null,k=e&&M[e]?M[e].$Key:null;return{oData:r.getObject(),keys:k};},refreshListIfRequired:function(r,o){if(!o||!r||!r.oData){return Promise.resolve();}var h=o.getBinding();if(h&&h.isA("sap.ui.model.odata.v4.ODataListBinding")){var i=r.oData,k=r.keys,j=o.getObject(),R=true;if(Object.keys(i).length){R=k.every(function(K){return j[K]===i[K];});if(!R){return new Promise(function(l,n){if(h.isRoot()){h.attachEventOnce("dataReceived",function(){l();});h.refresh();}else{h.getContext().requestSideEffects([{$NavigationPropertyPath:h.getPath()}]).then(function(){l();},function(){L.error("Error while refreshing the table");l();}).catch(function(e){L.error("Error while refreshing the table",e);});}});}}}return Promise.resolve();}});E.onExitApplication=function(A){var o=t[A];o&&o.destroy();delete t[A];};return E;});
