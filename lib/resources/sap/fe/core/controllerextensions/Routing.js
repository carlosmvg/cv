/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)
        (c) Copyright 2009-2020 SAP SE. All rights reserved
    
 */
sap.ui.define(["sap/ui/model/Filter","sap/ui/model/FilterOperator","sap/ui/base/Object","sap/m/MessagePage","sap/m/Link","sap/m/MessageBox","sap/base/Log","sap/fe/core/CommonUtils","sap/ui/base/BindingParser","sap/fe/core/BusyLocker","sap/fe/core/actions/messageHandling"],function(F,a,B,M,L,b,c,C,d,e,m){"use strict";var u,D,A,t,P,o=[],s,E,S=[],f,g,h,n=function(){c.debug("target binding of custom page or re-use component: "+s);};var l={CLEAN:0,PROCESSED:1,DIRTY:2,CREATION:3};var q=B.extend("sap.fe.core.controllerextensions.Routing",{configure:function(v,i){this.oView=v;this.oFcl=i;},navigateToContext:function(i,p){p=p||{};var r=this._getOwnerComponent().getRootContainer(),v=this.oView.getViewData(),j,T,k=null,R,w=this._getOwnerComponent().getRouterProxy(),x=this;if(p.targetPath&&v.navigation){R=v.navigation[p.targetPath].detail;T=R.route;if(R.parameters){k=this.prepareParameters(R.parameters,T,i);}}if(i.isA("sap.ui.model.odata.v4.ODataListBinding")){if(p.asyncContext){w.activateRouteMatchSynchronization();p.asyncContext.then(function(i){x.navigateToContext(i,{noHistoryEntry:true,noHashChange:p.noHashChange,useCanonicalPath:p.useCanonicalPath,editable:p.editable,bPersistOPScroll:p.bPersistOPScroll,updateFCLLevel:p.updateFCLLevel});}).catch(function(U){c.error("Error with the async context",U);});A=p.asyncContext;}else if(p.deferredContext){D=true;}else{throw"navigation to a list binding is not yet supported";}}else{if(i.getBinding()&&i.getBinding().isA("sap.ui.model.odata.v4.ODataListBinding")){if(C.hasTransientContext(i.getBinding())){return this.oView.getModel("sap.fe.i18n").getResourceBundle().then(function(U){var V=C.getTranslatedText("C_ROUTING_NAVIGATION_DISABLED_TITLE",U,null,i.getBinding().getPath().substr(1));var W=C.getTranslatedText("C_ROUTING_NAVIGATION_DISABLED_MESSAGE",U,null,i.getBinding().getPath().substr(1));b.show(W,{icon:b.Icon.WARNING,title:V,actions:[b.Action.CLOSE],details:U.getText("C_TRANSACTION_HELPER_TRANSIENT_CONTEXT_DESCRIPTION"),contentWidth:"100px"});});}}u=i;}t=p.editable;P=p.bPersistOPScroll;if(p.useCanonicalPath){j=i.getCanonicalPath();}else if(i.isA("sap.ui.model.odata.v4.ODataListBinding")&&i.isRelative()){j=i.getHeaderContext().getPath();}else{j=i.getPath();}if(p.updateFCLLevel===-1){var y=new RegExp("/[^/]*$");j=j.replace(y,"");u=null;if(j.length===0&&E){return w.exitFromApp();}}var z=this._getOwnerComponent();var G=z.getRouter();var H=G.getHashChanger().getHash();var I=z.getRootViewController();if(p.asyncContext||p.deferredContext){j+="(...)";}else if(S&&S.length&&g&&H.split("/").length===1&&H.indexOf("(...)")===-1&&j!==""&&!z.getRootViewController().isFclEnabled()){var J=(i&&i.getPath().substring(0,i.getPath().indexOf("(")))||H.substring(0,H.indexOf("("));var K="";while(J.indexOf("/")===0){J=J.substr(1);}if(v.viewLevel===0){K=this._createHash(S,J,i);}else if(v.viewLevel===1&&H!==""){if(p.useHash){K=H;}else if(i&&i.getPath().split("/").length<=2){K=this._createHash(S,J,i);}}if(K!==""){if(H===K||H.replace(/[&?]{1}sap-iapp-state=[A-Z0-9]+/,"")===K){this._bindTargetPage(r.getCurrentPage(),null,null,true,false,G);return Promise.resolve();}else if(K===undefined){if(p.useHash){this._bindTargetPage(r.getCurrentPage(),null,null,true,false,G);return Promise.resolve();}}else{j=K;}}}if(z.getRootViewController().isFclEnabled()){var N=this.oFcl.getFCLLevel();if(p.updateFCLLevel){N+=p.updateFCLLevel;if(N<0){N=0;}}var O;if(p.sLayout){O=p.sLayout;}else{O=I.getFCLLayout(N,j);}j+="?layout="+O;}while(j.indexOf("/")===0){j=j.substr(1);}if(p.noHashChange){if(z.getRootViewController().isFclEnabled()){if(j===this._getOwnerComponent().getRouter().getHashChanger().getHash()){var Q;switch(this.oFcl.getFCLLevel()){case 0:Q=r.getCurrentBeginColumnPage();break;case 1:Q=r.getCurrentMidColumnPage();break;default:Q=r.getCurrentEndColumnPage();break;}this._bindTargetPage(Q,null,null,true,true,G);return Promise.resolve();}}else{this._bindTargetPage(r.getCurrentPage(),null,null,true,false,G);return Promise.resolve();}}if(T&&k!==null){this._getOwnerComponent().getRouter().navTo(T,k);}else if(p.transient&&p.editable==true&&j.indexOf("(...)")===-1){if(j.indexOf("?")>-1){j+="&i-action=create";}else{j+="?i-action=create";}}return w.navToHash(j,false,p.noPreservationCache);},prepareParameters:function(p,T,i){var j;try{var k=i.getPath();var r=k.split("/");j=Object.keys(p).reduce(function(R,w){var x=p[w];var y=d.complexParser(x);var z=y.parts||[y];var G=z.map(function(H){var I=H.path.split("../");var J=r.slice(0,r.length-I.length+1);J.push(I[I.length-1]);return i.getObject(J.join("/"));});if(y.formatter){R[w]=y.formatter.apply(this,G);}else{R[w]=G.join("");}return R;},{});}catch(v){c.error("Could not parse the parameters for the navigation to route "+T);j=undefined;}return j;},navigateBackFromContext:function(i,p){p=p||{};p.updateFCLLevel=-1;return this.navigateToContext(i,p);},navigateForwardToContext:function(i,p){p=p||{};p.updateFCLLevel=1;return this.navigateToContext(i,p);},navigateToMessagePage:function(i,p){p=p||{};var j=C.getAppComponent(p.navContainer);var r=j.getRouter();if(r.getHashChanger().getHash().indexOf("i-action=create")>-1){var j=C.getAppComponent(p.navContainer);return this.getRootEntitySet(j).then(function(k){var H=k+"(...)";var v=j.getRouterProxy();v.navToHash(H);});}var R=p.navContainer||this._getOwnerComponent().getRootContainer();if(!this.oMessagePage){this.oMessagePage=new M({showHeader:false,icon:"sap-icon://message-error"});R.addPage(this.oMessagePage);}this.oMessagePage.setText(i);if(p.technicalMessage){this.oMessagePage.setCustomDescription(new L({text:p.description||p.technicalMessage,press:function(){b.show(p.technicalMessage,{icon:b.Icon.ERROR,title:p.title,actions:[b.Action.OK],defaultAction:b.Action.OK,details:p.technicalDetails||"",contentWidth:"60%"});}}));}else{this.oMessagePage.setDescription(p.description||"");}R.to(this.oMessagePage);},navigateBackFromTransientState:function(i,p){var r=i.getRouterProxy(),H=r.getHash();if(H.indexOf("(...)")!==-1){if(p&&p.unLockObject&&e.isLocked(p.unLockObject)){e.unlock(p.unLockObject);}r.navBack();}},setUIStateDirty:function(){q.flagUIState=l.DIRTY;},setUIStateProcessed:function(){q.flagUIState=l.PROCESSED;},setUIStateCreation:function(){q.flagUIState=l.CREATION;},resetUIState:function(){q.flagUIState=l.CLEAN;},isUIStateDirty:function(){return q.flagUIState!==l.CLEAN;},cleanProcessedUIState:function(){if(q.flagUIState===l.PROCESSED){q.flagUIState=l.CLEAN;}},getFirstBeforeRouteMatchedCallEvent:function(){return h;},getNavigablePages:function(j){var r=j.getManifest()["sap.ui5"].routing,R=r.routes,T=r.targets,p={};for(var i=0;i<R.length;i++){var k={},v=R[i].pattern,w=R[i].target,x=v.split("/").length-1;k["pattern"]=v;if(v===":?query:"||v===""){continue;}if(x===1&&v.split("/")[x]===":?query:"){x=0;}k["level"]=x;if(Array.isArray(w)){k["target"]=w[w.length-1];}else{k["target"]=w;}if(T[k.target].options&&T[k.target].options.settings){k["allowDeepLinking"]=T[k.target].options.settings.allowDeepLinking;k["entitySet"]=T[k.target].options.settings.entitySet;}if(!k["allowDeepLinking"]&&k["level"]!==0){continue;}else if(!p[k.level]){p[k.level]=[];}p[k.level].push(k);}return p;},checkForKeys:function(k,p){if(k&&k.length){for(var j=0;j<k.length;j++){var i=k[j].$PropertyPath;if(!i){i=k[j];}var r=p[i];if(!r||(r&&r.length>1)){return false;}}return true;}return false;},getFilters:function(g,k,i){var p=[];for(var j=0;j<k.length;j++){var r=k[j].$PropertyPath;if(!r){r=k[j];if(r==="IsActiveEntity"){g=false;}}var v=i[r][0];if(v){p.push(new F(r,a.EQ,v));}else{return undefined;}}if(g){var w=new F({filters:[new F("IsActiveEntity","EQ",false),new F("SiblingEntity/IsActiveEntity","EQ",null)],and:false});p.push(w);}var x=new F(p,true);return x;},_initializeRouteMatcher:function(i,r){var j=this;r.attachBeforeRouteMatched(function(k){var R=i.getRootControl();e.lock(R);if(!h&&k){h=Object.assign({},k);h.getParameters=k.getParameters;h.getParameter=k.getParameter;}});r.attachRouteMatched(function(k){var v=k.getParameters().arguments,T="",K,w;j.fireOnAfterNavigation();var R=i.getRootControl();var x=i.getAppStateHandler();if(e.isLocked(R)){e.unlock(R);}if(x.checkIfRouteChangedByIApp()){x.resetRouteChangedByIApp();return;}if(Object.keys(v).length>0){var y;if(k.getParameter("view").getComponentInstance&&k.getParameter("view").getComponentInstance()&&k.getParameter("view").getComponentInstance().getBindingContextPattern){y=k.getParameter("view").getComponentInstance().getBindingContextPattern();}T=y||k.getParameters().config.pattern;T=T.replace(":?query:","");for(var p in v){K=v[p];if(K==="..."){w=true;t=true;}T=T.replace("{"+p+"}",K);}if(T&&T[0]!=="/"){T="/"+T;}}var z=k.getParameter("config").target;if(i.getRootViewController().isFclEnabled()&&typeof z==="object"&&z.length){i.getRootViewController().updateFCLLevels(z,k.getParameter("views"));z.forEach(function(H,I){var J=i.getRootViewController().getTargetAggregation()[H];if(J.pattern!==undefined){T=j.buildBindingContext(J.pattern,v);}var N=k.getParameter("views")[I];if(N!=null){j._bindTargetPage(N,T,w,false,true,r);}else{throw new Error("No Container found for target "+H+"(Please check the Router configuration)");}});}else{var R=i.getRootContainer();j._bindTargetPage(R.getCurrentPage(),T,w,false,false,r);}j.cleanProcessedUIState();var G=i.getRouterProxy();if(!history.state||history.state.feLevel===undefined){G.restoreHistory().then(function(){G.resolveRouteMatch();}).catch(function(H){c.error("Error while restoing history",H);});}else{G.resolveRouteMatch();}});},initializeRouting:function(j){var p=this;var r=j.getModel();var v=r.getMetaModel();var R=j.getRouter();u=null;D=false;A=null;t=false;P=null;o=[];E=false;h=null;p.resetUIState();this._initializeRouteMatcher(j,R);return p.getRootEntitySet(j).then(function(w){var x,I=R.getHashChanger().getHash().indexOf("sap-iapp-state")!==-1,y=j.getComponentData(),z=y&&y.startupParameters,H=z!==undefined&&Object.keys(z).length!==0;var G=[];var J={};var K="";if(w){f=v.getObject("/$EntityContainer/"+w+"/");g=v.getObject("/$EntityContainer/"+w+"@com.sap.vocabularies.Common.v1.DraftRoot")||v.getObject("/$EntityContainer/"+w+"@com.sap.vocabularies.Common.v1.DraftNode");S=v.getObject("/$EntityContainer/"+w+"/@com.sap.vocabularies.Common.v1.SemanticKey");}else{c.info("no root entity identified - therefore no draft information and semantic keys available");}if(!I&&H){if(z.preferredMode&&z.preferredMode[0]==="create"&&!R.getHashChanger().getHash()){if(w){x=w+"(...)";}else{c.error("Cannot handle this App due to missing root entity definition - neither DraftRoot nor StickySessionSupported found");}R.getHashChanger().replaceHash(x);E=true;}else{var O,N,Q=p.getNavigablePages(j),T=0;while(T in Q){O=Q[T];for(var i=0;i<O.length;++i){N=O[i];if(!N.entitySet&&N.level===0){N.entitySet=w;}if(!N.entitySet){continue;}N.entityType=v.getObject("/$EntityContainer/"+N.entitySet+"/");N.draft=v.getObject("/$EntityContainer/"+N.entitySet+"@com.sap.vocabularies.Common.v1.DraftRoot")||v.getObject("/$EntityContainer/"+N.entitySet+"@com.sap.vocabularies.Common.v1.DraftNode");N.technicalKeys=N.entityType["$Key"];N.semanticKeys=v.getObject("/$EntityContainer/"+N.entitySet+"/@com.sap.vocabularies.Common.v1.SemanticKey");if(p.checkForKeys(N.semanticKeys,z)){N.isSemanticKeyNavigation=true;J[T]=N;break;}else if(N.level===0&&p.checkForKeys(N.technicalKeys,z)){N.isSemanticKeyNavigation=false;J[T]=N;break;}}++T;}Object.keys(J).forEach(function(k){var U=J[k],V,W;if(U.isSemanticKeyNavigation){V=p.getFilters(U.draft,U.semanticKeys,z);}else{V=p.getFilters(U.draft,U.technicalKeys,z);}W=r.bindList("/"+U.entitySet,undefined,undefined,V);G.push(W.requestContexts());});}}return Promise.all(G).then(function(V){var U,k=0,i=0,W={},X=[],Y=j.getRootControl().getViewName()==="sap.fe.templates.RootContainer.view.Fcl";for(i=0;i<V.length;i++){if(V[i]&&V[i].length){if(V[i].length>1){break;}U=V[i][0].getPath().split("(");var Z=U[U.length-1];W[i]=Z;}else{break;}}var $=Object.keys(W).length;if(Object.keys(J).length&&$){X=J[$-1].pattern.split("/");}if($===1&&!Y){f=J[0].entityType;S=J[0].semanticKeys;g=J[0].draft;w=J[0].entitySet;if(J[0].isSemanticKeyNavigation){K=p._createHash(S,w,z);}else{K=p._createHash(J[0].technicalKeys,w,z);}}else{for(k=0;k<X.length;k++){var _=X[k].split("{")[0];K=K+"/"+_+W[k];}}if(K){R.getHashChanger().replaceHash(K);}}).catch(function(k){c.info("Could not find results for list bind: "+k);});}).finally(function(){R.initialize();});},_bindTargetPage:function(T,k,p,N,I,r){var v=T.getComponentInstance?T.getComponentInstance():T.getController(),O=(v.onBeforeBinding||n).bind(v),w=(v.onAfterBinding||n).bind(v),x,y,z,G,H,J=T.getModel().getMetaModel(),K=T.getComponentInstance&&T.getComponentInstance().getEntitySet&&T.getComponentInstance().getEntitySet(),Q=this,R;function U(){if(S&&S.length){var Z=[];var $=[];var W=r.getHashChanger().getHash();W=W.split("?")[0];if(u){var _;for(var i=0;i<S.length;i++){_=u.getObject(S[i].$PropertyPath);if(_){$.push(_);}else{return undefined;}}}else{$=W.substring(W.indexOf("(")+1,W.length-1).split(",");}for(var j=0;j<S.length;j++){var a1=S[j].$PropertyPath;var b1;if($.length===1){b1=$[0];}else{b1=$[j].split("=")[1];}if(b1.indexOf("'")===0&&b1.lastIndexOf("'")===b1.length-1){b1=b1.substr(1,b1.length-2);}Z.push(new F(a1,a.EQ,b1));}if(g){var c1=new F({filters:[new F("IsActiveEntity","EQ",false),new F("SiblingEntity/IsActiveEntity","EQ",null)],and:false});Z.push(c1);}var X=new F(Z,true);return X;}}function V(){if(!N){x=T.getBindingContext();y=x&&x.getPath();z=x&&x.getBinding();G=u&&u.getBinding();}if(N||y!==k||(u&&z!==G&&!I)){if(k||N){if(!u||!u.getBinding()||u.getBinding().isA("sap.ui.model.odata.v4.ODataListBinding")){H=u&&u.getBinding();var i={$$patchWithoutSideEffects:true,$$groupId:"$auto.Heroes",$$updateGroupId:"$auto"};if(R){i.$select=R;}var j=J.getObject(J.getMetaPath(k)+"@com.sap.vocabularies.Common.v1.DraftRoot");var Z=J.getObject(J.getMetaPath(k)+"@com.sap.vocabularies.Common.v1.DraftNode");if(j!==undefined||Z!==undefined){if(i.$select===undefined){i.$select="HasActiveEntity,HasDraftEntity,IsActiveEntity";}else{i.$select+=",HasActiveEntity,HasDraftEntity,IsActiveEntity";}}var $=T.getModel().bindContext(k,undefined,i);$.attachEventOnce("dataRequested",function(){e.lock(T);});$.attachEventOnce("dataReceived",function(_){var a1=_&&_.getParameter("error");e.unlock(T);if(a1){sap.ui.getCore().getLibraryResourceBundle("sap.fe.core",true).then(function(b1){m.removeUnboundTransitionMessages();Q.navigateToMessagePage(b1.getText("SAPFE_DATA_RECEIVED_ERROR"),{title:b1.getText("C_COMMON_SAPFE_ERROR"),description:a1,navContainer:T.getParent()});}).catch(function(b1){c.error("Error while getting the core resource bundle",b1);});}});u=$.getBoundContext();if(Q.isUIStateDirty()){setTimeout(function(){Q._refreshBindingContext(x,R);},0);}}x=u;O(x,{editable:t,listBinding:H,bPersistOPScroll:P});T.setBindingContext(x);w(x);u=null;}else if(k===""){O(null);w(null);}}else if(Q.isUIStateDirty()){Q._refreshBindingContext(x,R);}}s=T.getComponent?T.getComponent():T.getControllerName();if(K){R=J.getProperty("/"+K+"/@com.sap.vocabularies.Common.v1.Messages/$Path");}if(p){O(null,{editable:t});if(D||!A){if(v&&v.createDeferredContext){v.createDeferredContext(k);A=null;D=false;}}if(T.getBindingContext()&&T.getBindingContext().hasPendingChanges()){T.getBindingContext().getBinding().resetChanges();}T.setBindingContext(null);return false;}var W=r.getHashChanger().getHash();if(S&&S.length&&g&&W&&W.split("/").length===1&&k!==""&&!I){if(!u){var X=U();var Y=T.getModel().bindList("/"+W.substring(0,W.indexOf("(")),undefined,undefined,X,{"$$groupId":"$auto.Heroes"});Y.requestContexts().then(function(i){if(i&&i.length){k=i[0].getPath();}V();}).catch(function(i){var j=T.getParent();var Z=sap.ui.getCore().getLibraryResourceBundle("sap.fe.core");this.navigateToMessagePage(Z.getText("SAPFE_DATA_RECEIVED_ERROR"),{title:Z.getText("C_COMMON_SAPFE_ERROR"),description:i.message,navContainer:j});}.bind(this));}else{k=u.getPath();V();}}else{V();}},buildBindingContext:function(p,i){if(p.length===0){return"";}var j=p;var k=p.indexOf("{");if(k!=-1){var r=p.indexOf("}");var v=p.substr(k+1,r-k-1);j=p.substr(0,k)+i[v];j+=this.buildBindingContext(p.substr(r+1),i);}return j;},_refreshBindingContext:function(j,k){var N=[],p=[],r=[];var v=function(w){var x,y=w.getPath();if(w.isA("sap.ui.model.odata.v4.ODataContextBinding")){x=w.getDependentBindings();if(x){for(var i=0;i<x.length;i++){v(x[i]);}}else{if(N.indexOf(y)===-1){N.push(y);}}}else if(w.isA("sap.ui.model.odata.v4.ODataListBinding")){if(N.indexOf(y)===-1){N.push(y);}}else if(w.isA("sap.ui.model.odata.v4.ODataPropertyBinding")){if(p.indexOf(y)===-1){p.push(y);}}};v(j.getBinding());for(var i=0;i<N.length;i++){r.push({$NavigationPropertyPath:N[i]});}for(var i=0;i<p.length;i++){r.push({$PropertyPath:p[i]});}if(k){r.push({$PropertyPath:k});}j.requestSideEffects(r);},attachOnAfterNavigation:function(H){o.push(H);},detachOnAfterNavigation:function(H){for(var i=0;i<o.length;i++){if(o[i]===H){o.splice(i,1);}}},fireOnAfterNavigation:function(){for(var i=0;i<o.length;i++){o[i]();}},getOutbounds:function(){if(!this.outbounds){if(!this.manifest){this.manifest=this._getOwnerComponent().getMetadata().getManifest();}this.outbounds=this.manifest["sap.app"]&&this.manifest["sap.app"].crossNavigation&&this.manifest["sap.app"].crossNavigation.outbounds;}return this.outbounds;},_getOwnerComponent:function(){return C.getAppComponent(this.oView);},getRootEntitySet:function(i){var j=i.getModel().getMetaModel();return j.requestObject("/$EntityContainer/").then(function(k){return Object.keys(k).find(function(K){return(j.getObject("/$EntityContainer/"+K+"@com.sap.vocabularies.Common.v1.DraftRoot")||j.getObject("/$EntityContainer/"+K+"@com.sap.vocabularies.Session.v1.StickySessionSupported"));});});},_createHash:function(k,j,p){var r=j+"(";var K,v;var w=this._getEntityType();if(k.length===1){K=k[0].$PropertyPath||k[0];v=p.isA&&p.isA("sap.ui.model.odata.v4.Context")?p.getObject(K):p[K][0];if(v!==undefined){r=w[K].$Type==="Edm.String"?r+"'"+v+"'":r+v;}else{r=undefined;}}else{for(var i=0;i<k.length;i++){K=k[i].$PropertyPath||k[i];v=p.getObject?p.getObject(K):p[K][0];if(v){r=w[K].$Type==="Edm.String"?r+K+"='"+v+"'":r+K+"="+v;if(i!==k.length-1){r=r+",";}}else{r=undefined;break;}}}if(r){r=r+")";return r;}return undefined;},_getEntityType:function(){return f||null;}});q.flagUIState=l.CLEAN;return q;});
