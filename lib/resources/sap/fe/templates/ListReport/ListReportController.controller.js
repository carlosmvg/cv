/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)
        (c) Copyright 2009-2020 SAP SE. All rights reserved
    
 */
sap.ui.define(["sap/ui/core/mvc/Controller","sap/ui/model/json/JSONModel","sap/fe/core/controllerextensions/Routing","sap/fe/core/controllerextensions/FlexibleColumnLayout","sap/fe/core/controllerextensions/EditFlow","sap/fe/macros/field/FieldRuntime","sap/fe/macros/CommonHelper","sap/fe/core/AnnotationHelper","sap/fe/core/actions/messageHandling","sap/base/Log","sap/base/util/ObjectPath","sap/fe/navigation/SelectionVariant","sap/m/MessageBox","sap/fe/core/CommonUtils","sap/fe/navigation/library","sap/fe/core/FEHelper","sap/ui/mdc/p13n/StateUtil","sap/fe/macros/table/Utils","sap/fe/macros/ResourceModel","sap/fe/core/controllerextensions/RoutingListener","sap/ui/model/Filter","sap/ui/model/FilterOperator","sap/fe/macros/chart/ChartRuntime","sap/fe/templates/controls/Share/ShareUtils","sap/base/util/merge","sap/fe/templates/ListReport/ExtensionAPI","sap/fe/macros/filter/FilterUtils","sap/fe/macros/chart/ChartUtils"],function(C,J,R,F,E,a,b,A,m,L,O,S,M,c,N,d,e,T,f,g,h,i,j,l,n,o,p,q){"use strict";return C.extend("sap.fe.templates.ListReport.ListReportController",{routingListener:g,getExtensionAPI:function(){if(!this.extensionAPI){this.extensionAPI=new o(this);}return this.extensionAPI;},constructor:function(){C.apply(this,arguments);this.routing=new R();this.fcl=new F();this.editFlow=new E();},messageHandling:m,onInit:function(){var t=this;this.routing.configure(this.getView(),this.fcl);this.fcl.configure(this.getView(),this.routing);this.editFlow.configure(this.getView(),this.routing);this._oAppComponent=c.getAppComponent(this.getView());var k=this._getTables();var r=[];k.forEach(function(s){var Q=s.getQuickFilter();if(Q){Q.setEnabled(false);}if(t._isMultiMode()){var u=function(){t._updateCounts();};T.addEventToBindingInfo(s,"dataRequested",u);r.push(s.initialized());}});r.push(this._getFilterBarControl().waitForInitialization());this.getView().setModel(this.editFlow.getTransactionHelper().getUIStateModel(),"ui");this.getView().setModel(this.editFlow.getUIStateModel({sessionOn:false,appliedFilters:"",filterBarExpanded:true}),"localUI");this.filterBarConditions={};this._oAppComponent.getRouterProxy().waitForRouteMatchBeforeNavigation();Promise.all(r).then(function(){k.forEach(function(s){var Q=s.getQuickFilter();if(Q){Q.bindProperty("enabled","localUI>/isPendingFilters",function(v){return v!==true;});}});t._updateMultiTableHiddenStatus();t._oAppComponent.getAppStateHandler().applyAppState(t);}).catch(function(s){L.error("Error while getting the chart",s);});},onExit:function(){delete this.filterBarConditions;delete this._oListReportControl;delete this._bMultiMode;this.editFlow.destroy();},onAfterBinding:function(B,P){if(this.routing.isUIStateDirty()){var t=this._getTableBinding();var k=this.getView().getModel("localUI");if(t){t.refresh();if(k){k.setProperty("/$contexts",{});}}this.routing.setUIStateProcessed();}var r=this._getTables();var I=[];r.forEach(function(s){I=c.getIBNActions(s,I);});c.updateDataFieldForIBNButtonsVisibility(I,this.getView());},onAfterRendering:function(k){var t=this;this.getView().getModel("sap.fe.i18n").getResourceBundle().then(function(r){t.oResourceBundle=r;}).catch(function(r){L.error("Error while retrieving the resource bundle",r);});},onPageReady:function(P){var k=P.lastFocusedControl;var v=this.getView();if(k&&k.controlId&&k.focusInfo){var r=v.byId(k.controlId);if(r){r.applyFocusInfo(k.focusInfo);}}},_getPageTitleInformation:function(){var t=this;return new Promise(function(r,k){var s={title:"",subtitle:"",intent:"",icon:""};s.title=t.getView().getContent()[0].data().ListReportTitle;s.subtitle=t.getView().getContent()[0].data().ListReportSubtitle;r(s);});},_getFilterBarControl:function(){return this.getView().byId(this._getFilterBarControlId());},_getFilterBarControlId:function(){return this.getView().getContent()[0].data("filterBarId");},_getChartControlId:function(){return this.getView().getContent()[0].data("singleChartId");},_getChartControl:function(){return this.getView().byId(this._getChartControlId());},_getMultiModeControl:function(){return this.getView().byId("fe::TabMultipleMode");},_getTableControlId:function(){return this.getView().getContent()[0].data("singleTableId");},_getCurrentTable:function(){if(!this._oListReportControl){var k=this._getMultiModeControl();if(k){this._oListReportControl=this.getView().byId(k.getSelectedKey()||k.getItems()[0].getKey());}else{this._oListReportControl=this.getView().byId(this._getTableControlId());}}return this._oListReportControl;},_getTableBinding:function(t){var k=t?this.getView().byId(t):this._getCurrentTable(),B=k&&k._getRowBinding();return B;},_getTables:function(){var t=this;if(this._isMultiMode()){var k=[];var r=this._getMultiModeControl();r.getItems().forEach(function(I){var s=t.getView().byId(I.getKey());if(s){k.push(s);}});return k;}return[this._getCurrentTable()];},_getMergedContext:function(k,r){var s,t;s=c.addExternalStateFiltersToSelectionVariant(new S(),r);if(k&&k.length){var u=this.getView().getModel().getMetaModel();t=k.map(function(v){return{contextData:v.getObject(),entitySet:u.getMetaPath(v.getPath()).replace(/^\/*/,"")};});t=c.removeSensitiveData(t,u);}return{selectionVariant:s,attributes:t};},_isMultiMode:function(){if(!this._oListReportControl){this._bMultiMode=!!this._getMultiModeControl();}return this._bMultiMode;},_setShareModel:function(){var G=O.get("sap.ushell.Container.getUser");var s={bookmarkTitle:document.title,bookmarkCustomUrl:function(){var H=window.hasher.getHash();return H?"#"+H:window.location.href;},isShareInJamActive:!!G&&G().isJamActive()};var t=this.getOwnerComponent().getModel("_templPriv");t.setProperty("/listReport/share",s);},_updateMultiTableHiddenStatus:function(){var D=this._getCurrentTable();if(this._isMultiMode()&&D){var s=D.getId();var t=this._getTables();t.forEach(function(k){var r=k.getId();k.data("tableHidden",r!==s);});}},_updateTableControl:function(){this._oListReportControl=undefined;this._getCurrentTable();},_updateCounts:function(){this._updateMutliModeCounts();},_updateMutliModeCounts:function(){var t=this;var B=[];var r=this._getMultiModeControl();if(r&&r.data("showCounts")==="true"){var D=this._getCurrentTable();var s=D.getId();var u=[];var I=r.getItems();I.forEach(function(k){var v=t.getView().byId(k.getKey());if(v&&(k.data("outdatedCounts")||v.getId()===s)){u.push({table:v,item:k});}});B=u.map(function(k){k.item.setCount("...");var v=k.table;var w=T.getFiltersInfoforSV(v,k.item.data("selectionVariant"));return T.getListBindingForCount(v,t.getView().getBindingContext(),{batchGroupId:v.getId()===s?v.data("batchGroupId"):"$auto",additionalFilters:w.filters});});Promise.all(B).then(function(v){for(var k in v){var w=u[k].item;w.setCount(T.getCountFormatted(v[k]));w.data("outdatedCounts",false);}}).catch(function(k){L.error("Error while retrieving the values for the icon tab bar",k);});}},handlers:{onShareListReportActionButtonPress:function(k,r){var s=r.getView().byId("fe::Share");if(s&&(s.getVisible()||(s.getEnabled&&s.getEnabled()))){l.onShareActionButtonPressImpl(s,r,null);}},onTabMultiModeChange:function(k){this._updateTableControl();this._updateMultiTableHiddenStatus();var r=this._getFilterBarControl();var s=this.getView().getModel("localUI");var D=this._getCurrentTable();if(r&&s.getProperty("/isPendingFilters")!==true&&(!D.getRowBinding()||D.data("outdatedRows")===true)){D.rebindTable();D.data("outdatedRows",false);}var t=n({},k);this._oAppComponent.getAppStateHandler().createAppState(this,t);},onFiltersChanged:function(k){var t=this;var r=k.getSource(),s=this.getView().getModel("localUI");s.setProperty("/appliedFilters",r.getAssignedFiltersText().filtersText);s.setProperty("/isPendingFilters",true);var u=n({},k);var v=this._getCurrentTable();Promise.all([r.waitForInitialization(),v.initialized()]).then(function(){if(u.getParameter("conditionsBased")){t._oAppComponent.getAppStateHandler().createAppState(t,u);}}).catch(function(w){L.error("Error while waiting for filterbar and table",w);});},onVariantSelected:function(k){var r=n({},k);this._oAppComponent.getAppStateHandler().createAppState(this,r);},onVariantSaved:function(k){var t=this;var r=n({},k);setTimeout(function(){t._oAppComponent.getAppStateHandler().createAppState(t,r);},500);},onSearch:function(k){var D=this._getCurrentTable().getId();var r=this.getView().getModel("localUI");r.setProperty("/isPendingFilters",false);r.setProperty("/filterBarExpanded",false);if(this._isMultiMode()){var t=this._getTables();var s=this._getMultiModeControl();if(s&&s.data("showCounts")==="true"){var I=s.getItems();I.forEach(function(B){B.data("outdatedCounts",true);});}t.forEach(function(B){B.data("outdatedRows",B.getId()!==D);});}var u=this._oAppComponent.getAppStateHandler();var v=this;var w=k.getSource();var x=this._getChartControl();if(x){var y=x.getModel("localUI");y.setProperty("/$contexts",{});}e.retrieveExternalState(w).then(function(B){v.filterBarConditions=B.filter;}).catch(function(B){L.error("Error while retrieving the external state",B);});if(this.getView().getViewData().liveMode===false&&u.bIsInitialSearch===false){var z=n({},k);this._oAppComponent.getAppStateHandler().createAppState(this,z);}if(u.bIsInitialSearch===true){u.bIsInitialSearch=false;}},onFieldValueChange:function(k){this.editFlow.syncTask(k.getParameter("promise"));a.handleChange(k);},onDataFieldForIntentBasedNavigation:function(k,s,r,t,v,u,I){var w={};if(I==="true"&&(u==="false"||u==="undefined")){sap.m.MessageBox.show(f.getText("M_COMMON_NAVIGATION_CONTEXT_MESSAGE"),{title:f.getText("M_COMMON_NAVIGATION_ERROR_TITLE")});}else{if(v&&v.length){w=k._getMergedContext(v,k.filterBarConditions);if(t!="undefined"){w.semanticObjectMapping=t;}}w.entitySet=k.getView().getViewData().entitySet;c.navigateToExternalApp(k.getView(),w,s,r,null);}},onChevronPressNavigateOutBound:function(k,s,r){var t=k.routing.getOutbounds(),u={},D=t[s];if(D){if(r){u=k._getMergedContext([r],k.filterBarConditions);}u.entitySet=k.getView().getViewData().entitySet;c.navigateToExternalApp(k.getView(),u,D.semanticObject,D.action,b.showNavigateErrorMessage);return Promise.resolve();}else{throw new Error("outbound target "+s+" not found in cross navigation definition of manifest");}},onChartSelectionChanged:function(k){var r=k.getSource(),t=this._getCurrentTable(),D=k.getParameter("dataContext");if(D&&D.data){j.fnUpdateChart(k);q.setChartFilters(r);}if(t){t.rebindTable();}}}});});
