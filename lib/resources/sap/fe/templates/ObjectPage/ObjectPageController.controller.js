/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)
        (c) Copyright 2009-2020 SAP SE. All rights reserved
    
 */
sap.ui.define(["sap/ui/core/mvc/Controller","sap/ui/model/json/JSONModel","sap/fe/core/controllerextensions/Routing","sap/fe/core/controllerextensions/RoutingListener","sap/fe/core/controllerextensions/FlexibleColumnLayout","sap/fe/core/controllerextensions/EditFlow","sap/ui/model/odata/v4/ODataListBinding","sap/fe/macros/field/FieldRuntime","sap/base/Log","sap/base/util/merge","sap/fe/core/CommonUtils","sap/fe/navigation/SelectionVariant","sap/fe/macros/CommonHelper","sap/fe/macros/table/Utils","sap/m/MessageBox","sap/fe/core/BusyLocker","sap/fe/core/actions/messageHandling","sap/fe/core/FEHelper","sap/fe/macros/ResourceModel","sap/m/Link","sap/fe/macros/chart/ChartRuntime","sap/fe/templates/controls/Share/ShareUtils","sap/fe/templates/ObjectPage/ExtensionAPI","sap/fe/core/helpers/PasteHelper"],function(C,J,R,a,F,E,O,b,L,m,c,S,d,T,M,B,e,f,g,h,j,k,l,n){"use strict";var o;return C.extend("sap.fe.templates.ObjectPage.ObjectPageController",{routingListener:a,constructor:function(){C.apply(this,arguments);this.routing=new R();this.fcl=new F();this.editFlow=new E();},getExtensionAPI:function(){if(!this.extensionAPI){this.extensionAPI=new l(this);}return this.extensionAPI;},onInit:function(){var t=this,i=this.byId("fe::ObjectPage");this.routing.configure(this.getView(),this.fcl);this.fcl.configure(this.getView(),this.routing);this.editFlow.configure(this.getView(),this.routing);this._oAppComponent=c.getAppComponent(this.getView());this.getView().setModel(this.editFlow.getTransactionHelper().getUIStateModel(),"ui");this.getView().setModel(this.editFlow.getUIStateModel({sessionOn:false,batchGroups:t._getBatchGroupsForView()}),"localUI");var r=new J({visibility:false,items:null});this.getView().setModel(r,"relatedAppsModel");var p=new J({});this.getView().setModel(p,"creationRowModel");if(i.getEnableLazyLoading()){i.attachEvent("subSectionEnteredViewPort",this._handleSubSectionEnteredViewPort.bind(this));}},onExit:function(){this.getView().getModel("relatedAppsModel").destroy();this.getView().getModel("creationRowModel").destroy();this.editFlow.destroy();},_getTableBinding:function(t){return t&&t.getRowBinding();},onAfterRendering:function(i){var t=this;this.getView().getModel("sap.fe.i18n").getResourceBundle().then(function(r){t.oResourceBundle=r;}).catch(function(p){L.error("Error while retrieving the resource bundle",p);});},onBeforeBinding:function(p,P){var t=this,q=this._findTables(),r,s=this.byId("fe::ObjectPage"),u=P.listBinding,v=t.getView().getModel("localUI"),w=v.getProperty("/batchGroups");w.push("$auto");if(s.getBindingContext()&&s.getBindingContext().hasPendingChanges()&&!w.some(s.getBindingContext().getModel().hasPendingChanges.bind(s.getBindingContext().getModel()))){s.getBindingContext().getBinding().resetChanges();}for(var i=0;i<q.length;i++){r=q[i].getCreationRow();if(r){r.setBindingContext(null);}}var x=function(N){if(!P.bPersistOPScroll){s.setSelectedSection(null);s.detachModelContextChange(x);}};s.attachModelContextChange(x);if(u&&u.isA("sap.ui.model.odata.v4.ODataListBinding")){var y=t.byId("fe::Paginator");if(y){y.setListBinding(u);}}if(!P.editable){if(v.getProperty("/sessionOn")===true){v.setProperty("/sessionOn",false);}}if(s.getEnableLazyLoading()){var z=s.getSections(),U=s.getUseIconTabBar(),A=2;for(var D=0;D<z.length;D++){var G=z[D];var H=G.getSubSections();for(var I=0;I<H.length;I++,A--){if(A<1||(U&&D>0)){var K=H[I];K.setBindingContext(null);}}}}},_handleSubSectionEnteredViewPort:function(i){var s=i.getParameter("subSection");s.setBindingContext(undefined);},onAfterBinding:function(i,p){var q=this.byId("fe::ObjectPage"),t=this,r=i.getModel(),s=this._findTables(),u;t.getView().getModel("creationRowModel").setProperty("/fieldValidity",{});i=q.getBindingContext();var I=[];q.getSections().forEach(function(A){A.getSubSections().forEach(function(D){I=c.getIBNActions(D,I);});});s.forEach(function(A){I=c.getIBNActions(A,I);var D=A.getRowBinding();if(D){t.editFlow.getProgrammingModel(D).then(function(G){if(G==="Sticky"){D.removeCachesAndMessages("");}}).catch(function(G){L.error("Error while clearing table binding cache.",G);});}});c.updateDataFieldForIBNButtonsVisibility(I,this.getView());u=this.editFlow.computeEditMode(i);if(i.getBinding().oCache){t._updateRelatedApps();}else{var U=function(){t._updateRelatedApps();i.getBinding().detachDataReceived(U);};i.getBinding().attachDataReceived(U);}function v(A,D){var G=A.getCreationRow(),H,K;if(G){u.then(function(){if(G.getVisible()){H=r.bindList(D.getPath(),D.getContext(),[],[],{$$updateGroupId:"doNotSubmit",$$groupId:"doNotSubmit"});H.refreshInternal=function(){};K=H.create();G.setBindingContext(K);K.created().catch(function(){L.trace("transient fast creation context deleted");});}}).catch(function(N){L.error("Error while computing the final UI state",N);});}}function w(A){var z=t._getTableBinding(A),H=function(){v(A,z);};if(!z){L.error("Expected binding missing for table: "+A.getId());return;}if(z.oContext){H();}else{var D=function(){if(z.oContext){H();z.detachChange(D);}};z.attachChange(D);}}var x=this.editFlow.getTransactionHelper(),y=x.getUIStateModel();y.setProperty("/draftStatus","Clear");var z=(i.getBinding&&i.getBinding())||i;z.attachEvent("patchSent",this.editFlow.handlePatchSent,this);z.attachEvent("patchCompleted",this.editFlow.handlePatchCompleted,this);s.forEach(function(A){T.whenBound(A).then(w).catch(function(D){L.error("Error while waiting for the table to be bound",D);});});q._triggerVisibleSubSectionsEvents();this._oAppComponent.getAppStateHandler().applyAppState(this);},onPageReady:function(p){this._clearTableSelection();var i=p.lastFocusedControl;if(i&&i.controlId&&i.focusInfo){var v=this.getView();var q=v.byId(i.controlId);if(q){q.applyFocusInfo(i.focusInfo);return;}}var r=this.byId("fe::ObjectPage");var s=r.getModel("ui").getProperty("/editMode")==="Display";var t;if(s){var A=r.getHeaderTitle().getActions();if(A.length){t=A.find(function(w){return w.mProperties["visible"];});if(t){t.focus();}}}else{var u=r._getFirstEditableInput();if(u){u.focus();}}this._checkDataPointTitleForExternalNavigation();},_getPageTitleInformation:function(){var i=this.byId("fe::ObjectPage");var t={title:i.data("ObjectPageTitle")||"",subtitle:"",intent:"",icon:""};var p=i.getCustomData().find(function(q){return q.getKey()==="ObjectPageSubtitle";});if(p&&p.getBinding("value")!==undefined){if(p.getBinding("value").isA("sap.ui.model.odata.v4.ODataPropertyBinding")){return p.getBinding("value").requestValue().then(function(v){t.subtitle=v;return t;});}else if(p.getBinding("value").isA("sap.ui.model.resource.ResourcePropertyBinding")){t.subtitle=p.getBinding("value").getValue();return Promise.resolve(t);}}else{if(t.subtitle===""&&p&&p.mProperties.value){t.subtitle=p.mProperties.value;}return Promise.resolve(t);}},_executeHeaderShortcut:function(i){var s=this.getView().getId()+"--"+i,p=this.byId("fe::ObjectPage").getHeaderTitle().getActions().find(function(q){return q.getId()===s;});c.fireButtonPress(p);},_executeFooterShortcut:function(i){var s=this.getView().getId()+"--"+i,p=this.byId("fe::ObjectPage").getFooter().getContent().find(function(q){return q.getMetadata().getName()==="sap.m.Button"&&q.getId()===s;});c.fireButtonPress(p);},_executeTabShortCut:function(i){var p=this.byId("fe::ObjectPage"),s=p.indexOfSection(this.byId(p.getSelectedSection())),q=p.getSections(),r=q.length-1,t=i.oSource.getCommand(),u;if(s!==-1&&r>0){if(t==="NextTab"){if(s<=r-1){u=q[++s];}}else{if(s!==0){u=q[--s];}}if(u){p.setSelectedSection(u);u.focus();}}},_getFooterVisibility:function(i){o=i.getParameter("iMessageLength");var p=this.getView().getModel("localUI");o>0&&!p.getProperty("/bIsCreateDialogOpen")?p.setProperty("/showMessageFooter",true):p.setProperty("/showMessageFooter",false);},_showMessagePopover:function(i){var p=i.oMessagePopover,I=p.getBinding("items");if(I.getLength()>0){p.openBy(i);}},_editDocument:function(i){var t=this;var p=this.getView().getModel("ui");B.lock(p);return this.editFlow.editDocument.apply(this.editFlow,[i,this.getView().getViewData().prepareOnEdit]).finally(function(){t._clearTableSelection();B.unlock(p);});},_saveDocument:function(i){var t=this,p=this.getView().getModel("ui"),w=[];var q=false;B.lock(p);this._findTables().forEach(function(r){var s=t._getTableBinding(r);var P={creationMode:r.data("creationMode"),creationRow:r.getCreationRow(),createAtEnd:r.data("createAtEnd")==="true"};var u=P.creationRow&&P.creationRow.getBindingContext()&&Object.keys(P.creationRow.getBindingContext().getObject()).length>1;if(u){P.bSkipSideEffects=true;q=true;w.push(t.editFlow.createDocument(s,P));}});return Promise.all(w).then(function(){return t.editFlow.saveDocument(i,q).then(function(){var r=t.getView().byId("fe::FooterBar::MessageButton");var D={onAfterRendering:function(s){t._showMessagePopover(r);r.removeEventDelegate(t._oDelegateOnAfter);delete t._oDelegateOnAfter;}};t._oDelegateOnAfter=D;r.addEventDelegate(D,t);}).catch(function(r){var s=t.getView().byId("fe::FooterBar::MessageButton");if(s){t._showMessagePopover(s);}}).finally(function(){B.unlock(p);});});},_cancelDocument:function(i,p){var t=this;return this.editFlow.cancelDocument(i,p).finally(function(){t._clearTableSelection();});},_applyDocument:function(i){var t=this;return this.editFlow.applyDocument(i).catch(function(p){L.error(p);var q=t.getView().byId("fe::FooterBar::MessageButton");if(q){t._showMessagePopover(q);}});},_updateRelatedApps:function(){var i=this.byId("fe::ObjectPage");if(c.resolveStringtoBoolean(i.data("showRelatedApps"))){c.updateRelatedAppsDetails(i);}},_findTableInSubSection:function(p,s,t){for(var i=0;i<p.length;i++){var P=p[i].getContent instanceof Function&&p[i].getContent(),v=P.getMetadata instanceof Function&&P.getMetadata().getName()==="sap.fe.templates.controls.ViewSwitchContainer"&&P.getItems().length&&P.getItems()[0],q=v&&v.getContent();if(q&&q.isA("sap.ui.mdc.Table")){t.push(q);if(q.getType().isA("sap.ui.mdc.table.GridTableType")&&!s.hasStyleClass("sapUxAPObjectPageSubSectionFitContainer")){s.addStyleClass("sapUxAPObjectPageSubSectionFitContainer");}}}},_findTables:function(){var i=this.byId("fe::ObjectPage"),t=[];var s=i.getSections();for(var p=0;p<s.length;p++){var q=s[p].getSubSections();for(var r=0;r<q.length;r++){this._findTableInSubSection(q[r].getBlocks(),q[r],t);this._findTableInSubSection(q[r].getMoreBlocks(),q[r],t);}}return t;},_getChartContextData:function(i,s){var p=[];var q=i.getObject();if(i&&s){if(q[s]){p=q[s];delete q[s];p.push(q);}else{p=[i.getObject()];}return p;}},_mergeMultipleContexts:function(p,i,s){var t=this;var A=[],P=[],q,r,u,v,w,x,y;y=p.getPath();q=p&&p.getModel()&&p.getModel().getMetaModel();v=q&&q.getMetaPath(y).replace(/^\/*/,"");if(i&&i.length){r=i[0];w=r.getPath();u=q&&q.getMetaPath(w).replace(/^\/*/,"");i.map(function(z){if(s){var D=t._getChartContextData(z,s);if(D){A=D.map(function(D){return{contextData:D,entitySet:v+"/"+s};});}}else{A.push({contextData:z.getObject(),entitySet:u});}});}P.push({contextData:p.getObject(),entitySet:v});P=c.removeSensitiveData(P,q);x=c.addPageContextToSelectionVariant(new S(),P,t.getView());A=c.removeSensitiveData(A,q);return{selectionVariant:x,attributes:A};},_getBatchGroupsForView:function(){var t=this,v=t.getView().getViewData(),i=v.controlConfiguration,p=i&&Object.keys(i),q=["$auto.Heroes","$auto.Decoration","$auto.Workers"];if(p&&p.length>0){p.forEach(function(K){var r=i[K];if(r.requestGroupId==="LongRunners"){q.push("$auto.LongRunners");}});}return q;},_setBreadcrumbLinks:function(s){var p=s.getBindingContext();var A=c.getAppComponent(this.getView());if(p){var N=p.getPath(),P=N.split("/"),q="";P.shift();P.splice(-1,1);P.forEach(function(r,i){q+="/"+r;var t=A.getRootViewController();var u=t.getTitleHierarchyCache();var v;if(!u[q]){v=t.addNewEntryInCacheTitle(q,A);}else{v=Promise.resolve(u[q]);}v.then(function(w){var x=s.getLinks()[i]?s.getLinks()[i]:new h();x.setText(w.subtitle||w.title);x.setHref(w.intent);if(!s.getLinks()[i]){s.addLink(x);}}).catch(function(w){L.error("Error while computing the title hierarchy",w);});});}},_checkDataPointTitleForExternalNavigation:function(){var v=this.getView();var i=v.getModel("localUI");var A=c.getAppComponent(v);var D=c.getHeaderFacetItemConfigForExternalNavigation(v.getViewData(),this.routing.getOutbounds());var s=A.getShellServices();var p=v&&v.getBindingContext();i.setProperty("/isHeaderDPLinkVisible",{});if(p){p.requestObject().then(function(t){G(D,t);}).catch(function(t){L.error("Cannot retrieve the links from the shell service",t);});}function q(t){L.error(t);}function r(t){var u=this.id;if(t&&t.length===1&&t[0].supported){i.setProperty("/isHeaderDPLinkVisible/"+u,true);}}function G(D,P){for(var I in D){var t=D[I];var u={};var w=v.byId(I);if(!w){continue;}var x=w.getBindingContext();var y=x&&x.getObject();var z=m({},P,y);if(t.semanticObjectMapping){var H=t.semanticObjectMapping;for(var K in H){var N=H[K];var Q=N["LocalProperty"]["$PropertyPath"];var U=N["SemanticObjectProperty"];if(Q!==U){if(z.hasOwnProperty(Q)){var V={};V[U]=z[Q];z=m({},z,V);delete z[Q];}}}}if(z){for(var W in z){if(W.indexOf("_")!==0&&W.indexOf("odata.context")===-1){u[W]=z[W];}}}s.isNavigationSupported([{target:{semanticObject:t.semanticObject,action:t.action},params:u}]).then(r.bind({id:I})).catch(q);}}},_clearTableSelection:function(){var t=this;var i=this._findTables();var p=this.getView().getModel("localUI");i.forEach(function(q){var s=t.getView().getLocalId(q.getId());var r=(q&&q.getSelectedContexts())||[];if(r.length>0){q.clearSelection();if(p){p.setProperty("/$contexts/"+s,{});}}});},_onPasteInTable:function(i,p){if(this.getView().getModel("ui").getProperty("/editMode")!=="Editable"){return;}var r=i.getParameter("data"),t=i.getSource(),P=t.data()["pasteEnabled"],q=this,s;if(P!==false&&P!==undefined){n.parseDataForTablePaste(r,t).then(function(u){if(u&&u.length>0){return q.editFlow.createMultipleDocuments(t.getRowBinding(),u,p);}}).catch(function(u){L.error("Error while pasting data",u);});}else{s=sap.ui.getCore().getLibraryResourceBundle("sap.fe.core");M.error(s.getText("T_OP_CONTROLLER_SAPFE_PASTE_DISABLED_MESSAGE"),{title:s.getText("C_COMMON_SAPFE_ERROR")});}},_onPasteTableButtonPressed:function(t){var r=sap.ui.getCore().getLibraryResourceBundle("sap.fe.templates");M.information(r.getText("T_OP_CONTROLLER_TABLE_PASTE_BUTTON_ACTION_MESSAGE"),{onClose:function(i){if(t){t.getAggregation("_content").applyFocusInfo({preventScroll:true});}}});},handlers:{onFieldValueChange:function(i){this.editFlow.syncTask(i.getParameter("promise"));b.handleChange(i);},onTableContextChange:function(p){var t=this;var s=p.getSource();var q;this._findTables().some(function(_){if(_.getRowBinding()===s){q=_;return true;}return false;});var r=q.data("enableAutoScroll");if(typeof r==="string"){r=r==="true"?true:false;}if(r&&this.editFlow.getCurrentActionPromise()){var u=s.getContexts(0);if(!u[0]){return;}this.editFlow.getCurrentActionPromise().then(function(A){if(!A){return;}var v=A.oData;var K=A.keys;var N=-1;u.find(function(w,i){var x=w.getObject();var y=K.every(function(z){return x[z]===v[z];});if(y){N=i;}return y;});if(N!==-1){q.scrollToIndex(N);t.editFlow.deleteCurrentActionPromise();}}).catch(function(i){L.error("An error occurs while scrolling to the newly created Item: "+i);});}},onShareObjectPageActionButtonPress:function(i,p){var q=p.getView().byId("fe::Share");p._getPageTitleInformation().then(function(r){if(q&&(q.getVisible()||(q.getEnabled&&q.getEnabled()))){k.onShareActionButtonPressImpl(q,p,r);}}).catch(function(r){L.error("Error while retrieving the page title information",r);});},onRelatedAppsItemPressed:function(p,q){var r=p.getSource(),s=q&&q.getView()&&q.getView().getBindingContext();q.editFlow.getProgrammingModel(s).then(function(t){var u=r.getCustomData(),v,w;for(var i=0;i<u.length;i++){var x=u[i].getKey();var y=u[i].getValue();if(x=="targetSemObject"){v=y;}else if(x=="targetAction"){w=y;}}var z={semanticObject:v,action:w};var A=q.getView().getAggregation("content")[0].getBindingContext();var D=q.getView().getModel().getMetaModel();var G=[{contextData:A.getObject(),entitySet:D.getMetaPath(A.getPath()).replace(/^\/*/,"")}];G=c.removeSensitiveData(G,D);c.navigateToExternalApp(q.getView(),{selectionVariant:new S(),attributes:G},z.semanticObject,z.action,null,c.isStickyEditMode(r,t));}).catch(function(i){L.error("Error while retrieving the programming model",i);});},onCallActionFromFooter:function(v,A,p){var i=v.getController();var t=i;return i.editFlow.onCallAction(A,p).then(function(){var q=t.getView().byId("fe::FooterBar::MessageButton");if(q.isActive()){t._showMessagePopover(q);}else if(o){t._oDelegateOnAfter={onAfterRendering:function(r){t._showMessagePopover(q);q.removeEventDelegate(t._oDelegateOnAfter);delete t._oDelegateOnAfter;}};q.addEventDelegate(t._oDelegateOnAfter,t);}}).catch(function(q){var r=t.getView().byId("fe::FooterBar::MessageButton");if(r){t._showMessagePopover(r);}});},onDataPointTitlePressed:function(i,s,p,q,r){p=typeof p==="string"?JSON.parse(p):p;var t=i&&i.getView();var u=p[q];var v=c.getSemanticObjectMapping(u);var D=s.getBindingContext();var P=i.getView().getBindingContext();var w=i._mergeMultipleContexts(P,[D],r);if(v.length>0){w.semanticObjectMapping=v;}i.editFlow.getProgrammingModel(P).then(function(x){c.navigateToExternalApp(i.getView(),w,u.semanticObject,u.action,null,c.isStickyEditMode(t,x));}).catch(function(x){L.error("Error while retrieving the programming model",x);});},onDataFieldForIntentBasedNavigation:function(i,s,A,p,q,r,I){var t=i&&i.getView(),u=t&&t.getBindingContext();if(I==="true"&&(r==="false"||r==="undefined")){M.show(g.getText("M_COMMON_NAVIGATION_CONTEXT_MESSAGE"),{title:g.getText("M_COMMON_NAVIGATION_ERROR_TITLE")});}else{i.editFlow.getProgrammingModel(u).then(function(v){var w;var P;if(i.getView().getAggregation("content")[0].getBindingContext()){P=i.getView().getAggregation("content")[0].getBindingContext();}if(q&&!Array.isArray(q)){q=[q];}w=i._mergeMultipleContexts(P,q);if(p!="undefined"){w.semanticObjectMapping=p;}c.navigateToExternalApp(i.getView(),w,s,A,null,c.isStickyEditMode(t,v));}).catch(function(v){L.error("Error while retrieving the programming model",v);});}},onChevronPressNavigateOutBound:function(i,s,p){var q=i&&i.getView(),r=q&&q.getBindingContext();return i.editFlow.getProgrammingModel(r).then(function(t){var u=i.routing.getOutbounds(),v,D=u[s],P=i.getView().getAggregation("content")[0].getBindingContext();if(D){if(p){v=i._mergeMultipleContexts(P,[p]);}c.navigateToExternalApp(i.getView(),v,D.semanticObject,D.action,d.showNavigateErrorMessage,c.isStickyEditMode(q,t));return Promise.resolve();}else{throw new Error("outbound target "+s+" not found in cross navigation definition of manifest");}});},onNavigateChange:function(i){this._oAppComponent.getAppStateHandler().createAppState(this,i);this.bSectionNavigated=true;},onVariantSelected:function(i){this._oAppComponent.getAppStateHandler().createAppState(this,i);},onVariantSaved:function(i){var t=this;var p=m({},i);setTimeout(function(){t._oAppComponent.getAppStateHandler().createAppState(t,p);},500);},navigateToSubSection:function(i,D){var p=typeof D==="string"?JSON.parse(D):D,q=i.getView().byId("fe::ObjectPage"),s,r;if(p.sectionId){s=i.getView().byId(p.sectionId);r=p.subSectionId?i.getView().byId(p.subSectionId):s&&s.getSubSections()&&s.getSubSections()[0];}else if(p.subSectionId){r=i.getView().byId(p.subSectionId);s=r&&r.getParent();}if(!s||!r||!s.getVisible()||!r.getVisible()){i.getView().getModel("sap.fe.i18n").getResourceBundle().then(function(t){var u=c.getTranslatedText("T_OP_CONTROLLER_OBJECT_PAGE_INPAGE_NAV_ERROR",t,null,i.getView().getViewData().entitySet);M.error(u);}).catch(function(t){L.error(t);});}else{q.scrollToSection(r.getId());q.fireNavigate({section:s,subSection:r});}},onChartSelectionChanged:function(i){j.fnUpdateChart(i);}}});});
