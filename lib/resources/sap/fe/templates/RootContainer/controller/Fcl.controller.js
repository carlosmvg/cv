sap.ui.define(["sap/base/Log","sap/ui/model/json/JSONModel","./BaseController","sap/f/FlexibleColumnLayoutSemanticHelper","sap/ui/core/Component","sap/fe/core/controllerextensions/Routing"],function(L,J,B,F,C,R){"use strict";var a={page:{names:["BeginColumn","MidColumn","EndColumn"],currentGetter:{prefix:"getCurrent",suffix:"Page"},getter:{prefix:"get",suffix:"Pages"}}};return B.extend("sap.fe.templates.RootContainer.controller.Fcl",{onInit:function(e){B.prototype.onInit.bind(this)();this.oTargetsAggregation={};this.oTargetsFromRoutePattern={};this.sCurrentRouteName="";this.sCurrentArguments={};this.SQUERYKEYNAME="?query";var A=C.getOwnerComponentFor(this.getView());this.oRouter=A.getRouter();this.oNavigationHelper=A.getRouterProxy();this._oFCLConfig={};var r=A.getManifest()["sap.ui5"].routing;if(r.config&&r.config.flexibleColumnLayout){var f=r.config.flexibleColumnLayout;if(f.defaultTwoColumnLayoutType){this._oFCLConfig.defaultTwoColumnLayoutType=f.defaultTwoColumnLayoutType;}if(f.defaultThreeColumnLayoutType){this._oFCLConfig.defaultThreeColumnLayoutType=f.defaultThreeColumnLayoutType;}if(f.limitFCLToTwoColumns===true){this._oFCLConfig.maxColumnsCount=2;}else{this._oFCLConfig.maxColumnsCount=3;}}this.initializeTargetAggregation(A);this._initializeRoutesInformation(A);var o=new R();var b=o.getFirstBeforeRouteMatchedCallEvent();if(b){this.onBeforeRouteMatched(b);}this._aFCLHelperModels=[];},attachShellTitleHandler:function(){B.prototype.attachShellTitleHandler.apply(this,arguments);var A=C.getOwnerComponentFor(this.getView());var r=A.getRouter();r.attachBeforeRouteMatched(this.onBeforeRouteMatched,this);r.attachRouteMatched(this.onRouteMatched,this);},getFclControl:function(){return this.getView().getContent()[0];},_createFCLHelperModel:function(){var m=new J();this._aFCLHelperModels.push(m);return m;},onExit:function(){this.oRouter.detachRouteMatched(this.onRouteMatched,this);this.oRouter.detachBeforeRouteMatched(this.onBeforeRouteMatched,this);this.getFclControl().detachStateChange(this.onStateChanged,this);this.getFclControl().detachAfterEndColumnNavigate(this.onStateChanged,this);this.oRouter=null;this.oTargetsAggregation=null;this.oTargetsFromRoutePattern=null;this._aFCLHelperModels.forEach(function(m){m.destroy();});},isFclEnabled:function(){return true;},initializeTargetAggregation:function(A){var m=A.getManifest();var t=m["sap.ui5"].routing.targets;var b=this;Object.keys(t).forEach(function(T){var o=t[T];if(o.controlAggregation){b.oTargetsAggregation[T]={aggregation:o.controlAggregation,pattern:o.contextPattern};}else{b.oTargetsAggregation[T]={aggregation:"page",pattern:null};}});},_initializeRoutesInformation:function(A){var m=A.getManifest();var r=m["sap.ui5"].routing.routes;var t=this;r.forEach(function(b){t.oTargetsFromRoutePattern[b.pattern]=b.target;});},getCurrentArgument:function(){return this.sCurrentArguments;},getCurrentRouteName:function(){return this.sCurrentRouteName;},getConstants:function(){return a;},getTargetAggregation:function(){return this.oTargetsAggregation;},onRouteMatched:function(e){var r=e.getParameter("name");this._updateUIStateForEachView();this.sCurrentRouteName=r;this.sCurrentArguments=e.getParameter("arguments");},onStateChanged:function(e){var i=e.getParameter("isNavigationArrow");if(this.sCurrentArguments!==undefined){if(!this.sCurrentArguments[this.SQUERYKEYNAME]){this.sCurrentArguments[this.SQUERYKEYNAME]={};}this.sCurrentArguments[this.SQUERYKEYNAME].layout=e.getParameter("layout");}this._updateUIStateForEachView();this._forceModelContextChangeOnBreadCrumbs(e);if(i){this.oNavigationHelper.navTo(this.sCurrentRouteName,this.sCurrentArguments);}},_forceModelContextChangeOnBreadCrumbs:function(e){var f=e.getSource();var p=[];p=p.concat(f.getBeginColumnPages()).concat(f.getMidColumnPages()).concat(f.getEndColumnPages());p.forEach(function(P){var v=P.getComponentInstance().getRootControl();var b=v.byId("breadcrumbs");if(b){b.fireModelContextChange();}});},_updateUIStateForEachView:function(){var v=this._getAllVisibleViews();if(!this.getView().getModel("fclnavigated")){this.getView().setModel(this._createFCLHelperModel(),"fclnavigated");}for(var i=0;i<v.length;i++){var V=v[i];if(V){this._updateUIStateForView(V);if(V.getBindingContext()){var d=this.getView().getModel("fclnavigated").getProperty("/deepestPath"),s=V.getBindingContext().getPath();if(!d||d.indexOf(s)!==0){this.getView().getModel("fclnavigated").setProperty("/deepestPath",s);}}}}},_updateShareButtonVisibility:function(v,l){var s;switch(l){case"OneColumn":s=v==="beginColumn";break;case"MidColumnFullScreen":case"ThreeColumnsBeginExpandedEndHidden":case"ThreeColumnsMidExpandedEndHidden":case"TwoColumnsBeginExpanded":case"TwoColumnsMidExpanded":s=v==="midColumn";break;case"EndColumnFullScreen":case"ThreeColumnsEndExpanded":case"ThreeColumnsMidExpanded":s=v==="endColumn";break;default:s=false;}return s;},_updateUIStateForView:function(v){var u=this.getHelper().getCurrentUIState(),f=["beginColumn","midColumn","endColumn"],b=v.getController().fcl.getFCLLevel(),l=this.getFclControl().getLayout(),c;if(!v.getModel("fclhelper")){v.setModel(this._createFCLHelperModel(),"fclhelper");}if(b>=this._oFCLConfig.maxColumnsCount){c=f[this._oFCLConfig.maxColumnsCount-1];u.actionButtonsInfo.midColumn.exitFullScreen=null;u.actionButtonsInfo.midColumn.closeColumn=null;u.actionButtonsInfo.endColumn.exitFullScreen=null;u.actionButtonsInfo.endColumn.closeColumn=null;}else{c=f[b];}if(b>=this._oFCLConfig.maxColumnsCount||l==="EndColumnFullScreen"||l==="MidColumnFullScreen"||l==="OneColumn"){v.getModel("fclhelper").setProperty("/breadCrumbIsVisible",true);}else{v.getModel("fclhelper").setProperty("/breadCrumbIsVisible",false);}u.actionButtonsInfo.beginColumn={fullScreen:null,exitFullScreen:null,closeColumn:null};v.getModel("fclhelper").setProperty("/actionButtonsInfo",Object.assign({},u.actionButtonsInfo[c]));v.getModel("fclhelper").setProperty("/showShareIcon",this._updateShareButtonVisibility(c,l));},_getViewFromContainer:function(c){if(c.isA("sap.ui.core.ComponentContainer")){return c.getComponentInstance().getRootControl();}else{return c;}},onBeforeRouteMatched:function(e){if(e){var q=e.getParameters().arguments[this.SQUERYKEYNAME];var l=q?q.layout:null;if(!l){var n=this.getHelper().getNextUIState(0);l=n.layout;}var t=e.getParameter("config").target;l=this._correctLayoutForTargets(l,t);if(l){if(!this.getFclControl().getModel("fcl")){this.getFclControl().setModel(new J(),"fcl");this.getFclControl().bindProperty("layout","fcl>/layout");}this.getFclControl().setProperty("layout",l);}}},getHelper:function(){return F.getInstanceFor(this.getFclControl(),this._oFCLConfig);},updateFCLLevels:function(t,c){var v;if(t.length==1&&this.getTargetAggregation()[t[0]].aggregation!=="beginColumnPages"){v=this._getViewFromContainer(c[0]);v.getController().fcl.setFCLLevel(3);this._updateUIStateForView(v);}else{for(var i=0;i<t.length;i++){var T=t[i];var o=this.getTargetAggregation()[T];v=this._getViewFromContainer(c[i]);switch(o.aggregation){case"beginColumnPages":v.getController().fcl.setFCLLevel(0);break;case"midColumnPages":v.getController().fcl.setFCLLevel(1);break;default:v.getController().fcl.setFCLLevel(2);}this._updateUIStateForView(v);}}},getFCLLayout:function(n,h,p){if(!p){p=this.getHelper().getNextUIState(n).layout;}var r=this.oRouter.getRouteByHash(h+"?layout="+p);var t=this.oTargetsFromRoutePattern[r.getPattern()];return this._correctLayoutForTargets(p,t);},_correctLayoutForTargets:function(p,t){var b={"2":["TwoColumnsMidExpanded","TwoColumnsBeginExpanded","MidColumnFullScreen"],"3":["ThreeColumnsMidExpanded","ThreeColumnsEndExpanded","ThreeColumnsMidExpandedEndHidden","ThreeColumnsBeginExpandedEndHidden","MidColumnFullScreen","EndColumnFullScreen"]};if(!t){return p;}else if(t.length>1){var l=b[t.length];if(l.indexOf(p)<0){p=l[0];}}else{switch(this.getTargetAggregation()[t[0]].aggregation){case"beginColumnPages":p="OneColumn";break;case"midColumnPages":p="MidColumnFullScreen";break;default:p="EndColumnFullScreen";break;}}return p;},_getAllVisibleViews:function(){var v=[];switch(this.getFclControl().getLayout()){case sap.f.LayoutType.EndColumnFullScreen:if(this.getFclControl().getCurrentEndColumnPage()){v.push(this._getViewFromContainer(this.getFclControl().getCurrentEndColumnPage()));}break;case sap.f.LayoutType.MidColumnFullScreen:if(this.getFclControl().getCurrentMidColumnPage()){v.push(this._getViewFromContainer(this.getFclControl().getCurrentMidColumnPage()));}break;case sap.f.LayoutType.OneColumn:if(this.getFclControl().getCurrentBeginColumnPage()){v.push(this._getViewFromContainer(this.getFclControl().getCurrentBeginColumnPage()));}break;case sap.f.LayoutType.ThreeColumnsEndExpanded:case sap.f.LayoutType.ThreeColumnsMidExpanded:if(this.getFclControl().getCurrentBeginColumnPage()){v.push(this._getViewFromContainer(this.getFclControl().getCurrentBeginColumnPage()));}if(this.getFclControl().getCurrentMidColumnPage()){v.push(this._getViewFromContainer(this.getFclControl().getCurrentMidColumnPage()));}if(this.getFclControl().getCurrentEndColumnPage()){v.push(this._getViewFromContainer(this.getFclControl().getCurrentEndColumnPage()));}break;case sap.f.LayoutType.TwoColumnsBeginExpanded:case sap.f.LayoutType.TwoColumnsMidExpanded:case sap.f.LayoutType.ThreeColumnsMidExpandedEndHidden:case sap.f.LayoutType.ThreeColumnsBeginExpandedEndHidden:if(this.getFclControl().getCurrentBeginColumnPage()){v.push(this._getViewFromContainer(this.getFclControl().getCurrentBeginColumnPage()));}if(this.getFclControl().getCurrentMidColumnPage()){v.push(this._getViewFromContainer(this.getFclControl().getCurrentMidColumnPage()));}break;default:L.error("Unhandled switch case for "+this.getFclControl().getLayout());}return v;}});},true);
